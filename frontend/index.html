<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DSA Learning Daily - Master Data Structures & Algorithms</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animation.css">
    <link rel="stylesheet" href="css/responsive.css">
</head>

<body class="bg-gray-50">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="loading-spinner">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3 text-muted">Loading DSA Learning Platform...</p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app" class="app-container" style="display: none;">
        <!-- Top Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary fixed-top shadow-lg">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#">
                    <i class="bi bi-code-square me-2"></i>DSA Learning Daily
                </a>

                <!-- Desktop Navigation -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-page="dashboard">
                                <i class="bi bi-speedometer2 me-1"></i>Dashboard
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="roadmap">
                                <i class="bi bi-map me-1"></i>Roadmap
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="calendar">
                                <i class="bi bi-calendar-week me-1"></i>Calendar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-page="progress">
                                <i class="bi bi-graph-up me-1"></i>Progress
                            </a>
                        </li>
                    </ul>

                    <!-- User Menu -->
                    <div class="navbar-nav">
                        <div class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" role="button"
                                data-bs-toggle="dropdown">
                                <img src="https://via.placeholder.com/32" class="rounded-circle me-2" width="32"
                                    height="32" id="userAvatar">
                                <span id="userName">User</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="#" data-page="profile"><i
                                            class="bi bi-person me-2"></i>Profile</a></li>
                                <li><a class="dropdown-item" href="#" data-page="notes"><i
                                            class="bi bi-journal-text me-2"></i>Notes</a></li>
                                <li><a class="dropdown-item" href="#" data-page="pomodoro"><i
                                            class="bi bi-clock me-2"></i>Pomodoro</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="#" onclick="logout()"><i
                                            class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Mobile Menu Button -->
                <button class="navbar-toggler d-lg-none" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content" style="margin-top: 76px;">
            <div id="pageContent" class="container-fluid p-4">
                <!-- Dynamic content will be loaded here -->
            </div>
        </main>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-nav d-lg-none">
            <div class="mobile-nav-item" data-page="dashboard">
                <i class="bi bi-speedometer2"></i>
                <span>Dashboard</span>
            </div>
            <div class="mobile-nav-item" data-page="roadmap">
                <i class="bi bi-map"></i>
                <span>Roadmap</span>
            </div>
            <div class="mobile-nav-item" data-page="calendar">
                <i class="bi bi-calendar-week"></i>
                <span>Calendar</span>
            </div>
            <div class="mobile-nav-item" data-page="progress">
                <i class="bi bi-graph-up"></i>
                <span>Progress</span>
            </div>
            <div class="mobile-nav-item" data-page="notes">
                <i class="bi bi-journal-text"></i>
                <span>Notes</span>
            </div>
        </nav>
    </div>

    <!-- Success Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="bi bi-check-circle me-2"></i>
                <strong class="me-auto">Success!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
    </div>

    <!-- Error Toast -->
    <div class="toast-container position-fixed top-0 end-0 p-3">
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong class="me-auto">Error!</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
    </div>

    <!-- Achievement Modal -->
    <div class="modal fade" id="achievementModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-gradient-to-r from-yellow-400 to-orange-500 text-white">
                <div class="modal-body text-center p-5">
                    <div class="achievement-icon mb-3">
                        <i class="bi bi-trophy-fill" style="font-size: 3rem;"></i>
                    </div>
                    <h4 class="modal-title mb-2">ðŸŽ‰ Achievement Unlocked!</h4>
                    <p class="mb-3" id="achievementMessage">Great job completing your daily goal!</p>
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Awesome!</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        // Global Configuration
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let currentUser = null;
        let authToken = localStorage.getItem('accessToken');

        // Initialize App
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        async function initializeApp() {
            // Check authentication
            if (!authToken) {
                window.location.href = 'auth/login.html';
                return;
            }

            try {
                // Verify token and get user data
                const userData = await fetchWithAuth('/profile');
                currentUser = userData.user;

                // Update UI with user data
                updateUserUI(userData.user);

                // Load dashboard by default
                await loadPage('dashboard');

                // Hide loading screen
                document.getElementById('loadingScreen').style.display = 'none';
                document.getElementById('app').style.display = 'block';

                // Set up event listeners
                setupEventListeners();

                // Start real-time updates
                startRealTimeUpdates();

            } catch (error) {
                console.error('Authentication failed:', error);
                localStorage.removeItem('accessToken');
                window.location.href = 'auth/login.html';
            }
        }

        function updateUserUI(user) {
            document.getElementById('userName').textContent = user.name;
            if (user.avatar_url) {
                document.getElementById('userAvatar').src = user.avatar_url;
            }
        }

        function setupEventListeners() {
            // Navigation links
            document.querySelectorAll('[data-page]').forEach(link => {
                link.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const page = e.currentTarget.getAttribute('data-page');
                    await loadPage(page);
                    updateActiveNavigation(page);
                });
            });

            // Mobile navigation
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.addEventListener('click', async (e) => {
                    const page = e.currentTarget.getAttribute('data-page');
                    await loadPage(page);
                    updateActiveMobileNav(page);
                });
            });
        }

        function updateActiveNavigation(page) {
            // Update desktop navigation
            document.querySelectorAll('.navbar-nav .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            document.querySelector(`[data-page="${page}"]`).classList.add('active');
        }

        function updateActiveMobileNav(page) {
            // Update mobile navigation
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.mobile-nav-item[data-page="${page}"]`).classList.add('active');
        }

        async function loadPage(page) {
            try {
                showPageLoading();

                let content = '';

                switch (page) {
                    case 'dashboard':
                        content = await loadDashboard();
                        break;
                    case 'roadmap':
                        content = await loadRoadmap();
                        break;
                    case 'calendar':
                        content = await loadCalendar();
                        break;
                    case 'progress':
                        content = await loadProgress();
                        break;
                    case 'notes':
                        content = await loadNotes();
                        break;
                    case 'pomodoro':
                        content = await loadPomodoro();
                        break;
                    case 'profile':
                        content = await loadProfile();
                        break;
                    case 'analytics':
                        content = await loadAnalytics();
                        break;
                    default:
                        content = '<div class="alert alert-warning">Page not found</div>';
                }

                document.getElementById('pageContent').innerHTML = content;
                hidePageLoading();

            } catch (error) {
                console.error('Error loading page:', error);
                showError('Failed to load page content');
                hidePageLoading();
            }
        }

        function showPageLoading() {
            document.getElementById('pageContent').innerHTML = `
                <div class="d-flex justify-content-center align-items-center" style="height: 50vh;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `;
        }

        function hidePageLoading() {
            // Content is already replaced, nothing to do
        }

        // API Helper Functions
        async function fetchWithAuth(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });

            if (response.status === 401) {
                // Token expired, try to refresh
                try {
                    await refreshToken();
                    // Retry the original request
                    return fetchWithAuth(endpoint, options);
                } catch (error) {
                    localStorage.removeItem('accessToken');
                    window.location.href = 'auth/login.html';
                    throw new Error('Authentication failed');
                }
            }

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Request failed');
            }

            return await response.json();
        }

        async function refreshToken() {
            const refreshToken = localStorage.getItem('refreshToken');
            if (!refreshToken) {
                throw new Error('No refresh token');
            }

            const response = await fetch(`${API_BASE}/auth/refresh`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${refreshToken}`
                }
            });

            if (!response.ok) {
                throw new Error('Token refresh failed');
            }

            const data = await response.json();
            authToken = data.access_token;
            localStorage.setItem('accessToken', authToken);
        }

        // Dashboard Functions
        async function loadDashboard() {
            const dashboardData = await fetchWithAuth('/dashboard');
            const progressData = await fetchWithAuth('/progress');

            return `
                <div class="row g-4">
                    <!-- Welcome Section -->
                    <div class="col-12">
                        <div class="card bg-gradient-to-r from-blue-500 to-purple-600 text-white border-0 shadow-lg">
                            <div class="card-body p-4">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <h2 class="mb-2">Welcome back, ${currentUser.name}! ðŸ‘‹</h2>
                                        <p class="mb-0 opacity-90">Ready to continue your DSA journey?</p>
                                    </div>
                                    <div class="text-center">
                                        <div class="h4 mb-1">${dashboardData.stats.current_streak}</div>
                                        <small>Day Streak</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="text-primary mb-2">
                                    <i class="bi bi-fire" style="font-size: 2rem;"></i>
                                </div>
                                <h4 class="mb-1">${dashboardData.stats.current_streak}</h4>
                                <small class="text-muted">Current Streak</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="text-success mb-2">
                                    <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
                                </div>
                                <h4 class="mb-1">${Math.round(dashboardData.stats.completion_percentage)}%</h4>
                                <small class="text-muted">Completed</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="text-warning mb-2">
                                    <i class="bi bi-clock" style="font-size: 2rem;"></i>
                                </div>
                                <h4 class="mb-1">${Math.floor(dashboardData.stats.total_study_time / 60)}h</h4>
                                <small class="text-muted">Study Time</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3 col-6">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-body text-center">
                                <div class="text-info mb-2">
                                    <i class="bi bi-trophy" style="font-size: 2rem;"></i>
                                </div>
                                <h4 class="mb-1">${dashboardData.stats.longest_streak}</h4>
                                <small class="text-muted">Best Streak</small>
                            </div>
                        </div>
                    </div>

                    <!-- Weekly Progress -->
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white border-0 pb-0">
                                <h5 class="mb-0">Weekly Progress</h5>
                            </div>
                            <div class="card-body">
                                <div class="weekly-progress">
                                    ${generateWeeklyProgressChart(dashboardData.weekly_progress)}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Quote & Quick Actions -->
                    <div class="col-lg-4">
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i class="bi bi-quote text-muted" style="font-size: 2rem;"></i>
                                </div>
                                <blockquote class="blockquote mb-3">
                                    <p class="mb-0" id="dailyQuote">Loading inspirational quote...</p>
                                </blockquote>
                                <small class="text-muted">Daily Motivation</small>
                            </div>
                        </div>
                        
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 pb-0">
                                <h6 class="mb-0">Quick Actions</h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-primary btn-sm" onclick="loadPage('pomodoro')">
                                        <i class="bi bi-play-circle me-2"></i>Start Study Session
                                    </button>
                                    <button class="btn btn-outline-primary btn-sm" onclick="loadPage('roadmap')">
                                        <i class="bi bi-map me-2"></i>View Today's Topic
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activity -->
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 pb-0">
                                <h5 class="mb-0">Recent Activity</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">Recent Study Sessions</h6>
                                        ${generateRecentSessions(dashboardData.recent_sessions)}
                                    </div>
                                    <div class="col-md-6">
                                        <h6 class="text-muted mb-3">Recent Notes</h6>
                                        ${generateRecentNotes(dashboardData.recent_notes)}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function generateWeeklyProgressChart(weeklyProgress) {
            let html = '<div class="row g-2">';

            for (let week = 1; week <= 14; week++) {
                const progress = weeklyProgress[week] || { completed: 0, total: 7, percentage: 0 };
                const isActive = progress.completed > 0;

                html += `
                    <div class="col-6 col-md-4 col-lg-3 mb-2">
                        <div class="card ${isActive ? 'border-primary' : 'border-light'} h-100">
                            <div class="card-body p-2 text-center">
                                <small class="text-muted">Week ${week}</small>
                                <div class="progress mt-1 mb-1" style="height: 4px;">
                                    <div class="progress-bar" style="width: ${progress.percentage}%"></div>
                                </div>
                                <small>${progress.completed}/${progress.total}</small>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            return html;
        }

        function generateRecentSessions(sessions) {
            if (!sessions || sessions.length === 0) {
                return '<p class="text-muted">No recent study sessions</p>';
            }

            return sessions.map(session => `
                <div class="d-flex align-items-center mb-2">
                    <div class="me-3">
                        <i class="bi bi-clock-fill text-primary"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-medium">${session.topic || 'Study Session'}</div>
                        <small class="text-muted">${session.duration} minutes â€¢ ${formatDate(session.start_time)}</small>
                    </div>
                    <div>
                        <span class="badge ${session.completed ? 'bg-success' : 'bg-warning'}">
                            ${session.completed ? 'Completed' : 'In Progress'}
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function generateRecentNotes(notes) {
            if (!notes || notes.length === 0) {
                return '<p class="text-muted">No recent notes</p>';
            }

            return notes.map(note => `
                <div class="d-flex align-items-center mb-2">
                    <div class="me-3">
                        <i class="bi bi-journal-text text-info"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="fw-medium">${note.title}</div>
                        <small class="text-muted">${formatDate(note.updated_at)}</small>
                    </div>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewNote('${note.id}')">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('successToast'));
            toast.show();
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            const toast = new bootstrap.Toast(document.getElementById('errorToast'));
            toast.show();
        }

        function showAchievement(message) {
            document.getElementById('achievementMessage').textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('achievementModal'));
            modal.show();

            // Trigger confetti
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
        }

        // Real-time Updates
        function startRealTimeUpdates() {
            // Update daily quote
            updateDailyQuote();

            // Refresh dashboard data every 5 minutes
            setInterval(async () => {
                if (document.querySelector('[data-page="dashboard"].active')) {
                    await loadPage('dashboard');
                }
            }, 300000); // 5 minutes
        }

        function updateDailyQuote() {
            const quotes = [
                "The only way to learn a new programming language is by writing programs in it. - Dennis Ritchie",
                "Programs must be written for people to read, and only incidentally for machines to execute. - Harold Abelson",
                "Code is like humor. When you have to explain it, it's bad. - Cory House",
                "Programming isn't about what you know; it's about what you can figure out. - Chris Pine",
                "The best error message is the one that never shows up. - Thomas Fuchs"
            ];

            const today = new Date().getDate();
            const quote = quotes[today % quotes.length];

            setTimeout(() => {
                const quoteElement = document.getElementById('dailyQuote');
                if (quoteElement) {
                    quoteElement.textContent = quote;
                }
            }, 1000);
        }

        // Authentication Functions
        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            window.location.href = 'auth/login.html';
        }

        // Placeholder functions for other pages (will be implemented in their respective sections)
        async function loadRoadmap() { return '<div>Roadmap content will be loaded here</div>'; }
        async function loadCalendar() { return '<div>Calendar content will be loaded here</div>'; }
        async function loadProgress() { return '<div>Progress content will be loaded here</div>'; }
        async function loadNotes() { return '<div>Notes content will be loaded here</div>'; }
        async function loadPomodoro() { return '<div>Pomodoro content will be loaded here</div>'; }
        async function loadProfile() { return '<div>Profile content will be loaded here</div>'; }
        async function loadAnalytics() { return '<div>Analytics content will be loaded here</div>'; }

        function viewNote(noteId) { console.log('View note:', noteId); }
    </script>
</body>

</html>