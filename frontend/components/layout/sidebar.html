<aside class="app-sidebar bg-white border-end no-print">
    <div class="sidebar-content h-100 d-flex flex-column">
        <!-- Main Navigation -->
        <nav class="sidebar-nav flex-grow-1 py-3">
            <ul class="nav nav-pills flex-column">
                <!-- Dashboard -->
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard" data-page="dashboard">
                        <i class="bi bi-speedometer2"></i>
                        <span>Dashboard</span>
                    </a>
                </li>

                <!-- Learning Section -->
                <li class="nav-item mt-3">
                    <div class="px-3 py-2">
                        <small class="text-muted fw-medium text-uppercase">Learning</small>
                    </div>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/roadmap" data-page="roadmap">
                        <i class="bi bi-map"></i>
                        <span>Roadmap</span>
                        <span class="badge bg-primary ms-auto" id="roadmap-progress">0%</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/resources" data-page="resources">
                        <i class="bi bi-book"></i>
                        <span>Resources</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/notes" data-page="notes">
                        <i class="bi bi-journal-text"></i>
                        <span>Notes</span>
                        <span class="badge bg-secondary ms-auto" id="notes-count">0</span>
                    </a>
                </li>

                <!-- Study Tools -->
                <li class="nav-item mt-3">
                    <div class="px-3 py-2">
                        <small class="text-muted fw-medium text-uppercase">Study Tools</small>
                    </div>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/pomodoro" data-page="pomodoro">
                        <i class="bi bi-clock"></i>
                        <span>Pomodoro Timer</span>
                        <span class="badge bg-success ms-auto d-none" id="timer-status">Running</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/calendar" data-page="calendar">
                        <i class="bi bi-calendar3"></i>
                        <span>Calendar</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/ai-assistant" data-page="ai-assistant">
                        <i class="bi bi-robot"></i>
                        <span>AI Assistant</span>
                        <span class="badge bg-info ms-auto">Beta</span>
                    </a>
                </li>

                <!-- Analytics -->
                <li class="nav-item mt-3">
                    <div class="px-3 py-2">
                        <small class="text-muted fw-medium text-uppercase">Analytics</small>
                    </div>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/progress" data-page="progress">
                        <i class="bi bi-graph-up"></i>
                        <span>Progress</span>
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/analytics" data-page="analytics">
                        <i class="bi bi-bar-chart"></i>
                        <span>Analytics</span>
                    </a>
                </li>

                <!-- Quick Actions -->
                <li class="nav-item mt-3">
                    <div class="px-3 py-2">
                        <small class="text-muted fw-medium text-uppercase">Quick Actions</small>
                    </div>
                </li>

                <li class="nav-item">
                    <a class="nav-link" href="/search" data-page="search">
                        <i class="bi bi-search"></i>
                        <span>Search</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Quick Stats Card -->
        <div class="p-3 border-top">
            <div class="card bg-primary text-white">
                <div class="card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-grow-1">
                            <div class="streak-display">
                                <div class="d-flex align-items-center mb-1">
                                    <i class="bi bi-fire text-warning me-2"></i>
                                    <span class="fw-bold" id="sidebar-current-streak">0</span>
                                    <small class="ms-1">day streak</small>
                                </div>
                                <small class="opacity-75">Keep it up!</small>
                            </div>
                        </div>
                        <div class="text-end">
                            <div class="circular-progress" style="width: 40px; height: 40px;">
                                <svg width="40" height="40" class="circular-progress-svg">
                                    <circle cx="20" cy="20" r="15" fill="none" stroke="rgba(255,255,255,0.3)"
                                        stroke-width="3" />
                                    <circle cx="20" cy="20" r="15" fill="none" stroke="white" stroke-width="3"
                                        stroke-dasharray="94.25" stroke-dashoffset="94.25" id="sidebar-progress-circle"
                                        transform="rotate(-90 20 20)" />
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle">
                                    <small class="fw-bold" id="sidebar-progress-percent">0%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-3 border-top">
            <div class="d-flex align-items-center justify-content-between">
                <small class="text-muted">© 2024 DSA Path</small>
                <div class="d-flex gap-2">
                    <a href="/profile" class="btn btn-sm btn-ghost" title="Profile">
                        <i class="bi bi-person"></i>
                    </a>
                    <a href="/settings" class="btn btn-sm btn-ghost" title="Settings">
                        <i class="bi bi-gear"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</aside>

<script>
    // Sidebar-specific functionality
    document.addEventListener('DOMContentLoaded', function () {
        updateSidebarStats();

        // Listen for progress updates
        document.addEventListener(EVENT_TYPES.PROGRESS_UPDATED, updateSidebarStats);

        // Listen for timer updates
        document.addEventListener(EVENT_TYPES.TIMER_TICK, updateTimerStatus);
        document.addEventListener(EVENT_TYPES.TIMER_COMPLETE, updateTimerStatus);
    });

    async function updateSidebarStats() {
        try {
            if (!Auth.isAuthenticated) return;

            const [dashboard, progress, notes] = await Promise.all([
                API.dashboard.get().catch(() => ({ stats: {} })),
                API.progress.get().catch(() => ({ progress: {} })),
                API.notes.getAll({ limit: 1 }).catch(() => ({ pagination: { total: 0 } }))
            ]);

            // Update streak
            const currentStreak = dashboard.stats?.current_streak || 0;
            const streakEl = document.getElementById('sidebar-current-streak');
            if (streakEl) streakEl.textContent = currentStreak;

            // Update progress percentage
            const progressPercent = dashboard.stats?.completion_percentage || 0;
            const progressEl = document.getElementById('sidebar-progress-percent');
            const progressCircle = document.getElementById('sidebar-progress-circle');

            if (progressEl) progressEl.textContent = `${Math.round(progressPercent)}%`;
            if (progressCircle) {
                const circumference = 94.25; // 2 * π * 15
                const offset = circumference - (progressPercent / 100) * circumference;
                progressCircle.style.strokeDashoffset = offset;
            }

            // Update roadmap progress badge
            const roadmapProgressEl = document.getElementById('roadmap-progress');
            if (roadmapProgressEl) {
                roadmapProgressEl.textContent = `${Math.round(progressPercent)}%`;
            }

            // Update notes count
            const notesCountEl = document.getElementById('notes-count');
            if (notesCountEl) {
                notesCountEl.textContent = notes.pagination?.total || 0;
            }

        } catch (error) {
            console.error('Error updating sidebar stats:', error);
        }
    }

    function updateTimerStatus() {
        const timer = State.get('timer');
        const statusEl = document.getElementById('timer-status');

        if (!statusEl) return;

        if (timer.isRunning) {
            statusEl.textContent = 'Running';
            statusEl.className = 'badge bg-success ms-auto';
            statusEl.classList.remove('d-none');
        } else if (timer.timeLeft > 0) {
            statusEl.textContent = 'Paused';
            statusEl.className = 'badge bg-warning ms-auto';
            statusEl.classList.remove('d-none');
        } else {
            statusEl.classList.add('d-none');
        }
    }

    // Highlight active navigation item
    function updateActiveNavigation() {
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('.sidebar-nav .nav-link');

        navLinks.forEach(link => {
            link.classList.remove('active');

            const href = link.getAttribute('href');
            if (href === currentPath || (currentPath === '/' && href === '/dashboard')) {
                link.classList.add('active');
            }
        });
    }

    // Listen for route changes to update navigation
    document.addEventListener(EVENT_TYPES.ROUTE_CHANGED, updateActiveNavigation);

    // Initial navigation update
    updateActiveNavigation();
</script>