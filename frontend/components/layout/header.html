<header class="app-header d-flex align-items-center px-3 px-lg-4 border-bottom bg-white no-print">
    <div class="container-fluid">
        <div class="row align-items-center">
            <!-- Brand -->
            <div class="col-6 col-lg-3">
                <a href="/dashboard" class="header-brand text-decoration-none fw-bold fs-4 text-primary">
                    <i class="bi bi-code-square me-2"></i>
                    DSA Path
                </a>
            </div>

            <!-- Search (Desktop) -->
            <div class="col-lg-6 d-none d-lg-block">
                <div class="search-container position-relative mx-auto" style="max-width: 500px;">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" id="global-search" class="form-control border-start-0 ps-0"
                            placeholder="Search resources, notes, topics..." autocomplete="off">
                    </div>
                </div>
            </div>

            <!-- User Actions -->
            <div class="col-6 col-lg-3">
                <div class="d-flex align-items-center justify-content-end gap-2">
                    <!-- Mobile Search Toggle -->
                    <button type="button" class="btn btn-ghost btn-sm d-lg-none" data-bs-toggle="collapse"
                        data-bs-target="#mobile-search" aria-expanded="false">
                        <i class="bi bi-search"></i>
                    </button>

                    <!-- Notifications -->
                    <div class="dropdown" data-auth-required>
                        <button type="button" class="btn btn-ghost btn-sm position-relative" data-bs-toggle="dropdown"
                            aria-expanded="false">
                            <i class="bi bi-bell"></i>
                            <span
                                class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger d-none"
                                id="notification-badge">
                                <span class="visually-hidden">unread notifications</span>
                            </span>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end shadow-lg" style="width: 350px;">
                            <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom">
                                <h6 class="mb-0">Notifications</h6>
                                <button class="btn btn-sm btn-ghost" onclick="Notifications.clear()">
                                    <i class="bi bi-check-all"></i>
                                </button>
                            </div>
                            <div id="notification-list" class="overflow-auto" style="max-height: 300px;">
                                <div class="p-4 text-center text-muted">
                                    <i class="bi bi-bell fs-2 mb-2"></i>
                                    <p class="mb-0">No new notifications</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Theme Toggle -->
                    <button type="button" class="btn btn-ghost btn-sm" id="theme-toggle" data-theme-toggle
                        aria-label="Toggle theme">
                        <i class="bi bi-sun"></i>
                    </button>

                    <!-- User Profile Dropdown -->
                    <div class="dropdown" data-auth-required>
                        <button type="button" class="btn btn-ghost btn-sm d-flex align-items-center"
                            data-bs-toggle="dropdown" aria-expanded="false">
                            <img src="/assets/icons/default-avatar.png" alt="User Avatar" id="header-user-avatar"
                                class="rounded-circle me-2 d-none" width="28" height="28">
                            <div class="avatar-placeholder bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                style="width: 28px; height: 28px; font-size: 12px;">
                                <span id="header-user-initial">U</span>
                            </div>
                            <span class="d-none d-md-inline fw-medium" id="header-user-name">User</span>
                            <i class="bi bi-chevron-down ms-1"></i>
                        </button>
                        <div class="dropdown-menu dropdown-menu-end shadow-lg">
                            <div class="px-3 py-2 border-bottom">
                                <div class="fw-medium" data-user-name>User</div>
                                <small class="text-muted" data-user-email>user@example.com</small>
                                <div class="mt-1">
                                    <span class="badge bg-warning text-dark" id="header-streak">
                                        <i class="bi bi-fire me-1"></i>
                                        <span>0 day streak</span>
                                    </span>
                                </div>
                            </div>
                            <a class="dropdown-item" href="/profile">
                                <i class="bi bi-person me-2"></i>
                                Profile
                            </a>
                            <a class="dropdown-item" href="/settings">
                                <i class="bi bi-gear me-2"></i>
                                Settings
                            </a>
                            <a class="dropdown-item" href="/analytics">
                                <i class="bi bi-bar-chart me-2"></i>
                                Analytics
                            </a>
                            <div class="dropdown-divider"></div>
                            <button class="dropdown-item text-danger" id="logout-btn">
                                <i class="bi bi-box-arrow-right me-2"></i>
                                Logout
                            </button>
                        </div>
                    </div>

                    <!-- Mobile Menu Toggle -->
                    <button type="button" class="btn btn-ghost btn-sm d-lg-none" id="hamburger-menu">
                        <i class="bi bi-list"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile Search Collapse -->
        <div class="collapse mt-3 d-lg-none" id="mobile-search">
            <div class="input-group">
                <span class="input-group-text">
                    <i class="bi bi-search text-muted"></i>
                </span>
                <input type="text" class="form-control" placeholder="Search resources, notes, topics..."
                    autocomplete="off">
            </div>
        </div>
    </div>
</header>

<script>
    // Header-specific functionality
    document.addEventListener('DOMContentLoaded', function () {
        // Update user initial
        const userNameEl = document.getElementById('header-user-name');
        const userInitialEl = document.getElementById('header-user-initial');

        if (userNameEl && userInitialEl) {
            const observer = new MutationObserver(() => {
                const name = userNameEl.textContent;
                if (name && name !== 'User') {
                    userInitialEl.textContent = name.charAt(0).toUpperCase();
                }
            });

            observer.observe(userNameEl, { childList: true, characterData: true });
        }

        // Load notifications
        loadNotifications();

        // Setup notification polling
        setInterval(loadNotifications, 60000); // Every minute
    });

    async function loadNotifications() {
        if (!Auth.isAuthenticated) return;

        try {
            const response = await API.notifications.getAll({ limit: 10 });
            const notifications = response.notifications;

            updateNotificationBadge(notifications);
            updateNotificationList(notifications);
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    function updateNotificationBadge(notifications) {
        const badge = document.getElementById('notification-badge');
        const unreadCount = notifications.filter(n => !n.is_read).length;

        if (unreadCount > 0) {
            badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
            badge.classList.remove('d-none');
        } else {
            badge.classList.add('d-none');
        }
    }

    function updateNotificationList(notifications) {
        const listContainer = document.getElementById('notification-list');

        if (notifications.length === 0) {
            listContainer.innerHTML = `
            <div class="p-4 text-center text-muted">
                <i class="bi bi-bell fs-2 mb-2"></i>
                <p class="mb-0">No new notifications</p>
            </div>
        `;
            return;
        }

        listContainer.innerHTML = notifications.map(notification => `
        <div class="dropdown-item ${notification.is_read ? '' : 'bg-light'}" 
             data-notification-id="${notification.id}">
            <div class="d-flex">
                <div class="flex-grow-1">
                    <div class="fw-medium mb-1">${notification.title}</div>
                    <p class="mb-1 text-muted small">${notification.message}</p>
                    <small class="text-muted">${Utils.getRelativeTime(notification.created_at)}</small>
                </div>
                ${!notification.is_read ? `
                    <button class="btn btn-sm btn-ghost" 
                            onclick="markNotificationRead('${notification.id}')"
                            title="Mark as read">
                        <i class="bi bi-check"></i>
                    </button>
                ` : ''}
            </div>
        </div>
    `).join('');
    }

    async function markNotificationRead(notificationId) {
        try {
            await API.notifications.markRead(notificationId);
            loadNotifications(); // Refresh list
        } catch (error) {
            console.error('Error marking notification as read:', error);
        }
    }
</script>