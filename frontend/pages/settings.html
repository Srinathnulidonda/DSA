<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Settings - DSAPath</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
</head>

<body data-requires-auth="true">
    <div class="app-layout">
        <div id="topbar"></div>
        <div id="sidebar"></div>

        <div class="app-content">
            <main class="app-main">
                <div class="page-header mb-4">
                    <h1 class="page-title">Settings</h1>
                    <p class="page-subtitle">Customize your learning experience</p>
                </div>

                <div class="settings-layout">
                    <!-- Settings Navigation -->
                    <div class="settings-nav">
                        <div class="list-group">
                            <a href="#appearance" class="list-group-item list-group-item-action active">
                                <i class="bi bi-palette me-2"></i> Appearance
                            </a>
                            <a href="#notifications" class="list-group-item list-group-item-action">
                                <i class="bi bi-bell me-2"></i> Notifications
                            </a>
                            <a href="#privacy" class="list-group-item list-group-item-action">
                                <i class="bi bi-shield-check me-2"></i> Privacy
                            </a>
                            <a href="#data" class="list-group-item list-group-item-action">
                                <i class="bi bi-database me-2"></i> Data & Storage
                            </a>
                            <a href="#sessions" class="list-group-item list-group-item-action">
                                <i class="bi bi-laptop me-2"></i> Sessions
                            </a>
                        </div>
                    </div>

                    <!-- Settings Content -->
                    <div class="settings-content">
                        <!-- Appearance Settings -->
                        <div class="settings-section" id="appearance-section">
                            <h4 class="mb-4">Appearance</h4>

                            <div class="mb-4">
                                <label class="form-label">Theme</label>
                                <div class="theme-selector">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="theme" id="theme-light"
                                            value="light">
                                        <label class="form-check-label" for="theme-light">
                                            <div class="theme-preview theme-light-preview">
                                                <i class="bi bi-sun"></i>
                                                <span>Light</span>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="theme" id="theme-dark"
                                            value="dark">
                                        <label class="form-check-label" for="theme-dark">
                                            <div class="theme-preview theme-dark-preview">
                                                <i class="bi bi-moon"></i>
                                                <span>Dark</span>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="theme" id="theme-system"
                                            value="system">
                                        <label class="form-check-label" for="theme-system">
                                            <div class="theme-preview theme-system-preview">
                                                <i class="bi bi-laptop"></i>
                                                <span>System</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Layout</label>
                                <select class="form-select" id="layout-select">
                                    <option value="default">Default</option>
                                    <option value="compact">Compact</option>
                                    <option value="comfortable">Comfortable</option>
                                </select>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="accessibility-mode">
                                <label class="form-check-label" for="accessibility-mode">
                                    High Contrast Mode
                                </label>
                                <div class="form-text">Improve visibility with higher contrast colors</div>
                            </div>
                        </div>

                        <!-- Notifications Settings -->
                        <div class="settings-section d-none" id="notifications-section">
                            <h4 class="mb-4">Notifications</h4>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="notifications-enabled" checked>
                                <label class="form-check-label" for="notifications-enabled">
                                    Enable Notifications
                                </label>
                                <div class="form-text">Show in-app notifications</div>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                                <label class="form-check-label" for="email-notifications">
                                    Email Notifications
                                </label>
                                <div class="form-text">Receive important updates via email</div>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="desktop-notifications">
                                <label class="form-check-label" for="desktop-notifications">
                                    Desktop Notifications
                                </label>
                                <div class="form-text">Show browser notifications</div>
                            </div>

                            <h5 class="mt-4 mb-3">Notification Types</h5>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-achievements" checked>
                                <label class="form-check-label" for="notify-achievements">
                                    Achievement unlocked
                                </label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-reminders" checked>
                                <label class="form-check-label" for="notify-reminders">
                                    Study reminders
                                </label>
                            </div>

                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="notify-streak" checked>
                                <label class="form-check-label" for="notify-streak">
                                    Streak alerts
                                </label>
                            </div>
                        </div>

                        <!-- Privacy Settings -->
                        <div class="settings-section d-none" id="privacy-section">
                            <h4 class="mb-4">Privacy</h4>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="profile-public">
                                <label class="form-check-label" for="profile-public">
                                    Public Profile
                                </label>
                                <div class="form-text">Allow others to view your progress</div>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="share-progress">
                                <label class="form-check-label" for="share-progress">
                                    Share Progress
                                </label>
                                <div class="form-text">Show your progress on leaderboards</div>
                            </div>

                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="analytics-opt-out">
                                <label class="form-check-label" for="analytics-opt-out">
                                    Opt-out of Analytics
                                </label>
                                <div class="form-text">Disable anonymous usage analytics</div>
                            </div>
                        </div>

                        <!-- Data & Storage Settings -->
                        <div class="settings-section d-none" id="data-section">
                            <h4 class="mb-4">Data & Storage</h4>

                            <div class="storage-info mb-4">
                                <h5>Local Storage Usage</h5>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar" id="storage-bar" style="width: 0%">0%</div>
                                </div>
                                <small class="text-muted" id="storage-info">Calculating...</small>
                            </div>

                            <div class="mb-4">
                                <button class="btn btn-outline-secondary me-2" onclick="clearCache()">
                                    <i class="bi bi-trash me-2"></i>Clear Cache
                                </button>
                                <button class="btn btn-outline-secondary" onclick="clearDrafts()">
                                    <i class="bi bi-file-earmark-x me-2"></i>Clear Drafts
                                </button>
                            </div>

                            <h5 class="mb-3">Export Data</h5>
                            <div class="d-grid gap-2 d-md-block">
                                <button class="btn btn-primary" onclick="exportData('progress')">
                                    <i class="bi bi-download me-2"></i>Export Progress
                                </button>
                                <button class="btn btn-primary" onclick="exportData('notes')">
                                    <i class="bi bi-download me-2"></i>Export Notes
                                </button>
                                <button class="btn btn-primary" onclick="exportData('all')">
                                    <i class="bi bi-download me-2"></i>Export All Data
                                </button>
                            </div>
                        </div>

                        <!-- Sessions Settings -->
                        <div class="settings-section d-none" id="sessions-section">
                            <h4 class="mb-4">Active Sessions</h4>

                            <div id="sessions-list">
                                <div class="text-center py-3">
                                    <div class="spinner-border spinner-border-sm"></div>
                                </div>
                            </div>

                            <div class="mt-4">
                                <button class="btn btn-danger" onclick="revokeAllSessions()">
                                    <i class="bi bi-x-circle me-2"></i>Revoke All Other Sessions
                                </button>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="mt-4">
                            <button class="btn btn-primary" id="save-settings">
                                <i class="bi bi-save me-2"></i>Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="mobile-nav"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/theme.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/lib.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/loader.js"></script>

    <script>
        let currentPreferences = {};

        async function loadSettings() {
            try {
                const response = await api.get('/profile');
                currentPreferences = response.preferences;

                // Apply settings to UI
                applySettingsToUI();

                // Load additional data
                calculateStorageUsage();
                loadSessions();

            } catch (error) {
                notifications.error('Failed to load settings');
                console.error('Settings error:', error);
            }
        }

        function applySettingsToUI() {
            // Theme
            const currentTheme = themeManager.getTheme();
            document.querySelector(`input[name="theme"][value="${currentTheme}"]`).checked = true;

            // Layout
            document.getElementById('layout-select').value = currentPreferences.layout;

            // Accessibility
            document.getElementById('accessibility-mode').checked = currentPreferences.accessibility_mode;

            // Notifications
            document.getElementById('notifications-enabled').checked = currentPreferences.notifications_enabled;
            document.getElementById('email-notifications').checked = currentPreferences.email_notifications;

            // Request permission for desktop notifications
            if ('Notification' in window && Notification.permission === 'granted') {
                document.getElementById('desktop-notifications').checked = true;
            }
        }

        // Navigation
        document.querySelectorAll('.settings-nav a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();

                // Update active state
                document.querySelectorAll('.settings-nav a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                // Show corresponding section
                document.querySelectorAll('.settings-section').forEach(section => {
                    section.classList.add('d-none');
                });

                const targetId = link.getAttribute('href').substring(1) + '-section';
                document.getElementById(targetId).classList.remove('d-none');
            });
        });

        // Theme selector
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                themeManager.setTheme(e.target.value);
            });
        });

        // Desktop notifications
        document.getElementById('desktop-notifications').addEventListener('change', async (e) => {
            if (e.target.checked) {
                const permission = await notifications.requestPermission();
                if (!permission) {
                    e.target.checked = false;
                    notifications.warning('Desktop notifications permission denied');
                }
            }
        });

        // Save settings
        document.getElementById('save-settings').addEventListener('click', async () => {
            const settings = {
                theme: document.querySelector('input[name="theme"]:checked').value,
                layout: document.getElementById('layout-select').value,
                notifications_enabled: document.getElementById('notifications-enabled').checked,
                email_notifications: document.getElementById('email-notifications').checked,
                accessibility_mode: document.getElementById('accessibility-mode').checked
            };

            try {
                await api.put('/preferences', settings);
                notifications.success('Settings saved successfully');

                // Apply layout changes
                if (settings.layout !== currentPreferences.layout) {
                    document.body.className = `layout-${settings.layout}`;
                }

                currentPreferences = { ...currentPreferences, ...settings };

            } catch (error) {
                notifications.error('Failed to save settings');
            }
        });

        function calculateStorageUsage() {
            if ('navigator' in window && 'storage' in navigator && 'estimate' in navigator.storage) {
                navigator.storage.estimate().then(estimate => {
                    const used = estimate.usage || 0;
                    const quota = estimate.quota || 0;
                    const percentage = quota > 0 ? Math.round((used / quota) * 100) : 0;

                    document.getElementById('storage-bar').style.width = percentage + '%';
                    document.getElementById('storage-bar').textContent = percentage + '%';
                    document.getElementById('storage-info').textContent =
                        `Using ${formatBytes(used)} of ${formatBytes(quota)}`;
                });
            } else {
                document.getElementById('storage-info').textContent = 'Storage info not available';
            }
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function loadSessions() {
            try {
                const response = await api.get('/sessions');
                const container = document.getElementById('sessions-list');

                if (response.sessions.length === 0) {
                    container.innerHTML = '<p class="text-muted">No active sessions</p>';
                    return;
                }

                container.innerHTML = response.sessions.map(session => {
                    const isCurrentSession = session.is_current; // Backend should mark this

                    return `
                        <div class="session-item mb-3 p-3 border rounded">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">
                                        ${session.device_info || 'Unknown Device'}
                                        ${isCurrentSession ? '<span class="badge bg-primary ms-2">Current</span>' : ''}
                                    </h6>
                                    <small class="text-muted">
                                        IP: ${session.ip_address}<br>
                                        Login: ${new Date(session.login_time).toLocaleString()}<br>
                                        Last active: ${new Date(session.last_activity).toLocaleString()}
                                    </small>
                                </div>
                                ${!isCurrentSession ? `
                                    <button class="btn btn-sm btn-outline-danger" 
                                            onclick="revokeSession('${session.id}')">
                                        Revoke
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        async function revokeSession(sessionId) {
            if (!confirm('Revoke this session?')) return;

            try {
                await api.delete(`/sessions/${sessionId}`);
                notifications.success('Session revoked');
                loadSessions();
            } catch (error) {
                notifications.error('Failed to revoke session');
            }
        }

        async function revokeAllSessions() {
            if (!confirm('This will log you out from all other devices. Continue?')) return;

            try {
                const response = await api.get('/sessions');
                const otherSessions = response.sessions.filter(s => !s.is_current);

                for (const session of otherSessions) {
                    await api.delete(`/sessions/${session.id}`);
                }

                notifications.success('All other sessions revoked');
                loadSessions();

            } catch (error) {
                notifications.error('Failed to revoke sessions');
            }
        }

        function clearCache() {
            if (!confirm('Clear all cached data?')) return;

            cache.clear();
            notifications.success('Cache cleared');
            calculateStorageUsage();
        }

        function clearDrafts() {
            if (!confirm('Clear all unsaved drafts?')) return;

            drafts.clearOldDrafts();
            localStorage.removeItem('note_drafts');
            notifications.success('Drafts cleared');
            calculateStorageUsage();
        }

        async function exportData(type) {
            try {
                loader.showLoading();

                let data = {};
                const filename = `dsapath-${type}-${new Date().toISOString().split('T')[0]}.json`;

                if (type === 'progress' || type === 'all') {
                    const progress = await api.get('/progress');
                    const dashboard = await api.get('/dashboard');
                    data.progress = {
                        stats: dashboard.stats,
                        weekly: dashboard.weekly_progress,
                        detailed: progress.progress
                    };
                }

                if (type === 'notes' || type === 'all') {
                    const notes = await api.get('/notes?per_page=1000');
                    data.notes = notes.notes;
                }

                if (type === 'all') {
                    const profile = await api.get('/profile');
                    data.profile = profile.user;
                    data.preferences = profile.preferences;
                }

                // Download file
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                notifications.success(`${type} data exported successfully`);

            } catch (error) {
                notifications.error('Failed to export data');
            } finally {
                loader.hideLoading();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadSettings();
        });
    </script>

    <style>
        .theme-selector {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .theme-preview {
            padding: 2rem 1.5rem;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .theme-preview i {
            font-size: 2rem;
            display: block;
            margin-bottom: 0.5rem;
        }

        .form-check-input:checked~.form-check-label .theme-preview {
            border-color: var(--primary);
            background: rgba(59, 130, 246, 0.1);
        }

        .theme-light-preview {
            background: white;
            color: #333;
        }

        .theme-dark-preview {
            background: #1a1a1a;
            color: white;
        }

        .theme-system-preview {
            background: linear-gradient(to right, white 50%, #1a1a1a 50%);
            color: #333;
        }

        .storage-info {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: var(--radius-lg);
        }

        .session-item {
            background: var(--bg-secondary);
            transition: all var(--transition-base);
        }

        .session-item:hover {
            box-shadow: var(--shadow-sm);
        }

        @media (max-width: 768px) {
            .settings-layout {
                grid-template-columns: 1fr;
            }

            .settings-nav {
                margin-bottom: 1rem;
            }
        }
    </style>
</body>

</html>