<div class="page-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-1">
                <i class="bi bi-gear text-primary me-2"></i>
                Settings
            </h1>
            <p class="text-muted mb-0">Customize your learning experience</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Settings Navigation -->
        <div class="col-lg-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body p-2">
                    <nav class="nav nav-pills flex-column">
                        <a class="nav-link active" href="#general" data-bs-toggle="pill">
                            <i class="bi bi-gear me-2"></i>General
                        </a>
                        <a class="nav-link" href="#appearance" data-bs-toggle="pill">
                            <i class="bi bi-palette me-2"></i>Appearance
                        </a>
                        <a class="nav-link" href="#notifications" data-bs-toggle="pill">
                            <i class="bi bi-bell me-2"></i>Notifications
                        </a>
                        <a class="nav-link" href="#study" data-bs-toggle="pill">
                            <i class="bi bi-book me-2"></i>Study Preferences
                        </a>
                        <a class="nav-link" href="#privacy" data-bs-toggle="pill">
                            <i class="bi bi-shield me-2"></i>Privacy
                        </a>
                        <a class="nav-link" href="#data" data-bs-toggle="pill">
                            <i class="bi bi-database me-2"></i>Data & Storage
                        </a>
                    </nav>
                </div>
            </div>
        </div>

        <!-- Settings Content -->
        <div class="col-lg-9">
            <div class="tab-content">
                <!-- General Settings -->
                <div class="tab-pane fade show active" id="general">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="mb-0">General Settings</h5>
                        </div>
                        <div class="card-body">
                            <form id="general-settings-form">
                                <div class="mb-4">
                                    <label for="language" class="form-label">Language</label>
                                    <select class="form-select" id="language">
                                        <option value="en" selected>English</option>
                                        <option value="es">Spanish</option>
                                        <option value="fr">French</option>
                                        <option value="de">German</option>
                                        <option value="zh">Chinese</option>
                                        <option value="ja">Japanese</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="date-format" class="form-label">Date Format</label>
                                    <select class="form-select" id="date-format">
                                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="time-format" class="form-label">Time Format</label>
                                    <select class="form-select" id="time-format">
                                        <option value="12">12-hour (AM/PM)</option>
                                        <option value="24">24-hour</option>
                                    </select>
                                </div>

                                <div class="mb-4">
                                    <label for="week-start" class="form-label">Week Starts On</label>
                                    <select class="form-select" id="week-start">
                                        <option value="sunday">Sunday</option>
                                        <option value="monday">Monday</option>
                                    </select>
                                </div>

                                <button type="submit" class="btn btn-primary">Save Changes</button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Appearance Settings -->
                <div class="tab-pane fade" id="appearance">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="mb-0">Appearance</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="mb-3">Theme</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <div class="form-check card p-3">
                                            <input class="form-check-input" type="radio" name="theme" id="theme-light"
                                                value="light">
                                            <label class="form-check-label d-flex align-items-center" for="theme-light">
                                                <i class="bi bi-sun me-2 fs-4"></i>
                                                <div>
                                                    <div class="fw-medium">Light</div>
                                                    <small class="text-muted">Default light theme</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check card p-3">
                                            <input class="form-check-input" type="radio" name="theme" id="theme-dark"
                                                value="dark">
                                            <label class="form-check-label d-flex align-items-center" for="theme-dark">
                                                <i class="bi bi-moon me-2 fs-4"></i>
                                                <div>
                                                    <div class="fw-medium">Dark</div>
                                                    <small class="text-muted">Easy on the eyes</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="form-check card p-3">
                                            <input class="form-check-input" type="radio" name="theme" id="theme-auto"
                                                value="auto">
                                            <label class="form-check-label d-flex align-items-center" for="theme-auto">
                                                <i class="bi bi-circle-half me-2 fs-4"></i>
                                                <div>
                                                    <div class="fw-medium">Auto</div>
                                                    <small class="text-muted">Follow system</small>
                                                </div>
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Font Size</h6>
                                <input type="range" class="form-range" id="font-size" min="12" max="20" value="16"
                                    step="1">
                                <div class="d-flex justify-content-between">
                                    <small>Small</small>
                                    <small>Medium</small>
                                    <small>Large</small>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Layout Density</h6>
                                <select class="form-select" id="layout-density">
                                    <option value="comfortable">Comfortable</option>
                                    <option value="compact">Compact</option>
                                    <option value="spacious">Spacious</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="saveAppearanceSettings()">
                                Save Appearance Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="tab-pane fade" id="notifications">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="mb-0">Notification Preferences</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="enable-notifications" checked>
                                    <label class="form-check-label" for="enable-notifications">
                                        <div class="fw-medium">Enable Notifications</div>
                                        <small class="text-muted">Get notified about important events</small>
                                    </label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="email-notifications" checked>
                                    <label class="form-check-label" for="email-notifications">
                                        <div class="fw-medium">Email Notifications</div>
                                        <small class="text-muted">Receive updates via email</small>
                                    </label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="browser-notifications" checked>
                                    <label class="form-check-label" for="browser-notifications">
                                        <div class="fw-medium">Browser Notifications</div>
                                        <small class="text-muted">Show desktop notifications</small>
                                    </label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="sound-notifications" checked>
                                    <label class="form-check-label" for="sound-notifications">
                                        <div class="fw-medium">Sound Effects</div>
                                        <small class="text-muted">Play sounds for notifications</small>
                                    </label>
                                </div>
                            </div>

                            <hr>

                            <h6 class="mb-3">Notification Types</h6>
                            <div class="mb-4">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notify-achievements" checked>
                                    <label class="form-check-label" for="notify-achievements">
                                        Achievement unlocked
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notify-streaks" checked>
                                    <label class="form-check-label" for="notify-streaks">
                                        Streak milestones
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notify-reminders" checked>
                                    <label class="form-check-label" for="notify-reminders">
                                        Study reminders
                                    </label>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="notify-timer" checked>
                                    <label class="form-check-label" for="notify-timer">
                                        Timer completions
                                    </label>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="saveNotificationSettings()">
                                Save Notification Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Study Preferences -->
                <div class="tab-pane fade" id="study">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="mb-0">Study Preferences</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label for="daily-goal" class="form-label">Daily Study Goal (minutes)</label>
                                <input type="number" class="form-control" id="daily-goal" min="15" max="240" value="60">
                                <small class="text-muted">Set your daily study target</small>
                            </div>

                            <div class="mb-4">
                                <label for="reminder-time" class="form-label">Study Reminder Time</label>
                                <input type="time" class="form-control" id="reminder-time" value="19:00">
                                <small class="text-muted">Get daily reminders to study</small>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Pomodoro Timer Settings</h6>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <label for="pomodoro-length" class="form-label">Focus Time</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="pomodoro-length" value="25"
                                                min="15" max="60">
                                            <span class="input-group-text">min</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="short-break-length" class="form-label">Short Break</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="short-break-length" value="5"
                                                min="3" max="15">
                                            <span class="input-group-text">min</span>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="long-break-length" class="form-label">Long Break</label>
                                        <div class="input-group">
                                            <input type="number" class="form-control" id="long-break-length" value="15"
                                                min="10" max="30">
                                            <span class="input-group-text">min</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-save-notes" checked>
                                    <label class="form-check-label" for="auto-save-notes">
                                        <div class="fw-medium">Auto-save Notes</div>
                                        <small class="text-muted">Automatically save notes as you type</small>
                                    </label>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="saveStudySettings()">
                                Save Study Preferences
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Privacy Settings -->
                <div class="tab-pane fade" id="privacy">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="mb-0">Privacy Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="mb-3">Profile Visibility</h6>
                                <select class="form-select" id="profile-visibility">
                                    <option value="public">Public - Anyone can view</option>
                                    <option value="friends">Friends Only</option>
                                    <option value="private" selected>Private - Only you</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Data Sharing</h6>
                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="share-analytics">
                                    <label class="form-check-label" for="share-analytics">
                                        <div class="fw-medium">Share Analytics Data</div>
                                        <small class="text-muted">Help improve the platform with anonymous usage
                                            data</small>
                                    </label>
                                </div>

                                <div class="form-check form-switch mb-3">
                                    <input class="form-check-input" type="checkbox" id="share-progress">
                                    <label class="form-check-label" for="share-progress">
                                        <div class="fw-medium">Share Progress</div>
                                        <small class="text-muted">Show your learning progress on your profile</small>
                                    </label>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Active Sessions</h6>
                                <p class="text-muted">Manage devices where you're logged in</p>
                                <div id="active-sessions">
                                    <!-- Sessions will be loaded here -->
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="savePrivacySettings()">
                                Save Privacy Settings
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Data & Storage -->
                <div class="tab-pane fade" id="data">
                    <div class="card border-0 shadow-sm">
                        <div class="card-header bg-white border-bottom-0">
                            <h5 class="mb-0">Data & Storage</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h6 class="mb-3">Storage Usage</h6>
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between mb-1">
                                        <span>Local Storage</span>
                                        <span id="storage-used">0 KB</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" id="storage-bar" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Cache Management</h6>
                                <p class="text-muted">Clear cached data to free up space</p>
                                <button class="btn btn-outline-danger" onclick="clearCache()">
                                    <i class="bi bi-trash me-2"></i>Clear Cache
                                </button>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Data Export</h6>
                                <p class="text-muted">Download all your data</p>
                                <button class="btn btn-outline-primary" onclick="exportAllData()">
                                    <i class="bi bi-download me-2"></i>Export Data
                                </button>
                            </div>

                            <div class="mb-4">
                                <h6 class="mb-3">Offline Mode</h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enable-offline">
                                    <label class="form-check-label" for="enable-offline">
                                        <div class="fw-medium">Enable Offline Mode</div>
                                        <small class="text-muted">Save data for offline access</small>
                                    </label>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="saveDataSettings()">
                                Save Data Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let preferences = null;

    document.addEventListener('DOMContentLoaded', async function () {
        await loadSettings();
        setupSettingsHandlers();
        updateStorageUsage();
    });

    async function loadSettings() {
        try {
            // Load preferences from storage and API
            preferences = Storage.preferences.get();

            // Populate settings forms
            populateGeneralSettings();
            populateAppearanceSettings();
            populateNotificationSettings();
            populateStudySettings();
            populatePrivacySettings();
            populateDataSettings();

        } catch (error) {
            console.error('Error loading settings:', error);
            Notifications.error('Failed to load settings');
        }
    }

    function setupSettingsHandlers() {
        // General settings form
        document.getElementById('general-settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveGeneralSettings();
        });

        // Theme radio buttons
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', function () {
                if (this.checked) {
                    ThemeManager.setTheme(this.value);
                }
            });
        });

        // Font size slider
        const fontSizeSlider = document.getElementById('font-size');
        fontSizeSlider.addEventListener('input', function () {
            document.documentElement.style.fontSize = `${this.value}px`;
        });
    }

    function populateGeneralSettings() {
        document.getElementById('language').value = preferences.language || 'en';
        document.getElementById('date-format').value = preferences.dateFormat || 'MM/DD/YYYY';
        document.getElementById('time-format').value = preferences.timeFormat || '12';
        document.getElementById('week-start').value = preferences.weekStart || 'sunday';
    }

    function populateAppearanceSettings() {
        // Theme
        const currentTheme = ThemeManager.getCurrentTheme();
        document.querySelector(`input[name="theme"][value="${currentTheme}"]`).checked = true;

        // Font size
        const fontSize = preferences.fontSize || 16;
        document.getElementById('font-size').value = fontSize;

        // Layout density
        document.getElementById('layout-density').value = preferences.layoutDensity || 'comfortable';
    }

    function populateNotificationSettings() {
        document.getElementById('enable-notifications').checked = preferences.notifications !== false;
        document.getElementById('email-notifications').checked = preferences.emailNotifications !== false;
        document.getElementById('browser-notifications').checked = preferences.browserNotifications !== false;
        document.getElementById('sound-notifications').checked = preferences.sounds !== false;

        // Notification types
        document.getElementById('notify-achievements').checked = preferences.notifyAchievements !== false;
        document.getElementById('notify-streaks').checked = preferences.notifyStreaks !== false;
        document.getElementById('notify-reminders').checked = preferences.notifyReminders !== false;
        document.getElementById('notify-timer').checked = preferences.notifyTimer !== false;
    }

    function populateStudySettings() {
        document.getElementById('daily-goal').value = preferences.dailyGoal || 60;
        document.getElementById('reminder-time').value = preferences.reminderTime || '19:00';
        document.getElementById('pomodoro-length').value = preferences.pomodoroLength || 25;
        document.getElementById('short-break-length').value = preferences.shortBreakLength || 5;
        document.getElementById('long-break-length').value = preferences.longBreakLength || 15;
        document.getElementById('auto-save-notes').checked = preferences.autoSave !== false;
    }

    function populatePrivacySettings() {
        document.getElementById('profile-visibility').value = preferences.profileVisibility || 'private';
        document.getElementById('share-analytics').checked = preferences.shareAnalytics || false;
        document.getElementById('share-progress').checked = preferences.shareProgress || false;
    }

    function populateDataSettings() {
        document.getElementById('enable-offline').checked = preferences.enableOffline || false;
    }

    async function saveGeneralSettings() {
        try {
            const settings = {
                language: document.getElementById('language').value,
                dateFormat: document.getElementById('date-format').value,
                timeFormat: document.getElementById('time-format').value,
                weekStart: document.getElementById('week-start').value
            };

            await updatePreferences(settings);
            Notifications.success('General settings saved!');

        } catch (error) {
            console.error('Error saving general settings:', error);
            Notifications.error('Failed to save settings');
        }
    }

    async function saveAppearanceSettings() {
        try {
            const settings = {
                theme: document.querySelector('input[name="theme"]:checked').value,
                fontSize: parseInt(document.getElementById('font-size').value),
                layoutDensity: document.getElementById('layout-density').value
            };

            await updatePreferences(settings);
            Notifications.success('Appearance settings saved!');

        } catch (error) {
            console.error('Error saving appearance settings:', error);
            Notifications.error('Failed to save settings');
        }
    }

    async function saveNotificationSettings() {
        try {
            const settings = {
                notifications: document.getElementById('enable-notifications').checked,
                emailNotifications: document.getElementById('email-notifications').checked,
                browserNotifications: document.getElementById('browser-notifications').checked,
                sounds: document.getElementById('sound-notifications').checked,
                notifyAchievements: document.getElementById('notify-achievements').checked,
                notifyStreaks: document.getElementById('notify-streaks').checked,
                notifyReminders: document.getElementById('notify-reminders').checked,
                notifyTimer: document.getElementById('notify-timer').checked
            };

            await updatePreferences(settings);

            // Request browser notification permission if enabled
            if (settings.browserNotifications) {
                await Notifications.requestPermission();
            }

            Notifications.success('Notification settings saved!');

        } catch (error) {
            console.error('Error saving notification settings:', error);
            Notifications.error('Failed to save settings');
        }
    }

    async function saveStudySettings() {
        try {
            const settings = {
                dailyGoal: parseInt(document.getElementById('daily-goal').value),
                reminderTime: document.getElementById('reminder-time').value,
                pomodoroLength: parseInt(document.getElementById('pomodoro-length').value),
                shortBreakLength: parseInt(document.getElementById('short-break-length').value),
                longBreakLength: parseInt(document.getElementById('long-break-length').value),
                autoSave: document.getElementById('auto-save-notes').checked
            };

            await updatePreferences(settings);
            Notifications.success('Study preferences saved!');

        } catch (error) {
            console.error('Error saving study settings:', error);
            Notifications.error('Failed to save settings');
        }
    }

    async function savePrivacySettings() {
        try {
            const settings = {
                profileVisibility: document.getElementById('profile-visibility').value,
                shareAnalytics: document.getElementById('share-analytics').checked,
                shareProgress: document.getElementById('share-progress').checked
            };

            await updatePreferences(settings);
            Notifications.success('Privacy settings saved!');

        } catch (error) {
            console.error('Error saving privacy settings:', error);
            Notifications.error('Failed to save settings');
        }
    }

    async function saveDataSettings() {
        try {
            const settings = {
                enableOffline: document.getElementById('enable-offline').checked
            };

            await updatePreferences(settings);
            Notifications.success('Data settings saved!');

        } catch (error) {
            console.error('Error saving data settings:', error);
            Notifications.error('Failed to save settings');
        }
    }

    async function updatePreferences(newSettings) {
        // Update local preferences
        preferences = { ...preferences, ...newSettings };
        Storage.preferences.set(preferences);
        State.setPreferences(preferences);

        // Update backend if authenticated
        if (Auth.isAuthenticated) {
            try {
                await API.user.updatePreferences(preferences);
            } catch (error) {
                console.warn('Failed to sync preferences to backend:', error);
            }
        }
    }

    function updateStorageUsage() {
        const storageSize = Storage.getSize();
        const storageUsed = Utils.formatFileSize(storageSize);
        const maxStorage = 5 * 1024 * 1024; // 5MB
        const percentage = (storageSize / maxStorage) * 100;

        document.getElementById('storage-used').textContent = storageUsed;
        document.getElementById('storage-bar').style.width = `${percentage}%`;
    }

    async function clearCache() {
        const confirmed = await Components.modal.confirm(
            'Are you sure you want to clear all cached data? This will remove all offline data.',
            { title: 'Clear Cache', confirmText: 'Clear' }
        );

        if (confirmed) {
            Storage.clear();
            State.clearAllCache();
            updateStorageUsage();
            Notifications.success('Cache cleared successfully!');
        }
    }

    async function exportAllData() {
        try {
            // Show loading
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Preparing export...';

            // Gather all data
            const exportData = {
                preferences: preferences,
                notes: State.get('notes') || [],
                progress: State.get('progress') || {},
                export_date: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsa-path-full-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Notifications.success('Data exported successfully!');

        } catch (error) {
            console.error('Error exporting data:', error);
            Notifications.error('Failed to export data');
        } finally {
            // Reset button
            const btn = event.target;
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download me-2"></i>Export Data';
        }
    }
</script>