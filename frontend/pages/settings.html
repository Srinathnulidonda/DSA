<!-- pages/settings.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <div id="topbar-container"></div>

            <!-- Settings Content -->
            <div class="container-fluid mt-4">
                <h1 class="h3 mb-4">Settings</h1>

                <!-- Appearance Settings -->
                <div class="settings-section">
                    <h5 class="mb-3">
                        <i class="fas fa-palette me-2"></i>Appearance
                    </h5>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Theme</h6>
                            <p class="text-muted mb-0 small">Choose your preferred color theme</p>
                        </div>
                        <select class="form-select" style="width: 150px;" id="themeSelect">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                            <option value="auto">Auto</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Layout</h6>
                            <p class="text-muted mb-0 small">Choose your preferred layout style</p>
                        </div>
                        <select class="form-select" style="width: 150px;" id="layoutSelect">
                            <option value="default">Default</option>
                            <option value="compact">Compact</option>
                            <option value="comfortable">Comfortable</option>
                        </select>
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="settings-section">
                    <h5 class="mb-3">
                        <i class="fas fa-bell me-2"></i>Notifications
                    </h5>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Push Notifications</h6>
                            <p class="text-muted mb-0 small">Get notified about important updates</p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="pushNotifications" checked>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Email Notifications</h6>
                            <p class="text-muted mb-0 small">Receive study reminders and progress reports</p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Study Reminders</h6>
                            <p class="text-muted mb-0 small">Daily reminders to maintain your streak</p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="studyReminders" checked>
                        </div>
                    </div>
                </div>

                <!-- Accessibility Settings -->
                <div class="settings-section">
                    <h5 class="mb-3">
                        <i class="fas fa-universal-access me-2"></i>Accessibility
                    </h5>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">High Contrast Mode</h6>
                            <p class="text-muted mb-0 small">Increase contrast for better visibility</p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="highContrast">
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Reduce Motion</h6>
                            <p class="text-muted mb-0 small">Minimize animations and transitions</p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="reduceMotion">
                        </div>
                    </div>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Font Size</h6>
                            <p class="text-muted mb-0 small">Adjust text size for better readability</p>
                        </div>
                        <select class="form-select" style="width: 150px;" id="fontSizeSelect">
                            <option value="small">Small</option>
                            <option value="medium" selected>Medium</option>
                            <option value="large">Large</option>
                            <option value="extra-large">Extra Large</option>
                        </select>
                    </div>
                </div>

                <!-- Privacy Settings -->
                <div class="settings-section">
                    <h5 class="mb-3">
                        <i class="fas fa-shield-alt me-2"></i>Privacy
                    </h5>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Profile Visibility</h6>
                            <p class="text-muted mb-0 small">Control who can see your profile</p>
                        </div>
                        <select class="form-select" style="width: 150px;" id="profileVisibility">
                            <option value="public">Public</option>
                            <option value="friends">Friends Only</option>
                            <option value="private" selected>Private</option>
                        </select>
                    </div>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Activity Status</h6>
                            <p class="text-muted mb-0 small">Show when you're actively studying</p>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="activityStatus">
                        </div>
                    </div>
                </div>

                <!-- Data & Storage -->
                <div class="settings-section">
                    <h5 class="mb-3">
                        <i class="fas fa-database me-2"></i>Data & Storage
                    </h5>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Export Data</h6>
                            <p class="text-muted mb-0 small">Download all your learning data</p>
                        </div>
                        <button class="btn btn-outline-primary btn-sm" onclick="exportData()">
                            <i class="fas fa-download me-1"></i>Export
                        </button>
                    </div>
                    <div class="settings-item">
                        <div>
                            <h6 class="mb-1">Clear Cache</h6>
                            <p class="text-muted mb-0 small">Free up storage space</p>
                        </div>
                        <button class="btn btn-outline-warning btn-sm" onclick="clearCache()">
                            <i class="fas fa-broom me-1"></i>Clear
                        </button>
                    </div>
                    <div class="settings-item border-0">
                        <div>
                            <h6 class="mb-1 text-danger">Delete Account</h6>
                            <p class="text-muted mb-0 small">Permanently delete your account and data</p>
                        </div>
                        <button class="btn btn-outline-danger btn-sm" onclick="deleteAccount()">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                    </div>
                </div>

                <!-- Save Button -->
                <div class="mt-4">
                    <button class="btn btn-primary" onclick="saveSettings()">
                        <i class="fas fa-save me-2"></i>Save Changes
                    </button>
                    <button class="btn btn-outline-secondary ms-2" onclick="resetSettings()">
                        <i class="fas fa-undo me-2"></i>Reset to Default
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/animation.js"></script>

    <script>
        // Load components
        fetch('/components/sidebar.html').then(r => r.text()).then(html => {
            document.getElementById('sidebar-container').innerHTML = html;
            initSidebar();
        });

        fetch('/components/topbar.html').then(r => r.text()).then(html => {
            document.getElementById('topbar-container').innerHTML = html;
        });

        fetch('/components/mobile-nav.html').then(r => r.text()).then(html => {
            document.getElementById('mobile-nav-container').innerHTML = html;
            initMobileNav();
        });

        // Settings functionality
        let currentPreferences = {};

        async function loadSettings() {
            try {
                const data = await api.get('/profile');
                currentPreferences = data.preferences;

                // Apply settings to UI
                document.getElementById('themeSelect').value = currentPreferences.theme || 'light';
                document.getElementById('layoutSelect').value = currentPreferences.layout || 'default';
                document.getElementById('pushNotifications').checked = currentPreferences.notifications_enabled !== false;
                document.getElementById('emailNotifications').checked = currentPreferences.email_notifications !== false;
                document.getElementById('highContrast').checked = currentPreferences.accessibility_mode || false;

                // Apply theme
                applyTheme(currentPreferences.theme || 'light');

            } catch (error) {
                console.error('Failed to load settings:', error);
                showToast('Failed to load settings', 'danger');
            }
        }

        async function saveSettings() {
            const preferences = {
                theme: document.getElementById('themeSelect').value,
                layout: document.getElementById('layoutSelect').value,
                notifications_enabled: document.getElementById('pushNotifications').checked,
                email_notifications: document.getElementById('emailNotifications').checked,
                accessibility_mode: document.getElementById('highContrast').checked
            };

            try {
                await api.put('/preferences', preferences);
                currentPreferences = preferences;

                showToast('Settings saved successfully', 'success');

                // Apply theme immediately
                applyTheme(preferences.theme);

            } catch (error) {
                showToast('Failed to save settings', 'danger');
            }
        }

        function resetSettings() {
            if (!confirm('Are you sure you want to reset all settings to default?')) {
                return;
            }

            // Reset to defaults
            document.getElementById('themeSelect').value = 'light';
            document.getElementById('layoutSelect').value = 'default';
            document.getElementById('pushNotifications').checked = true;
            document.getElementById('emailNotifications').checked = true;
            document.getElementById('studyReminders').checked = true;
            document.getElementById('highContrast').checked = false;
            document.getElementById('reduceMotion').checked = false;
            document.getElementById('fontSizeSelect').value = 'medium';
            document.getElementById('profileVisibility').value = 'private';
            document.getElementById('activityStatus').checked = false;

            saveSettings();
        }

        function applyTheme(theme) {
            if (theme === 'dark' || (theme === 'auto' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.body.classList.add('dark-theme');
            } else {
                document.body.classList.remove('dark-theme');
            }
        }

        async function exportData() {
            showToast('Preparing your data export...', 'info');

            try {
                // In a real app, this would call an export endpoint
                const data = {
                    profile: await api.get('/profile'),
                    progress: await api.get('/progress'),
                    notes: await api.get('/notes?per_page=1000')
                };

                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dsa-learning-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Data exported successfully', 'success');
            } catch (error) {
                showToast('Failed to export data', 'danger');
            }
        }

        function clearCache() {
            if (!confirm('This will clear all cached data. Continue?')) {
                return;
            }

            // Clear local storage except auth tokens
            const authTokens = {
                access_token: localStorage.getItem('access_token'),
                refresh_token: localStorage.getItem('refresh_token'),
                user: localStorage.getItem('user')
            };

            localStorage.clear();

            // Restore auth tokens
            Object.entries(authTokens).forEach(([key, value]) => {
                if (value) localStorage.setItem(key, value);
            });

            showToast('Cache cleared successfully', 'success');
        }

        function deleteAccount() {
            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                return;
            }

            if (!confirm('This will permanently delete all your data. Are you absolutely sure?')) {
                return;
            }

            // In a real app, this would call a delete account endpoint
            showToast('Account deletion requires email confirmation', 'info');
        }

        // Theme change listener
        document.getElementById('themeSelect').addEventListener('change', function () {
            applyTheme(this.value);
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function () {
            loadSettings();
        });
    </script>
</body>

</html>