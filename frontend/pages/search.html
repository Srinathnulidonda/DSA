<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Search Results - DSAPath</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href "/css/animations.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/layouts.css">
</head>

<body data-requires-auth="true">
    <div class="app-layout">
        <div id="topbar"></div>
        <div id="sidebar"></div>

        <div class="app-content">
            <main class="app-main">
                <div class="page-header mb-4">
                    <h1 class="page-title">Search Results</h1>
                    <p class="page-subtitle" id="search-subtitle">Search across resources, notes, and roadmap</p>
                </div>

                <!-- Search Bar -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="search-form">
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="search" class="form-control" id="search-input"
                                    placeholder="Search for topics, resources, or notes..." autocomplete="off">
                                <button class="btn btn-primary" onclick="performSearch()">
                                    Search
                                </button>
                            </div>
                        </div>

                        <!-- Search Filters -->
                        <div class="search-filters mt-3">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="btn btn-sm btn-outline-secondary active" data-filter="all">
                                    All
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" data-filter="resources">
                                    <i class="bi bi-collection me-1"></i>Resources
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" data-filter="notes">
                                    <i class="bi bi-journal-text me-1"></i>Notes
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" data-filter="roadmap">
                                    <i class="bi bi-map me-1"></i>Roadmap
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Search Results -->
                <div id="search-results">
                    <!-- Initial state -->
                    <div class="empty-state text-center py-5" id="initial-state">
                        <i class="bi bi-search display-1 text-muted"></i>
                        <h5 class="mt-3">What would you like to learn about?</h5>
                        <p class="text-muted">Try searching for topics like "binary search", "linked lists", or "dynamic
                            programming"</p>
                        <div class="mt-4">
                            <h6 class="text-muted mb-3">Popular searches:</h6>
                            <div class="d-flex flex-wrap gap-2 justify-content-center">
                                <button class="btn btn-sm btn-outline-primary" onclick="searchFor('binary search')">
                                    Binary Search
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="searchFor('linked lists')">
                                    Linked Lists
                                </button>
                                <button class="btn btn-sm btn-outline-primary"
                                    onclick="searchFor('dynamic programming')">
                                    Dynamic Programming
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="searchFor('graph algorithms')">
                                    Graph Algorithms
                                </button>
                                <button class="btn btn-sm btn-outline-primary"
                                    onclick="searchFor('sorting algorithms')">
                                    Sorting
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Loading state -->
                    <div class="d-none" id="loading-state">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Searching...</span>
                            </div>
                            <p class="text-muted mt-3">Searching...</p>
                        </div>
                    </div>

                    <!-- Results container -->
                    <div class="d-none" id="results-container">
                        <!-- Results summary -->
                        <div class="results-summary mb-4">
                            <h5 id="results-count">0 results found</h5>
                            <p class="text-muted mb-0" id="results-query">for ""</p>
                        </div>

                        <!-- Resources Results -->
                        <div class="results-section mb-4" id="resources-section">
                            <h6 class="section-title">
                                <i class="bi bi-collection me-2"></i>
                                Resources (<span id="resources-count">0</span>)
                            </h6>
                            <div id="resources-results" class="search-results-grid">
                                <!-- Resources will be loaded here -->
                            </div>
                        </div>

                        <!-- Notes Results -->
                        <div class="results-section mb-4" id="notes-section">
                            <h6 class="section-title">
                                <i class="bi bi-journal-text me-2"></i>
                                Notes (<span id="notes-count">0</span>)
                            </h6>
                            <div id="notes-results">
                                <!-- Notes will be loaded here -->
                            </div>
                        </div>

                        <!-- Roadmap Results -->
                        <div class="results-section mb-4" id="roadmap-section">
                            <h6 class="section-title">
                                <i class="bi bi-map me-2"></i>
                                Roadmap (<span id="roadmap-count">0</span>)
                            </h6>
                            <div id="roadmap-results">
                                <!-- Roadmap will be loaded here -->
                            </div>
                        </div>

                        <!-- Pagination -->
                        <div id="search-pagination" class="mt-4"></div>
                    </div>

                    <!-- No results state -->
                    <div class="d-none" id="no-results-state">
                        <div class="empty-state text-center py-5">
                            <i class="bi bi-search display-1 text-muted"></i>
                            <h5 class="mt-3">No results found</h5>
                            <p class="text-muted">Try adjusting your search terms or browse our resources</p>
                            <div class="mt-4">
                                <a href="/pages/resources" class="btn btn-primary me-2">
                                    Browse Resources
                                </a>
                                <a href="/pages/roadmap" class="btn btn-outline-primary">
                                    View Roadmap
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>

        <div id="mobile-nav"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/theme.js"></script>
    <script src="/js/notifications.js"></script>
    <script src="/js/lib.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/loader.js"></script>

    <script>
        let searchResults = {};
        let currentPage = 1;
        let currentFilter = 'all';
        let currentQuery = '';

        // Initialize search from URL parameter
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const query = urlParams.get('q');

            if (query) {
                document.getElementById('search-input').value = query;
                searchFor(query);
            }

            setupEventListeners();
        });

        function setupEventListeners() {
            // Search input
            document.getElementById('search-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });

            // Filter buttons
            document.querySelectorAll('[data-filter]').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Update active filter
                    document.querySelectorAll('[data-filter]').forEach(b => {
                        b.classList.remove('active');
                    });
                    btn.classList.add('active');

                    currentFilter = btn.dataset.filter;
                    if (currentQuery) {
                        displayResults();
                    }
                });
            });
        }

        function searchFor(query) {
            document.getElementById('search-input').value = query;
            performSearch();
        }

        async function performSearch() {
            const query = document.getElementById('search-input').value.trim();

            if (!query) {
                showInitialState();
                return;
            }

            currentQuery = query;
            showLoadingState();

            try {
                const response = await api.get('/search', {
                    q: query,
                    page: currentPage,
                    per_page: 20,
                    type: currentFilter === 'all' ? '' : currentFilter
                });

                searchResults = response;
                displayResults();

                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('q', query);
                window.history.pushState({}, '', url);

            } catch (error) {
                notifications.error('Search failed. Please try again.');
                console.error('Search error:', error);
                showNoResults();
            }
        }

        function displayResults() {
            const hasResults = (
                (searchResults.resources && searchResults.resources.length > 0) ||
                (searchResults.notes && searchResults.notes.length > 0) ||
                (searchResults.roadmap && searchResults.roadmap.length > 0)
            );

            if (!hasResults) {
                showNoResults();
                return;
            }

            showResults();
            updateResultsSummary();
            renderResourcesResults();
            renderNotesResults();
            renderRoadmapResults();
        }

        function updateResultsSummary() {
            const totalResults =
                (searchResults.resources?.length || 0) +
                (searchResults.notes?.length || 0) +
                (searchResults.roadmap?.length || 0);

            document.getElementById('results-count').textContent = `${totalResults} results found`;
            document.getElementById('results-query').textContent = `for "${currentQuery}"`;

            // Update subtitle
            document.getElementById('search-subtitle').textContent = `Search results for "${currentQuery}"`;
        }

        function renderResourcesResults() {
            const container = document.getElementById('resources-results');
            const section = document.getElementById('resources-section');
            const count = document.getElementById('resources-count');

            if (!searchResults.resources || searchResults.resources.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = currentFilter === 'all' || currentFilter === 'resources' ? 'block' : 'none';
            count.textContent = searchResults.resources.length;

            container.innerHTML = searchResults.resources.map(resource => {
                const sourceInfo = getSourceInfo(resource.url);
                const icon = getResourceIcon(resource.type);

                return `
                    <a href="${resource.url}" 
                       target="_blank" 
                       class="search-result-item resource-result animate-fade-in"
                       onclick="trackResourceClick('${resource.id}')">
                        <div class="result-icon">
                            <i class="bi ${icon}"></i>
                        </div>
                        <div class="result-content">
                            <h6 class="result-title">${highlightQuery(resource.title, currentQuery)}</h6>
                            <p class="result-meta text-muted">
                                ${sourceInfo.name} • ${capitalizeFirst(resource.type)}
                                <span class="badge bg-secondary ms-2">${sourceInfo.badge}</span>
                            </p>
                        </div>
                        <div class="result-action">
                            <i class="bi bi-arrow-up-right"></i>
                        </div>
                    </a>
                `;
            }).join('');
        }

        function renderNotesResults() {
            const container = document.getElementById('notes-results');
            const section = document.getElementById('notes-section');
            const count = document.getElementById('notes-count');

            if (!searchResults.notes || searchResults.notes.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = currentFilter === 'all' || currentFilter === 'notes' ? 'block' : 'none';
            count.textContent = searchResults.notes.length;

            container.innerHTML = searchResults.notes.map(note => {
                const preview = note.content.substring(0, 150) + '...';
                const date = new Date(note.updated_at).toLocaleDateString();

                return `
                    <div class="search-result-item note-result animate-fade-in" 
                         onclick="openNote('${note.id}')">
                        <div class="result-icon">
                            <i class="bi bi-journal-text"></i>
                        </div>
                        <div class="result-content">
                            <h6 class="result-title">${highlightQuery(note.title, currentQuery)}</h6>
                            <p class="result-excerpt text-muted">${highlightQuery(preview, currentQuery)}</p>
                            <div class="result-meta">
                                <small class="text-muted">
                                    ${note.week ? `Week ${note.week} • ` : ''}${date}
                                </small>
                                ${note.tags.length > 0 ? `
                                    <div class="mt-1">
                                        ${note.tags.map(tag => `
                                            <span class="badge bg-secondary me-1">${tag}</span>
                                        `).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="result-action">
                            <i class="bi bi-arrow-right"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRoadmapResults() {
            const container = document.getElementById('roadmap-results');
            const section = document.getElementById('roadmap-section');
            const count = document.getElementById('roadmap-count');

            if (!searchResults.roadmap || searchResults.roadmap.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = currentFilter === 'all' || currentFilter === 'roadmap' ? 'block' : 'none';
            count.textContent = searchResults.roadmap.length;

            container.innerHTML = searchResults.roadmap.map(week => {
                return `
                    <div class="search-result-item roadmap-result animate-fade-in" 
                         onclick="openWeek(${week.week})">
                        <div class="result-icon">
                            <div class="week-number">${week.week}</div>
                        </div>
                        <div class="result-content">
                            <h6 class="result-title">${highlightQuery(week.title, currentQuery)}</h6>
                            <p class="result-excerpt text-muted">${highlightQuery(week.goal, currentQuery)}</p>
                            <div class="result-meta">
                                <small class="text-muted">
                                    Week ${week.week} • ${week.days.length} days
                                </small>
                            </div>
                        </div>
                        <div class="result-action">
                            <i class="bi bi-arrow-right"></i>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function highlightQuery(text, query) {
            if (!query) return text;

            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[```\```/g, '\\$&');
        }

        function getResourceIcon(type) {
            const icons = {
                'text': 'bi-file-text',
                'video': 'bi-play-circle',
                'interactive': 'bi-diagram-3',
                'practice': 'bi-code-square'
            };
            return icons[type] || 'bi-link-45deg';
        }

        function getSourceInfo(url) {
            if (url.includes('w3schools')) return { name: 'W3Schools', badge: 'W3' };
            if (url.includes('geeksforgeeks')) return { name: 'GeeksforGeeks', badge: 'GFG' };
            if (url.includes('leetcode')) return { name: 'LeetCode', badge: 'LC' };
            if (url.includes('youtube')) return { name: 'YouTube', badge: 'YT' };
            if (url.includes('visualgo')) return { name: 'VisuAlgo', badge: 'VA' };
            return { name: 'External', badge: 'EXT' };
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function trackResourceClick(resourceId) {
            // Track resource usage for analytics
            console.log('Resource clicked:', resourceId);
        }

        function openNote(noteId) {
            window.location.href = `/pages/notes?note=${noteId}`;
        }

        function openWeek(weekNumber) {
            window.location.href = `/pages/roadmap#week-${weekNumber}`;
        }

        function showInitialState() {
            hideAllStates();
            document.getElementById('initial-state').classList.remove('d-none');
        }

        function showLoadingState() {
            hideAllStates();
            document.getElementById('loading-state').classList.remove('d-none');
        }

        function showResults() {
            hideAllStates();
            document.getElementById('results-container').classList.remove('d-none');
        }

        function showNoResults() {
            hideAllStates();
            document.getElementById('no-results-state').classList.remove('d-none');
        }

        function hideAllStates() {
            document.getElementById('initial-state').classList.add('d-none');
            document.getElementById('loading-state').classList.add('d-none');
            document.getElementById('results-container').classList.add('d-none');
            document.getElementById('no-results-state').classList.add('d-none');
        }
    </script>

    <style>
        .search-form {
            position: relative;
        }

        .search-filters .btn {
            transition: all var(--transition-fast);
        }

        .search-filters .btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .search-results-grid {
            display: grid;
            gap: 1rem;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        }

        .search-result-item {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 1rem;
            text-decoration: none;
            color: inherit;
            display: flex;
            align-items: start;
            gap: 1rem;
            transition: all var(--transition-base);
            cursor: pointer;
        }

        .search-result-item:hover {
            text-decoration: none;
            color: inherit;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--primary);
        }

        .result-icon {
            width: 40px;
            height: 40px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 1.25rem;
            color: var(--primary);
        }

        .week-number {
            font-weight: bold;
            font-size: 1rem;
        }

        .result-content {
            flex: 1;
            min-width: 0;
        }

        .result-title {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .result-excerpt {
            font-size: 0.875rem;
            line-height: 1.4;
            margin-bottom: 0.5rem;
        }

        .result-meta {
            font-size: 0.75rem;
        }

        .result-action {
            flex-shrink: 0;
            color: var(--text-tertiary);
            font-size: 1.25rem;
        }

        .search-result-item:hover .result-action {
            color: var(--primary);
        }

        .results-section {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1.5rem;
        }

        .results-section:last-child {
            border-bottom: none;
        }

        .section-title {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .note-result,
        .roadmap-result {
            display: block;
            margin-bottom: 1rem;
        }

        mark {
            background: rgba(59, 130, 246, 0.2);
            color: var(--primary);
            padding: 0 0.125rem;
            border-radius: 2px;
        }

        .empty-state {
            padding: 3rem 1rem;
        }

        .empty-state .display-1 {
            font-size: 4rem;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .search-results-grid {
                grid-template-columns: 1fr;
            }

            .result-content {
                font-size: 0.875rem;
            }

            .result-icon {
                width: 32px;
                height: 32px;
                font-size: 1rem;
            }
        }
    </style>
</body>

</html>