<div class="page-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-bar-chart text-primary me-2"></i>
                        Learning Analytics
                    </h1>
                    <p class="text-muted mb-0">Deep insights into your learning journey</p>
                </div>
                <div class="mt-3 mt-lg-0 d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-calendar-range me-2"></i>This Month
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="changeTimeRange('week')">This Week</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeTimeRange('month')">This Month</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeTimeRange('quarter')">This Quarter</a>
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="changeTimeRange('year')">This Year</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="changeTimeRange('all')">All Time</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="bi bi-file-earmark-pdf me-2"></i>Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Study Sessions</h6>
                            <h3 class="mb-0" id="total-sessions">0</h3>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i>
                                <span id="sessions-change">+0%</span> vs last period
                            </small>
                        </div>
                        <div class="bg-primary bg-opacity-10 p-2 rounded">
                            <i class="bi bi-play-circle text-primary fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Total Time</h6>
                            <h3 class="mb-0" id="total-time">0h</h3>
                            <small class="text-success">
                                <i class="bi bi-arrow-up"></i>
                                <span id="time-change">+0%</span> vs last period
                            </small>
                        </div>
                        <div class="bg-success bg-opacity-10 p-2 rounded">
                            <i class="bi bi-clock text-success fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Avg Session</h6>
                            <h3 class="mb-0" id="avg-session">0m</h3>
                            <small class="text-warning">
                                <i class="bi bi-dash"></i>
                                <span id="avg-change">0%</span> vs last period
                            </small>
                        </div>
                        <div class="bg-warning bg-opacity-10 p-2 rounded">
                            <i class="bi bi-hourglass text-warning fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="text-muted mb-1">Focus Score</h6>
                            <h3 class="mb-0" id="focus-score">0%</h3>
                            <small class="text-info">
                                <i class="bi bi-arrow-up"></i>
                                <span id="focus-change">+0</span> points
                            </small>
                        </div>
                        <div class="bg-info bg-opacity-10 p-2 rounded">
                            <i class="bi bi-bullseye text-info fs-4"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="row g-4 mb-4">
        <!-- Study Time Trend -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Study Time Trend</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="time-view" id="view-daily" checked>
                        <label class="btn btn-outline-primary" for="view-daily">Daily</label>

                        <input type="radio" class="btn-check" name="time-view" id="view-weekly">
                        <label class="btn btn-outline-primary" for="view-weekly">Weekly</label>

                        <input type="radio" class="btn-check" name="time-view" id="view-monthly">
                        <label class="btn btn-outline-primary" for="view-monthly">Monthly</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="time-trend-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Topic Distribution -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">Topic Distribution</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 350px;">
                        <canvas id="topic-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="row g-4 mb-4">
        <!-- Streak Calendar -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">Study Streak Calendar</h5>
                    <small class="text-muted">Your consistency over the past 12 weeks</small>
                </div>
                <div class="card-body">
                    <div id="streak-calendar">
                        <!-- Calendar heatmap will be rendered here -->
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">Less</small>
                        <div class="d-flex gap-1">
                            <div class="streak-box bg-light" style="width: 15px; height: 15px;"></div>
                            <div class="streak-box bg-success bg-opacity-25" style="width: 15px; height: 15px;"></div>
                            <div class="streak-box bg-success bg-opacity-50" style="width: 15px; height: 15px;"></div>
                            <div class="streak-box bg-success bg-opacity-75" style="width: 15px; height: 15px;"></div>
                            <div class="streak-box bg-success" style="width: 15px; height: 15px;"></div>
                        </div>
                        <small class="text-muted">More</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Performance Metrics -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">Performance Metrics</h5>
                </div>
                <div class="card-body">
                    <div class="metric-item mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Completion Rate</span>
                            <span class="fw-bold" id="completion-metric">0%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" id="completion-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="metric-item mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Study Consistency</span>
                            <span class="fw-bold" id="consistency-metric">0%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" id="consistency-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="metric-item mb-4">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Goal Achievement</span>
                            <span class="fw-bold" id="goal-metric">0%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-warning" id="goal-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <div class="metric-item">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Efficiency Score</span>
                            <span class="fw-bold" id="efficiency-metric">0%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-info" id="efficiency-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Analysis -->
    <div class="row g-4">
        <!-- Weekly Patterns -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">Weekly Study Patterns</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="weekly-pattern-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Best Study Times -->
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">Best Study Times</h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="best-times-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let analyticsData = null;
    let currentTimeRange = 'month';
    let charts = {};

    document.addEventListener('DOMContentLoaded', async function () {
        await loadAnalyticsData();
        setupChartControls();
        renderAllCharts();
        renderStreakCalendar();
    });

    async function loadAnalyticsData() {
        try {
            // Show loading state
            showLoadingState();

            // Load analytics data from backend
            const [dashboard, pomodoroHistory] = await Promise.all([
                API.dashboard.get(),
                API.pomodoro.getHistory({ limit: 100 })
            ]);

            analyticsData = {
                dashboard,
                pomodoroHistory: pomodoroHistory.sessions
            };

            updateSummaryCards();
            updatePerformanceMetrics();

        } catch (error) {
            console.error('Error loading analytics:', error);
            Notifications.handleApiError(error, 'Loading analytics');
        }
    }

    function showLoadingState() {
        // Add loading spinners to charts
        document.querySelectorAll('.chart-container').forEach(container => {
            container.innerHTML = `
            <div class="d-flex justify-content