<!-- pages/analytics.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
</head>

<body class="app-layout">
    <!-- Sidebar -->
    <div id="sidebarContainer"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div id="topbarContainer"></div>

        <!-- Analytics Content -->
        <div class="content-area">
            <!-- Header -->
            <div class="page-header">
                <div class="row align-items-center mb-4">
                    <div class="col-lg-8">
                        <h1 class="page-title">
                            <i class="fas fa-chart-bar me-3"></i>
                            Learning Analytics
                        </h1>
                        <p class="page-subtitle">Detailed insights into your learning journey</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="analytics-controls">
                            <select class="form-select" id="timeRange" style="max-width: 200px;">
                                <option value="7">Last 7 days</option>
                                <option value="30" selected>Last 30 days</option>
                                <option value="90">Last 3 months</option>
                                <option value="365">Last year</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Row -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-primary">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="metric-content">
                            <h3 id="totalStudyTime">0h</h3>
                            <p>Total Study Time</p>
                            <small class="metric-change positive" id="studyTimeChange">+0%</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-success">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="metric-content">
                            <h3 id="completedTopics">0</h3>
                            <p>Topics Completed</p>
                            <small class="metric-change positive" id="topicsChange">+0%</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-warning">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="metric-content">
                            <h3 id="avgSessionTime">0m</h3>
                            <p>Avg Session Time</p>
                            <small class="metric-change neutral" id="sessionTimeChange">+0%</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-info">
                            <i class="fas fa-percentage"></i>
                        </div>
                        <div class="metric-content">
                            <h3 id="completionRate">0%</h3>
                            <p>Completion Rate</p>
                            <small class="metric-change positive" id="completionRateChange">+0%</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4 mb-4">
                <!-- Study Time Trend -->
                <div class="col-lg-8">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>
                                Study Time Trend
                            </h5>
                            <div class="chart-controls">
                                <button class="btn btn-sm btn-outline-primary active" data-period="daily">Daily</button>
                                <button class="btn btn-sm btn-outline-primary" data-period="weekly">Weekly</button>
                                <button class="btn btn-sm btn-outline-primary" data-period="monthly">Monthly</button>
                            </div>
                        </div>
                        <div class="chart-body">
                            <canvas id="studyTrendChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Performance Distribution -->
                <div class="col-lg-4">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-pie me-2"></i>
                                Performance Distribution
                            </h5>
                        </div>
                        <div class="chart-body">
                            <canvas id="performanceChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Analytics Row -->
            <div class="row g-4 mb-4">
                <!-- Productivity Heatmap -->
                <div class="col-lg-8">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calendar me-2"></i>
                                Productivity Heatmap
                            </h5>
                            <small class="text-muted">Study activity over the past weeks</small>
                        </div>
                        <div class="chart-body">
                            <div id="heatmapChart">
                                <!-- Heatmap will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Learning Path Progress -->
                <div class="col-lg-4">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="mb-0">
                                <i class="fas fa-route me-2"></i>
                                Learning Path Progress
                            </h5>
                        </div>
                        <div class="chart-body">
                            <div id="learningPathProgress">
                                <!-- Progress items will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Study Patterns Row -->
            <div class="row g-4 mb-4">
                <!-- Time of Day Analysis -->
                <div class="col-lg-6">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="mb-0">
                                <i class="fas fa-clock me-2"></i>
                                Study Time Patterns
                            </h5>
                        </div>
                        <div class="chart-body">
                            <canvas id="timePatternChart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Topic Difficulty Analysis -->
                <div class="col-lg-6">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="mb-0">
                                <i class="fas fa-brain me-2"></i>
                                Topic Difficulty Analysis
                            </h5>
                        </div>
                        <div class="chart-body">
                            <canvas id="difficultyChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Insights & Recommendations -->
            <div class="row g-4">
                <!-- AI Insights -->
                <div class="col-lg-8">
                    <div class="insights-card">
                        <div class="insights-header">
                            <h5 class="mb-0">
                                <i class="fas fa-lightbulb me-2"></i>
                                AI-Generated Insights
                            </h5>
                        </div>
                        <div class="insights-body">
                            <div id="aiInsights">
                                <!-- AI insights will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="col-lg-4">
                    <div class="stats-card">
                        <div class="stats-header">
                            <h5 class="mb-0">
                                <i class="fas fa-trophy me-2"></i>
                                Achievement Stats
                            </h5>
                        </div>
                        <div class="stats-body">
                            <div id="achievementStats">
                                <!-- Achievement stats will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let analyticsData = {};
        let charts = {};

        // Load components
        async function loadComponents() {
            try {
                const [sidebarResponse, topbarResponse, mobileNavResponse] = await Promise.all([
                    fetch('../components/sidebar.html'),
                    fetch('../components/topbar.html'),
                    fetch('../components/mobile-nav.html')
                ]);

                document.getElementById('sidebarContainer').innerHTML = await sidebarResponse.text();
                document.getElementById('topbarContainer').innerHTML = await topbarResponse.text();
                document.getElementById('mobileNavContainer').innerHTML = await mobileNavResponse.text();

                initializeComponents();
                setActiveNavItem('analytics');
                document.getElementById('pageTitle').textContent = 'Analytics';
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            try {
                const timeRange = document.getElementById('timeRange').value;
                const token = localStorage.getItem('access_token');

                // Load multiple endpoints for comprehensive analytics
                const [progressResponse, pomodoroResponse, dashboardResponse] = await Promise.all([
                    fetch(`${API_BASE}/progress`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/pomodoro/history?per_page=100`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/dashboard`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    })
                ]);

                if (progressResponse.ok && pomodoroResponse.ok && dashboardResponse.ok) {
                    const [progressData, pomodoroData, dashboardData] = await Promise.all([
                        progressResponse.json(),
                        pomodoroResponse.json(),
                        dashboardResponse.json()
                    ]);

                    analyticsData = {
                        progress: progressData,
                        pomodoro: pomodoroData,
                        dashboard: dashboardData,
                        timeRange: parseInt(timeRange)
                    };

                    updateMetrics();
                    renderCharts();
                    renderHeatmap();
                    renderLearningPath();
                    generateInsights();
                    updateAchievementStats();
                } else {
                    throw new Error('Failed to load analytics data');
                }
            } catch (error) {
                console.error('Analytics error:', error);
                showError('Failed to load analytics data');
            }
        }

        // Update key metrics
        function updateMetrics() {
            const { dashboard, pomodoro } = analyticsData;
            const sessions = pomodoro.sessions || [];
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - analyticsData.timeRange);

            // Filter sessions by time range
            const recentSessions = sessions.filter(session =>
                new Date(session.start_time) >= cutoffDate && session.completed
            );

            // Calculate metrics
            const totalStudyTime = recentSessions.reduce((sum, session) => sum + session.duration, 0);
            const completedTopics = Object.values(analyticsData.progress.progress || {}).reduce((sum, weekProgress) => {
                return sum + Object.values(weekProgress).filter(day => day.completed).length;
            }, 0);

            const avgSessionTime = recentSessions.length > 0 ?
                Math.round(totalStudyTime / recentSessions.length) : 0;

            const completionRate = dashboard.stats ?
                Math.round(dashboard.stats.completion_percentage) : 0;

            // Update UI
            document.getElementById('totalStudyTime').textContent = Math.round(totalStudyTime / 60) + 'h';
            document.getElementById('completedTopics').textContent = completedTopics;
            document.getElementById('avgSessionTime').textContent = avgSessionTime + 'm';
            document.getElementById('completionRate').textContent = completionRate + '%';

            // Calculate changes (mock data for demonstration)
            updateMetricChanges({
                studyTime: 12,
                topics: 8,
                sessionTime: -3,
                completion: 5
            });
        }

        // Update metric change indicators
        function updateMetricChanges(changes) {
            const elements = {
                studyTimeChange: changes.studyTime,
                topicsChange: changes.topics,
                sessionTimeChange: changes.sessionTime,
                completionRateChange: changes.completion
            };

            Object.entries(elements).forEach(([id, change]) => {
                const element = document.getElementById(id);
                const isPositive = change > 0;
                const isNegative = change < 0;

                element.textContent = `${change > 0 ? '+' : ''}${change}%`;
                element.className = `metric-change ${isPositive ? 'positive' : isNegative ? 'negative' : 'neutral'}`;
            });
        }

        // Render charts
        function renderCharts() {
            renderStudyTrendChart();
            renderPerformanceChart();
            renderTimePatternChart();
            renderDifficultyChart();
        }

        // Study trend chart
        function renderStudyTrendChart() {
            const ctx = document.getElementById('studyTrendChart').getContext('2d');
            const sessions = analyticsData.pomodoro.sessions || [];

            // Generate data for the last 30 days
            const days = 30;
            const labels = [];
            const data = [];

            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                const dayStart = new Date(date);
                dayStart.setHours(0, 0, 0, 0);
                const dayEnd = new Date(date);
                dayEnd.setHours(23, 59, 59, 999);

                const daySessions = sessions.filter(session => {
                    const sessionDate = new Date(session.start_time);
                    return sessionDate >= dayStart && sessionDate <= dayEnd && session.completed;
                });

                const dayTotal = daySessions.reduce((sum, session) => sum + session.duration, 0);
                data.push(dayTotal);
            }

            if (charts.studyTrend) {
                charts.studyTrend.destroy();
            }

            charts.studyTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: data,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value + 'min';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Performance distribution chart
        function renderPerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            const sessions = analyticsData.pomodoro.sessions || [];

            // Categorize sessions by duration
            const categories = {
                'Short (< 15min)': 0,
                'Medium (15-30min)': 0,
                'Long (30-45min)': 0,
                'Extended (45min+)': 0
            };

            sessions.forEach(session => {
                if (session.completed) {
                    if (session.duration < 15) categories['Short (< 15min)']++;
                    else if (session.duration <= 30) categories['Medium (15-30min)']++;
                    else if (session.duration <= 45) categories['Long (30-45min)']++;
                    else categories['Extended (45min+)']++;
                }
            });

            if (charts.performance) {
                charts.performance.destroy();
            }

            charts.performance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#FF6384',
                            '#36A2EB',
                            '#FFCE56',
                            '#4BC0C0'
                        ],
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Time pattern chart
        function renderTimePatternChart() {
            const ctx = document.getElementById('timePatternChart').getContext('2d');
            const sessions = analyticsData.pomodoro.sessions || [];

            // Group sessions by hour of day
            const hourlyData = Array(24).fill(0);

            sessions.forEach(session => {
                if (session.completed) {
                    const hour = new Date(session.start_time).getHours();
                    hourlyData[hour] += session.duration;
                }
            });

            const labels = hourlyData.map((_, index) => {
                return index < 12 ? `${index || 12}AM` : `${index - 12 || 12}PM`;
            });

            if (charts.timePattern) {
                charts.timePattern.destroy();
            }

            charts.timePattern = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: hourlyData,
                        backgroundColor: 'rgba(0, 123, 255, 0.7)',
                        borderColor: 'rgba(0, 123, 255, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // Difficulty analysis chart
        function renderDifficultyChart() {
            const ctx = document.getElementById('difficultyChart').getContext('2d');

            // Mock difficulty data based on week progress
            const difficultyData = {
                'Easy': 25,
                'Medium': 45,
                'Hard': 20,
                'Expert': 10
            };

            if (charts.difficulty) {
                charts.difficulty.destroy();
            }

            charts.difficulty = new Chart(ctx, {
                type: 'polarArea',
                data: {
                    labels: Object.keys(difficultyData),
                    datasets: [{
                        data: Object.values(difficultyData),
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.7)',
                            'rgba(255, 206, 86, 0.7)',
                            'rgba(255, 99, 132, 0.7)',
                            'rgba(153, 102, 255, 0.7)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(255, 99, 132, 1)',
                            'rgba(153, 102, 255, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Render productivity heatmap
        function renderHeatmap() {
            const container = document.getElementById('heatmapChart');
            const sessions = analyticsData.pomodoro.sessions || [];

            // Generate heatmap for last 12 weeks
            const weeks = 12;
            const today = new Date();
            const heatmapData = [];

            for (let week = weeks - 1; week >= 0; week--) {
                const weekStart = new Date(today);
                weekStart.setDate(today.getDate() - (week * 7) - today.getDay());

                const weekData = [];
                for (let day = 0; day < 7; day++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + day);

                    const dayStart = new Date(date);
                    dayStart.setHours(0, 0, 0, 0);
                    const dayEnd = new Date(date);
                    dayEnd.setHours(23, 59, 59, 999);

                    const daySessions = sessions.filter(session => {
                        const sessionDate = new Date(session.start_time);
                        return sessionDate >= dayStart && sessionDate <= dayEnd && session.completed;
                    });

                    const dayTotal = daySessions.reduce((sum, session) => sum + session.duration, 0);
                    weekData.push({
                        date: new Date(date),
                        value: dayTotal
                    });
                }
                heatmapData.push(weekData);
            }

            // Render heatmap HTML
            const maxValue = Math.max(...heatmapData.flat().map(d => d.value));
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

            container.innerHTML = `
                <div class="heatmap-container">
                    <div class="heatmap-labels">
                        ${dayNames.map(day => `<div class="day-label">${day}</div>`).join('')}
                    </div>
                    <div class="heatmap-grid">
                        ${heatmapData.map(week => `
                            <div class="heatmap-week">
                                ${week.map(day => {
                const intensity = maxValue > 0 ? (day.value / maxValue) : 0;
                const level = Math.floor(intensity * 4);
                return `
                                        <div class="heatmap-day level-${level}" 
                                             title="${day.date.toDateString()}: ${day.value} minutes">
                                        </div>
                                    `;
            }).join('')}
                            </div>
                        `).join('')}
                    </div>
                    <div class="heatmap-legend">
                        <span>Less</span>
                        <div class="legend-scale">
                            <div class="legend-item level-0"></div>
                            <div class="legend-item level-1"></div>
                            <div class="legend-item level-2"></div>
                            <div class="legend-item level-3"></div>
                            <div class="legend-item level-4"></div>
                        </div>
                        <span>More</span>
                    </div>
                </div>
            `;
        }

        // Render learning path progress
        function renderLearningPath() {
            const container = document.getElementById('learningPathProgress');
            const progress = analyticsData.progress.progress || {};

            // Calculate progress for each major topic area
            const topicAreas = [
                { name: 'Arrays & Strings', weeks: [1, 2], color: '#007bff' },
                { name: 'Linked Lists', weeks: [3], color: '#28a745' },
                { name: 'Stacks & Queues', weeks: [4], color: '#ffc107' },
                { name: 'Trees', weeks: [5, 6], color: '#17a2b8' },
                { name: 'Heaps', weeks: [7], color: '#6f42c1' },
                { name: 'Hashing', weeks: [8], color: '#fd7e14' },
                { name: 'Graphs', weeks: [9, 10], color: '#20c997' },
                { name: 'Algorithms', weeks: [11, 12], color: '#e83e8c' },
                { name: 'Advanced', weeks: [13, 14], color: '#6c757d' }
            ];

            container.innerHTML = topicAreas.map(topic => {
                let totalDays = 0;
                let completedDays = 0;

                topic.weeks.forEach(weekNum => {
                    const weekProgress = progress[weekNum] || {};
                    const weekCompleted = Object.values(weekProgress).filter(day => day.completed).length;
                    const weekTotal = 7; // Assuming 7 days per week

                    completedDays += weekCompleted;
                    totalDays += weekTotal;
                });

                const percentage = totalDays > 0 ? (completedDays / totalDays) * 100 : 0;

                return `
                    <div class="learning-path-item">
                        <div class="path-header">
                            <span class="path-color" style="background-color: ${topic.color}"></span>
                            <span class="path-name">${topic.name}</span>
                            <span class="path-percentage">${Math.round(percentage)}%</span>
                        </div>
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar" style="width: ${percentage}%; background-color: ${topic.color}"></div>
                        </div>
                        <small class="text-muted">${completedDays}/${totalDays} days completed</small>
                    </div>
                `;
            }).join('');
        }

        // Generate AI insights
        function generateInsights() {
            const container = document.getElementById('aiInsights');
            const sessions = analyticsData.pomodoro.sessions || [];
            const progress = analyticsData.progress.progress || {};

            // Generate insights based on data patterns
            const insights = [];

            // Study consistency insight
            const recentSessions = sessions.filter(session => {
                const sessionDate = new Date(session.start_time);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return sessionDate >= weekAgo && session.completed;
            });

            if (recentSessions.length >= 5) {
                insights.push({
                    type: 'positive',
                    title: 'Great Consistency!',
                    message: `You've completed ${recentSessions.length} study sessions this week. Keep up the excellent routine!`
                });
            } else if (recentSessions.length > 0) {
                insights.push({
                    type: 'suggestion',
                    title: 'Room for Improvement',
                    message: `You've studied ${recentSessions.length} times this week. Try to aim for daily sessions to build momentum.`
                });
            }

            // Best study time insight
            const hourlyTotals = Array(24).fill(0);
            sessions.forEach(session => {
                if (session.completed) {
                    const hour = new Date(session.start_time).getHours();
                    hourlyTotals[hour] += session.duration;
                }
            });

            const bestHour = hourlyTotals.indexOf(Math.max(...hourlyTotals));
            if (bestHour >= 0 && hourlyTotals[bestHour] > 0) {
                const timeString = bestHour < 12 ? `${bestHour || 12}AM` : `${bestHour - 12 || 12}PM`;
                insights.push({
                    type: 'info',
                    title: 'Peak Performance Time',
                    message: `Your most productive study time is around ${timeString}. Consider scheduling important topics during this time.`
                });
            }

            // Progress insight
            const totalCompleted = Object.values(progress).reduce((sum, weekProgress) => {
                return sum + Object.values(weekProgress).filter(day => day.completed).length;
            }, 0);

            if (totalCompleted >= 50) {
                insights.push({
                    type: 'achievement',
                    title: 'Halfway Milestone!',
                    message: `You've completed ${totalCompleted} topics! You're making excellent progress through the DSA curriculum.`
                });
            }

            // Render insights
            container.innerHTML = insights.map(insight => `
                <div class="insight-item ${insight.type}">
                    <div class="insight-icon">
                        <i class="fas ${getInsightIcon(insight.type)}"></i>
                    </div>
                    <div class="insight-content">
                        <h6 class="insight-title">${insight.title}</h6>
                        <p class="insight-message">${insight.message}</p>
                    </div>
                </div>
            `).join('');

            if (insights.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-lightbulb text-muted mb-3" style="font-size: 3rem;"></i>
                        <h6 class="text-muted">Start studying to get personalized insights!</h6>
                    </div>
                `;
            }
        }

        function getInsightIcon(type) {
            const icons = {
                positive: 'fa-thumbs-up',
                suggestion: 'fa-lightbulb',
                info: 'fa-info-circle',
                achievement: 'fa-trophy'
            };
            return icons[type] || 'fa-info-circle';
        }

        // Update achievement stats
        function updateAchievementStats() {
            const container = document.getElementById('achievementStats');
            const dashboard = analyticsData.dashboard;

            const stats = [
                {
                    icon: 'fa-fire',
                    label: 'Current Streak',
                    value: `${dashboard.stats?.current_streak || 0} days`
                },
                {
                    icon: 'fa-medal',
                    label: 'Longest Streak',
                    value: `${dashboard.stats?.longest_streak || 0} days`
                },
                {
                    icon: 'fa-clock',
                    label: 'Total Study Time',
                    value: `${Math.round((dashboard.stats?.total_study_time || 0) / 60)}h`
                },
                {
                    icon: 'fa-calendar-check',
                    label: 'Days Completed',
                    value: dashboard.stats?.completed_days || 0
                }
            ];

            container.innerHTML = stats.map(stat => `
                <div class="achievement-stat">
                    <div class="stat-icon">
                        <i class="fas ${stat.icon}"></i>
                    </div>
                    <div class="stat-content">
                        <div class="stat-value">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                </div>
            `).join('');
        }

        // Chart period controls
        function setupChartControls() {
            document.querySelectorAll('[data-period]').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('[data-period]').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');

                    // Re-render charts with new period
                    renderStudyTrendChart();
                });
            });
        }

        // Time range change handler
        document.getElementById('timeRange').addEventListener('change', loadAnalytics);

        // Initialize analytics page
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuth();
            await loadComponents();
            await loadAnalytics();
            setupChartControls();
        });
    </script>

    <style>
        .metric-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            color: white;
            font-size: 1.5rem;
        }

        .metric-content h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            color: var(--dark-color);
        }

        .metric-content p {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--secondary-color);
        }

        .metric-change {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .metric-change.positive {
            color: var(--success-color);
        }

        .metric-change.negative {
            color: var(--danger-color);
        }

        .metric-change.neutral {
            color: var(--secondary-color);
        }

        .chart-card,
        .insights-card,
        .stats-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .chart-header,
        .insights-header,
        .stats-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-body,
        .insights-body,
        .stats-body {
            padding: 1.5rem;
        }

        .chart-controls {
            display: flex;
            gap: 0.5rem;
        }

        .chart-controls .btn {
            padding: 0.25rem 0.75rem;
        }

        /* Heatmap Styles */
        .heatmap-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .heatmap-labels {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .day-label {
            width: 12px;
            font-size: 0.75rem;
            color: var(--secondary-color);
            text-align: center;
            margin-right: 2px;
        }

        .heatmap-grid {
            display: flex;
            gap: 2px;
        }

        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: #ebedf0;
            cursor: pointer;
        }

        .heatmap-day.level-1 {
            background: #c6e48b;
        }

        .heatmap-day.level-2 {
            background: #7bc96f;
        }

        .heatmap-day.level-3 {
            background: #239a3b;
        }

        .heatmap-day.level-4 {
            background: #196127;
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
            font-size: 0.8rem;
            color: var(--secondary-color);
        }

        .legend-scale {
            display: flex;
            gap: 2px;
        }

        .legend-item {
            width: 10px;
            height: 10px;
            border-radius: 2px;
            background: #ebedf0;
        }

        .legend-item.level-1 {
            background: #c6e48b;
        }

        .legend-item.level-2 {
            background: #7bc96f;
        }

        .legend-item.level-3 {
            background: #239a3b;
        }

        .legend-item.level-4 {
            background: #196127;
        }

        /* Learning Path Styles */
        .learning-path-item {
            margin-bottom: 1.5rem;
        }

        .learning-path-item:last-child {
            margin-bottom: 0;
        }

        .path-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .path-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            margin-right: 0.75rem;
        }

        .path-name {
            flex: 1;
            font-weight: 600;
        }

        .path-percentage {
            font-weight: 600;
            color: var(--primary-color);
        }

        /* Insight Styles */
        .insight-item {
            display: flex;
            align-items: flex-start;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-item.positive {
            background: #f0f9ff;
            border-color: var(--success-color);
        }

        .insight-item.suggestion {
            background: #fffbeb;
            border-color: var(--warning-color);
        }

        .insight-item.info {
            background: #f0f9ff;
            border-color: var(--info-color);
        }

        .insight-item.achievement {
            background: #fdf2f8;
            border-color: var(--warning-color);
        }

        .insight-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            flex-shrink: 0;
        }

        .insight-item.positive .insight-icon {
            background: var(--success-color);
            color: white;
        }

        .insight-item.suggestion .insight-icon {
            background: var(--warning-color);
            color: white;
        }

        .insight-item.info .insight-icon {
            background: var(--info-color);
            color: white;
        }

        .insight-item.achievement .insight-icon {
            background: var(--warning-color);
            color: white;
        }

        .insight-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .insight-message {
            margin-bottom: 0;
            color: var(--secondary-color);
        }

        /* Achievement Stats */
        .achievement-stat {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .achievement-stat:last-child {
            border-bottom: none;
        }

        .achievement-stat .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .achievement-stat .stat-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--dark-color);
        }

        .achievement-stat .stat-label {
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        @media (max-width: 991.98px) {
            .metric-card {
                flex-direction: column;
                text-align: center;
            }

            .metric-icon {
                margin-right: 0;
                margin-bottom: 1rem;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .chart-controls {
                align-self: stretch;
            }
        }

        @media (max-width: 767.98px) {
            .analytics-controls {
                margin-top: 1rem;
            }

            .heatmap-grid {
                transform: scale(0.8);
                transform-origin: left;
            }

            .page-header .col-lg-4 {
                text-align: left !important;
            }
        }
    </style>
</body>

</html>