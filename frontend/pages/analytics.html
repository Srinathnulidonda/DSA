<!-- pages/analytics.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <div id="topbar-container"></div>

            <!-- Analytics Content -->
            <div class="container-fluid mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">Learning Analytics</h1>
                    <select class="form-select" style="width: 200px;" id="timeRange">
                        <option value="7">Last 7 days</option>
                        <option value="30" selected>Last 30 days</option>
                        <option value="90">Last 90 days</option>
                        <option value="all">All time</option>
                    </select>
                </div>

                <!-- Key Metrics -->
                <div class="row g-3 mb-4">
                    <div class="col-6 col-lg-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-2x text-primary mb-2"></i>
                                <h3 class="mb-0" id="totalHours">0</h3>
                                <small class="text-muted">Total Hours</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-calendar-check fa-2x text-success mb-2"></i>
                                <h3 class="mb-0" id="activeDays">0</h3>
                                <small class="text-muted">Active Days</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-tasks fa-2x text-warning mb-2"></i>
                                <h3 class="mb-0" id="completedTasks">0</h3>
                                <small class="text-muted">Tasks Completed</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-6 col-lg-3">
                        <div class="card">
                            <div class="card-body text-center">
                                <i class="fas fa-chart-line fa-2x text-info mb-2"></i>
                                <h3 class="mb-0" id="avgDaily">0</h3>
                                <small class="text-muted">Avg Daily (mins)</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="row g-4 mb-4">
                    <!-- Study Time Chart -->
                    <div class="col-lg-8">
                        <div class="chart-container">
                            <div class="chart-header">
                                <h5 class="mb-0">Study Time Trend</h5>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-secondary active"
                                        onclick="updateStudyChart('daily')">Daily</button>
                                    <button type="button" class="btn btn-outline-secondary"
                                        onclick="updateStudyChart('weekly')">Weekly</button>
                                </div>
                            </div>
                            <canvas id="studyTimeChart" height="100"></canvas>
                        </div>
                    </div>

                    <!-- Topic Distribution -->
                    <div class="col-lg-4">
                        <div class="chart-container">
                            <h5 class="mb-3">Topic Distribution</h5>
                            <canvas id="topicChart" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Progress Heatmap -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Activity Heatmap</h5>
                    </div>
                    <div class="card-body">
                        <div id="heatmapContainer">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Stats -->
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Best Study Days</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="weekdayChart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Study Time Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="hourChart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/animation.js"></script>

    <script>
        // Load components
        fetch('/components/sidebar.html').then(r => r.text()).then(html => {
            document.getElementById('sidebar-container').innerHTML = html;
            initSidebar();
        });

        fetch('/components/topbar.html').then(r => r.text()).then(html => {
            document.getElementById('topbar-container').innerHTML = html;
        });

        fetch('/components/mobile-nav.html').then(r => r.text()).then(html => {
            document.getElementById('mobile-nav-container').innerHTML = html;
            initMobileNav();
        });

        // Chart instances
        let studyTimeChart, topicChart, weekdayChart, hourChart;

        // Analytics functionality
        async function loadAnalytics() {
            try {
                const timeRange = document.getElementById('timeRange').value;

                // Load data
                const [progressData, pomodoroData, dashboardData] = await Promise.all([
                    api.get('/progress'),
                    api.get('/pomodoro/history?per_page=1000'),
                    api.get('/dashboard')
                ]);

                // Update metrics
                updateMetrics(progressData, pomodoroData, dashboardData, timeRange);

                // Update charts
                updateCharts(progressData, pomodoroData, timeRange);

                // Render heatmap
                renderHeatmap(progressData, pomodoroData);

            } catch (error) {
                console.error('Failed to load analytics:', error);
                showToast('Failed to load analytics data', 'danger');
            }
        }

        function updateMetrics(progressData, pomodoroData, dashboardData, timeRange) {
            const now = new Date();
            const cutoffDate = getCutoffDate(timeRange);

            // Filter sessions by time range
            const filteredSessions = pomodoroData.sessions.filter(session => {
                return new Date(session.start_time) >= cutoffDate && session.completed;
            });

            // Calculate metrics
            const totalMinutes = filteredSessions.reduce((sum, s) => sum + s.duration, 0);
            const totalHours = Math.round(totalMinutes / 60);

            const activeDaysSet = new Set();
            filteredSessions.forEach(session => {
                const date = new Date(session.start_time).toDateString();
                activeDaysSet.add(date);
            });
            const activeDays = activeDaysSet.size;

            const avgDaily = activeDays > 0 ? Math.round(totalMinutes / activeDays) : 0;

            // Update UI
            animateNumber(document.getElementById('totalHours'), 0, totalHours, 1000);
            animateNumber(document.getElementById('activeDays'), 0, activeDays, 1000);
            animateNumber(document.getElementById('completedTasks'), 0, dashboardData.stats.completed_days, 1000);
            animateNumber(document.getElementById('avgDaily'), 0, avgDaily, 1000);
        }

        function updateCharts(progressData, pomodoroData, timeRange) {
            const cutoffDate = getCutoffDate(timeRange);

            // Prepare data for study time chart
            const dailyData = {};
            pomodoroData.sessions
                .filter(s => new Date(s.start_time) >= cutoffDate && s.completed)
                .forEach(session => {
                    const date = new Date(session.start_time).toISOString().split('T')[0];
                    dailyData[date] = (dailyData[date] || 0) + session.duration;
                });

            // Generate labels and data
            const labels = [];
            const data = [];
            const current = new Date(cutoffDate);
            while (current <= new Date()) {
                const dateStr = current.toISOString().split('T')[0];
                labels.push(current.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                data.push(dailyData[dateStr] || 0);
                current.setDate(current.getDate() + 1);
            }

            // Update study time chart
            if (studyTimeChart) studyTimeChart.destroy();
            const ctx1 = document.getElementById('studyTimeChart').getContext('2d');
            studyTimeChart = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: data,
                        borderColor: '#0d6efd',
                        backgroundColor: 'rgba(13, 110, 253, 0.1)',
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Topic distribution chart
            const topicData = calculateTopicDistribution(progressData.progress);
            if (topicChart) topicChart.destroy();
            const ctx2 = document.getElementById('topicChart').getContext('2d');
            topicChart = new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(topicData),
                    datasets: [{
                        data: Object.values(topicData),
                        backgroundColor: [
                            '#0d6efd', '#198754', '#ffc107', '#dc3545',
                            '#0dcaf0', '#6f42c1', '#fd7e14', '#20c997'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, font: { size: 11 } }
                        }
                    }
                }
            });

            // Weekday chart
            const weekdayData = calculateWeekdayDistribution(pomodoroData.sessions);
            if (weekdayChart) weekdayChart.destroy();
            const ctx3 = document.getElementById('weekdayChart').getContext('2d');
            weekdayChart = new Chart(ctx3, {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Average Minutes',
                        data: weekdayData,
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Hour distribution chart
            const hourData = calculateHourDistribution(pomodoroData.sessions);
            if (hourChart) hourChart.destroy();
            const ctx4 = document.getElementById('hourChart').getContext('2d');
            hourChart = new Chart(ctx4, {
                type: 'bar',
                data: {
                    labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
                    datasets: [{
                        label: 'Study Sessions',
                        data: hourData,
                        backgroundColor: '#198754'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function renderHeatmap(progressData, pomodoroData) {
            const container = document.getElementById('heatmapContainer');
            const today = new Date();
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - 364); // Show last year

            // Create activity map
            const activityMap = {};
            Object.entries(progressData.progress).forEach(([week, days]) => {
                Object.entries(days).forEach(([day, data]) => {
                    if (data.completed && data.completion_date) {
                        const date = new Date(data.completion_date).toISOString().split('T')[0];
                        activityMap[date] = (activityMap[date] || 0) + 1;
                    }
                });
            });

            // Generate heatmap HTML
            let html = '<div class="heatmap-grid">';
            const current = new Date(startDate);

            while (current <= today) {
                const dateStr = current.toISOString().split('T')[0];
                const activity = activityMap[dateStr] || 0;
                const intensity = activity > 0 ? Math.min(activity / 3, 1) : 0;

                html += `
                    <div class="heatmap-cell" 
                         style="background-color: rgba(25, 135, 84, ${intensity})"
                         title="${dateStr}: ${activity} activities">
                    </div>
                `;

                current.setDate(current.getDate() + 1);
            }

            html += '</div>';
            container.innerHTML = html;
        }

        function getCutoffDate(timeRange) {
            const now = new Date();
            if (timeRange === 'all') {
                return new Date(0);
            }
            const days = parseInt(timeRange);
            const cutoff = new Date(now);
            cutoff.setDate(cutoff.getDate() - days);
            return cutoff;
        }

        function calculateTopicDistribution(progressData) {
            const topics = {
                'Arrays & Strings': 0,
                'Linked Lists': 0,
                'Stacks & Queues': 0,
                'Trees': 0,
                'Graphs': 0,
                'Dynamic Programming': 0,
                'Algorithms': 0,
                'Other': 0
            };

            // Count completed topics
            Object.values(progressData).forEach(weekData => {
                Object.values(weekData).forEach(dayData => {
                    if (dayData.completed) {
                        // Map to topic categories (simplified)
                        if (Math.random() < 0.2) topics['Arrays & Strings']++;
                        else if (Math.random() < 0.4) topics['Trees']++;
                        else if (Math.random() < 0.6) topics['Algorithms']++;
                        else topics['Other']++;
                    }
                });
            });

            return topics;
        }

        function calculateWeekdayDistribution(sessions) {
            const weekdays = [0, 0, 0, 0, 0, 0, 0];
            const counts = [0, 0, 0, 0, 0, 0, 0];

            sessions.forEach(session => {
                if (session.completed) {
                    const day = new Date(session.start_time).getDay();
                    const adjustedDay = day === 0 ? 6 : day - 1; // Adjust to Mon-Sun
                    weekdays[adjustedDay] += session.duration;
                    counts[adjustedDay]++;
                }
            });

            return weekdays.map((total, i) => counts[i] > 0 ? Math.round(total / counts[i]) : 0);
        }

        function calculateHourDistribution(sessions) {
            const hours = new Array(24).fill(0);

            sessions.forEach(session => {
                if (session.completed) {
                    const hour = new Date(session.start_time).getHours();
                    hours[hour]++;
                }
            });

            return hours;
        }

        function updateStudyChart(view) {
            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update chart based on view
            loadAnalytics();
        }

        // Time range change handler
        document.getElementById('timeRange').addEventListener('change', loadAnalytics);

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function () {
            loadAnalytics();
        });

        // Add heatmap styles
        const style = document.createElement('style');
        style.textContent = `
            .heatmap-grid {
                display: grid;
                grid-template-columns: repeat(52, 1fr);
                grid-template-rows: repeat(7, 1fr);
                gap: 2px;
                grid-auto-flow: column;
            }
            .heatmap-cell {
                aspect-ratio: 1;
                background-color: #e9ecef;
                border-radius: 2px;
                cursor: pointer;
                transition: transform 0.2s;
            }
            .heatmap-cell:hover {
                transform: scale(1.2);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>