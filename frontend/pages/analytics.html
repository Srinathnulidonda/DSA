<!-- pages/analytics.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - DSA Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.min.js">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>

<body>
    <!-- Mobile Header -->
    <div class="mobile-header d-lg-none">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0 fw-bold">Analytics</h4>
                <small class="text-muted">Learning insights & trends</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="refreshAnalytics()">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown">
                        <i class="fas fa-filter"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="setDateRange('week')">This Week</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setDateRange('month')">This Month</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setDateRange('quarter')">This Quarter</a></li>
                        <li><a class="dropdown-item" href="#" onclick="setDateRange('year')">This Year</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" onclick="showCustomRange()">Custom Range</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <!-- Topbar -->
        <div id="topbarContainer"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-gradient-to-r from-cyan-500 to-blue-600 text-white animate-fade-in">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-lg-8">
                                    <h2 class="mb-2"><i class="fas fa-chart-bar me-2"></i>Learning Analytics</h2>
                                    <p class="mb-0 opacity-75">Track your progress, identify patterns, and optimize your
                                        learning</p>
                                </div>
                                <div class="col-lg-4 text-lg-end">
                                    <div
                                        class="d-flex justify-content-lg-end justify-content-center mt-3 mt-lg-0 gap-2">
                                        <button class="btn btn-light btn-sm" onclick="exportAnalytics()">
                                            <i class="fas fa-download me-1"></i>
                                            Export Report
                                        </button>
                                        <button class="btn btn-outline-light btn-sm" onclick="shareAnalytics()">
                                            <i class="fas fa-share me-1"></i>
                                            Share
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Range Selector -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center flex-wrap">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary"
                                        onclick="setDateRange('week')">Week</button>
                                    <button type="button" class="btn btn-outline-primary active"
                                        onclick="setDateRange('month')">Month</button>
                                    <button type="button" class="btn btn-outline-primary"
                                        onclick="setDateRange('quarter')">Quarter</button>
                                    <button type="button" class="btn btn-outline-primary"
                                        onclick="setDateRange('year')">Year</button>
                                    <button type="button" class="btn btn-outline-primary"
                                        onclick="setDateRange('all')">All Time</button>
                                </div>
                                <div class="d-flex align-items-center mt-2 mt-md-0">
                                    <span class="text-muted me-2">Showing:</span>
                                    <strong id="dateRangeDisplay">Last 30 days</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Overview -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="card stats-card bg-gradient-to-r from-blue-500 to-blue-600 text-white animate-slide-up">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-1" id="totalStudyHours">0h</h3>
                                    <p class="mb-0 opacity-75">Total Study Time</p>
                                </div>
                                <i class="fas fa-clock text-4xl opacity-50"></i>
                            </div>
                            <div class="mt-3">
                                <span class="badge bg-white text-primary" id="studyTrend">
                                    <i class="fas fa-arrow-up me-1"></i>+12%
                                </span>
                                <small class="ms-2">vs last period</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-3">
                    <div
                        class="card stats-card bg-gradient-to-r from-green-500 to-green-600 text-white animate-slide-up animation-delay-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-1" id="completionRate">0%</h3>
                                    <p class="mb-0 opacity-75">Completion Rate</p>
                                </div>
                                <i class="fas fa-check-circle text-4xl opacity-50"></i>
                            </div>
                            <div class="mt-3">
                                <span class="badge bg-white text-success" id="completionTrend">
                                    <i class="fas fa-arrow-up me-1"></i>+5%
                                </span>
                                <small class="ms-2">vs last period</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-3">
                    <div
                        class="card stats-card bg-gradient-to-r from-purple-500 to-purple-600 text-white animate-slide-up animation-delay-200">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-1" id="avgSessionTime">0m</h3>
                                    <p class="mb-0 opacity-75">Avg Session</p>
                                </div>
                                <i class="fas fa-stopwatch text-4xl opacity-50"></i>
                            </div>
                            <div class="mt-3">
                                <span class="badge bg-white text-purple-600" id="sessionTrend">
                                    <i class="fas fa-arrow-down me-1"></i>-3m
                                </span>
                                <small class="ms-2">vs last period</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-3">
                    <div
                        class="card stats-card bg-gradient-to-r from-orange-500 to-orange-600 text-white animate-slide-up animation-delay-300">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h3 class="mb-1" id="productivityScore">0</h3>
                                    <p class="mb-0 opacity-75">Productivity Score</p>
                                </div>
                                <i class="fas fa-chart-line text-4xl opacity-50"></i>
                            </div>
                            <div class="mt-3">
                                <span class="badge bg-white text-orange-600" id="productivityTrend">
                                    <i class="fas fa-arrow-up me-1"></i>+8
                                </span>
                                <small class="ms-2">vs last period</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="card animate-slide-up animation-delay-400">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Study Progress Timeline</h5>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary active"
                                    onclick="updateProgressChart('hours')">Hours</button>
                                <button type="button" class="btn btn-outline-primary"
                                    onclick="updateProgressChart('sessions')">Sessions</button>
                                <button type="button" class="btn btn-outline-primary"
                                    onclick="updateProgressChart('topics')">Topics</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <canvas id="progressTimelineChart" height="300"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4">
                    <div class="card animate-slide-up animation-delay-500">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Time Distribution</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="timeDistributionChart" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Study Patterns -->
            <div class="row mb-4">
                <div class="col-lg-6 mb-4">
                    <div class="card animate-slide-up animation-delay-600">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-calendar-check me-2"></i>Study Heatmap</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="studyHeatmap" height="250"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 mb-4">
                    <div class="card animate-slide-up animation-delay-700">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-brain me-2"></i>Peak Performance Times</h5>
                        </div>
                        <div class="card-body">
                            <canvas id="performanceTimesChart" height="250"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Stats -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-4">
                    <div class="card animate-slide-up animation-delay-800">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>Topic Mastery Progress</h5>
                        </div>
                        <div class="card-body">
                            <div id="topicMasteryContainer">
                                <!-- Topic progress bars will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4 mb-4">
                    <div class="card animate-slide-up animation-delay-900">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>Milestones & Streaks</h5>
                        </div>
                        <div class="card-body">
                            <div id="milestonesContainer">
                                <!-- Milestones will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Comparative Analysis -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card animate-slide-up animation-delay-1000">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-balance-scale me-2"></i>Comparative Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-lg-6">
                                    <h6 class="mb-3">Your Progress vs Average</h6>
                                    <canvas id="comparativeChart" height="200"></canvas>
                                </div>
                                <div class="col-lg-6">
                                    <h6 class="mb-3">Performance Insights</h6>
                                    <div id="performanceInsights">
                                        <!-- Insights will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recommendations -->
            <div class="row">
                <div class="col-12">
                    <div class="card animate-slide-up animation-delay-1100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Personalized Recommendations</h5>
                        </div>
                        <div class="card-body">
                            <div id="recommendationsContainer" class="row">
                                <!-- Recommendations will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <!-- Custom Date Range Modal -->
    <div class="modal fade" id="customRangeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Custom Date Range</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Start Date</label>
                            <input type="date" class="form-control" id="startDate">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">End Date</label>
                            <input type="date" class="form-control" id="endDate">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyCustomRange()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.0.1/dist/chart.min.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';

        // Global variables
        let currentUser = null;
        let analyticsData = null;
        let charts = {};
        let currentDateRange = 'month';
        let currentMetric = 'hours';

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadComponents();
            await loadAnalytics();
            setActivePage('analytics');
            initializeCharts();
        });

        // Authentication check
        async function checkAuth() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Authentication failed');
                }

                const data = await response.json();
                currentUser = data.user;
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = '/login';
            }
        }

        // Load reusable components
        async function loadComponents() {
            try {
                const sidebarResponse = await fetch('../components/sidebar.html');
                const sidebarHtml = await sidebarResponse.text();
                document.getElementById('sidebarContainer').innerHTML = sidebarHtml;

                if (window.innerWidth >= 992) {
                    const topbarResponse = await fetch('../components/topbar.html');
                    const topbarHtml = await topbarResponse.text();
                    document.getElementById('topbarContainer').innerHTML = topbarHtml;

                    setTimeout(() => {
                        const pageTitle = document.getElementById('pageTitle');
                        if (pageTitle) pageTitle.textContent = 'Analytics';
                    }, 100);
                }

                const mobileNavResponse = await fetch('../components/mobile-nav.html');
                const mobileNavHtml = await mobileNavResponse.text();
                document.getElementById('mobileNavContainer').innerHTML = mobileNavHtml;

            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Load analytics data
        async function loadAnalytics() {
            const token = localStorage.getItem('accessToken');

            try {
                // Load progress data
                const progressResponse = await fetch(`${API_BASE}/progress`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                // Load session history
                const sessionsResponse = await fetch(`${API_BASE}/pomodoro/history?per_page=100`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                let progressData = null;
                let sessionsData = null;

                if (progressResponse.ok) {
                    progressData = await progressResponse.json();
                }

                if (sessionsResponse.ok) {
                    sessionsData = await sessionsResponse.json();
                }

                // Generate analytics from data
                analyticsData = generateAnalytics(progressData, sessionsData);
                updateMetrics();
                updateCharts();
                updateTopicMastery();
                updateMilestones();
                updatePerformanceInsights();
                updateRecommendations();

            } catch (error) {
                console.error('Analytics error:', error);
                // Use demo data
                analyticsData = generateDemoAnalytics();
                updateMetrics();
                updateCharts();
                updateTopicMastery();
                updateMilestones();
                updatePerformanceInsights();
                updateRecommendations();
            }
        }

        // Generate analytics from data
        function generateAnalytics(progressData, sessionsData) {
            const analytics = {
                totalStudyHours: 0,
                completionRate: 0,
                avgSessionTime: 0,
                productivityScore: 0,
                dailyData: [],
                topicDistribution: {},
                performanceTimes: {},
                streaks: []
            };

            // Calculate from progress data
            if (progressData) {
                analytics.completionRate = progressData.stats.completion_percentage || 0;
                analytics.totalStudyHours = Math.round((progressData.stats.total_study_time || 0) / 60);

                // Calculate topic distribution
                const topics = ['Arrays', 'Linked Lists', 'Stacks', 'Trees', 'Graphs', 'DP', 'Sorting', 'Other'];
                topics.forEach(topic => {
                    analytics.topicDistribution[topic] = Math.floor(Math.random() * 20) + 5;
                });
            }

            // Calculate from sessions data
            if (sessionsData && sessionsData.sessions) {
                const sessions = sessionsData.sessions;

                // Average session time
                const completedSessions = sessions.filter(s => s.completed);
                if (completedSessions.length > 0) {
                    const totalTime = completedSessions.reduce((sum, s) => sum + s.duration, 0);
                    analytics.avgSessionTime = Math.round(totalTime / completedSessions.length);
                }

                // Performance times
                for (let hour = 0; hour < 24; hour++) {
                    analytics.performanceTimes[hour] = 0;
                }

                sessions.forEach(session => {
                    const hour = new Date(session.start_time).getHours();
                    analytics.performanceTimes[hour]++;
                });
            }

            // Calculate productivity score (0-100)
            analytics.productivityScore = Math.round(
                (analytics.completionRate * 0.4) +
                (Math.min(analytics.totalStudyHours / 100, 1) * 30) +
                (Math.min(analytics.avgSessionTime / 25, 1) * 30)
            );

            return analytics;
        }

        // Generate demo analytics
        function generateDemoAnalytics() {
            const analytics = {
                totalStudyHours: 127,
                completionRate: 68,
                avgSessionTime: 23,
                productivityScore: 75,
                dailyData: [],
                topicDistribution: {
                    'Arrays & Strings': 25,
                    'Linked Lists': 15,
                    'Stacks & Queues': 12,
                    'Trees': 20,
                    'Graphs': 10,
                    'Dynamic Programming': 8,
                    'Sorting & Searching': 7,
                    'Other': 3
                },
                performanceTimes: {},
                streaks: [
                    { days: 7, date: '2024-01-15' },
                    { days: 14, date: '2024-02-10' },
                    { days: 3, date: '2024-03-05' }
                ]
            };

            // Generate daily data for last 30 days
            for (let i = 29; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);

                analytics.dailyData.push({
                    date: date.toISOString().split('T')[0],
                    hours: Math.random() * 4 + 0.5,
                    sessions: Math.floor(Math.random() * 8) + 1,
                    topics: Math.floor(Math.random() * 3)
                });
            }

            // Generate performance times
            const peakHours = [9, 10, 14, 15, 16, 20, 21];
            for (let hour = 0; hour < 24; hour++) {
                analytics.performanceTimes[hour] = peakHours.includes(hour) ?
                    Math.floor(Math.random() * 20) + 10 :
                    Math.floor(Math.random() * 5);
            }

            return analytics;
        }

        // Update metrics display
        function updateMetrics() {
            if (!analyticsData) return;

            document.getElementById('totalStudyHours').textContent = `${analyticsData.totalStudyHours}h`;
            document.getElementById('completionRate').textContent = `${analyticsData.completionRate}%`;
            document.getElementById('avgSessionTime').textContent = `${analyticsData.avgSessionTime}m`;
            document.getElementById('productivityScore').textContent = analyticsData.productivityScore;

            // Update trends (demo)
            document.getElementById('studyTrend').innerHTML = '<i class="fas fa-arrow-up me-1"></i>+12%';
            document.getElementById('completionTrend').innerHTML = '<i class="fas fa-arrow-up me-1"></i>+5%';
            document.getElementById('sessionTrend').innerHTML = '<i class="fas fa-arrow-down me-1"></i>-3m';
            document.getElementById('productivityTrend').innerHTML = '<i class="fas fa-arrow-up me-1"></i>+8';
        }

        // Initialize charts
        function initializeCharts() {
            initializeProgressTimelineChart();
            initializeTimeDistributionChart();
            initializeStudyHeatmap();
            initializePerformanceTimesChart();
            initializeComparativeChart();
        }

        // Initialize progress timeline chart
        function initializeProgressTimelineChart() {
            const ctx = document.getElementById('progressTimelineChart').getContext('2d');

            const labels = analyticsData.dailyData.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en', { month: 'short', day: 'numeric' });
            });

            const data = analyticsData.dailyData.map(d => d.hours);

            charts.progressTimeline = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Hours',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Hours'
                            }
                        }
                    }
                }
            });
        }

        // Initialize time distribution chart
        function initializeTimeDistributionChart() {
            const ctx = document.getElementById('timeDistributionChart').getContext('2d');

            const labels = Object.keys(analyticsData.topicDistribution);
            const data = Object.values(analyticsData.topicDistribution);

            charts.timeDistribution = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444',
                            '#8b5cf6',
                            '#06b6d4',
                            '#84cc16',
                            '#f97316'
                        ],
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Initialize study heatmap
        function initializeStudyHeatmap() {
            const ctx = document.getElementById('studyHeatmap').getContext('2d');

            // Generate heatmap data
            const weeks = [];
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const data = [];

            for (let week = 0; week < 12; week++) {
                weeks.push(`Week ${week + 1}`);
                for (let day = 0; day < 7; day++) {
                    data.push({
                        x: week,
                        y: day,
                        v: Math.random() * 4
                    });
                }
            }

            charts.studyHeatmap = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Study Intensity',
                        data: data,
                        backgroundColor: function (context) {
                            const value = context.parsed.v;
                            const alpha = value / 4;
                            return `rgba(59, 130, 246, ${alpha})`;
                        },
                        pointRadius: 10,
                        pointHoverRadius: 12
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            position: 'bottom',
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    return weeks[value] || '';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Weeks'
                            }
                        },
                        y: {
                            type: 'linear',
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    return days[value] || '';
                                }
                            },
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                title: function (context) {
                                    const point = context[0];
                                    return `${weeks[point.parsed.x]}, ${days[point.parsed.y]}`;
                                },
                                label: function (context) {
                                    return `Study Hours: ${context.parsed.v.toFixed(1)}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Initialize performance times chart
        function initializePerformanceTimesChart() {
            const ctx = document.getElementById('performanceTimesChart').getContext('2d');

            const hours = [];
            const data = [];

            for (let hour = 0; hour < 24; hour++) {
                hours.push(`${hour}:00`);
                data.push(analyticsData.performanceTimes[hour] || 0);
            }

            charts.performanceTimes = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours,
                    datasets: [{
                        label: 'Sessions Started',
                        data: data,
                        backgroundColor: function (context) {
                            const value = context.parsed.y;
                            const max = Math.max(...data);
                            const intensity = value / max;
                            return intensity > 0.7 ? '#22c55e' : intensity > 0.4 ? '#f59e0b' : '#94a3b8';
                        }
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Sessions'
                            }
                        }
                    }
                }
            });
        }

        // Initialize comparative chart
        function initializeComparativeChart() {
            const ctx = document.getElementById('comparativeChart').getContext('2d');

            const metrics = ['Study Hours', 'Completion Rate', 'Consistency', 'Focus Score', 'Productivity'];
            const yourScores = [85, 68, 75, 82, 75];
            const avgScores = [70, 65, 60, 75, 68];

            charts.comparative = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: metrics,
                    datasets: [{
                        label: 'Your Performance',
                        data: yourScores,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        pointBackgroundColor: '#3b82f6'
                    }, {
                        label: 'Average User',
                        data: avgScores,
                        borderColor: '#94a3b8',
                        backgroundColor: 'rgba(148, 163, 184, 0.2)',
                        pointBackgroundColor: '#94a3b8'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    }
                }
            });
        }

        // Update topic mastery
        function updateTopicMastery() {
            const topics = [
                { name: 'Arrays & Strings', progress: 85, status: 'advanced' },
                { name: 'Linked Lists', progress: 72, status: 'intermediate' },
                { name: 'Stacks & Queues', progress: 65, status: 'intermediate' },
                { name: 'Trees & Graphs', progress: 45, status: 'learning' },
                { name: 'Dynamic Programming', progress: 30, status: 'beginner' },
                { name: 'Sorting & Searching', progress: 90, status: 'mastered' },
                { name: 'Recursion & Backtracking', progress: 55, status: 'learning' },
                { name: 'Bit Manipulation', progress: 25, status: 'beginner' }
            ];

            const container = document.getElementById('topicMasteryContainer');
            let html = '';

            topics.forEach(topic => {
                const statusColor = topic.status === 'mastered' ? 'success' :
                    topic.status === 'advanced' ? 'primary' :
                        topic.status === 'intermediate' ? 'warning' :
                            topic.status === 'learning' ? 'info' : 'secondary';

                html += `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-semibold">${topic.name}</span>
                            <span class="badge bg-${statusColor}">${topic.status}</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-${statusColor}" style="width: ${topic.progress}%"></div>
                        </div>
                        <small class="text-muted">${topic.progress}% Complete</small>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update milestones
        function updateMilestones() {
            const milestones = [
                {
                    icon: 'fa-fire',
                    title: 'Current Streak',
                    value: '7 days',
                    color: 'warning',
                    description: 'Keep it up!'
                },
                {
                    icon: 'fa-trophy',
                    title: 'Longest Streak',
                    value: '21 days',
                    color: 'success',
                    description: 'Achieved in February'
                },
                {
                    icon: 'fa-calendar-check',
                    title: 'Total Days',
                    value: '45 days',
                    color: 'primary',
                    description: 'Since you started'
                },
                {
                    icon: 'fa-star',
                    title: 'Perfect Weeks',
                    value: '3 weeks',
                    color: 'info',
                    description: '7/7 days completed'
                }
            ];

            const container = document.getElementById('milestonesContainer');
            let html = '';

            milestones.forEach(milestone => {
                html += `
                    <div class="d-flex align-items-center mb-3 p-3 border rounded">
                        <div class="flex-shrink-0">
                            <div class="bg-${milestone.color} bg-opacity-10 text-${milestone.color} rounded p-3">
                                <i class="fas ${milestone.icon} text-xl"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">${milestone.title}</h6>
                            <p class="mb-0 fw-bold">${milestone.value}</p>
                            <small class="text-muted">${milestone.description}</small>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update performance insights
        function updatePerformanceInsights() {
            const insights = [
                {
                    type: 'positive',
                    icon: 'fa-arrow-trend-up',
                    text: 'Your study consistency has improved by 25% this month'
                },
                {
                    type: 'positive',
                    icon: 'fa-clock',
                    text: 'Peak performance time: 2:00 PM - 4:00 PM'
                },
                {
                    type: 'neutral',
                    icon: 'fa-chart-line',
                    text: 'Average session duration is optimal at 23 minutes'
                },
                {
                    type: 'suggestion',
                    icon: 'fa-lightbulb',
                    text: 'Try studying Dynamic Programming during peak hours'
                },
                {
                    type: 'warning',
                    icon: 'fa-exclamation-triangle',
                    text: 'Tree algorithms need more practice time'
                }
            ];

            const container = document.getElementById('performanceInsights');
            let html = '';

            insights.forEach(insight => {
                const colorClass = insight.type === 'positive' ? 'success' :
                    insight.type === 'warning' ? 'warning' :
                        insight.type === 'suggestion' ? 'info' : 'secondary';

                html += `
                    <div class="alert alert-${colorClass} d-flex align-items-center" role="alert">
                        <i class="fas ${insight.icon} me-2"></i>
                        <div>${insight.text}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update recommendations
        function updateRecommendations() {
            const recommendations = [
                {
                    title: 'Focus on Trees',
                    description: 'Your tree algorithm skills need improvement. Practice BST operations.',
                    action: 'Start Practice',
                    link: '/roadmap?week=5',
                    icon: 'fa-tree',
                    color: 'primary'
                },
                {
                    title: 'Maintain Streak',
                    description: 'You\'re on a 7-day streak! Complete today\'s session to continue.',
                    action: 'Study Now',
                    link: '/pomodoro',
                    icon: 'fa-fire',
                    color: 'warning'
                },
                {
                    title: 'Review Arrays',
                    description: 'It\'s been 2 weeks since you practiced arrays. Time for a refresh.',
                    action: 'Review',
                    link: '/roadmap?week=2',
                    icon: 'fa-redo',
                    color: 'info'
                },
                {
                    title: 'Challenge Yourself',
                    description: 'You\'re ready for advanced dynamic programming problems.',
                    action: 'Take Challenge',
                    link: '/roadmap?week=13',
                    icon: 'fa-trophy',
                    color: 'success'
                }
            ];

            const container = document.getElementById('recommendationsContainer');
            let html = '';

            recommendations.forEach(rec => {
                html += `
                    <div class="col-lg-6 mb-3">
                        <div class="card h-100 border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="bg-${rec.color} bg-opacity-10 text-${rec.color} rounded p-2 me-3">
                                        <i class="fas ${rec.icon} text-xl"></i>
                                    </div>
                                    <h6 class="mb-0">${rec.title}</h6>
                                </div>
                                <p class="text-muted mb-3">${rec.description}</p>
                                <a href="${rec.link}" class="btn btn-${rec.color} btn-sm">
                                    ${rec.action} <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update charts based on metric
        function updateProgressChart(metric) {
            currentMetric = metric;

            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update chart data
            const chart = charts.progressTimeline;
            let data = [];
            let label = '';

            switch (metric) {
                case 'hours':
                    data = analyticsData.dailyData.map(d => d.hours);
                    label = 'Study Hours';
                    break;
                case 'sessions':
                    data = analyticsData.dailyData.map(d => d.sessions);
                    label = 'Sessions';
                    break;
                case 'topics':
                    data = analyticsData.dailyData.map(d => d.topics);
                    label = 'Topics Completed';
                    break;
            }

            chart.data.datasets[0].data = data;
            chart.data.datasets[0].label = label;
            chart.update();
        }

        // Set date range
        function setDateRange(range) {
            currentDateRange = range;

            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update display
            const displays = {
                'week': 'Last 7 days',
                'month': 'Last 30 days',
                'quarter': 'Last 3 months',
                'year': 'Last 12 months',
                'all': 'All time'
            };

            document.getElementById('dateRangeDisplay').textContent = displays[range];

            // Reload analytics with new range
            refreshAnalytics();
        }

        // Show custom range modal
        function showCustomRange() {
            new bootstrap.Modal(document.getElementById('customRangeModal')).show();
        }

        // Apply custom range
        function applyCustomRange() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                showToast('Please select both start and end dates', 'warning');
                return;
            }

            currentDateRange = 'custom';
            document.getElementById('dateRangeDisplay').textContent =
                `${new Date(startDate).toLocaleDateString()} - ${new Date(endDate).toLocaleDateString()}`;

            bootstrap.Modal.getInstance(document.getElementById('customRangeModal')).hide();
            refreshAnalytics();
        }

        // Refresh analytics
        async function refreshAnalytics() {
            showToast('Refreshing analytics...', 'info');
            await loadAnalytics();
            showToast('Analytics updated!', 'success');
        }

        // Export analytics
        function exportAnalytics() {
            const exportData = {
                user: currentUser.name,
                exportDate: new Date().toISOString(),
                dateRange: currentDateRange,
                metrics: {
                    totalStudyHours: analyticsData.totalStudyHours,
                    completionRate: analyticsData.completionRate,
                    avgSessionTime: analyticsData.avgSessionTime,
                    productivityScore: analyticsData.productivityScore
                },
                data: analyticsData
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsa-analytics-${currentUser.name}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Analytics report exported successfully!', 'success');
        }

        // Share analytics
        function shareAnalytics() {
            showToast('Share functionality coming soon!', 'info');
        }

        // Set active page in navigation
        function setActivePage(page) {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });

            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();

            const toast = `
                <div class="toast ${type}" role="alert" id="${toastId}">
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            toastContainer.innerHTML += toast;

            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement);
            bsToast.show();

            setTimeout(() => {
                toastElement.remove();
            }, 5000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
    </script>
</body>

</html>