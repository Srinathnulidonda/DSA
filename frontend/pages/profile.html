<div class="page-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 mb-1">
                <i class="bi bi-person-circle text-primary me-2"></i>
                Profile
            </h1>
            <p class="text-muted mb-0">Manage your account information and preferences</p>
        </div>
    </div>

    <div class="row g-4">
        <!-- Profile Card -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <!-- Avatar -->
                    <div class="position-relative d-inline-block mb-3">
                        <img src="/assets/icons/default-avatar.png" alt="Profile Avatar" id="profile-avatar"
                            class="rounded-circle border border-3 border-white shadow" width="120" height="120"
                            style="object-fit: cover;">
                        <button class="btn btn-sm btn-primary rounded-circle position-absolute bottom-0 end-0"
                            onclick="changeAvatar()" title="Change Avatar">
                            <i class="bi bi-camera"></i>
                        </button>
                    </div>

                    <!-- User Info -->
                    <h4 class="mb-1" id="profile-name">Loading...</h4>
                    <p class="text-muted mb-3" id="profile-email">loading@example.com</p>

                    <!-- Stats -->
                    <div class="row g-3 mb-3">
                        <div class="col-4">
                            <div class="border-end">
                                <h5 class="mb-0 text-warning" id="profile-streak">0</h5>
                                <small class="text-muted">Day Streak</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="border-end">
                                <h5 class="mb-0 text-primary" id="profile-completion">0%</h5>
                                <small class="text-muted">Complete</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div>
                                <h5 class="mb-0 text-success" id="profile-hours">0h</h5>
                                <small class="text-muted">Study Time</small>
                            </div>
                        </div>
                    </div>

                    <!-- Member Since -->
                    <div class="text-muted small">
                        <i class="bi bi-calendar me-1"></i>
                        Member since <span id="member-since">January 2024</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm text-start" onclick="exportData()">
                            <i class="bi bi-download me-2"></i>Export My Data
                        </button>
                        <button class="btn btn-outline-secondary btn-sm text-start" onclick="changePassword()">
                            <i class="bi bi-key me-2"></i>Change Password
                        </button>
                        <button class="btn btn-outline-danger btn-sm text-start" onclick="deleteAccount()">
                            <i class="bi bi-trash me-2"></i>Delete Account
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Form -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">Profile Information</h5>
                </div>
                <div class="card-body">
                    <form id="profile-form">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="profile-form-name" class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="profile-form-name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="profile-form-email" class="form-label">Email Address</label>
                                <input type="email" class="form-control" id="profile-form-email" required>
                            </div>
                            <div class="col-12">
                                <label for="profile-bio" class="form-label">Bio</label>
                                <textarea class="form-control" id="profile-bio" rows="3"
                                    placeholder="Tell us about yourself..."></textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="profile-location" class="form-label">Location</label>
                                <input type="text" class="form-control" id="profile-location"
                                    placeholder="City, Country">
                            </div>
                            <div class="col-md-6">
                                <label for="profile-timezone" class="form-label">Timezone</label>
                                <select class="form-select" id="profile-timezone">
                                    <option value="">Select Timezone</option>
                                    <option value="UTC">UTC</option>
                                    <option value="America/New_York">Eastern Time (US)</option>
                                    <option value="America/Chicago">Central Time (US)</option>
                                    <option value="America/Denver">Mountain Time (US)</option>
                                    <option value="America/Los_Angeles">Pacific Time (US)</option>
                                    <option value="Europe/London">London</option>
                                    <option value="Europe/Paris">Paris</option>
                                    <option value="Asia/Tokyo">Tokyo</option>
                                    <option value="Asia/Shanghai">Shanghai</option>
                                    <option value="Asia/Kolkata">India</option>
                                </select>
                            </div>
                        </div>

                        <hr class="my-4">

                        <h6 class="mb-3">Learning Preferences</h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="preferred-language" class="form-label">Preferred Programming
                                    Language</label>
                                <select class="form-select" id="preferred-language">
                                    <option value="">Select Language</option>
                                    <option value="python">Python</option>
                                    <option value="javascript">JavaScript</option>
                                    <option value="java">Java</option>
                                    <option value="cpp">C++</option>
                                    <option value="csharp">C#</option>
                                    <option value="go">Go</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="skill-level" class="form-label">Skill Level</label>
                                <select class="form-select" id="skill-level">
                                    <option value="">Select Level</option>
                                    <option value="beginner">Beginner</option>
                                    <option value="intermediate">Intermediate</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label for="learning-goals" class="form-label">Learning Goals</label>
                                <textarea class="form-control" id="learning-goals" rows="2"
                                    placeholder="What do you want to achieve?"></textarea>
                            </div>
                        </div>

                        <div class="mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg me-2"></i>Save Changes
                            </button>
                            <button type="button" class="btn btn-outline-secondary ms-2" onclick="cancelEdit()">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Activity History -->
            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Recent Activity</h5>
                    <a href="/analytics" class="btn btn-sm btn-outline-primary">
                        View All
                        <i class="bi bi-arrow-right ms-1"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div id="recent-activity">
                        <!-- Loading state -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Avatar Upload Modal -->
<div class="modal fade" id="avatarModal" tabindex="-1" aria-labelledby="avatarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="avatarModalLabel">Change Profile Picture</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <img src="/assets/icons/default-avatar.png" id="avatar-preview" class="rounded-circle border"
                        width="150" height="150" style="object-fit: cover;">
                </div>
                <div class="mb-3">
                    <label for="avatar-file" class="form-label">Choose new profile picture</label>
                    <input type="file" class="form-control" id="avatar-file" accept="image/*">
                    <small class="text-muted">Maximum file size: 5MB. Supported formats: JPEG, PNG, GIF, WebP</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="uploadAvatar()">
                    <i class="bi bi-upload me-1"></i>Upload
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="passwordModal" tabindex="-1" aria-labelledby="passwordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="passwordModalLabel">Change Password</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="password-form">
                    <div class="mb-3">
                        <label for="current-password" class="form-label">Current Password</label>
                        <input type="password" class="form-control" id="current-password" required>
                    </div>
                    <div class="mb-3">
                        <label for="new-password" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="new-password" required>
                        <div class="form-text">
                            <div id="password-strength" class="mt-2"></div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="confirm-password" class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" id="confirm-password" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitPasswordChange()">
                    <i class="bi bi-key me-1"></i>Change Password
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let profileData = null;
    let originalProfileData = null;

    document.addEventListener('DOMContentLoaded', async function () {
        await loadProfileData();
        setupProfileForm();
        loadRecentActivity();
    });

    async function loadProfileData() {
        try {
            const response = await API.user.getProfile();
            profileData = response.user;
            originalProfileData = { ...response.user };

            // Update UI with profile data
            updateProfileDisplay();
            populateProfileForm();

        } catch (error) {
            console.error('Error loading profile:', error);
            Notifications.handleApiError(error, 'Loading profile');
        }
    }

    function updateProfileDisplay() {
        // Avatar
        const avatar = document.getElementById('profile-avatar');
        if (profileData.avatar_url) {
            avatar.src = profileData.avatar_url;
        }

        // Basic info
        document.getElementById('profile-name').textContent = profileData.name;
        document.getElementById('profile-email').textContent = profileData.email;

        // Stats
        document.getElementById('profile-streak').textContent = profileData.current_streak || 0;
        document.getElementById('profile-completion').textContent = `${Math.round(profileData.completion_percentage || 0)}%`;
        document.getElementById('profile-hours').textContent = `${Math.round((profileData.total_study_time || 0) / 60)}h`;

        // Member since
        const memberSince = new Date(profileData.created_at);
        document.getElementById('member-since').textContent = memberSince.toLocaleDateString('en-US', {
            month: 'long',
            year: 'numeric'
        });
    }

    function populateProfileForm() {
        document.getElementById('profile-form-name').value = profileData.name || '';
        document.getElementById('profile-form-email').value = profileData.email || '';
        document.getElementById('profile-bio').value = profileData.bio || '';
        document.getElementById('profile-location').value = profileData.location || '';
        document.getElementById('profile-timezone').value = profileData.timezone || '';
        document.getElementById('preferred-language').value = profileData.preferred_language || '';
        document.getElementById('skill-level').value = profileData.skill_level || '';
        document.getElementById('learning-goals').value = profileData.learning_goals || '';
    }

    function setupProfileForm() {
        const form = document.getElementById('profile-form');
        const newPasswordInput = document.getElementById('new-password');
        const avatarFileInput = document.getElementById('avatar-file');

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveProfile();
        });

        // Password strength indicator
        newPasswordInput.addEventListener('input', function () {
            const strength = Auth.checkPasswordStrength(this.value);
            updatePasswordStrength(strength);
        });

        // Avatar preview
        avatarFileInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatar-preview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });
    }

    async function saveProfile() {
        try {
            const formData = {
                name: document.getElementById('profile-form-name').value,
                email: document.getElementById('profile-form-email').value,
                bio: document.getElementById('profile-bio').value,
                location: document.getElementById('profile-location').value,
                timezone: document.getElementById('profile-timezone').value,
                preferred_language: document.getElementById('preferred-language').value,
                skill_level: document.getElementById('skill-level').value,
                learning_goals: document.getElementById('learning-goals').value
            };

            const response = await API.user.updateProfile(formData);

            // Update local data
            profileData = { ...profileData, ...formData };
            Auth.updateUser(profileData);

            updateProfileDisplay();
            Notifications.success('Profile updated successfully!');

        } catch (error) {
            console.error('Error saving profile:', error);
            Notifications.handleApiError(error, 'Saving profile');
        }
    }

    function cancelEdit() {
        populateProfileForm();
        Notifications.info('Changes discarded');
    }

    function changeAvatar() {
        const modal = new bootstrap.Modal(document.getElementById('avatarModal'));
        modal.show();
    }

    async function uploadAvatar() {
        try {
            const fileInput = document.getElementById('avatar-file');
            const file = fileInput.files[0];

            if (!file) {
                Notifications.warning('Please select a file');
                return;
            }

            // Validate file
            const validation = Validators.image(file);
            if (!validation.isValid) {
                Notifications.error(validation.message);
                return;
            }

            // Show loading
            const uploadBtn = document.querySelector('[onclick="uploadAvatar()"]');
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Uploading...';

            // Upload avatar
            const response = await API.user.uploadAvatar(file);

            // Update avatar display
            profileData.avatar_url = response.avatar_url;
            document.getElementById('profile-avatar').src = response.avatar_url;
            document.getElementById('avatar-preview').src = response.avatar_url;

            // Update auth user data
            Auth.updateUser({ avatar_url: response.avatar_url });

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('avatarModal'));
            modal.hide();

            Notifications.success('Profile picture updated successfully!');

        } catch (error) {
            console.error('Error uploading avatar:', error);
            Notifications.handleApiError(error, 'Uploading avatar');
        } finally {
            // Reset button
            const uploadBtn = document.querySelector('[onclick="uploadAvatar()"]');
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = '<i class="bi bi-upload me-1"></i>Upload';
        }
    }

    function changePassword() {
        const modal = new bootstrap.Modal(document.getElementById('passwordModal'));
        modal.show();
    }

    async function submitPasswordChange() {
        try {
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            // Validate passwords
            if (newPassword !== confirmPassword) {
                Notifications.error('New passwords do not match');
                return;
            }

            const passwordValidation = Validators.password(newPassword);
            if (!passwordValidation.isValid) {
                Notifications.error(passwordValidation.message);
                return;
            }

            // TODO: API endpoint for password change would be needed
            // await API.user.changePassword(currentPassword, newPassword);

            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('passwordModal'));
            modal.hide();

            // Clear form
            document.getElementById('password-form').reset();

            Notifications.success('Password changed successfully!');

        } catch (error) {
            console.error('Error changing password:', error);
            Notifications.handleApiError(error, 'Changing password');
        }
    }

    function updatePasswordStrength(strength) {
        const container = document.getElementById('password-strength');
        const colors = {
            weak: 'danger',
            medium: 'warning',
            strong: 'success'
        };

        container.innerHTML = `
        <div class="progress" style="height: 5px;">
            <div class="progress-bar bg-${colors[strength.strength]}" 
                 style="width: ${strength.score * 20}%"></div>
        </div>
        <small class="text-${colors[strength.strength]}">
            Password strength: ${Utils.titleCase(strength.strength)}
        </small>
        ${strength.suggestions.length > 0 ? `
            <ul class="small mt-1 mb-0">
                ${strength.suggestions.map(s => `<li>${s}</li>`).join('')}
            </ul>
        ` : ''}
    `;
    }

    async function loadRecentActivity() {
        try {
            // This would typically fetch user-specific activity
            const activityContainer = document.getElementById('recent-activity');

            // Sample activity data
            const activities = [
                { type: 'study', action: 'Completed Week 2 Day 3', time: new Date(Date.now() - 3600000) },
                { type: 'note', action: 'Created note "Binary Search Tips"', time: new Date(Date.now() - 7200000) },
                { type: 'achievement', action: 'Earned 7-day streak badge', time: new Date(Date.now() - 86400000) },
                { type: 'timer', action: 'Completed 4 Pomodoro sessions', time: new Date(Date.now() - 172800000) }
            ];

            activityContainer.innerHTML = activities.map(activity => {
                const icons = {
                    study: 'bi-book text-primary',
                    note: 'bi-journal-text text-info',
                    achievement: 'bi-trophy text-warning',
                    timer: 'bi-clock text-success'
                };

                return `
                <div class="d-flex align-items-start mb-3">
                    <i class="${icons[activity.type]} me-3 mt-1"></i>
                    <div class="flex-grow-1">
                        <div>${activity.action}</div>
                        <small class="text-muted">${Utils.getRelativeTime(activity.time)}</small>
                    </div>
                </div>
            `;
            }).join('');

        } catch (error) {
            console.error('Error loading activity:', error);
            document.getElementById('recent-activity').innerHTML = `
            <div class="text-center py-3 text-muted">
                <p class="mb-0">Failed to load activity</p>
            </div>
        `;
        }
    }

    async function exportData() {
        try {
            // Show loading
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Preparing export...';

            // In a real app, this would call an API endpoint to generate a data export
            // For now, we'll create a sample export
            const exportData = {
                user: profileData,
                export_date: new Date().toISOString(),
                progress: 'Sample progress data',
                notes: 'Sample notes data'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsa-path-export-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Notifications.success('Data exported successfully!');

        } catch (error) {
            console.error('Error exporting data:', error);
            Notifications.error('Failed to export data');
        } finally {
            // Reset button
            const btn = event.target;
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-download me-2"></i>Export My Data';
        }
    }

    async function deleteAccount() {
        const confirmed = await Components.modal.confirm(
            'Are you sure you want to delete your account? This action cannot be undone and all your data will be permanently deleted.',
            {
                title: 'Delete Account',
                confirmText: 'Delete My Account',
                confirmClass: 'btn-danger'
            }
        );

        if (confirmed) {
            // In a real app, this would call an API endpoint to delete the account
            Notifications.info('Account deletion would be processed here');
        }
    }
</script>