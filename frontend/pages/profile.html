<!-- pages/profile.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - DSA Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>

<body class="bg-gray-50">
    <!-- Sidebar -->
    <div id="sidebarContainer"></div>

    <!-- Topbar -->
    <div id="topbarContainer"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="h3 mb-3">Profile Settings</h1>
                    <p class="text-muted">Manage your account and preferences</p>
                </div>
            </div>

            <!-- Profile Tabs -->
            <div class="row">
                <div class="col-12">
                    <ul class="nav nav-tabs mb-4" id="profileTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="profile-tab" data-bs-toggle="tab"
                                data-bs-target="#profile-content" type="button" role="tab">
                                <i class="fas fa-user me-2"></i> Profile
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="preferences-tab" data-bs-toggle="tab"
                                data-bs-target="#preferences-content" type="button" role="tab">
                                <i class="fas fa-cog me-2"></i> Preferences
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="security-tab" data-bs-toggle="tab"
                                data-bs-target="#security-content" type="button" role="tab">
                                <i class="fas fa-lock me-2"></i> Security
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="sessions-tab" data-bs-toggle="tab"
                                data-bs-target="#sessions-content" type="button" role="tab">
                                <i class="fas fa-laptop me-2"></i> Sessions
                            </button>
                        </li>
                    </ul>

                    <div class="tab-content" id="profileTabContent">
                        <!-- Profile Tab -->
                        <div class="tab-pane fade show active" id="profile-content" role="tabpanel">
                            <div class="row">
                                <div class="col-lg-8">
                                    <div class="card">
                                        <div class="card-header bg-white">
                                            <h5 class="mb-0">Profile Information</h5>
                                        </div>
                                        <div class="card-body">
                                            <form id="profileForm">
                                                <div class="row align-items-center mb-4">
                                                    <div class="col-auto">
                                                        <img src="https://ui-avatars.com/api/?name=User&background=007bff&color=fff"
                                                            alt="Avatar" class="rounded-circle" width="100" height="100"
                                                            id="avatarPreview">
                                                    </div>
                                                    <div class="col">
                                                        <input type="file" class="form-control d-none" id="avatarInput"
                                                            accept="image/*" onchange="previewAvatar(event)">
                                                        <button type="button" class="btn btn-outline-primary"
                                                            onclick="document.getElementById('avatarInput').click()">
                                                            <i class="fas fa-camera me-2"></i> Change Avatar
                                                        </button>
                                                        <button type="button"
                                                            class="btn btn-outline-secondary ms-2 d-none"
                                                            id="uploadAvatarBtn" onclick="uploadAvatar()">
                                                            <i class="fas fa-cloud-upload-alt me-2"></i> Upload
                                                        </button>
                                                    </div>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="profileName" class="form-label">Full Name</label>
                                                    <input type="text" class="form-control" id="profileName" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="profileEmail" class="form-label">Email Address</label>
                                                    <input type="email" class="form-control" id="profileEmail" required>
                                                </div>

                                                <div class="mb-3">
                                                    <label class="form-label">Member Since</label>
                                                    <p class="form-control-plaintext" id="memberSince">Loading...</p>
                                                </div>

                                                <button type="submit" class="btn btn-primary">
                                                    <i class="fas fa-save me-2"></i> Save Changes
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-lg-4 mt-4 mt-lg-0">
                                    <div class="card">
                                        <div class="card-header bg-white">
                                            <h5 class="mb-0">Learning Stats</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="stat-item mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Current Streak</span>
                                                    <strong><span id="profileStreak">0</span> days</strong>
                                                </div>
                                            </div>
                                            <div class="stat-item mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Longest Streak</span>
                                                    <strong><span id="profileLongestStreak">0</span> days</strong>
                                                </div>
                                            </div>
                                            <div class="stat-item mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Total Study Time</span>
                                                    <strong><span id="profileStudyTime">0</span> hours</strong>
                                                </div>
                                            </div>
                                            <div class="stat-item">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="text-muted">Completion</span>
                                                    <strong><span id="profileCompletion">0</span>%</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Preferences Tab -->
                        <div class="tab-pane fade" id="preferences-content" role="tabpanel">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Application Preferences</h5>
                                </div>
                                <div class="card-body">
                                    <form id="preferencesForm">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6 class="mb-3">Display Settings</h6>

                                                <div class="mb-3">
                                                    <label for="theme" class="form-label">Theme</label>
                                                    <select class="form-select" id="theme">
                                                        <option value="light">Light</option>
                                                        <option value="dark">Dark</option>
                                                        <option value="auto">Auto (System)</option>
                                                    </select>
                                                </div>

                                                <div class="mb-3">
                                                    <label for="language" class="form-label">Language</label>
                                                    <select class="form-select" id="language">
                                                        <option value="en">English</option>
                                                        <option value="es">Spanish</option>
                                                        <option value="fr">French</option>
                                                        <option value="de">German</option>
                                                    </select>
                                                </div>

                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="accessibilityMode">
                                                    <label class="form-check-label" for="accessibilityMode">
                                                        Enable Accessibility Mode
                                                    </label>
                                                </div>
                                            </div>

                                            <div class="col-md-6">
                                                <h6 class="mb-3">Notification Settings</h6>

                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="notificationsEnabled" checked>
                                                    <label class="form-check-label" for="notificationsEnabled">
                                                        Enable Push Notifications
                                                    </label>
                                                </div>

                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox"
                                                        id="emailNotifications" checked>
                                                    <label class="form-check-label" for="emailNotifications">
                                                        Email Notifications
                                                    </label>
                                                </div>

                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="streakReminders"
                                                        checked>
                                                    <label class="form-check-label" for="streakReminders">
                                                        Daily Streak Reminders
                                                    </label>
                                                </div>

                                                <div class="form-check form-switch mb-3">
                                                    <input class="form-check-input" type="checkbox" id="weeklyProgress"
                                                        checked>
                                                    <label class="form-check-label" for="weeklyProgress">
                                                        Weekly Progress Reports
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-2"></i> Save Preferences
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Security Tab -->
                        <div class="tab-pane fade" id="security-content" role="tabpanel">
                            <div class="card mb-4">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Change Password</h5>
                                </div>
                                <div class="card-body">
                                    <form id="passwordForm">
                                        <div class="mb-3">
                                            <label for="currentPassword" class="form-label">Current Password</label>
                                            <input type="password" class="form-control" id="currentPassword" required>
                                        </div>

                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="newPassword" required>
                                            <div class="form-text">Must be at least 8 characters long</div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" id="confirmPassword" required>
                                        </div>

                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-lock me-2"></i> Change Password
                                        </button>
                                    </form>
                                </div>
                            </div>

                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Two-Factor Authentication</h5>
                                </div>
                                <div class="card-body">
                                    <p class="text-muted">Add an extra layer of security to your account</p>
                                    <button class="btn btn-outline-primary" disabled>
                                        <i class="fas fa-mobile-alt me-2"></i> Enable 2FA (Coming Soon)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Sessions Tab -->
                        <div class="tab-pane fade" id="sessions-content" role="tabpanel">
                            <div class="card">
                                <div class="card-header bg-white">
                                    <h5 class="mb-0">Active Sessions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="sessionsList">
                                        <div class="text-center py-4">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/components.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let profileData = null;
        let preferencesData = null;
        let selectedAvatar = null;

        // Initialize profile
        async function initProfile() {
            await loadComponents();
            await loadProfile();
            await loadSessions();

            // Check for hash to switch tabs
            const hash = window.location.hash.substring(1);
            if (hash === 'settings') {
                const tab = new bootstrap.Tab(document.getElementById('preferences-tab'));
                tab.show();
            }
        }

        // Load profile data
        async function loadProfile() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    profileData = data.user;
                    preferencesData = data.preferences;
                    updateProfileUI();
                    updatePreferencesUI();
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        // Update profile UI
        function updateProfileUI() {
            // Profile form
            document.getElementById('profileName').value = profileData.name;
            document.getElementById('profileEmail').value = profileData.email;
            document.getElementById('memberSince').textContent =
                new Date(profileData.created_at).toLocaleDateString();

            // Avatar
            if (profileData.avatar_url) {
                document.getElementById('avatarPreview').src = profileData.avatar_url;
            } else {
                document.getElementById('avatarPreview').src =
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(profileData.name)}&background=007bff&color=fff`;
            }

            // Stats
            document.getElementById('profileStreak').textContent = profileData.current_streak;
            document.getElementById('profileLongestStreak').textContent = profileData.longest_streak;
            document.getElementById('profileStudyTime').textContent = Math.round(profileData.total_study_time / 60);

            // Calculate completion percentage
            loadDashboardStats();
        }

        // Load dashboard stats for completion percentage
        async function loadDashboardStats() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_BASE}/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('profileCompletion').textContent =
                        Math.round(data.stats.completion_percentage);
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        // Update preferences UI
        function updatePreferencesUI() {
            document.getElementById('theme').value = preferencesData.theme;
            document.getElementById('language').value = preferencesData.language;
            document.getElementById('accessibilityMode').checked = preferencesData.accessibility_mode;
            document.getElementById('notificationsEnabled').checked = preferencesData.notifications_enabled;
            document.getElementById('emailNotifications').checked = preferencesData.email_notifications;
        }

        // Preview avatar
        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                    document.getElementById('uploadAvatarBtn').classList.remove('d-none');
                };
                reader.readAsDataURL(file);
                selectedAvatar = file;
            }
        }

        // Upload avatar
        async function uploadAvatar() {
            if (!selectedAvatar) return;

            const token = localStorage.getItem('access_token');
            const formData = new FormData();
            formData.append('avatar', selectedAvatar);

            try {
                const response = await fetch(`${API_BASE}/profile/avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    showAlert('Avatar uploaded successfully!', 'success');
                    document.getElementById('uploadAvatarBtn').classList.add('d-none');

                    // Update avatar in localStorage
                    const user = JSON.parse(localStorage.getItem('user'));
                    user.avatar_url = data.avatar_url;
                    localStorage.setItem('user', JSON.stringify(user));

                    // Update topbar avatar
                    document.getElementById('userAvatar').src = data.avatar_url;
                } else {
                    showAlert('Failed to upload avatar', 'danger');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'danger');
            }
        }

        // Handle profile form submission
        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = localStorage.getItem('access_token');
            const data = {
                name: document.getElementById('profileName').value,
                email: document.getElementById('profileEmail').value
            };

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    showAlert('Profile updated successfully!', 'success');

                    // Update localStorage
                    localStorage.setItem('user', JSON.stringify(result.user));

                    // Update topbar
                    document.getElementById('userName').textContent = result.user.name;
                } else {
                    const error = await response.json();
                    showAlert(error.error || 'Failed to update profile', 'danger');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'danger');
            }
        });

        // Handle preferences form submission
        document.getElementById('preferencesForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const token = localStorage.getItem('access_token');
            const data = {
                theme: document.getElementById('theme').value,
                language: document.getElementById('language').value,
                accessibility_mode: document.getElementById('accessibilityMode').checked,
                notifications_enabled: document.getElementById('notificationsEnabled').checked,
                email_notifications: document.getElementById('emailNotifications').checked
            };

            try {
                const response = await fetch(`${API_BASE}/preferences`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    showAlert('Preferences updated successfully!', 'success');

                    // Apply theme if changed
                    if (data.theme === 'dark') {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                } else {
                    showAlert('Failed to update preferences', 'danger');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'danger');
            }
        });

        // Handle password form submission
        document.getElementById('passwordForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword.length < 8) {
                showAlert('Password must be at least 8 characters long', 'danger');
                return;
            }

            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'danger');
                return;
            }

            // Note: Backend doesn't have change password endpoint yet
            showAlert('Password change functionality coming soon!', 'info');
            e.target.reset();
        });

        // Load sessions
        async function loadSessions() {
            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_BASE}/sessions`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderSessions(data.sessions);
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        // Render sessions
        function renderSessions(sessions) {
            const container = document.getElementById('sessionsList');

            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-muted">No active sessions found.</p>';
                return;
            }

            container.innerHTML = `
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Device</th>
                                <th>IP Address</th>
                                <th>Login Time</th>
                                <th>Last Activity</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sessions.map(session => `
                                <tr>
                                    <td>
                                        <i class="fas fa-desktop me-2"></i>
                                        ${session.device_info || 'Unknown Device'}
                                    </td>
                                    <td>${session.ip_address}</td>
                                    <td>${new Date(session.login_time).toLocaleString()}</td>
                                    <td>${new Date(session.last_activity).toLocaleString()}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="revokeSession('${session.id}')">
                                            Revoke
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // Revoke session
        async function revokeSession(sessionId) {
            if (!confirm('Are you sure you want to revoke this session?')) return;

            const token = localStorage.getItem('access_token');
            try {
                const response = await fetch(`${API_BASE}/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showAlert('Session revoked successfully!', 'success');
                    loadSessions();
                } else {
                    showAlert('Failed to revoke session', 'danger');
                }
            } catch (error) {
                showAlert('Network error. Please try again.', 'danger');
            }
        }

        // Show alert
        function showAlert(message, type) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 end-0 m-3`;
            alert.style.zIndex = '9999';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);

            setTimeout(() => alert.remove(), 5000);
        }

        // Initialize on load
        initProfile();
    </script>
</body>

</html>