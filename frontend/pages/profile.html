<!-- pages/profile.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>

<body class="app-layout">
    <!-- Sidebar -->
    <div id="sidebarContainer"></div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div id="topbarContainer"></div>

        <!-- Profile Content -->
        <div class="content-area">
            <!-- Header -->
            <div class="page-header">
                <div class="row align-items-center mb-4">
                    <div class="col-lg-8">
                        <h1 class="page-title">
                            <i class="fas fa-user me-3"></i>
                            Profile
                        </h1>
                        <p class="page-subtitle">Manage your account information and learning preferences</p>
                    </div>
                    <div class="col-lg-4 text-lg-end">
                        <div class="profile-actions">
                            <button class="btn btn-outline-primary" data-bs-toggle="modal"
                                data-bs-target="#avatarModal">
                                <i class="fas fa-camera me-2"></i>
                                Change Avatar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Profile Card -->
                <div class="col-lg-4">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <img src="https://via.placeholder.com/120" alt="Profile Avatar" id="profileAvatar">
                                <div class="avatar-overlay">
                                    <i class="fas fa-camera"></i>
                                </div>
                            </div>
                            <h4 id="profileName">Loading...</h4>
                            <p class="text-muted" id="profileEmail">Loading...</p>
                            <div class="profile-stats">
                                <div class="stat">
                                    <span class="stat-value" id="memberSince">-</span>
                                    <span class="stat-label">Member Since</span>
                                </div>
                            </div>
                        </div>

                        <div class="profile-progress">
                            <h6 class="mb-3">Learning Progress</h6>
                            <div class="progress-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Overall Completion</span>
                                    <span id="overallProgress">0%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" id="overallProgressBar" style="width: 0%"></div>
                                </div>
                            </div>
                            <div class="progress-item">
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Current Streak</span>
                                    <span id="currentStreak">0 days</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar bg-warning" id="streakProgressBar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="profile-achievements">
                            <h6 class="mb-3">Recent Achievements</h6>
                            <div id="recentAchievements">
                                <!-- Achievements will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Profile Forms -->
                <div class="col-lg-8">
                    <!-- Personal Information -->
                    <div class="dashboard-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-user-edit me-2"></i>
                                Personal Information
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="personalInfoForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="firstName" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="firstName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="lastName" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="lastName">
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" required>
                                </div>
                                <div class="mb-3">
                                    <label for="bio" class="form-label">Bio</label>
                                    <textarea class="form-control" id="bio" rows="3"
                                        placeholder="Tell us about yourself..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="location" placeholder="City, Country">
                                </div>
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">Timezone</label>
                                    <select class="form-select" id="timezone">
                                        <!-- Timezone options will be populated -->
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    Save Changes
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Security Settings -->
                    <div class="dashboard-card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>
                                Security Settings
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="passwordForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">Current Password</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="newPassword" class="form-label">New Password</label>
                                            <input type="password" class="form-control" id="newPassword" required
                                                minlength="8">
                                            <div class="form-text">Must be at least 8 characters long</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                                            <input type="password" class="form-control" id="confirmPassword" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="password-strength mb-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="small">Password Strength:</span>
                                        <span class="badge bg-secondary" id="passwordStrength">Not set</span>
                                    </div>
                                    <div class="progress mt-1" style="height: 4px;">
                                        <div class="progress-bar" id="passwordStrengthBar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-key me-2"></i>
                                    Update Password
                                </button>
                            </form>
                        </div>
                    </div>

                    <!-- Active Sessions -->
                    <div class="dashboard-card mb-4">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="fas fa-devices me-2"></i>
                                    Active Sessions
                                </h5>
                                <button class="btn btn-sm btn-outline-danger" onclick="revokeAllSessions()">
                                    <i class="fas fa-sign-out-alt me-1"></i>
                                    Sign Out All
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="activeSessions">
                                <!-- Sessions will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Danger Zone -->
                    <div class="dashboard-card border-danger">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Danger Zone
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <i class="fas fa-warning me-2"></i>
                                <strong>Warning:</strong> These actions are irreversible. Please proceed with caution.
                            </div>
                            <button class="btn btn-outline-danger" data-bs-toggle="modal"
                                data-bs-target="#deleteAccountModal">
                                <i class="fas fa-trash me-2"></i>
                                Delete Account
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <!-- Avatar Upload Modal -->
    <div class="modal fade" id="avatarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-camera me-2"></i>
                        Change Avatar
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="avatar-preview">
                            <img src="https://via.placeholder.com/150" alt="Avatar Preview" id="avatarPreview">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="avatarFile" class="form-label">Choose new avatar</label>
                        <input type="file" class="form-control" id="avatarFile" accept="image/*">
                        <div class="form-text">Maximum file size: 2MB. Supported formats: JPG, PNG, GIF</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="uploadAvatarBtn">
                        <i class="fas fa-upload me-2"></i>
                        Upload Avatar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Account Modal -->
    <div class="modal fade" id="deleteAccountModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Delete Account
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>This action cannot be undone!</strong>
                        This will permanently delete your account and all associated data.
                    </div>
                    <p>Please type <strong>DELETE</strong> to confirm:</p>
                    <input type="text" class="form-control" id="deleteConfirmation" placeholder="Type DELETE">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" disabled>
                        <i class="fas fa-trash me-2"></i>
                        Delete My Account
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let profileData = null;

        // Load components
        async function loadComponents() {
            try {
                const [sidebarResponse, topbarResponse, mobileNavResponse] = await Promise.all([
                    fetch('../components/sidebar.html'),
                    fetch('../components/topbar.html'),
                    fetch('../components/mobile-nav.html')
                ]);

                document.getElementById('sidebarContainer').innerHTML = await sidebarResponse.text();
                document.getElementById('topbarContainer').innerHTML = await topbarResponse.text();
                document.getElementById('mobileNavContainer').innerHTML = await mobileNavResponse.text();

                initializeComponents();
                setActiveNavItem('profile');
                document.getElementById('pageTitle').textContent = 'Profile';
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Load profile data
        async function loadProfile() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    profileData = await response.json();
                    populateProfileData();
                    loadActiveSessions();
                } else {
                    throw new Error('Failed to load profile');
                }
            } catch (error) {
                console.error('Profile error:', error);
                showError('Failed to load profile data');
            }
        }

        // Populate profile data
        function populateProfileData() {
            const { user, preferences } = profileData;

            // Profile card
            document.getElementById('profileName').textContent = user.name;
            document.getElementById('profileEmail').textContent = user.email;
            document.getElementById('memberSince').textContent = formatDate(user.created_at);

            if (user.avatar_url) {
                document.getElementById('profileAvatar').src = user.avatar_url;
                document.getElementById('avatarPreview').src = user.avatar_url;
            }

            // Personal information form
            const nameParts = user.name.split(' ');
            document.getElementById('firstName').value = nameParts[0] || '';
            document.getElementById('lastName').value = nameParts.slice(1).join(' ') || '';
            document.getElementById('email').value = user.email;

            // Progress stats
            document.getElementById('currentStreak').textContent = `${user.current_streak} days`;
            const overallProgress = calculateOverallProgress();
            document.getElementById('overallProgress').textContent = `${overallProgress}%`;
            document.getElementById('overallProgressBar').style.width = `${overallProgress}%`;

            const streakProgress = Math.min((user.current_streak / 30) * 100, 100);
            document.getElementById('streakProgressBar').style.width = `${streakProgress}%`;

            // Populate timezones
            populateTimezones();

            // Load achievements
            loadRecentAchievements();
        }

        // Calculate overall progress
        function calculateOverallProgress() {
            // This would typically come from the dashboard API
            // For now, we'll calculate based on streak and study time
            const streak = profileData.user.current_streak;
            const studyTime = profileData.user.total_study_time;

            // Simple calculation: base progress on study time (assuming 1000 hours = 100%)
            const timeProgress = Math.min((studyTime / 60000) * 100, 100); // 1000 hours in minutes
            const streakBonus = Math.min(streak * 2, 20); // Up to 20% bonus for streak

            return Math.min(Math.round(timeProgress + streakBonus), 100);
        }

        // Populate timezone options
        function populateTimezones() {
            const timezones = [
                'UTC', 'America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles',
                'Europe/London', 'Europe/Paris', 'Europe/Berlin', 'Asia/Tokyo', 'Asia/Shanghai',
                'Asia/Kolkata', 'Australia/Sydney'
            ];

            const select = document.getElementById('timezone');
            timezones.forEach(tz => {
                select.appendChild(new Option(tz, tz));
            });

            // Set current timezone
            select.value = Intl.DateTimeFormat().resolvedOptions().timeZone || 'UTC';
        }

        // Load recent achievements
        function loadRecentAchievements() {
            const container = document.getElementById('recentAchievements');

            // Mock achievements based on user data
            const achievements = [
                { icon: 'fa-fire', title: 'Streak Starter', earned: profileData.user.current_streak >= 7 },
                { icon: 'fa-calendar-check', title: 'First Week', earned: profileData.user.total_study_time > 0 },
                { icon: 'fa-clock', title: 'Time Keeper', earned: profileData.user.total_study_time >= 3600 }
            ];

            const earnedAchievements = achievements.filter(a => a.earned);

            if (earnedAchievements.length === 0) {
                container.innerHTML = '<p class="text-muted small">No achievements yet. Keep studying!</p>';
                return;
            }

            container.innerHTML = earnedAchievements.map(achievement => `
                <div class="achievement-badge">
                    <i class="fas ${achievement.icon} text-warning"></i>
                    <span>${achievement.title}</span>
                </div>
            `).join('');
        }

        // Load active sessions
        async function loadActiveSessions() {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/sessions`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderActiveSessions(data.sessions);
                } else {
                    throw new Error('Failed to load sessions');
                }
            } catch (error) {
                console.error('Sessions error:', error);
                document.getElementById('activeSessions').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load active sessions
                    </div>
                `;
            }
        }

        // Render active sessions
        function renderActiveSessions(sessions) {
            const container = document.getElementById('activeSessions');

            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-muted">No active sessions</p>';
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="session-item">
                    <div class="session-info">
                        <div class="session-device">
                            <i class="fas ${getDeviceIcon(session.device_info)} me-2"></i>
                            <strong>${getDeviceName(session.device_info)}</strong>
                        </div>
                        <div class="session-details">
                            <small class="text-muted">
                                ${session.ip_address} â€¢ Last active: ${formatDistanceToNow(session.last_activity)}
                            </small>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-outline-danger" onclick="revokeSession('${session.id}')">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            `).join('');
        }

        // Get device icon
        function getDeviceIcon(deviceInfo) {
            if (!deviceInfo) return 'fa-desktop';
            const info = deviceInfo.toLowerCase();
            if (info.includes('mobile') || info.includes('android') || info.includes('iphone')) return 'fa-mobile-alt';
            if (info.includes('tablet') || info.includes('ipad')) return 'fa-tablet-alt';
            return 'fa-desktop';
        }

        // Get device name
        function getDeviceName(deviceInfo) {
            if (!deviceInfo) return 'Unknown Device';

            // Extract browser and OS info
            if (deviceInfo.includes('Chrome')) return 'Chrome Browser';
            if (deviceInfo.includes('Firefox')) return 'Firefox Browser';
            if (deviceInfo.includes('Safari')) return 'Safari Browser';
            if (deviceInfo.includes('Edge')) return 'Edge Browser';

            return 'Web Browser';
        }

        // Save personal information
        async function savePersonalInfo(event) {
            event.preventDefault();

            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const email = document.getElementById('email').value.trim();
            const bio = document.getElementById('bio').value.trim();
            const location = document.getElementById('location').value.trim();

            const fullName = `${firstName} ${lastName}`.trim();

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name: fullName,
                        email: email,
                        bio: bio,
                        location: location
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess('Profile updated successfully!');

                    // Update local storage
                    const user = JSON.parse(localStorage.getItem('user'));
                    user.name = fullName;
                    user.email = email;
                    localStorage.setItem('user', JSON.stringify(user));

                    // Reload profile
                    await loadProfile();
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to update profile');
                }
            } catch (error) {
                console.error('Update profile error:', error);
                showError(error.message);
            }
        }

        // Change password
        async function changePassword(event) {
            event.preventDefault();

            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }

            if (newPassword.length < 8) {
                showError('Password must be at least 8 characters long');
                return;
            }

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/auth/change-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        current_password: currentPassword,
                        new_password: newPassword
                    })
                });

                if (response.ok) {
                    showSuccess('Password updated successfully!');
                    document.getElementById('passwordForm').reset();
                    updatePasswordStrength('');
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to change password');
                }
            } catch (error) {
                console.error('Change password error:', error);
                showError(error.message);
            }
        }

        // Upload avatar
        async function uploadAvatar() {
            const fileInput = document.getElementById('avatarFile');
            const file = fileInput.files[0];

            if (!file) {
                showError('Please select a file');
                return;
            }

            if (file.size > 2 * 1024 * 1024) {
                showError('File size must be less than 2MB');
                return;
            }

            const formData = new FormData();
            formData.append('avatar', file);

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/profile/avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    showSuccess('Avatar updated successfully!');

                    // Update avatar display
                    document.getElementById('profileAvatar').src = result.avatar_url;
                    document.getElementById('avatarPreview').src = result.avatar_url;

                    // Close modal
                    bootstrap.Modal.getInstance(document.getElementById('avatarModal')).hide();

                    // Update user in localStorage
                    const user = JSON.parse(localStorage.getItem('user'));
                    user.avatar_url = result.avatar_url;
                    localStorage.setItem('user', JSON.stringify(user));
                } else {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to upload avatar');
                }
            } catch (error) {
                console.error('Upload avatar error:', error);
                showError(error.message);
            }
        }

        // Revoke session
        async function revokeSession(sessionId) {
            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/sessions/${sessionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    showSuccess('Session revoked successfully');
                    loadActiveSessions();
                } else {
                    throw new Error('Failed to revoke session');
                }
            } catch (error) {
                console.error('Revoke session error:', error);
                showError('Failed to revoke session');
            }
        }

        // Revoke all sessions
        function revokeAllSessions() {
            if (confirm('This will sign you out from all devices. Continue?')) {
                // Implementation would revoke all sessions except current
                showInfo('All other sessions have been terminated');
            }
        }

        // Password strength checker
        function updatePasswordStrength(password) {
            const strength = calculatePasswordStrength(password);
            const strengthText = ['Very Weak', 'Weak', 'Fair', 'Good', 'Strong'];
            const strengthColors = ['danger', 'warning', 'info', 'primary', 'success'];

            document.getElementById('passwordStrength').textContent = strengthText[strength];
            document.getElementById('passwordStrength').className = `badge bg-${strengthColors[strength]}`;
            document.getElementById('passwordStrengthBar').style.width = `${(strength + 1) * 20}%`;
            document.getElementById('passwordStrengthBar').className = `progress-bar bg-${strengthColors[strength]}`;
        }

        function calculatePasswordStrength(password) {
            let strength = 0;

            if (password.length >= 8) strength++;
            if (password.match(/[a-z]/)) strength++;
            if (password.match(/[A-Z]/)) strength++;
            if (password.match(/[0-9]/)) strength++;
            if (password.match(/[^a-zA-Z0-9]/)) strength++;

            return Math.min(strength - 1, 4);
        }

        // Avatar file preview
        function previewAvatar(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // Delete account confirmation
        function enableDeleteButton() {
            const input = document.getElementById('deleteConfirmation');
            const button = document.getElementById('confirmDeleteBtn');
            button.disabled = input.value !== 'DELETE';
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Form submissions
            document.getElementById('personalInfoForm').addEventListener('submit', savePersonalInfo);
            document.getElementById('passwordForm').addEventListener('submit', changePassword);

            // Avatar upload
            document.getElementById('avatarFile').addEventListener('change', previewAvatar);
            document.getElementById('uploadAvatarBtn').addEventListener('click', uploadAvatar);

            // Password strength
            document.getElementById('newPassword').addEventListener('input', (e) => {
                updatePasswordStrength(e.target.value);
            });

            // Delete confirmation
            document.getElementById('deleteConfirmation').addEventListener('input', enableDeleteButton);

            // Profile avatar click
            document.getElementById('profileAvatar').addEventListener('click', () => {
                bootstrap.Modal.getOrCreateInstance(document.getElementById('avatarModal')).show();
            });
        });

        // Utility functions
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long'
            });
        }

        // Initialize profile page
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuth();
            await loadComponents();
            await loadProfile();
        });
    </script>

    <style>
        .profile-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .profile-avatar {
            position: relative;
            width: 120px;
            height: 120px;
            margin: 0 auto 1rem;
            cursor: pointer;
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid white;
            object-fit: cover;
        }

        .avatar-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: var(--transition);
        }

        .profile-avatar:hover .avatar-overlay {
            opacity: 1;
        }

        .avatar-overlay i {
            font-size: 1.5rem;
            color: white;
        }

        .profile-stats {
            margin-top: 1rem;
        }

        .stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .profile-progress,
        .profile-achievements {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .profile-achievements:last-child {
            border-bottom: none;
        }

        .progress-item {
            margin-bottom: 1rem;
        }

        .progress-item:last-child {
            margin-bottom: 0;
        }

        .achievement-badge {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }

        .achievement-badge:last-child {
            margin-bottom: 0;
        }

        .achievement-badge i {
            margin-right: 0.5rem;
            font-size: 1.1rem;
        }

        .achievement-badge span {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .avatar-preview {
            width: 150px;
            height: 150px;
            margin: 0 auto;
            border-radius: 50%;
            overflow: hidden;
            border: 3px solid #e5e7eb;
        }

        .avatar-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .session-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
        }

        .session-item:last-child {
            margin-bottom: 0;
        }

        .session-device {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .password-strength .progress {
            height: 4px;
        }

        .profile-actions {
            display: flex;
            gap: 0.5rem;
        }

        @media (max-width: 991.98px) {
            .profile-card {
                margin-bottom: 2rem;
            }

            .profile-header {
                padding: 1.5rem;
            }

            .profile-avatar {
                width: 100px;
                height: 100px;
            }

            .profile-progress,
            .profile-achievements {
                padding: 1rem;
            }
        }

        @media (max-width: 767.98px) {
            .profile-header {
                padding: 1rem;
            }

            .profile-avatar {
                width: 80px;
                height: 80px;
            }

            .session-item {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .page-header .col-lg-4 {
                text-align: left !important;
                margin-top: 1rem;
            }

            .profile-actions {
                justify-content: flex-start;
            }
        }
    </style>
</body>

</html>