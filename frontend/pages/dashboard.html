<div class="container-fluid p-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div
                class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center mb-4">
                <div>
                    <h1 class="h3 fw-bold mb-1">Welcome back, <span id="user-name-display">Student</span>! ðŸ‘‹</h1>
                    <p class="text-muted mb-0">Ready to continue your DSA journey today?</p>
                </div>
                <div class="d-flex gap-2 mt-3 mt-lg-0">
                    <a href="/pages/pomodoro" class="btn btn-primary">
                        <i class="fas fa-clock me-2"></i>Start Study Session
                    </a>
                    <a href="/pages/roadmap" class="btn btn-outline-primary">
                        <i class="fas fa-map me-2"></i>View Roadmap
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row g-4 mb-4" id="stats-section">
        <div class="col-md-3 col-sm-6">
            <div class="card stat-card bg-gradient-to-r from-blue-500 to-blue-600 text-white border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3 class="stat-value" data-stat="current_streak">0</h3>
                            <p class="stat-label mb-0">Day Streak</p>
                            <div class="stat-change positive mt-2">
                                <i class="fas fa-fire me-1"></i>
                                <span>Keep it going!</span>
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-calendar-check fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card stat-card bg-gradient-to-r from-green-500 to-green-600 text-white border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3 class="stat-value" data-stat="completion_percentage">0%</h3>
                            <p class="stat-label mb-0">Progress</p>
                            <div class="stat-change positive mt-2">
                                <i class="fas fa-arrow-up me-1"></i>
                                <span data-stat="completed_days">0</span>/<span data-stat="total_days">98</span> days
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-chart-line fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card stat-card bg-gradient-to-r from-purple-500 to-purple-600 text-white border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3 class="stat-value" data-stat="total_study_time">0h</h3>
                            <p class="stat-label mb-0">Total Study Time</p>
                            <div class="stat-change mt-2">
                                <i class="fas fa-clock me-1"></i>
                                <span data-stat="study_time_last_7_days">0h</span> this week
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-hourglass-half fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card stat-card bg-gradient-to-r from-orange-500 to-orange-600 text-white border-0 h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h3 class="stat-value" data-stat="longest_streak">0</h3>
                            <p class="stat-label mb-0">Best Streak</p>
                            <div class="stat-change mt-2">
                                <i class="fas fa-trophy me-1"></i>
                                <span>Personal Record</span>
                            </div>
                        </div>
                        <div class="stat-icon">
                            <i class="fas fa-medal fa-2x opacity-75"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content Row -->
    <div class="row g-4">
        <!-- Weekly Progress Chart -->
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2 text-primary"></i>
                        Weekly Progress
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" data-view="weekly">Weekly</button>
                        <button type="button" class="btn btn-outline-primary" data-view="monthly">Monthly</button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="weekly-progress-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Today's Focus -->
        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-bullseye me-2 text-success"></i>
                        Today's Focus
                    </h5>
                </div>
                <div class="card-body" id="todays-focus">
                    <!-- Will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activities -->
    <div class="row g-4 mt-0">
        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-clock me-2 text-info"></i>
                        Recent Study Sessions
                    </h5>
                    <a href="/pages/pomodoro" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body">
                    <div id="recent-sessions">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-sticky-note me-2 text-warning"></i>
                        Recent Notes
                    </h5>
                    <a href="/pages/notes" class="btn btn-sm btn-outline-primary">View All</a>
                </div>
                <div class="card-body">
                    <div id="recent-notes">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row g-4 mt-0">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-rocket me-2 text-primary"></i>
                        Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3 col-sm-6">
                            <a href="/pages/roadmap"
                                class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3 text-decoration-none">
                                <i class="fas fa-map fa-2x mb-2"></i>
                                <span class="fw-medium">Study Roadmap</span>
                                <small class="text-muted">View weekly curriculum</small>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="/pages/notes"
                                class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3 text-decoration-none">
                                <i class="fas fa-plus fa-2x mb-2"></i>
                                <span class="fw-medium">New Note</span>
                                <small class="text-muted">Capture your thoughts</small>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="/pages/ai-assistant"
                                class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3 text-decoration-none">
                                <i class="fas fa-robot fa-2x mb-2"></i>
                                <span class="fw-medium">AI Assistant</span>
                                <small class="text-muted">Get instant help</small>
                            </a>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <a href="/pages/resources"
                                class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3 text-decoration-none">
                                <i class="fas fa-book fa-2x mb-2"></i>
                                <span class="fw-medium">Resources</span>
                                <small class="text-muted">Browse materials</small>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        console.log('Loading dashboard...');

        try {
            // Load dashboard data
            const dashboardData = await ApiMethods.dashboard.get();
            console.log('Dashboard data loaded:', dashboardData);

            // Update user name
            const user = Storage.user.getUserData();
            if (user) {
                document.getElementById('user-name-display').textContent = user.name;
            }

            // Update stats cards
            updateStatsCards(dashboardData.stats);

            // Update weekly progress chart
            updateWeeklyProgressChart(dashboardData.weekly_progress);

            // Update today's focus
            updateTodaysFocus(dashboardData);

            // Update recent activities
            updateRecentActivities(dashboardData);

        } catch (error) {
            console.error('Failed to load dashboard:', error);
            Notifications.error('Failed to load dashboard data');
        }
    });

    function updateStatsCards(stats) {
        // Update stat values
        Object.entries(stats).forEach(([key, value]) => {
            const element = document.querySelector(`[data-stat="${key}"]`);
            if (element) {
                switch (key) {
                    case 'total_study_time':
                    case 'study_time_last_7_days':
                        element.textContent = Utils.time.formatDuration(value * 60);
                        break;
                    case 'completion_percentage':
                        element.textContent = `${Math.round(value)}%`;
                        break;
                    default:
                        element.textContent = value;
                }
            }
        });
    }

    function updateWeeklyProgressChart(weeklyProgress) {
        const canvas = document.getElementById('weekly-progress-chart');
        if (!canvas || !weeklyProgress) return;

        const weeklyData = Object.entries(weeklyProgress).map(([week, data]) => ({
            week: parseInt(week),
            percentage: data.percentage
        }));

        Lib.charts.createWeeklyProgressChart(canvas, weeklyData);
    }

    function updateTodaysFocus(data) {
        const container = document.getElementById('todays-focus');
        if (!container) return;

        // Get current week and day
        const today = new Date();
        const currentWeek = Math.ceil((today.getTime() - new Date(today.getFullYear(), 0, 1).getTime()) / (7 * 24 * 60 * 60 * 1000));
        const dayName = today.toLocaleDateString('en-US', { weekday: 'long' });

        container.innerHTML = `
        <div class="mb-3">
            <h6 class="fw-bold text-primary">Week ${Math.min(currentWeek, 14)}</h6>
            <p class="text-muted mb-2">${dayName}</p>
        </div>
        
        <div class="d-flex align-items-center justify-content-between mb-3">
            <span class="text-sm">Today's Progress</span>
            <span class="badge bg-primary">75%</span>
        </div>
        
        <div class="progress mb-3" style="height: 8px;">
            <div class="progress-bar bg-gradient" role="progressbar" style="width: 75%"></div>
        </div>
        
        <div class="d-grid gap-2">
            <a href="/pages/roadmap?week=${Math.min(currentWeek, 14)}" class="btn btn-primary btn-sm">
                <i class="fas fa-play me-2"></i>Continue Learning
            </a>
            <a href="/pages/pomodoro" class="btn btn-outline-primary btn-sm">
                <i class="fas fa-clock me-2"></i>Start Timer
            </a>
        </div>
    `;
    }

    function updateRecentActivities(data) {
        updateRecentSessions(data.recent_sessions || []);
        updateRecentNotes(data.recent_notes || []);
    }

    function updateRecentSessions(sessions) {
        const container = document.getElementById('recent-sessions');
        if (!container) return;

        if (sessions.length === 0) {
            container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-clock text-muted fa-2x mb-2"></i>
                <p class="text-muted mb-0">No study sessions yet</p>
                <a href="/pages/pomodoro" class="btn btn-sm btn-primary mt-2">Start Your First Session</a>
            </div>
        `;
            return;
        }

        container.innerHTML = sessions.map(session => `
        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div class="flex-grow-1">
                <div class="fw-medium">${session.topic || 'Study Session'}</div>
                <small class="text-muted">${Utils.date.relative(session.start_time)}</small>
            </div>
            <div class="text-end">
                <span class="badge bg-${session.completed ? 'success' : 'warning'}">
                    ${session.duration} min
                </span>
                ${session.completed ? '<i class="fas fa-check-circle text-success ms-2"></i>' : '<i class="fas fa-clock text-warning ms-2"></i>'}
            </div>
        </div>
    `).join('');
    }

    function updateRecentNotes(notes) {
        const container = document.getElementById('recent-notes');
        if (!container) return;

        if (notes.length === 0) {
            container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-sticky-note text-muted fa-2x mb-2"></i>
                <p class="text-muted mb-0">No notes yet</p>
                <a href="/pages/notes" class="btn btn-sm btn-primary mt-2">Create Your First Note</a>
            </div>
        `;
            return;
        }

        container.innerHTML = notes.map(note => `
        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div class="flex-grow-1">
                <div class="fw-medium">${Utils.string.truncate(note.title, 30)}</div>
                <small class="text-muted">${Utils.date.relative(note.updated_at)}</small>
            </div>
            <a href="/pages/notes?id=${note.id}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-external-link-alt"></i>
            </a>
        </div>
    `).join('');
    }
</script>