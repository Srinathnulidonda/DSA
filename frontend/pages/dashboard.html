<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DSA Learning Daily</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/animation.css">
    <link rel="stylesheet" href="../css/responsive.css">
</head>

<body class="bg-gray-50">
    <div class="container-fluid p-4">
        <!-- Dashboard Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="mb-1">Dashboard</h1>
                        <p class="text-muted mb-0">Track your DSA learning progress</p>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="refreshDashboard()">
                            <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                        </button>
                        <button class="btn btn-primary" onclick="startQuickSession()">
                            <i class="bi bi-play-fill me-1"></i>Quick Session
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Overview Stats -->
        <div class="row g-4 mb-4">
            <div class="col-md-3 col-sm-6">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-primary-subtle text-primary rounded-circle p-3 me-3">
                                <i class="bi bi-fire fs-4"></i>
                            </div>
                            <div>
                                <h3 class="mb-0" id="currentStreak">0</h3>
                                <small class="text-muted">Current Streak</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-success-subtle text-success rounded-circle p-3 me-3">
                                <i class="bi bi-check-circle fs-4"></i>
                            </div>
                            <div>
                                <h3 class="mb-0" id="completionRate">0%</h3>
                                <small class="text-muted">Completion Rate</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-warning-subtle text-warning rounded-circle p-3 me-3">
                                <i class="bi bi-clock fs-4"></i>
                            </div>
                            <div>
                                <h3 class="mb-0" id="totalStudyTime">0h</h3>
                                <small class="text-muted">Total Study Time</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 col-sm-6">
                <div class="card stats-card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="stats-icon bg-info-subtle text-info rounded-circle p-3 me-3">
                                <i class="bi bi-trophy fs-4"></i>
                            </div>
                            <div>
                                <h3 class="mb-0" id="longestStreak">0</h3>
                                <small class="text-muted">Longest Streak</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="row g-4">
            <!-- Weekly Progress Chart -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Weekly Progress Overview</h5>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                                    data-bs-toggle="dropdown">
                                    <i class="bi bi-three-dots"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="exportProgress()">Export Data</a>
                                    </li>
                                    <li><a class="dropdown-item" href="#" onclick="showDetailedProgress()">Detailed
                                            View</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="weeklyProgressChart" class="weekly-progress-grid">
                            <!-- Progress chart will be dynamically generated -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Focus & Quick Actions -->
            <div class="col-lg-4">
                <!-- Today's Focus -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0">Today's Focus</h5>
                    </div>
                    <div class="card-body">
                        <div id="todaysFocus">
                            <div class="d-flex align-items-center mb-3">
                                <div class="focus-icon bg-primary-subtle text-primary rounded-circle p-2 me-3">
                                    <i class="bi bi-book"></i>
                                </div>
                                <div>
                                    <h6 class="mb-0" id="todayTopic">Loading...</h6>
                                    <small class="text-muted" id="todayWeek">Week - Day</small>
                                </div>
                            </div>
                            <div class="progress mb-3" style="height: 8px;">
                                <div class="progress-bar" id="todayProgress" style="width: 0%"></div>
                            </div>
                            <div class="d-grid">
                                <button class="btn btn-primary btn-sm" onclick="startTodaySession()">
                                    <i class="bi bi-play-fill me-1"></i>Start Today's Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Daily Motivation -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body text-center">
                        <div class="motivation-icon mb-3">
                            <i class="bi bi-lightbulb text-warning" style="font-size: 2.5rem;"></i>
                        </div>
                        <blockquote class="blockquote mb-3">
                            <p class="mb-0 fst-italic" id="motivationalQuote">Loading daily motivation...</p>
                        </blockquote>
                        <small class="text-muted">Daily Inspiration</small>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <h6 class="mb-0">Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="openPomodoro()">
                                <i class="bi bi-clock me-2"></i>Start Pomodoro
                            </button>
                            <button class="btn btn-outline-success btn-sm" onclick="openNotes()">
                                <i class="bi bi-journal-plus me-2"></i>Add Note
                            </button>
                            <button class="btn btn-outline-info btn-sm" onclick="openCalendar()">
                                <i class="bi bi-calendar-check me-2"></i>View Schedule
                            </button>
                            <button class="btn btn-outline-warning btn-sm" onclick="openProgress()">
                                <i class="bi bi-graph-up me-2"></i>View Progress
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Activity Section -->
        <div class="row g-4 mt-2">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Recent Study Sessions</h5>
                            <a href="#" class="text-decoration-none" onclick="openPomodoro()">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="recentSessions">
                            <!-- Recent sessions will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Recent Notes</h5>
                            <a href="#" class="text-decoration-none" onclick="openNotes()">View All</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="recentNotes">
                            <!-- Recent notes will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements Section -->
        <div class="row g-4 mt-2">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0">Recent Achievements</h5>
                    </div>
                    <div class="card-body">
                        <div id="achievementsList" class="row g-3">
                            <!-- Achievements will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Chart.js for progress visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let authToken = localStorage.getItem('accessToken');
        let dashboardData = {};

        // Initialize Dashboard
        document.addEventListener('DOMContentLoaded', function () {
            if (!authToken) {
                window.location.href = '../auth/login.html';
                return;
            }
            initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                showLoading();
                await loadDashboardData();
                updateDashboardUI();
                setupRealTimeUpdates();
            } catch (error) {
                console.error('Failed to initialize dashboard:', error);
                showError('Failed to load dashboard data');
            } finally {
                hideLoading();
            }
        }

        async function loadDashboardData() {
            try {
                const [dashboard, progress, roadmap] = await Promise.all([
                    fetchWithAuth('/dashboard'),
                    fetchWithAuth('/progress'),
                    fetchWithAuth('/roadmap')
                ]);

                dashboardData = {
                    ...dashboard,
                    progress: progress,
                    roadmap: roadmap.roadmap
                };

                return dashboardData;
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                throw error;
            }
        }

        function updateDashboardUI() {
            // Update stats
            document.getElementById('currentStreak').textContent = dashboardData.stats.current_streak || 0;
            document.getElementById('completionRate').textContent = Math.round(dashboardData.stats.completion_percentage || 0) + '%';
            document.getElementById('totalStudyTime').textContent = Math.floor((dashboardData.stats.total_study_time || 0) / 60) + 'h';
            document.getElementById('longestStreak').textContent = dashboardData.stats.longest_streak || 0;

            // Update weekly progress chart
            updateWeeklyProgressChart();

            // Update today's focus
            updateTodaysFocus();

            // Update recent activities
            updateRecentSessions();
            updateRecentNotes();

            // Update achievements
            updateAchievements();

            // Update daily quote
            updateDailyQuote();
        }

        function updateWeeklyProgressChart() {
            const chartContainer = document.getElementById('weeklyProgressChart');
            let html = '<div class="row g-2">';

            for (let week = 1; week <= 14; week++) {
                const weekProgress = dashboardData.weekly_progress[week] || { completed: 0, total: 7, percentage: 0 };
                const isCurrentWeek = getCurrentWeek() === week;
                const isCompleted = weekProgress.percentage === 100;

                let cardClass = 'border-light';
                if (isCompleted) cardClass = 'border-success bg-success-subtle';
                else if (isCurrentWeek) cardClass = 'border-primary bg-primary-subtle';
                else if (weekProgress.completed > 0) cardClass = 'border-warning bg-warning-subtle';

                html += `
                    <div class="col-6 col-md-4 col-xl-3">
                        <div class="card ${cardClass} week-progress-card" data-week="${week}" onclick="openWeekDetail(${week})">
                            <div class="card-body p-3 text-center">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="fw-semibold">Week ${week}</small>
                                    ${isCompleted ? '<i class="bi bi-check-circle-fill text-success"></i>' : ''}
                                </div>
                                <div class="progress mb-2" style="height: 6px;">
                                    <div class="progress-bar ${isCompleted ? 'bg-success' : isCurrentWeek ? 'bg-primary' : 'bg-warning'}" 
                                         style="width: ${weekProgress.percentage}%"></div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">${weekProgress.completed}/${weekProgress.total}</small>
                                    <small class="fw-medium">${Math.round(weekProgress.percentage)}%</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            chartContainer.innerHTML = html;
        }

        function updateTodaysFocus() {
            const currentWeek = getCurrentWeek();
            const currentDay = getCurrentDay();

            if (dashboardData.roadmap && dashboardData.roadmap[currentWeek - 1]) {
                const weekData = dashboardData.roadmap[currentWeek - 1];
                const dayData = weekData.days.find(d => d.day === currentDay);

                if (dayData) {
                    document.getElementById('todayTopic').textContent = dayData.topic;
                    document.getElementById('todayWeek').textContent = `Week ${currentWeek} - ${currentDay}`;

                    // Calculate today's progress
                    const progress = dashboardData.progress[currentWeek] && dashboardData.progress[currentWeek][currentDay];
                    const progressPercentage = progress && progress.completed ? 100 : 0;
                    document.getElementById('todayProgress').style.width = progressPercentage + '%';
                }
            }
        }

        function updateRecentSessions() {
            const container = document.getElementById('recentSessions');
            const sessions = dashboardData.recent_sessions || [];

            if (sessions.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">No recent study sessions</p>';
                return;
            }

            let html = '';
            sessions.slice(0, 5).forEach(session => {
                html += `
                    <div class="d-flex align-items-center mb-3 session-item">
                        <div class="session-icon me-3">
                            <i class="bi bi-${session.completed ? 'check-circle-fill text-success' : 'clock text-warning'}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-medium">${session.topic || 'Study Session'}</div>
                            <small class="text-muted">${session.duration} min • ${formatDateTime(session.start_time)}</small>
                        </div>
                        <div>
                            <span class="badge ${session.completed ? 'bg-success' : 'bg-warning'}">
                                ${session.completed ? 'Completed' : 'In Progress'}
                            </span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateRecentNotes() {
            const container = document.getElementById('recentNotes');
            const notes = dashboardData.recent_notes || [];

            if (notes.length === 0) {
                container.innerHTML = '<p class="text-muted text-center py-3">No recent notes</p>';
                return;
            }

            let html = '';
            notes.slice(0, 5).forEach(note => {
                html += `
                    <div class="d-flex align-items-center mb-3 note-item">
                        <div class="note-icon me-3">
                            <i class="bi bi-journal-text text-info"></i>
                        </div>
                        <div class="flex-grow-1">
                            <div class="fw-medium">${note.title}</div>
                            <small class="text-muted">${formatDateTime(note.updated_at)}</small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewNote('${note.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function updateAchievements() {
            const container = document.getElementById('achievementsList');

            // Generate sample achievements based on user stats
            const achievements = generateAchievements();

            if (achievements.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted text-center py-3">Complete your first day to unlock achievements!</p></div>';
                return;
            }

            let html = '';
            achievements.forEach(achievement => {
                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-0 bg-gradient-to-r from-yellow-50 to-orange-50 achievement-card">
                            <div class="card-body text-center">
                                <div class="achievement-icon mb-2">
                                    <i class="bi bi-${achievement.icon} text-warning" style="font-size: 2rem;"></i>
                                </div>
                                <h6 class="card-title">${achievement.title}</h6>
                                <p class="card-text small text-muted">${achievement.description}</p>
                                <small class="text-muted">${achievement.date}</small>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function generateAchievements() {
            const achievements = [];
            const stats = dashboardData.stats;

            if (stats.current_streak >= 1) {
                achievements.push({
                    icon: 'fire',
                    title: 'First Streak!',
                    description: 'Completed your first day of learning',
                    date: 'Today'
                });
            }

            if (stats.current_streak >= 7) {
                achievements.push({
                    icon: 'trophy',
                    title: 'Week Warrior',
                    description: 'Maintained a 7-day learning streak',
                    date: 'This week'
                });
            }

            if (stats.total_study_time >= 60) {
                achievements.push({
                    icon: 'clock',
                    title: 'Study Master',
                    description: 'Completed 1 hour of focused study',
                    date: 'Recently'
                });
            }

            if (stats.completion_percentage >= 25) {
                achievements.push({
                    icon: 'graph-up',
                    title: 'Quarter Master',
                    description: 'Completed 25% of the roadmap',
                    date: 'Recently'
                });
            }

            return achievements;
        }

        function updateDailyQuote() {
            const quotes = [
                "The only way to learn a new programming language is by writing programs in it. - Dennis Ritchie",
                "Programs must be written for people to read, and only incidentally for machines to execute. - Harold Abelson",
                "Code is like humor. When you have to explain it, it's bad. - Cory House",
                "Programming isn't about what you know; it's about what you can figure out. - Chris Pine",
                "The best error message is the one that never shows up. - Thomas Fuchs",
                "Talk is cheap. Show me the code. - Linus Torvalds",
                "Any fool can write code that a computer can understand. Good programmers write code that humans can understand. - Martin Fowler",
                "First, solve the problem. Then, write the code. - John Johnson"
            ];

            const today = new Date().getDate();
            const quote = quotes[today % quotes.length];
            document.getElementById('motivationalQuote').textContent = quote;
        }

        // Helper Functions
        function getCurrentWeek() {
            // Calculate current week based on user's progress
            const completedDays = Object.values(dashboardData.progress || {}).flat().filter(p => p && p.completed).length;
            return Math.floor(completedDays / 7) + 1;
        }

        function getCurrentDay() {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            return days[new Date().getDay() === 0 ? 6 : new Date().getDay() - 1];
        }

        function formatDateTime(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffTime = Math.abs(now - date);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (diffDays === 1) return 'Yesterday';
            if (diffDays < 7) return `${diffDays} days ago`;
            return date.toLocaleDateString();
        }

        // API Functions
        async function fetchWithAuth(endpoint, options = {}) {
            const response = await fetch(`${API_BASE}${endpoint}`, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`,
                    ...options.headers
                }
            });

            if (response.status === 401) {
                localStorage.removeItem('accessToken');
                window.location.href = '../auth/login.html';
                return;
            }

            if (!response.ok) {
                throw new Error('Request failed');
            }

            return await response.json();
        }

        // Action Functions
        async function refreshDashboard() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Refreshing...';
            btn.disabled = true;

            try {
                await loadDashboardData();
                updateDashboardUI();
                showSuccess('Dashboard refreshed successfully');
            } catch (error) {
                showError('Failed to refresh dashboard');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function startQuickSession() {
            window.location.href = 'pomodoro.html?quick=true';
        }

        function startTodaySession() {
            const currentWeek = getCurrentWeek();
            const currentDay = getCurrentDay();
            window.location.href = `pomodoro.html?week=${currentWeek}&day=${currentDay}`;
        }

        function openPomodoro() {
            window.location.href = 'pomodoro.html';
        }

        function openNotes() {
            window.location.href = 'notes.html';
        }

        function openCalendar() {
            window.location.href = 'calendar.html';
        }

        function openProgress() {
            window.location.href = 'progress.html';
        }

        function openWeekDetail(week) {
            window.location.href = `roadmap.html?week=${week}`;
        }

        function viewNote(noteId) {
            window.location.href = `notes.html?note=${noteId}`;
        }

        function exportProgress() {
            // Implementation for exporting progress data
            showSuccess('Progress data exported successfully');
        }

        function showDetailedProgress() {
            window.location.href = 'analytics.html';
        }

        // Real-time Updates
        function setupRealTimeUpdates() {
            // Refresh dashboard every 5 minutes
            setInterval(() => {
                refreshDashboard();
            }, 300000);

            // Update time-based elements every minute
            setInterval(() => {
                updateRecentSessions();
                updateRecentNotes();
            }, 60000);
        }

        // UI Helper Functions
        function showLoading() {
            // Implementation for showing loading state
        }

        function hideLoading() {
            // Implementation for hiding loading state
        }

        function showSuccess(message) {
            // Show success toast
            console.log('Success:', message);
        }

        function showError(message) {
            // Show error toast
            console.log('Error:', message);
        }
    </script>
</body>

</html>