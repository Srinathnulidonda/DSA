<!-- pages/dashboard.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DSA Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>

<body>
    <!-- Mobile Header -->
    <div class="mobile-header d-lg-none">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0 fw-bold">Dashboard</h4>
                <small class="text-muted">Welcome back!</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#aiModal">
                    <i class="fas fa-robot"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown">
                        <i class="fas fa-user"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/profile">Profile</a></li>
                        <li><a class="dropdown-item" href="/settings">Settings</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger" href="#" onclick="logout()">Logout</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <!-- Topbar -->
        <div id="topbarContainer"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Stats Cards -->
            <div class="row mb-4" id="statsContainer">
                <!-- Loading skeletons -->
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card animate-fade-in">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-fire text-white text-3xl"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="text-white mb-0" id="currentStreak">-</h3>
                                <p class="text-white-50 mb-0">Day Streak</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card success animate-fade-in animation-delay-100">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-chart-line text-white text-3xl"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="text-white mb-0" id="completionPercentage">-</h3>
                                <p class="text-white-50 mb-0">Complete</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card warning animate-fade-in animation-delay-200">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-clock text-white text-3xl"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="text-white mb-0" id="studyTime">-</h3>
                                <p class="text-white-50 mb-0">Study Hours</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="stats-card info animate-fade-in animation-delay-300">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i class="fas fa-trophy text-white text-3xl"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h3 class="text-white mb-0" id="longestStreak">-</h3>
                                <p class="text-white-50 mb-0">Best Streak</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Weekly Progress -->
                <div class="col-lg-8 mb-4">
                    <div class="card animate-slide-up">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Weekly Progress</h5>
                            <a href="/roadmap" class="btn btn-outline-primary btn-sm">View Full Roadmap</a>
                        </div>
                        <div class="card-body">
                            <div id="weeklyProgressContainer">
                                <!-- Progress bars will be loaded here -->
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-lg-4 mb-4">
                    <div class="card animate-slide-up animation-delay-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-grid gap-2">
                                <a href="/pomodoro" class="btn btn-primary">
                                    <i class="fas fa-play me-2"></i>Start Study Session
                                </a>
                                <a href="/notes" class="btn btn-outline-success">
                                    <i class="fas fa-plus me-2"></i>Add Note
                                </a>
                                <button class="btn btn-outline-info" data-bs-toggle="modal" data-bs-target="#aiModal">
                                    <i class="fas fa-robot me-2"></i>Ask AI Tutor
                                </button>
                                <a href="/calendar" class="btn btn-outline-warning">
                                    <i class="fas fa-calendar me-2"></i>View Calendar
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Recent Study Sessions -->
                <div class="col-lg-6 mb-4">
                    <div class="card animate-slide-up animation-delay-200">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-history me-2"></i>Recent Sessions</h5>
                            <a href="/analytics" class="btn btn-outline-primary btn-sm">View All</a>
                        </div>
                        <div class="card-body">
                            <div id="recentSessionsContainer">
                                <!-- Sessions will be loaded here -->
                                <div class="text-center py-3">
                                    <div class="loading-dots">
                                        <div class="loading-dot"></div>
                                        <div class="loading-dot"></div>
                                        <div class="loading-dot"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Notes -->
                <div class="col-lg-6 mb-4">
                    <div class="card animate-slide-up animation-delay-300">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Recent Notes</h5>
                            <a href="/notes" class="btn btn-outline-primary btn-sm">View All</a>
                        </div>
                        <div class="card-body">
                            <div id="recentNotesContainer">
                                <!-- Notes will be loaded here -->
                                <div class="text-center py-3">
                                    <div class="loading-dots">
                                        <div class="loading-dot"></div>
                                        <div class="loading-dot"></div>
                                        <div class="loading-dot"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Motivational Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card animate-slide-up animation-delay-400">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                <i class="fas fa-quote-left text-primary text-2xl"></i>
                            </div>
                            <blockquote class="blockquote mb-3">
                                <p class="mb-0" id="dailyQuote">Loading inspirational quote...</p>
                            </blockquote>
                            <footer class="blockquote-footer">
                                <cite title="Source">Daily Motivation</cite>
                            </footer>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <!-- AI Assistant Modal -->
    <div class="modal fade" id="aiModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-robot me-2"></i>AI Tutor Assistant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-message assistant">
                            <div class="chat-bubble assistant">
                                Hi! I'm your AI tutor. Ask me anything about Data Structures and Algorithms!
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="input-group">
                            <input type="text" class="form-control" id="aiQuestion" placeholder="Ask your question...">
                            <button class="btn btn-primary" type="button" onclick="askAI()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';

        // Global variables
        let currentUser = null;
        let dashboardData = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadComponents();
            await loadDashboardData();
            loadDailyQuote();
            setActivePage('dashboard');
        });

        // Authentication check
        async function checkAuth() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Authentication failed');
                }

                const data = await response.json();
                currentUser = data.user;
                updateUserInfo();
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = '/login';
            }
        }

        // Load reusable components
        async function loadComponents() {
            try {
                // Load sidebar
                const sidebarResponse = await fetch('../components/sidebar.html');
                const sidebarHtml = await sidebarResponse.text();
                document.getElementById('sidebarContainer').innerHTML = sidebarHtml;

                // Load topbar (desktop only)
                if (window.innerWidth >= 992) {
                    const topbarResponse = await fetch('../components/topbar.html');
                    const topbarHtml = await topbarResponse.text();
                    document.getElementById('topbarContainer').innerHTML = topbarHtml;
                }

                // Load mobile navigation
                const mobileNavResponse = await fetch('../components/mobile-nav.html');
                const mobileNavHtml = await mobileNavResponse.text();
                document.getElementById('mobileNavContainer').innerHTML = mobileNavHtml;

                // Initialize component functionality
                initializeComponents();
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Initialize component functionality
        function initializeComponents() {
            // Update page title in topbar
            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = 'Dashboard';
            }

            // Setup global search
            const globalSearch = document.getElementById('globalSearch');
            if (globalSearch) {
                globalSearch.addEventListener('input', handleGlobalSearch);
            }

            // Update user info in components
            updateUserInfo();
        }

        // Update user information in UI
        function updateUserInfo() {
            if (!currentUser) return;

            // Update user name in topbar
            const userName = document.getElementById('userName');
            if (userName) {
                userName.textContent = currentUser.name;
            }

            // Update avatar if available
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar && currentUser.avatar_url) {
                userAvatar.src = currentUser.avatar_url;
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch(`${API_BASE}/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    dashboardData = await response.json();
                    updateStatsCards();
                    updateWeeklyProgress();
                    updateRecentSessions();
                    updateRecentNotes();
                } else {
                    throw new Error('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Dashboard error:', error);
                showToast('Error loading dashboard data', 'error');
            }
        }

        // Update stats cards
        function updateStatsCards() {
            if (!dashboardData) return;

            const stats = dashboardData.stats;

            document.getElementById('currentStreak').textContent = stats.current_streak || 0;
            document.getElementById('completionPercentage').textContent = `${Math.round(stats.completion_percentage || 0)}%`;
            document.getElementById('studyTime').textContent = `${Math.round((stats.total_study_time || 0) / 60)}h`;
            document.getElementById('longestStreak').textContent = stats.longest_streak || 0;
        }

        // Update weekly progress
        function updateWeeklyProgress() {
            if (!dashboardData) return;

            const container = document.getElementById('weeklyProgressContainer');
            const weeklyProgress = dashboardData.weekly_progress;

            let html = '';
            for (let week = 1; week <= 14; week++) {
                const progress = weeklyProgress[week] || { title: `Week ${week}`, completed: 0, total: 7, percentage: 0 };

                html += `
                    <div class="week-progress mb-3" onclick="goToWeek(${week})">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">${progress.title}</h6>
                            <span class="badge bg-primary">${progress.completed}/${progress.total}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" style="width: ${progress.percentage}%" 
                                 aria-valuenow="${progress.percentage}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round(progress.percentage)}%
                            </div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
        }

        // Update recent sessions
        function updateRecentSessions() {
            if (!dashboardData) return;

            const container = document.getElementById('recentSessionsContainer');
            const sessions = dashboardData.recent_sessions || [];

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-clock text-3xl mb-2"></i>
                        <p>No study sessions yet. <a href="/pomodoro">Start your first session!</a></p>
                    </div>
                `;
                return;
            }

            let html = '';
            sessions.forEach(session => {
                const startTime = new Date(session.start_time);
                const duration = session.duration;
                const status = session.completed ? 'success' : 'warning';
                const statusText = session.completed ? 'Completed' : 'Incomplete';

                html += `
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-shrink-0">
                            <div class="status-indicator ${status}">
                                <div class="status-dot"></div>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">${session.topic || 'Study Session'}</h6>
                            <small class="text-muted">
                                ${startTime.toLocaleDateString()} • ${duration} min • ${statusText}
                            </small>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Update recent notes
        function updateRecentNotes() {
            if (!dashboardData) return;

            const container = document.getElementById('recentNotesContainer');
            const notes = dashboardData.recent_notes || [];

            if (notes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-sticky-note text-3xl mb-2"></i>
                        <p>No notes yet. <a href="/notes">Create your first note!</a></p>
                    </div>
                `;
                return;
            }

            let html = '';
            notes.forEach(note => {
                const updatedTime = new Date(note.updated_at);

                html += `
                    <div class="d-flex align-items-center mb-3" onclick="goToNote('${note.id}')">
                        <div class="flex-shrink-0">
                            <i class="fas fa-sticky-note text-primary"></i>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h6 class="mb-1">${note.title}</h6>
                            <small class="text-muted">
                                ${updatedTime.toLocaleDateString()}
                            </small>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load daily motivational quote
        function loadDailyQuote() {
            const quotes = [
                "The only way to do great work is to love what you do. - Steve Jobs",
                "Success is not final, failure is not fatal: it is the courage to continue that counts. - Winston Churchill",
                "The future belongs to those who believe in the beauty of their dreams. - Eleanor Roosevelt",
                "It is during our darkest moments that we must focus to see the light. - Aristotle",
                "The way to get started is to quit talking and begin doing. - Walt Disney",
                "Don't be afraid to give up the good to go for the great. - John D. Rockefeller",
                "The pessimist sees difficulty in every opportunity. The optimist sees opportunity in every difficulty. - Winston Churchill",
                "Don't let yesterday take up too much of today. - Will Rogers",
                "You learn more from failure than from success. Don't let it stop you. Failure builds character. - Unknown",
                "If you are working on something that you really care about, you don't have to be pushed. The vision pulls you. - Steve Jobs"
            ];

            // Use date as seed for consistent daily quote
            const today = new Date();
            const dayOfYear = Math.floor((today - new Date(today.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            const quoteIndex = dayOfYear % quotes.length;

            document.getElementById('dailyQuote').textContent = quotes[quoteIndex];
        }

        // AI Assistant functionality
        async function askAI() {
            const questionInput = document.getElementById('aiQuestion');
            const question = questionInput.value.trim();

            if (!question) return;

            const chatContainer = document.getElementById('chatContainer');
            const token = localStorage.getItem('accessToken');

            // Add user message
            const userMessage = `
                <div class="chat-message user">
                    <div class="chat-bubble user">
                        ${question}
                    </div>
                    <div class="chat-timestamp">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            chatContainer.innerHTML += userMessage;

            // Add loading message
            const loadingMessage = `
                <div class="chat-message assistant" id="loadingMessage">
                    <div class="chat-bubble assistant">
                        <div class="loading-dots">
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                            <div class="loading-dot"></div>
                        </div>
                    </div>
                </div>
            `;
            chatContainer.innerHTML += loadingMessage;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            questionInput.value = '';

            try {
                const response = await fetch(`${API_BASE}/ai/ask`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ question })
                });

                const data = await response.json();

                // Remove loading message
                document.getElementById('loadingMessage').remove();

                // Add AI response
                const aiMessage = `
                    <div class="chat-message assistant">
                        <div class="chat-bubble assistant">
                            ${data.answer || data.error || 'Sorry, I could not process your question.'}
                        </div>
                        <div class="chat-timestamp">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                chatContainer.innerHTML += aiMessage;
                chatContainer.scrollTop = chatContainer.scrollHeight;

            } catch (error) {
                document.getElementById('loadingMessage').remove();
                const errorMessage = `
                    <div class="chat-message assistant">
                        <div class="chat-bubble assistant">
                            Sorry, I'm having trouble connecting right now. Please try again later.
                        </div>
                    </div>
                `;
                chatContainer.innerHTML += errorMessage;
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }
        }

        // Enter key for AI chat
        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && document.getElementById('aiQuestion') === document.activeElement) {
                askAI();
            }
        });

        // Navigation functions
        function goToWeek(week) {
            window.location.href = `/roadmap?week=${week}`;
        }

        function goToNote(noteId) {
            window.location.href = `/notes?note=${noteId}`;
        }

        // Global search functionality
        async function handleGlobalSearch(e) {
            const query = e.target.value.trim();
            if (query.length < 2) return;

            // Implement search functionality
            console.log('Searching for:', query);
        }

        // Set active page in navigation
        function setActivePage(page) {
            // Update sidebar
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });

            // Update mobile navigation
            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();

            const toast = `
                <div class="toast ${type}" role="alert" id="${toastId}">
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            toastContainer.innerHTML += toast;

            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement);
            bsToast.show();

            setTimeout(() => {
                toastElement.remove();
            }, 5000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // Sidebar toggle (desktop)
        document.addEventListener('click', (e) => {
            if (e.target.id === 'sidebarToggle') {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.querySelector('.main-content');

                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('sidebar-collapsed');
            }
        });

        // Window resize handler
        window.addEventListener('resize', () => {
            if (window.innerWidth < 992) {
                // Mobile view
                document.querySelector('.main-content').classList.add('sidebar-collapsed');
            } else {
                // Desktop view
                if (!document.getElementById('sidebar').classList.contains('collapsed')) {
                    document.querySelector('.main-content').classList.remove('sidebar-collapsed');
                }
            }
        });
    </script>
</body>

</html>