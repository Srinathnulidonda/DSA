<!-- pages/dashboard.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <div id="topbar-container"></div>

            <!-- Dashboard Content -->
            <div class="container-fluid mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">Dashboard</h1>
                    <div class="text-muted">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="currentDate"></span>
                    </div>
                </div>

                <!-- Welcome Message -->
                <div class="alert alert-primary alert-dismissible fade show animate-fade-in" role="alert">
                    <h5 class="alert-heading">Welcome back, <span id="userName">Learner</span>! ðŸ‘‹</h5>
                    <p class="mb-0" id="motivationalQuote">Loading daily motivation...</p>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Stats Overview -->
                <div class="row g-4 mb-4">
                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Current Streak</h6>
                                    <div class="d-flex align-items-baseline">
                                        <h2 class="mb-0" id="currentStreak">0</h2>
                                        <span class="ms-2 text-muted">days</span>
                                    </div>
                                </div>
                                <div class="stat-icon bg-primary bg-opacity-10 text-primary">
                                    <i class="fas fa-fire"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Progress</h6>
                                    <div class="d-flex align-items-baseline">
                                        <h2 class="mb-0" id="completionPercentage">0</h2>
                                        <span class="ms-2 text-muted">%</span>
                                    </div>
                                </div>
                                <div class="stat-icon bg-success bg-opacity-10 text-success">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Study Time</h6>
                                    <div class="d-flex align-items-baseline">
                                        <h2 class="mb-0" id="totalStudyTime">0</h2>
                                        <span class="ms-2 text-muted">hrs</span>
                                    </div>
                                </div>
                                <div class="stat-icon bg-warning bg-opacity-10 text-warning">
                                    <i class="fas fa-clock"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-12 col-sm-6 col-lg-3">
                        <div class="stat-card">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="text-muted mb-2">Completed</h6>
                                    <div class="d-flex align-items-baseline">
                                        <h2 class="mb-0" id="completedDays">0</h2>
                                        <span class="ms-2 text-muted">/ <span id="totalDays">98</span></span>
                                    </div>
                                </div>
                                <div class="stat-icon bg-info bg-opacity-10 text-info">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Progress -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Weekly Progress</h5>
                            </div>
                            <div class="card-body">
                                <div id="weeklyProgressList">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Recent Study Sessions</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentSessionsList">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions & Recent Notes -->
                <div class="row g-4">
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Quick Actions</h5>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2">
                                    <a href="/roadmap" class="btn btn-primary">
                                        <i class="fas fa-road me-2"></i>Continue Learning
                                    </a>
                                    <a href="/pomodoro" class="btn btn-outline-primary">
                                        <i class="fas fa-clock me-2"></i>Start Pomodoro
                                    </a>
                                    <a href="/notes" class="btn btn-outline-primary">
                                        <i class="fas fa-sticky-note me-2"></i>Add Note
                                    </a>
                                    <button class="btn btn-outline-primary" onclick="askAI()">
                                        <i class="fas fa-robot me-2"></i>Ask AI Assistant
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Recent Notes</h5>
                                <a href="/notes" class="btn btn-sm btn-link">View All</a>
                            </div>
                            <div class="card-body">
                                <div id="recentNotesList">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- AI Assistant Modal -->
    <div class="modal fade" id="aiModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">AI Assistant</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="aiChat" class="mb-3" style="height: 400px; overflow-y: auto;"></div>
                    <form id="aiForm">
                        <div class="input-group">
                            <input type="text" class="form-control" id="aiQuestion"
                                placeholder="Ask me anything about DSA...">
                            <button class="btn btn-primary" type="submit">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/animation.js"></script>

    <script>
        // Load components
        fetch('/components/sidebar.html').then(r => r.text()).then(html => {
            document.getElementById('sidebar-container').innerHTML = html;
            initSidebar();
        });

        fetch('/components/topbar.html').then(r => r.text()).then(html => {
            document.getElementById('topbar-container').innerHTML = html;
        });

        fetch('/components/mobile-nav.html').then(r => r.text()).then(html => {
            document.getElementById('mobile-nav-container').innerHTML = html;
            initMobileNav();
        });

        // Dashboard specific code
        const motivationalQuotes = [
            "The only way to learn a new programming language is by writing programs in it.",
            "First, solve the problem. Then, write the code.",
            "Simplicity is the soul of efficiency.",
            "Make it work, make it right, make it fast.",
            "The best way to predict the future is to implement it.",
            "Every expert was once a beginner.",
            "Code is like humor. When you have to explain it, it's bad.",
            "The computer was born to solve problems that did not exist before."
        ];

        async function loadDashboard() {
            try {
                // Load user data
                const user = auth.getUser();
                document.getElementById('userName').textContent = user.name || 'Learner';

                // Set current date
                document.getElementById('currentDate').textContent =
                    new Date().toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });

                // Set motivational quote
                const today = new Date().getDate();
                const quote = motivationalQuotes[today % motivationalQuotes.length];
                document.getElementById('motivationalQuote').textContent = quote;

                // Load dashboard data
                const data = await api.get('/dashboard');

                // Update stats with animation
                animateNumber(document.getElementById('currentStreak'), 0, data.stats.current_streak, 1000);
                animateNumber(document.getElementById('completionPercentage'), 0, Math.round(data.stats.completion_percentage), 1000);
                animateNumber(document.getElementById('totalStudyTime'), 0, Math.round(data.stats.total_study_time / 60), 1000);
                animateNumber(document.getElementById('completedDays'), 0, data.stats.completed_days, 1000);
                document.getElementById('totalDays').textContent = data.stats.total_days;

                // Load weekly progress
                loadWeeklyProgress(data.weekly_progress);

                // Load recent sessions
                loadRecentSessions(data.recent_sessions);

                // Load recent notes
                loadRecentNotes(data.recent_notes);

            } catch (error) {
                console.error('Dashboard load error:', error);
                showToast('Failed to load dashboard data', 'danger');
            }
        }

        function loadWeeklyProgress(weeklyProgress) {
            const container = document.getElementById('weeklyProgressList');

            if (Object.keys(weeklyProgress).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No progress data yet. Start learning!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = Object.entries(weeklyProgress)
                .slice(0, 6)
                .map(([week, data]) => `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="mb-0">Week ${week}: ${data.title}</h6>
                            <small class="text-muted">${data.completed}/${data.total} days</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: ${data.percentage}%"></div>
                        </div>
                    </div>
                `).join('');
        }

        function loadRecentSessions(sessions) {
            const container = document.getElementById('recentSessionsList');

            if (sessions.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-clock fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No study sessions yet</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sessions.map(session => `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <div>
                        <h6 class="mb-0 small">${session.topic || 'Study Session'}</h6>
                        <small class="text-muted">${formatDate(session.start_time)}</small>
                    </div>
                    <span class="badge bg-primary">${session.duration}m</span>
                </div>
            `).join('');
        }

        function loadRecentNotes(notes) {
            const container = document.getElementById('recentNotesList');

            if (notes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-sticky-note fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No notes yet</p>
                        <a href="/notes" class="btn btn-sm btn-primary">Create First Note</a>
                    </div>
                `;
                return;
            }

            container.innerHTML = notes.map(note => `
                <div class="note-card mb-2">
                    <h6 class="mb-1">${note.title}</h6>
                    <small class="text-muted">Updated ${formatDate(note.updated_at)}</small>
                </div>
            `).join('');
        }

        // AI Assistant
        function askAI() {
            const modal = new bootstrap.Modal(document.getElementById('aiModal'));
            modal.show();
        }

        document.getElementById('aiForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            const question = document.getElementById('aiQuestion').value.trim();
            if (!question) return;

            const chatContainer = document.getElementById('aiChat');

            // Add user message
            chatContainer.innerHTML += `
                <div class="ai-message user-message mb-3">
                    <div class="ai-bubble">${question}</div>
                    <div class="ai-avatar bg-secondary">
                        <i class="fas fa-user"></i>
                    </div>
                </div>
            `;

            // Clear input
            document.getElementById('aiQuestion').value = '';

            // Add loading message
            const loadingId = Date.now();
            chatContainer.innerHTML += `
                <div class="ai-message mb-3" id="loading-${loadingId}">
                    <div class="ai-avatar">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ai-bubble">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Thinking...
                    </div>
                </div>
            `;

            chatContainer.scrollTop = chatContainer.scrollHeight;

            try {
                const response = await api.post('/ai/ask', { question });

                // Remove loading message
                document.getElementById(`loading-${loadingId}`).remove();

                // Add AI response
                chatContainer.innerHTML += `
                    <div class="ai-message mb-3">
                        <div class="ai-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="ai-bubble">${response.answer}</div>
                    </div>
                `;

                if (response.citations && response.citations.length > 0) {
                    chatContainer.innerHTML += `
                        <div class="ai-message mb-3">
                            <div class="ai-avatar">
                                <i class="fas fa-link"></i>
                            </div>
                            <div class="ai-bubble">
                                <small class="text-muted">References:</small>
                                <ul class="mb-0 ps-3">
                                    ${response.citations.map(c =>
                        `<li><a href="${c.url}" target="_blank">${c.title}</a></li>`
                    ).join('')}
                                </ul>
                            </div>
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById(`loading-${loadingId}`).remove();
                chatContainer.innerHTML += `
                    <div class="ai-message mb-3">
                        <div class="ai-avatar bg-danger">
                            <i class="fas fa-exclamation"></i>
                        </div>
                        <div class="ai-bubble bg-danger text-white">
                            Sorry, I couldn't process your question. Please try again.
                        </div>
                    </div>
                `;
            }

            chatContainer.scrollTop = chatContainer.scrollHeight;
        });

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function () {
            loadDashboard();

            // Refresh dashboard every 5 minutes
            setInterval(loadDashboard, 5 * 60 * 1000);
        });
    </script>
</body>

</html>