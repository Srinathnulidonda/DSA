<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - DSA Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>

<body>
    <div class="main-layout">
        <!-- Include Sidebar -->
        <div id="sidebar-container"></div>

        <div class="main-content">
            <!-- Include Topbar -->
            <div id="topbar-container"></div>

            <div class="content-area">
                <!-- Welcome Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="animate-fadeInLeft">
                                <h2 class="fw-bold text-dark mb-1">Good <span id="greeting-time">morning</span>, <span
                                        id="user-greeting">there</span>! ðŸ‘‹</h2>
                                <p class="text-muted mb-0">Ready to continue your DSA journey today?</p>
                            </div>
                            <div class="d-none d-md-block animate-fadeInRight">
                                <div class="text-end">
                                    <div class="badge-streak badge-custom">
                                        <i class="fas fa-fire me-1"></i>
                                        <span id="current-streak">0</span> day streak
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Cards -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card hover-lift animate-fadeInUp">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="text-muted mb-1">Overall Progress</div>
                                    <h3 class="fw-bold text-primary mb-2" id="overall-progress">0%</h3>
                                    <div class="progress-bar-custom">
                                        <div class="progress-fill progress-fill-animation" id="progress-bar"
                                            style="width: 0%"></div>
                                    </div>
                                </div>
                                <div class="text-primary">
                                    <i class="fas fa-chart-line fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card hover-lift animate-fadeInUp animation-delay-100">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="text-muted mb-1">Current Streak</div>
                                    <h3 class="fw-bold text-warning mb-2">
                                        <i class="fas fa-fire me-1"></i>
                                        <span id="streak-days">0</span> days
                                    </h3>
                                    <small class="text-muted">Longest: <span id="longest-streak">0</span> days</small>
                                </div>
                                <div class="text-warning">
                                    <i class="fas fa-fire fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card hover-lift animate-fadeInUp animation-delay-200">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="text-muted mb-1">Study Time</div>
                                    <h3 class="fw-bold text-success mb-2" id="total-study-time">0h</h3>
                                    <small class="text-muted">This week: <span id="week-study-time">0h</span></small>
                                </div>
                                <div class="text-success">
                                    <i class="fas fa-clock fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-3 col-md-6">
                        <div class="stats-card hover-lift animate-fadeInUp animation-delay-300">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <div class="text-muted mb-1">Completed Topics</div>
                                    <h3 class="fw-bold text-info mb-2" id="completed-topics">0/98</h3>
                                    <small class="text-muted">Daily topics</small>
                                </div>
                                <div class="text-info">
                                    <i class="fas fa-check-circle fs-2"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Overview & Quick Actions -->
                <div class="row g-4 mb-4">
                    <div class="col-lg-8">
                        <div class="stats-card animate-fadeInLeft">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="fw-bold mb-0">Weekly Progress</h5>
                                <a href="/progress" class="btn btn-sm btn-outline-primary">
                                    View All <i class="fas fa-arrow-right ms-1"></i>
                                </a>
                            </div>
                            <div id="weekly-progress-container">
                                <div class="text-center py-4">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <p class="text-muted">Loading progress...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="stats-card animate-fadeInRight">
                            <h5 class="fw-bold mb-4">Quick Actions</h5>
                            <div class="d-grid gap-3">
                                <a href="/roadmap" class="btn btn-outline-primary btn-icon">
                                    <i class="fas fa-route"></i>
                                    <span>Continue Learning</span>
                                </a>
                                <a href="/pomodoro" class="btn btn-outline-success btn-icon">
                                    <i class="fas fa-play"></i>
                                    <span>Start Pomodoro</span>
                                </a>
                                <a href="/notes" class="btn btn-outline-info btn-icon">
                                    <i class="fas fa-plus"></i>
                                    <span>Add Note</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Today's Focus & Recent Activity -->
                <div class="row g-4">
                    <div class="col-lg-6">
                        <div class="stats-card animate-fadeInUp">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="fw-bold mb-0">Today's Focus</h5>
                                <span class="badge bg-primary" id="current-week-badge">Week 1</span>
                            </div>
                            <div id="today-focus-container">
                                <div class="text-center py-4">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <p class="text-muted">Loading today's focus...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="stats-card animate-fadeInUp animation-delay-200">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h5 class="fw-bold mb-0">Recent Activity</h5>
                                <a href="/analytics" class="btn btn-sm btn-outline-primary">View More</a>
                            </div>
                            <div id="recent-activity-container">
                                <div class="text-center py-4">
                                    <div class="loading-spinner mx-auto mb-2"></div>
                                    <p class="text-muted">Loading recent activity...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Motivational Quote -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="stats-card text-center animate-fadeInUp"
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <div class="py-3">
                                <i class="fas fa-quote-left fs-3 mb-3 opacity-75"></i>
                                <h4 class="fw-light mb-3" id="daily-quote">Loading motivational quote...</h4>
                                <p class="mb-0 opacity-75" id="quote-author">- Anonymous</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Include Mobile Navigation -->
        <div id="mobile-nav-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let dashboardData = {};

        document.addEventListener('DOMContentLoaded', function () {
            checkAuth();
            loadComponents();
            initializeDashboard();
        });

        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = '/login';
                return;
            }
        }

        async function loadComponents() {
            try {
                // Load sidebar
                const sidebarResponse = await fetch('../components/sidebar.html');
                const sidebarHtml = await sidebarResponse.text();
                document.getElementById('sidebar-container').innerHTML = sidebarHtml;

                // Load topbar
                const topbarResponse = await fetch('../components/topbar.html');
                const topbarHtml = await topbarResponse.text();
                document.getElementById('topbar-container').innerHTML = topbarHtml;

                // Load mobile nav
                const mobileNavResponse = await fetch('../components/mobile-nav.html');
                const mobileNavHtml = await mobileNavResponse.text();
                document.getElementById('mobile-nav-container').innerHTML = mobileNavHtml;

                // Execute scripts in loaded components
                executeScripts();
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        function executeScripts() {
            // Re-execute navigation scripts
            setActiveNavItem();
            setActiveMobileNavItem();
            updatePageTitle();
            loadUserData();
        }

        async function initializeDashboard() {
            try {
                setGreeting();
                await loadDashboardData();
                updateStats();
                loadWeeklyProgress();
                loadTodaysFocus();
                loadRecentActivity();
                loadDailyQuote();
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                showErrorMessage('Failed to load dashboard data');
            }
        }

        function setGreeting() {
            const now = new Date();
            const hour = now.getHours();
            const greetingElement = document.getElementById('greeting-time');
            const userElement = document.getElementById('user-greeting');

            let greeting = 'morning';
            if (hour >= 12 && hour < 17) greeting = 'afternoon';
            else if (hour >= 17) greeting = 'evening';

            greetingElement.textContent = greeting;

            // Get user name from localStorage
            const userData = JSON.parse(localStorage.getItem('user_data') || '{}');
            userElement.textContent = userData.name ? userData.name.split(' ')[0] : 'there';
        }

        async function loadDashboardData() {
            const token = localStorage.getItem('access_token');

            try {
                const response = await fetch(`${API_BASE}/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    dashboardData = await response.json();
                } else if (response.status === 401) {
                    // Token expired, redirect to login
                    localStorage.clear();
                    window.location.href = '/login';
                } else {
                    throw new Error('Failed to load dashboard data');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                // Show fallback data
                dashboardData = {
                    stats: {
                        completion_percentage: 0,
                        current_streak: 0,
                        longest_streak: 0,
                        total_study_time: 0,
                        study_time_last_7_days: 0,
                        completed_days: 0,
                        total_days: 98
                    },
                    weekly_progress: {},
                    recent_sessions: [],
                    recent_notes: []
                };
            }
        }

        function updateStats() {
            const stats = dashboardData.stats;

            // Overall progress with animation
            const progressElement = document.getElementById('overall-progress');
            const progressBar = document.getElementById('progress-bar');
            const completionPercentage = Math.round(stats.completion_percentage || 0);

            animateNumber(progressElement, 0, completionPercentage, '%');
            progressBar.style.width = `${completionPercentage}%`;

            // Streak
            const streakElement = document.getElementById('streak-days');
            const longestStreakElement = document.getElementById('longest-streak');
            const currentStreakElement = document.getElementById('current-streak');

            animateNumber(streakElement, 0, stats.current_streak || 0);
            longestStreakElement.textContent = stats.longest_streak || 0;
            currentStreakElement.textContent = stats.current_streak || 0;

            // Study time
            const totalTimeElement = document.getElementById('total-study-time');
            const weekTimeElement = document.getElementById('week-study-time');

            totalTimeElement.textContent = formatTime(stats.total_study_time || 0);
            weekTimeElement.textContent = formatTime(stats.study_time_last_7_days || 0);

            // Completed topics
            const completedTopicsElement = document.getElementById('completed-topics');
            completedTopicsElement.textContent = `${stats.completed_days || 0}/${stats.total_days || 98}`;
        }

        function animateNumber(element, start, end, suffix = '') {
            const duration = 1000;
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;

            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.round(current) + suffix;
            }, 16);
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;

            if (hours > 0) {
                return `${hours}h ${remainingMinutes}m`;
            }
            return `${minutes}m`;
        }

        async function loadWeeklyProgress() {
            const container = document.getElementById('weekly-progress-container');

            if (!dashboardData.weekly_progress || Object.keys(dashboardData.weekly_progress).length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fs-2 text-muted mb-3"></i>
                        <p class="text-muted">Start your learning journey to see progress here!</p>
                        <a href="/roadmap" class="btn btn-primary">Start Learning</a>
                    </div>
                `;
                return;
            }

            let html = '<div class="row g-3">';

            Object.entries(dashboardData.weekly_progress).forEach(([week, data]) => {
                const progress = data.percentage || 0;
                const isActive = progress > 0 && progress < 100;

                html += `
                    <div class="col-md-6 col-lg-4">
                        <div class="p-3 border rounded hover-lift ${isActive ? 'border-primary' : ''}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="fw-semibold mb-0">Week ${week}</h6>
                                <span class="badge ${progress === 100 ? 'bg-success' : progress > 0 ? 'bg-primary' : 'bg-light text-dark'}">${Math.round(progress)}%</span>
                            </div>
                            <p class="text-muted small mb-2">${data.title}</p>
                            <div class="progress-bar-custom">
                                <div class="progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <small class="text-muted">${data.completed}/${data.total} days completed</small>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        async function loadTodaysFocus() {
            const container = document.getElementById('today-focus-container');

            try {
                // Get current week/day based on progress
                const currentWeek = getCurrentWeek();
                const currentDay = getCurrentDay();

                if (!currentWeek || !currentDay) {
                    container.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-trophy fs-2 text-success mb-3"></i>
                            <h6 class="fw-semibold">Congratulations!</h6>
                            <p class="text-muted mb-0">You've completed your learning journey!</p>
                        </div>
                    `;
                    return;
                }

                document.getElementById('current-week-badge').textContent = `Week ${currentWeek}`;

                container.innerHTML = `
                    <div class="d-flex align-items-start">
                        <div class="me-3">
                            <div class="completion-toggle" onclick="quickToggleCompletion(${currentWeek}, '${currentDay}')">
                                <i class="fas fa-check" style="display: none;"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="fw-semibold mb-1">${currentDay}: Arrays & String Fundamentals</h6>
                            <p class="text-muted mb-2">Focus on basic array operations and string manipulation</p>
                            <div class="d-flex gap-2">
                                <span class="badge bg-light text-dark">Arrays</span>
                                <span class="badge bg-light text-dark">Strings</span>
                                <span class="badge bg-light text-dark">90 min</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 pt-3 border-top">
                        <a href="/roadmap" class="btn btn-sm btn-primary">
                            <i class="fas fa-play me-1"></i>Start Learning
                        </a>
                        <a href="/pomodoro" class="btn btn-sm btn-outline-success ms-2">
                            <i class="fas fa-clock me-1"></i>Pomodoro
                        </a>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading today\'s focus:', error);
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-exclamation-triangle text-warning mb-2"></i>
                        <p class="text-muted mb-0">Unable to load today's focus</p>
                    </div>
                `;
            }
        }

        function getCurrentWeek() {
            // Logic to determine current week based on progress
            const weeklyProgress = dashboardData.weekly_progress || {};

            for (let week = 1; week <= 14; week++) {
                const weekData = weeklyProgress[week];
                if (!weekData || weekData.percentage < 100) {
                    return week;
                }
            }

            return null; // All weeks completed
        }

        function getCurrentDay() {
            // Return current day of the week for focus
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const today = new Date().getDay();
            return days[today === 0 ? 6 : today - 1]; // Convert Sunday (0) to Saturday (6)
        }

        function loadRecentActivity() {
            const container = document.getElementById('recent-activity-container');
            const recentSessions = dashboardData.recent_sessions || [];
            const recentNotes = dashboardData.recent_notes || [];

            if (recentSessions.length === 0 && recentNotes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-history fs-2 text-muted mb-3"></i>
                        <p class="text-muted">No recent activity</p>
                        <small class="text-muted">Start studying to see your activity here</small>
                    </div>
                `;
                return;
            }

            let html = '<div class="activity-list">';

            // Combine and sort activities
            const activities = [];

            recentSessions.forEach(session => {
                activities.push({
                    type: 'session',
                    time: session.start_time,
                    data: session
                });
            });

            recentNotes.forEach(note => {
                activities.push({
                    type: 'note',
                    time: note.updated_at,
                    data: note
                });
            });

            activities.sort((a, b) => new Date(b.time) - new Date(a.time));

            activities.slice(0, 5).forEach(activity => {
                const timeAgo = getTimeAgo(activity.time);

                if (activity.type === 'session') {
                    const session = activity.data;
                    html += `
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-clock text-success"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">Pomodoro Session</div>
                                <small class="text-muted">${session.topic || 'Study session'} â€¢ ${session.duration} min â€¢ ${timeAgo}</small>
                            </div>
                        </div>
                    `;
                } else {
                    const note = activity.data;
                    html += `
                        <div class="d-flex align-items-center mb-3">
                            <div class="me-3">
                                <i class="fas fa-sticky-note text-info"></i>
                            </div>
                            <div class="flex-grow-1">
                                <div class="fw-semibold">${note.title}</div>
                                <small class="text-muted">Note updated â€¢ ${timeAgo}</small>
                            </div>
                        </div>
                    `;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }

        function getTimeAgo(dateString) {
            const now = new Date();
            const date = new Date(dateString);
            const diffInSeconds = Math.floor((now - date) / 1000);

            if (diffInSeconds < 60) return 'Just now';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;

            return date.toLocaleDateString();
        }

        function loadDailyQuote() {
            const quotes = [
                { text: "The best time to plant a tree was 20 years ago. The second best time is now.", author: "Chinese Proverb" },
                { text: "Code is like humor. When you have to explain it, it's bad.", author: "Cory House" },
                { text: "First, solve the problem. Then, write the code.", author: "John Johnson" },
                { text: "The only way to learn a new programming language is by writing programs in it.", author: "Dennis Ritchie" },
                { text: "Talk is cheap. Show me the code.", author: "Linus Torvalds" },
                { text: "Programs must be written for people to read, and only incidentally for machines to execute.", author: "Harold Abelson" },
                { text: "The best error message is the one that never shows up.", author: "Thomas Fuchs" },
                { text: "Debugging is twice as hard as writing the code in the first place.", author: "Brian Kernighan" }
            ];

            // Deterministic quote based on date
            const today = new Date().toDateString();
            const quoteIndex = hashCode(today) % quotes.length;
            const quote = quotes[Math.abs(quoteIndex)];

            document.getElementById('daily-quote').textContent = quote.text;
            document.getElementById('quote-author').textContent = `- ${quote.author}`;
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32-bit integer
            }
            return hash;
        }

        async function quickToggleCompletion(week, day) {
            const toggle = event.currentTarget;
            const icon = toggle.querySelector('i');

            try {
                const token = localStorage.getItem('access_token');
                const response = await fetch(`${API_BASE}/progress`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        week: week,
                        day: day,
                        completed: !toggle.classList.contains('completed')
                    })
                });

                if (response.ok) {
                    toggle.classList.toggle('completed');
                    if (toggle.classList.contains('completed')) {
                        icon.style.display = 'block';
                        showSuccessToast('Great job! Keep up the momentum! ðŸŽ‰');
                    } else {
                        icon.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error toggling completion:', error);
            }
        }

        function showSuccessToast(message) {
            // Create toast notification
            const toast = document.createElement('div');
            toast.className = 'position-fixed top-0 end-0 p-3';
            toast.style.zIndex = '1060';
            toast.innerHTML = `
                <div class="toast show animate-slideInDown" role="alert">
                    <div class="toast-header bg-success text-white">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong class="me-auto">Success</strong>
                        <button type="button" class="btn-close btn-close-white" onclick="this.closest('.toast').remove()"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        function showErrorMessage(message) {
            const container = document.querySelector('.content-area');
            const alert = document.createElement('div');
            alert.className = 'alert-custom alert-error-custom animate-fadeInDown';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <span>${message}</span>
            `;

            container.insertBefore(alert, container.firstChild);

            setTimeout(() => {
                alert.remove();
            }, 5000);
        }
    </script>
</body>

</html>