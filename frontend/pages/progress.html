<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress - DSA Learning Platform</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/animation.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body class="bg-gray-50">
    <!-- Include same navigation as other pages -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top" id="topNav">
        <!-- Same as calendar page -->
    </nav>

    <div class="d-flex">
        <!-- Include same sidebar as other pages -->
        <nav class="sidebar bg-white shadow-sm" id="sidebar">
            <!-- Same as calendar page but with progress active -->
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid p-4">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h1 class="h3 mb-0">Progress Analytics</h1>
                        <p class="text-muted mb-0">Track your learning journey and achievements</p>
                    </div>
                </div>

                <!-- Overall Stats -->
                <div class="row mb-4">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card border-0 shadow-sm stats-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">Completion Rate</h6>
                                        <h3 class="mb-0" id="completionRate">0%</h3>
                                    </div>
                                    <div class="stats-icon bg-primary bg-opacity-10">
                                        <i class="fas fa-chart-pie text-primary"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card border-0 shadow-sm stats-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">Total Study Hours</h6>
                                        <h3 class="mb-0" id="totalHours">0</h3>
                                    </div>
                                    <div class="stats-icon bg-success bg-opacity-10">
                                        <i class="fas fa-clock text-success"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card border-0 shadow-sm stats-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">Weeks Completed</h6>
                                        <h3 class="mb-0"><span id="weeksCompleted">0</span>/14</h3>
                                    </div>
                                    <div class="stats-icon bg-info bg-opacity-10">
                                        <i class="fas fa-calendar-check text-info"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-3 col-sm-6 mb-3">
                        <div class="card border-0 shadow-sm stats-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="text-muted mb-2">Average Daily Time</h6>
                                        <h3 class="mb-0" id="avgDailyTime">0m</h3>
                                    </div>
                                    <div class="stats-icon bg-warning bg-opacity-10">
                                        <i class="fas fa-chart-bar text-warning"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="row mb-4">
                    <!-- Progress Timeline -->
                    <div class="col-lg-8 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Study Activity Timeline</h5>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary active"
                                            data-range="week">Week</button>
                                        <button type="button" class="btn btn-outline-primary"
                                            data-range="month">Month</button>
                                        <button type="button" class="btn btn-outline-primary" data-range="all">All
                                            Time</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="activityChart" height="100"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Topic Distribution -->
                    <div class="col-lg-4 mb-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0">Topic Distribution</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="topicChart" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Breakdown -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0">Weekly Progress Breakdown</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Week</th>
                                                <th>Topic</th>
                                                <th>Progress</th>
                                                <th>Time Spent</th>
                                                <th>Status</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody id="weeklyBreakdown">
                                            <tr>
                                                <td colspan="6" class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Achievements Section -->
                <div class="row">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-white border-0 py-3">
                                <h5 class="mb-0">Achievements & Milestones</h5>
                            </div>
                            <div class="card-body">
                                <div class="row" id="achievements">
                                    <!-- Dynamically populated -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Include Mobile Navigation -->
    <nav class="mobile-nav d-lg-none">
        <!-- Same as other pages -->
    </nav>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/components.js"></script>

    <script>
        let progressData = {};
        let roadmapData = [];
        let pomodoroData = [];

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadAllData();
            updateStats();
            renderCharts();
            renderWeeklyBreakdown();
            renderAchievements();
        });

        async function loadAllData() {
            try {
                // Load progress
                const progressResponse = await fetchWithAuth(`${API_BASE}/progress`);
                if (progressResponse.ok) {
                    const data = await progressResponse.json();
                    progressData = data.progress;
                }

                // Load roadmap
                const roadmapResponse = await fetchWithAuth(`${API_BASE}/roadmap`);
                if (roadmapResponse.ok) {
                    const data = await roadmapResponse.json();
                    roadmapData = data.roadmap;
                }

                // Load pomodoro history
                const pomodoroResponse = await fetchWithAuth(`${API_BASE}/pomodoro/history`);
                if (pomodoroResponse.ok) {
                    const data = await pomodoroResponse.json();
                    pomodoroData = data.sessions;
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                showToast('Failed to load progress data', 'error');
            }
        }

        function updateStats() {
            let completedDays = 0;
            let totalDays = 0;
            let totalMinutes = 0;
            let completedWeeks = 0;

            roadmapData.forEach(week => {
                let weekCompleted = true;
                week.days.forEach(day => {
                    totalDays++;
                    if (progressData[week.week]?.[day.day]?.completed) {
                        completedDays++;
                        totalMinutes += progressData[week.week][day.day].time_spent || 0;
                    } else {
                        weekCompleted = false;
                    }
                });
                if (weekCompleted && week.days.length > 0) {
                    completedWeeks++;
                }
            });

            const completionRate = totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;
            const totalHours = Math.floor(totalMinutes / 60);
            const avgDailyMinutes = completedDays > 0 ? Math.round(totalMinutes / completedDays) : 0;

            document.getElementById('completionRate').textContent = `${completionRate}%`;
            document.getElementById('totalHours').textContent = totalHours;
            document.getElementById('weeksCompleted').textContent = completedWeeks;
            document.getElementById('avgDailyTime').textContent = formatTime(avgDailyMinutes);
        }

        function renderCharts() {
            renderActivityChart();
            renderTopicChart();
        }

        function renderActivityChart() {
            const ctx = document.getElementById('activityChart').getContext('2d');

            // Generate last 30 days of data
            const labels = [];
            const data = [];
            const today = new Date();

            for (let i = 29; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                // Calculate minutes for this day
                let dayMinutes = 0;
                pomodoroData.forEach(session => {
                    const sessionDate = new Date(session.start_time);
                    if (sessionDate.toDateString() === date.toDateString() && session.completed) {
                        dayMinutes += session.duration;
                    }
                });
                data.push(dayMinutes);
            }

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Study Time (minutes)',
                        data: data,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value + ' min';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTopicChart() {
            const ctx = document.getElementById('topicChart').getContext('2d');

            // Calculate topic distribution
            const topicCounts = {
                'Fundamentals': 0,
                'Data Structures': 0,
                'Algorithms': 0,
                'Advanced Topics': 0
            };

            roadmapData.forEach(week => {
                week.days.forEach(day => {
                    if (progressData[week.week]?.[day.day]?.completed) {
                        if (week.week <= 2) topicCounts['Fundamentals']++;
                        else if (week.week <= 8) topicCounts['Data Structures']++;
                        else if (week.week <= 12) topicCounts['Algorithms']++;
                        else topicCounts['Advanced Topics']++;
                    }
                });
            });

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(topicCounts),
                    datasets: [{
                        data: Object.values(topicCounts),
                        backgroundColor: [
                            '#6366f1',
                            '#10b981',
                            '#f59e0b',
                            '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function renderWeeklyBreakdown() {
            const tbody = document.getElementById('weeklyBreakdown');

            tbody.innerHTML = roadmapData.map(week => {
                let completedDays = 0;
                let totalTime = 0;

                week.days.forEach(day => {
                    if (progressData[week.week]?.[day.day]?.completed) {
                        completedDays++;
                        totalTime += progressData[week.week][day.day].time_spent || 0;
                    }
                });

                const progressPercent = Math.round((completedDays / week.days.length) * 100);
                const status = progressPercent === 100 ? 'Completed' :
                    progressPercent > 0 ? 'In Progress' : 'Not Started';
                const statusClass = progressPercent === 100 ? 'success' :
                    progressPercent > 0 ? 'warning' : 'secondary';

                return `
                    <tr>
                        <td>Week ${week.week}</td>
                        <td>${week.title}</td>
                        <td>
                            <div class="progress" style="height: 10px; min-width: 100px;">
                                <div class="progress-bar bg-${statusClass}" style="width: ${progressPercent}%"></div>
                            </div>
                            <small class="text-muted">${completedDays}/${week.days.length} days</small>
                        </td>
                        <td>${formatTime(totalTime)}</td>
                        <td>
                            <span class="badge bg-${statusClass}">${status}</span>
                        </td>
                        <td>
                            <a href="roadmap.html?week=${week.week}" class="btn btn-sm btn-outline-primary">
                                View Details
                            </a>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderAchievements() {
            const container = document.getElementById('achievements');

            const achievements = [
                {
                    id: 'first_day',
                    icon: 'star',
                    title: 'First Day',
                    description: 'Complete your first day',
                    earned: Object.keys(progressData).length > 0,
                    color: 'warning'
                },
                {
                    id: 'week_complete',
                    icon: 'calendar-check',
                    title: 'Week Complete',
                    description: 'Complete an entire week',
                    earned: roadmapData.some(week => {
                        return week.days.every(day =>
                            progressData[week.week]?.[day.day]?.completed
                        );
                    }),
                    color: 'success'
                },
                {
                    id: 'halfway',
                    icon: 'trophy',
                    title: 'Halfway There',
                    description: 'Complete 50% of the course',
                    earned: document.getElementById('completionRate').textContent.includes('5'),
                    color: 'info'
                },
                {
                    id: 'consistent',
                    icon: 'fire',
                    title: 'Consistency King',
                    description: 'Maintain a 7-day streak',
                    earned: false, // Would need streak data
                    color: 'danger'
                }
            ];

            container.innerHTML = achievements.map(achievement => `
                <div class="col-md-6 col-lg-3 mb-3">
                    <div class="card h-100 ${achievement.earned ? '' : 'opacity-50'}">
                        <div class="card-body text-center">
                            <div class="mb-3">
                                <div class="bg-${achievement.color} bg-opacity-10 rounded-circle d-inline-flex p-3">
                                    <i class="fas fa-${achievement.icon} text-${achievement.color} fs-3"></i>
                                </div>
                            </div>
                            <h6 class="mb-2">${achievement.title}</h6>
                            <p class="text-muted small mb-0">${achievement.description}</p>
                            ${achievement.earned ?
                    '<i class="fas fa-check-circle text-success mt-2"></i>' :
                    '<i class="fas fa-lock text-muted mt-2"></i>'
                }
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Time range selector
        document.querySelectorAll('[data-range]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('[data-range]').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                // Re-render chart with selected range
                renderActivityChart(e.target.dataset.range);
            });
        });
    </script>
</body>

</html>