<div class="container-fluid p-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="h3 fw-bold mb-1">
                        <i class="fas fa-chart-line text-success me-2"></i>
                        Progress Tracking
                    </h1>
                    <p class="text-muted mb-0">Monitor your learning journey and achievements</p>
                </div>
                <div class="d-flex gap-2 mt-3 mt-lg-0">
                    <button class="btn btn-outline-primary" id="export-progress-btn">
                        <i class="fas fa-download me-2"></i>Export Report
                    </button>
                    <button class="btn btn-primary" id="set-goals-btn">
                        <i class="fas fa-bullseye me-2"></i>Set Goals
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overview Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="icon-box bg-primary bg-opacity-10 text-primary rounded-circle p-3">
                            <i class="fas fa-percentage fa-lg"></i>
                        </div>
                        <span class="badge bg-primary" id="progress-change">+0%</span>
                    </div>
                    <h3 class="h4 fw-bold mb-1" id="overall-progress">0%</h3>
                    <p class="text-muted mb-0">Overall Progress</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="icon-box bg-success bg-opacity-10 text-success rounded-circle p-3">
                            <i class="fas fa-check-double fa-lg"></i>
                        </div>
                        <span class="badge bg-success" id="completed-change">+0</span>
                    </div>
                    <h3 class="h4 fw-bold mb-1" id="completed-days">0</h3>
                    <p class="text-muted mb-0">Days Completed</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="icon-box bg-warning bg-opacity-10 text-warning rounded-circle p-3">
                            <i class="fas fa-clock fa-lg"></i>
                        </div>
                        <span class="badge bg-warning text-dark" id="hours-change">+0h</span>
                    </div>
                    <h3 class="h4 fw-bold mb-1" id="total-hours">0h</h3>
                    <p class="text-muted mb-0">Study Time</p>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="icon-box bg-info bg-opacity-10 text-info rounded-circle p-3">
                            <i class="fas fa-fire fa-lg"></i>
                        </div>
                        <span class="badge bg-info" id="streak-status">Active</span>
                    </div>
                    <h3 class="h4 fw-bold mb-1" id="current-streak">0</h3>
                    <p class="text-muted mb-0">Day Streak</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-area me-2"></i>Weekly Activity
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="chart-period" id="week-view" checked>
                        <label class="btn btn-outline-primary" for="week-view">Week</label>
                        <input type="radio" class="btn-check" name="chart-period" id="month-view">
                        <label class="btn btn-outline-primary" for="month-view">Month</label>
                        <input type="radio" class="btn-check" name="chart-period" id="year-view">
                        <label class="btn btn-outline-primary" for="year-view">Year</label>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="activity-chart" height="300"></canvas>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Topic Distribution
                    </h5>
                </div>
                <div class="card-body">
                    <canvas id="topic-chart" height="300"></canvas>
                    <div id="topic-legend" class="mt-3">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Week-by-Week Progress -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-week me-2"></i>Week-by-Week Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div id="weekly-progress-container">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Achievements Section -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-trophy me-2 text-warning"></i>Achievements
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3" id="achievements-container">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Goals Modal -->
<div class="modal fade" id="goalsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Set Learning Goals</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="goals-form">
                    <div class="mb-3">
                        <label for="daily-goal" class="form-label">Daily Study Goal (minutes)</label>
                        <input type="number" class="form-control" id="daily-goal" min="15" max="480" value="60">
                        <div class="form-text">How many minutes do you want to study each day?</div>
                    </div>
                    <div class="mb-3">
                        <label for="weekly-goal" class="form-label">Weekly Completion Goal</label>
                        <select class="form-select" id="weekly-goal">
                            <option value="5">5 days per week</option>
                            <option value="6" selected>6 days per week</option>
                            <option value="7">7 days per week</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="target-date" class="form-label">Target Completion Date</label>
                        <input type="date" class="form-control" id="target-date">
                        <div class="form-text">When do you want to complete the 14-week program?</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-goals-btn">Save Goals</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        let progressData = {};
        let stats = {};
        let activityChart = null;
        let topicChart = null;

        // Initialize
        await loadProgressData();
        setupEventListeners();
        renderCharts();
        renderWeeklyProgress();
        renderAchievements();

        async function loadProgressData() {
            try {
                Components.loading.overlay(document.querySelector('.container-fluid'), true);

                const response = await ApiMethods.progress.get();
                progressData = response.progress || {};
                stats = response.stats || {};

                updateProgressCards();

                console.log('Progress data loaded:', progressData);

            } catch (error) {
                console.error('Failed to load progress:', error);
                Notifications.error('Failed to load progress data');
            } finally {
                Components.loading.overlay(document.querySelector('.container-fluid'), false);
            }
        }

        function updateProgressCards() {
            // Calculate overall progress
            const totalDays = 14 * 7; // 14 weeks * 7 days
            let completedDays = 0;
            let totalStudyTime = 0;

            Object.values(progressData).forEach(week => {
                Object.values(week).forEach(day => {
                    if (day.completed) completedDays++;
                    totalStudyTime += day.time_spent || 0;
                });
            });

            const overallProgress = Math.round((completedDays / totalDays) * 100);

            // Update cards
            document.getElementById('overall-progress').textContent = overallProgress + '%';
            document.getElementById('completed-days').textContent = completedDays;
            document.getElementById('total-hours').textContent = Utils.time.formatDuration(totalStudyTime * 60);
            document.getElementById('current-streak').textContent = stats.current_streak || 0;

            // Calculate changes (simulated for demo)
            document.getElementById('progress-change').textContent = '+2%';
            document.getElementById('completed-change').textContent = '+3';
            document.getElementById('hours-change').textContent = '+2h';

            // Streak status
            if (stats.current_streak > 0) {
                document.getElementById('streak-status').textContent = 'Active';
                document.getElementById('streak-status').className = 'badge bg-success';
            } else {
                document.getElementById('streak-status').textContent = 'Inactive';
                document.getElementById('streak-status').className = 'badge bg-secondary';
            }
        }

        function renderCharts() {
            renderActivityChart();
            renderTopicChart();
        }

        function renderActivityChart() {
            const ctx = document.getElementById('activity-chart').getContext('2d');

            // Prepare data for last 7 days
            const last7Days = [];
            const studyHours = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short' }));

                // Calculate study hours for that day (simulated data)
                studyHours.push(Math.random() * 3 + 0.5);
            }

            activityChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days,
                    datasets: [{
                        label: 'Study Hours',
                        data: studyHours,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.parsed.y.toFixed(1)} hours`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return value + 'h';
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderTopicChart() {
            const ctx = document.getElementById('topic-chart').getContext('2d');

            // Calculate topic distribution from progress data
            const topicCounts = {};
            const weekTopics = [
                'Arrays & Strings', 'Linked Lists', 'Stacks & Queues',
                'Trees', 'BST', 'Heaps', 'Hashing', 'Graphs',
                'Advanced Graphs', 'Sorting', 'Recursion', 'DP', 'Advanced'
            ];

            Object.entries(progressData).forEach(([weekNum, weekData]) => {
                const weekIndex = parseInt(weekNum) - 1;
                if (weekIndex < weekTopics.length) {
                    const topic = weekTopics[weekIndex];
                    const completed = Object.values(weekData).filter(day => day.completed).length;
                    topicCounts[topic] = completed;
                }
            });

            // Get top 5 topics
            const sortedTopics = Object.entries(topicCounts)
                .sort(([, a], [, b]) => b - a)
                .slice(0, 5);

            const labels = sortedTopics.map(([topic]) => topic);
            const data = sortedTopics.map(([, count]) => count);
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'
            ];

            topicChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${context.parsed} days`;
                                }
                            }
                        }
                    }
                }
            });

            // Custom legend
            const legendContainer = document.getElementById('topic-legend');
            legendContainer.innerHTML = labels.map((label, index) => `
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="d-flex align-items-center">
                    <div class="rounded-circle me-2" style="width: 12px; height: 12px; background-color: ${colors[index]}"></div>
                    <small>${label}</small>
                </div>
                <small class="text-muted">${data[index]} days</small>
            </div>
        `).join('');
        }

        function renderWeeklyProgress() {
            const container = document.getElementById('weekly-progress-container');
            const weeklyData = [];

            // Get roadmap data from backend
            fetch(`${API_BASE}/roadmap`)
                .then(res => res.json())
                .then(({ roadmap }) => {
                    roadmap.forEach(week => {
                        const weekProgress = progressData[week.week] || {};
                        const completedDays = Object.values(weekProgress).filter(day => day.completed).length;
                        const totalDays = week.days.length;
                        const percentage = totalDays > 0 ? (completedDays / totalDays) * 100 : 0;

                        weeklyData.push({
                            week: week.week,
                            title: week.title,
                            completed: completedDays,
                            total: totalDays,
                            percentage: percentage
                        });
                    });

                    container.innerHTML = weeklyData.map(week => `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <div>
                                <strong>Week ${week.week}: ${week.title}</strong>
                                <span class="ms-2 badge ${week.percentage === 100 ? 'bg-success' : week.percentage > 0 ? 'bg-warning' : 'bg-secondary'}">
                                    ${week.completed}/${week.total} days
                                </span>
                            </div>
                            <span class="text-muted">${Math.round(week.percentage)}%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-gradient" 
                                 style="width: ${week.percentage}%"
                                 role="progressbar"></div>
                        </div>
                    </div>
                `).join('');
                })
                .catch(error => {
                    console.error('Failed to load roadmap:', error);
                    container.innerHTML = '<p class="text-muted">Failed to load weekly progress</p>';
                });
        }

        function renderAchievements() {
            const container = document.getElementById('achievements-container');

            // Define achievements based on progress
            const achievements = [
                {
                    id: 'first_day',
                    title: 'First Step',
                    description: 'Complete your first day',
                    icon: 'fas fa-shoe-prints',
                    color: 'success',
                    unlocked: Object.values(progressData).some(week =>
                        Object.values(week).some(day => day.completed)
                    )
                },
                {
                    id: 'week_complete',
                    title: 'Week Warrior',
                    description: 'Complete an entire week',
                    icon: 'fas fa-calendar-check',
                    color: 'primary',
                    unlocked: Object.values(progressData).some(week =>
                        Object.values(week).filter(day => day.completed).length === 7
                    )
                },
                {
                    id: 'streak_7',
                    title: 'Week Streak',
                    description: 'Maintain a 7-day streak',
                    icon: 'fas fa-fire',
                    color: 'warning',
                    unlocked: (stats.longest_streak || 0) >= 7
                },
                {
                    id: 'half_way',
                    title: 'Halfway There',
                    description: 'Complete 50% of the program',
                    icon: 'fas fa-star-half-alt',
                    color: 'info',
                    unlocked: calculateOverallProgress() >= 50
                },
                {
                    id: 'early_bird',
                    title: 'Early Bird',
                    description: 'Study before 7 AM',
                    icon: 'fas fa-sun',
                    color: 'warning',
                    unlocked: false // Would need session time data
                },
                {
                    id: 'night_owl',
                    title: 'Night Owl',
                    description: 'Study after 10 PM',
                    icon: 'fas fa-moon',
                    color: 'dark',
                    unlocked: false // Would need session time data
                }
            ];

            container.innerHTML = achievements.map(achievement => `
            <div class="col-lg-4 col-md-6">
                <div class="achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'} p-3 rounded border">
                    <div class="d-flex align-items-center">
                        <div class="achievement-icon bg-${achievement.color} bg-opacity-10 text-${achievement.color} rounded-circle p-3 me-3">
                            <i class="${achievement.icon} fa-lg"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1 ${!achievement.unlocked ? 'text-muted' : ''}">${achievement.title}</h6>
                            <small class="text-muted">${achievement.description}</small>
                        </div>
                        ${achievement.unlocked ? '<i class="fas fa-check-circle text-success fa-lg"></i>' : '<i class="fas fa-lock text-muted"></i>'}
                    </div>
                </div>
            </div>
        `).join('');
        }

        function calculateOverallProgress() {
            const totalDays = 14 * 7;
            let completedDays = 0;

            Object.values(progressData).forEach(week => {
                completedDays += Object.values(week).filter(day => day.completed).length;
            });

            return Math.round((completedDays / totalDays) * 100);
        }

        function setupEventListeners() {
            // Chart period toggle
            document.querySelectorAll('input[name="chart-period"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    updateActivityChart(this.id);
                });
            });

            // Export button
            document.getElementById('export-progress-btn').addEventListener('click', exportProgressReport);

            // Goals button
            document.getElementById('set-goals-btn').addEventListener('click', openGoalsModal);
            document.getElementById('save-goals-btn').addEventListener('click', saveGoals);
        }

        function updateActivityChart(period) {
            // Update chart based on selected period
            // This would fetch different data based on week/month/year view
            if (activityChart) {
                // Update chart data based on period
                // For now, just showing placeholder behavior
                Notifications.info(`Switching to ${period.replace('-view', '')} view`);
            }
        }

        function exportProgressReport() {
            // Generate progress report
            const report = {
                generatedAt: new Date().toISOString(),
                overallProgress: calculateOverallProgress(),
                stats: stats,
                weeklyProgress: Object.entries(progressData).map(([week, data]) => ({
                    week: parseInt(week),
                    completedDays: Object.values(data).filter(d => d.completed).length,
                    totalTime: Object.values(data).reduce((sum, d) => sum + (d.time_spent || 0), 0)
                }))
            };

            // Download as JSON
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsa-progress-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);

            Notifications.success('Progress report exported successfully');
        }

        function openGoalsModal() {
            // Set default target date to 14 weeks from now
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + 98); // 14 weeks
            document.getElementById('target-date').value = targetDate.toISOString().split('T')[0];

            const modal = new bootstrap.Modal(document.getElementById('goalsModal'));
            modal.show();
        }

        function saveGoals() {
            const goals = {
                dailyMinutes: parseInt(document.getElementById('daily-goal').value),
                weeklyDays: parseInt(document.getElementById('weekly-goal').value),
                targetDate: document.getElementById('target-date').value
            };

            // Save to local storage (in production, this would go to backend)
            Storage.setItem('learning_goals', goals);

            bootstrap.Modal.getInstance(document.getElementById('goalsModal')).hide();
            Notifications.success('Learning goals saved successfully');
        }

        // Add custom styles
        const style = document.createElement('style');
        style.textContent = `
        .achievement-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .achievement-card.unlocked {
            background-color: rgba(16, 185, 129, 0.05);
            border-color: #10b981 !important;
        }
        
        .achievement-card.locked {
            opacity: 0.6;
            background-color: rgba(107, 114, 128, 0.05);
        }
        
        .achievement-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .icon-box {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    `;
        document.head.appendChild(style);
    });
</script>