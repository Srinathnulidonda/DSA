<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>

<body class="dashboard-body">
    <div id="sidebarContainer"></div>
    <div id="topbarContainer"></div>
    <div id="mobileNavContainer"></div>

    <main class="main-content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                        <div>
                            <h2 class="fw-bold text-dark mb-2">Progress Analytics</h2>
                            <p class="text-muted mb-0">Track your learning journey with detailed insights</p>
                        </div>
                        <div class="progress-controls">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-primary active"
                                    data-period="week">Week</button>
                                <button type="button" class="btn btn-outline-primary" data-period="month">Month</button>
                                <button type="button" class="btn btn-outline-primary" data-period="all">All
                                    Time</button>
                            </div>
                            <button class="btn btn-primary ms-2" onclick="exportProgress()">
                                <i class="fas fa-download me-2"></i>Export
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="row mb-4">
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-primary">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="overallProgress">0%</h3>
                            <p class="metric-label">Overall Progress</p>
                            <div class="metric-change">
                                <i class="fas fa-arrow-up text-success me-1"></i>
                                <span class="text-success" id="progressChange">+5%</span>
                                <span class="text-muted">this week</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-success">
                            <i class="fas fa-fire"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="currentStreak">0</h3>
                            <p class="metric-label">Current Streak</p>
                            <div class="metric-change">
                                <span class="text-muted">Best: </span>
                                <span class="fw-bold" id="bestStreak">0</span>
                                <span class="text-muted">days</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-info">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="totalStudyTime">0h</h3>
                            <p class="metric-label">Study Time</p>
                            <div class="metric-change">
                                <span class="text-muted">Avg: </span>
                                <span class="fw-bold" id="avgDailyTime">0</span>
                                <span class="text-muted">min/day</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <div class="metric-card">
                        <div class="metric-icon bg-warning">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="metric-content">
                            <h3 class="metric-value" id="completedTasks">0</h3>
                            <p class="metric-label">Tasks Completed</p>
                            <div class="metric-change">
                                <span class="text-muted">of </span>
                                <span class="fw-bold" id="totalTasks">98</span>
                                <span class="text-muted">total</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Progress Chart -->
                <div class="col-lg-8 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Learning Progress Over Time</h5>
                                <div class="chart-controls">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-primary active"
                                            data-chart="completion">Completion</button>
                                        <button type="button" class="btn btn-outline-primary" data-chart="time">Study
                                            Time</button>
                                        <button type="button" class="btn btn-outline-primary"
                                            data-chart="streak">Streak</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="progressChart" height="300"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Breakdown -->
                <div class="col-lg-4 mb-4">
                    <div class="card h-100">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Weekly Breakdown</h5>
                        </div>
                        <div class="card-body">
                            <div id="weeklyBreakdown">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Learning Patterns -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Learning Patterns</h5>
                        </div>
                        <div class="card-body">
                            <div class="learning-heatmap">
                                <h6 class="fw-semibold mb-3">Activity Heatmap (Last 4 Weeks)</h6>
                                <div id="activityHeatmap">
                                    <div class="heatmap-grid" id="heatmapGrid">
                                        <!-- Heatmap will be generated here -->
                                    </div>
                                    <div class="heatmap-legend mt-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">Less active</small>
                                            <div class="legend-scale">
                                                <span class="legend-box" data-level="0"></span>
                                                <span class="legend-box" data-level="1"></span>
                                                <span class="legend-box" data-level="2"></span>
                                                <span class="legend-box" data-level="3"></span>
                                                <span class="legend-box" data-level="4"></span>
                                            </div>
                                            <small class="text-muted">More active</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="study-habits mt-4">
                                <h6 class="fw-semibold mb-3">Study Habits</h6>
                                <div class="habit-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Best Study Day</span>
                                        <span class="fw-bold" id="bestStudyDay">Monday</span>
                                    </div>
                                </div>
                                <div class="habit-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Average Session</span>
                                        <span class="fw-bold" id="avgSessionTime">45 min</span>
                                    </div>
                                </div>
                                <div class="habit-item">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="text-muted">Consistency Score</span>
                                        <span class="fw-bold" id="consistencyScore">85%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Topic Progress -->
                <div class="col-lg-6 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">Topic Mastery</h5>
                        </div>
                        <div class="card-body">
                            <div id="topicProgress">
                                <!-- Topic progress will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Progress Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0">Detailed Progress</h5>
                                <div class="table-controls">
                                    <input type="text" class="form-control form-control-sm"
                                        placeholder="Search topics..." id="topicSearch" style="width: 200px;">
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Week</th>
                                            <th>Topic</th>
                                            <th>Status</th>
                                            <th>Completion Date</th>
                                            <th>Time Spent</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="progressTable">
                                        <tr>
                                            <td colspan="6" class="text-center py-4">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let currentPeriod = 'week';
        let currentChartType = 'completion';
        let progressData = {};
        let roadmapData = [];
        let progressChart = null;

        document.addEventListener('DOMContentLoaded', async function () {
            await loadComponents();
            await checkAuth();
            await loadProgressData();
            updateActivePage('progress');
            initializeEventListeners();
            renderProgressChart();
            renderHeatmap();
        });

        async function loadComponents() {
            try {
                const [sidebarResponse, topbarResponse, mobileNavResponse] = await Promise.all([
                    fetch('../components/sidebar.html'),
                    fetch('../components/topbar.html'),
                    fetch('../components/mobile-nav.html')
                ]);

                document.getElementById('sidebarContainer').innerHTML = await sidebarResponse.text();
                document.getElementById('topbarContainer').innerHTML = await topbarResponse.text();
                document.getElementById('mobileNavContainer').innerHTML = await mobileNavResponse.text();

                initializeComponents();
            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        function initializeComponents() {
            const sidebarToggle = document.getElementById('sidebarToggleBtn');
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function () {
                    document.body.classList.toggle('sidebar-collapsed');
                });
            }

            const globalSearch = document.getElementById('globalSearch');
            if (globalSearch) {
                globalSearch.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        window.location.href = `/search?q=${encodeURIComponent(this.value)}`;
                    }
                });
            }
        }

        async function checkAuth() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const data = await response.json();
                    updateUserInfo(data.user);
                } else {
                    localStorage.removeItem('accessToken');
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                localStorage.removeItem('accessToken');
                window.location.href = '/login';
            }
        }

        function updateUserInfo(user) {
            const userNameElements = ['sidebarUserName', 'topbarUserName', 'dropdownUserName', 'mobileUserName'];
            userNameElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = user.name;
            });

            const userEmailElements = ['sidebarUserEmail', 'dropdownUserEmail', 'mobileUserEmail'];
            userEmailElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.textContent = user.email;
            });

            const avatarUrl = user.avatar_url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=6366f1&color=ffffff`;
            const avatarElements = ['sidebarAvatar', 'topbarAvatar', 'mobileUserAvatar'];
            avatarElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.src = avatarUrl;
            });
        }

        async function loadProgressData() {
            try {
                const token = localStorage.getItem('accessToken');
                const [dashboardResponse, roadmapResponse] = await Promise.all([
                    fetch(`${API_BASE}/dashboard`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    }),
                    fetch(`${API_BASE}/roadmap`)
                ]);

                if (dashboardResponse.ok && roadmapResponse.ok) {
                    const dashboardResult = await dashboardResponse.json();
                    const roadmapResult = await roadmapResponse.json();

                    progressData = dashboardResult;
                    roadmapData = roadmapResult.roadmap;

                    updateKeyMetrics();
                    updateWeeklyBreakdown();
                    updateTopicProgress();
                    updateProgressTable();
                } else {
                    throw new Error('Failed to load progress data');
                }
            } catch (error) {
                console.error('Error loading progress:', error);
                showError('Failed to load progress data. Please try again.');
            }
        }

        function updateKeyMetrics() {
            const stats = progressData.stats;

            document.getElementById('overallProgress').textContent = Math.round(stats.completion_percentage) + '%';
            document.getElementById('currentStreak').textContent = stats.current_streak;
            document.getElementById('bestStreak').textContent = stats.longest_streak;
            document.getElementById('totalStudyTime').textContent = Math.round(stats.total_study_time / 60) + 'h';
            document.getElementById('completedTasks').textContent = stats.completed_days;
            document.getElementById('totalTasks').textContent = stats.total_days;

            // Calculate average daily time
            const avgDaily = stats.total_study_time / Math.max(stats.completed_days, 1);
            document.getElementById('avgDailyTime').textContent = Math.round(avgDaily);

            // Mock progress change (in real app, calculate from historical data)
            const progressChange = Math.round(Math.random() * 10 + 2);
            document.getElementById('progressChange').textContent = `+${progressChange}%`;
        }

        function updateWeeklyBreakdown() {
            const weeklyProgress = progressData.weekly_progress || {};
            const container = document.getElementById('weeklyBreakdown');

            const sortedWeeks = Object.keys(weeklyProgress)
                .sort((a, b) => parseInt(a) - parseInt(b))
                .slice(-4); // Show last 4 weeks

            container.innerHTML = sortedWeeks.map(weekNum => {
                const week = weeklyProgress[weekNum];
                const percentage = Math.round(week.percentage);

                return `
                    <div class="week-progress-item mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h6 class="fw-bold mb-0">Week ${weekNum}</h6>
                                <small class="text-muted">${week.title}</small>
                            </div>
                            <div class="text-end">
                                <span class="fw-bold ${percentage === 100 ? 'text-success' : 'text-primary'}">${percentage}%</span>
                                <br>
                                <small class="text-muted">${week.completed}/${week.total}</small>
                            </div>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar ${percentage === 100 ? 'bg-success' : 'bg-primary'}" 
                                 style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateTopicProgress() {
            const container = document.getElementById('topicProgress');

            // Group topics by category
            const topicCategories = [
                { name: 'Arrays & Strings', weeks: [1, 2], color: 'primary' },
                { name: 'Linked Lists & Stacks', weeks: [3, 4], color: 'success' },
                { name: 'Trees & Heaps', weeks: [5, 6, 7], color: 'info' },
                { name: 'Graphs & Advanced', weeks: [8, 9, 10], color: 'warning' },
                { name: 'Algorithms & DP', weeks: [11, 12, 13, 14], color: 'danger' }
            ];

            container.innerHTML = topicCategories.map(category => {
                const categoryWeeks = category.weeks;
                const totalDays = categoryWeeks.reduce((sum, weekNum) => {
                    const week = roadmapData.find(w => w.week === weekNum);
                    return sum + (week ? week.days.length : 0);
                }, 0);

                const completedDays = categoryWeeks.reduce((sum, weekNum) => {
                    const weekProgress = progressData.weekly_progress?.[weekNum];
                    return sum + (weekProgress ? weekProgress.completed : 0);
                }, 0);

                const percentage = totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;

                return `
                    <div class="topic-category mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-semibold mb-0">${category.name}</h6>
                            <span class="badge bg-${category.color}">${percentage}%</span>
                        </div>
                        <div class="progress mb-2" style="height: 6px;">
                            <div class="progress-bar bg-${category.color}" style="width: ${percentage}%"></div>
                        </div>
                        <small class="text-muted">${completedDays}/${totalDays} topics completed</small>
                    </div>
                `;
            }).join('');
        }

        function updateProgressTable() {
            const tbody = document.getElementById('progressTable');
            let tableHTML = '';

            roadmapData.forEach(week => {
                week.days.forEach(day => {
                    const dayProgress = progressData.weekly_progress?.[week.week];
                    const isCompleted = dayProgress ? (dayProgress.completed > 0) : false;
                    const completionDate = isCompleted ? new Date().toLocaleDateString() : '-';
                    const timeSpent = isCompleted ? `${day.time_estimate} min` : '-';

                    tableHTML += `
                        <tr class="${isCompleted ? 'table-success' : ''}">
                            <td>
                                <span class="fw-bold">Week ${week.week}</span>
                                <br>
                                <small class="text-muted">${week.title}</small>
                            </td>
                            <td>
                                <div class="topic-cell">
                                    <div class="fw-semibold">${day.topic}</div>
                                    <small class="text-muted">${day.activities}</small>
                                </div>
                            </td>
                            <td>
                                <span class="badge ${isCompleted ? 'bg-success' : 'bg-secondary'}">
                                    ${isCompleted ? 'Completed' : 'Pending'}
                                </span>
                            </td>
                            <td>${completionDate}</td>
                            <td>${timeSpent}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" onclick="viewTopicDetails(${week.week}, '${day.day}')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-outline-success" onclick="toggleCompletion(${week.week}, '${day.day}')">
                                        <i class="fas fa-${isCompleted ? 'undo' : 'check'}"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
            });

            tbody.innerHTML = tableHTML;
        }

        function renderProgressChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');

            if (progressChart) {
                progressChart.destroy();
            }

            const labels = [];
            const data = [];

            if (currentChartType === 'completion') {
                // Generate completion data over weeks
                for (let i = 1; i <= 14; i++) {
                    labels.push(`Week ${i}`);
                    const weekProgress = progressData.weekly_progress?.[i];
                    data.push(weekProgress ? weekProgress.percentage : 0);
                }
            } else if (currentChartType === 'time') {
                // Generate study time data
                for (let i = 1; i <= 14; i++) {
                    labels.push(`Week ${i}`);
                    const weekProgress = progressData.weekly_progress?.[i];
                    // Mock study time data
                    data.push(weekProgress ? weekProgress.completed * 90 : 0);
                }
            } else if (currentChartType === 'streak') {
                // Generate streak data (mock)
                for (let i = 0; i < 30; i++) {
                    const date = new Date();
                    date.setDate(date.getDate() - (29 - i));
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    data.push(Math.floor(Math.random() * 10) + 1);
                }
            }

            progressChart = new Chart(ctx, {
                type: currentChartType === 'streak' ? 'line' : 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: getChartLabel(),
                        data: data,
                        backgroundColor: currentChartType === 'streak' ? 'rgba(99, 102, 241, 0.1)' : 'rgba(99, 102, 241, 0.8)',
                        borderColor: '#6366f1',
                        borderWidth: 2,
                        fill: currentChartType === 'streak',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: currentChartType === 'completion' ? 100 : undefined,
                            ticks: {
                                callback: function (value) {
                                    if (currentChartType === 'completion') return value + '%';
                                    if (currentChartType === 'time') return value + 'min';
                                    return value;
                                }
                            }
                        }
                    }
                }
            });
        }

        function getChartLabel() {
            switch (currentChartType) {
                case 'completion': return 'Completion %';
                case 'time': return 'Study Time (min)';
                case 'streak': return 'Streak Days';
                default: return 'Progress';
            }
        }

        function renderHeatmap() {
            const grid = document.getElementById('heatmapGrid');
            const weeks = 4;
            const daysPerWeek = 7;

            let heatmapHTML = '';

            for (let week = 0; week < weeks; week++) {
                heatmapHTML += '<div class="heatmap-week">';
                for (let day = 0; day < daysPerWeek; day++) {
                    const activity = Math.floor(Math.random() * 5); // 0-4 activity level
                    heatmapHTML += `<div class="heatmap-day" data-level="${activity}" title="Activity level: ${activity}"></div>`;
                }
                heatmapHTML += '</div>';
            }

            grid.innerHTML = heatmapHTML;
        }

        function initializeEventListeners() {
            // Period filters
            document.querySelectorAll('[data-period]').forEach(button => {
                button.addEventListener('click', function () {
                    currentPeriod = this.dataset.period;
                    document.querySelectorAll('[data-period]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    // Refresh data based on period
                    loadProgressData();
                });
            });

            // Chart type filters
            document.querySelectorAll('[data-chart]').forEach(button => {
                button.addEventListener('click', function () {
                    currentChartType = this.dataset.chart;
                    document.querySelectorAll('[data-chart]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    renderProgressChart();
                });
            });

            // Topic search
            const topicSearch = document.getElementById('topicSearch');
            if (topicSearch) {
                topicSearch.addEventListener('input', function () {
                    const searchTerm = this.value.toLowerCase();
                    const rows = document.querySelectorAll('#progressTable tr');

                    rows.forEach(row => {
                        const topicCell = row.querySelector('.topic-cell');
                        if (topicCell) {
                            const topicText = topicCell.textContent.toLowerCase();
                            row.style.display = topicText.includes(searchTerm) ? '' : 'none';
                        }
                    });
                });
            }
        }

        function viewTopicDetails(weekNum, dayName) {
            // Redirect to roadmap with specific week/day
            window.location.href = `/roadmap?week=${weekNum}&day=${dayName}`;
        }

        async function toggleCompletion(weekNum, dayName) {
            try {
                const token = localStorage.getItem('accessToken');
                const response = await fetch(`${API_BASE}/progress`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        week: weekNum,
                        day: dayName,
                        completed: true, // This should be toggled based on current state
                        time_spent: 90
                    })
                });

                if (response.ok) {
                    await loadProgressData();
                    showToast('Progress updated successfully!', 'success');
                } else {
                    throw new Error('Failed to update progress');
                }
            } catch (error) {
                console.error('Error updating progress:', error);
                showToast('Failed to update progress. Please try again.', 'error');
            }
        }

        function exportProgress() {
            // Generate CSV data
            let csvContent = "Week,Topic,Status,Completion Date,Time Spent\n";

            roadmapData.forEach(week => {
                week.days.forEach(day => {
                    const dayProgress = progressData.weekly_progress?.[week.week];
                    const isCompleted = dayProgress ? (dayProgress.completed > 0) : false;
                    const completionDate = isCompleted ? new Date().toLocaleDateString() : '';
                    const timeSpent = isCompleted ? day.time_estimate : 0;

                    csvContent += `"Week ${week.week}","${day.topic}","${isCompleted ? 'Completed' : 'Pending'}","${completionDate}","${timeSpent} min"\n`;
                });
            });

            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'dsa_progress.csv';
            a.click();
            window.URL.revokeObjectURL(url);

            showToast('Progress exported successfully!', 'success');
        }

        function updateActivePage(page) {
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });

            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });

            const pageTitle = document.getElementById('pageTitle');
            if (pageTitle) {
                pageTitle.textContent = page.charAt(0).toUpperCase() + page.slice(1);
            }
        }

        function showError(message) {
            console.error(message);
            showToast(message, 'error');
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer') || createToastContainer();
            const toastHtml = `
                <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'primary'} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            const toastElement = toastContainer.lastElementChild;
            const toast = new bootstrap.Toast(toastElement);
            toast.show();

            toastElement.addEventListener('hidden.bs.toast', function () {
                this.remove();
            });
        }

        function createToastContainer() {
            const container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }

        // Global functions
        window.logout = function () {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            window.location.href = '/login';
        };

        window.toggleTheme = function () {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        };

        // Load saved theme
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-theme');
        }
    </script>

    <style>
        .metric-card {
            background: white;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            height: 100%;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .metric-icon {
            width: 60px;
            height: 60px;
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .metric-content {
            flex: 1;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark-color);
            margin-bottom: 0.25rem;
            line-height: 1;
        }

        .metric-label {
            color: var(--muted-color);
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .metric-change {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        .week-progress-item {
            padding: 1rem;
            background: rgba(99, 102, 241, 0.05);
            border-radius: var(--radius-md);
            transition: all 0.2s ease;
        }

        .week-progress-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .topic-category {
            padding: 1rem;
            background: rgba(99, 102, 241, 0.05);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary-color);
        }

        .heatmap-grid {
            display: flex;
            gap: 2px;
            margin-bottom: 1rem;
        }

        .heatmap-week {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .heatmap-day {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: #ebedf0;
            cursor: pointer;
        }

        .heatmap-day[data-level="1"] {
            background: #c6e48b;
        }

        .heatmap-day[data-level="2"] {
            background: #7bc96f;
        }

        .heatmap-day[data-level="3"] {
            background: #239a3b;
        }

        .heatmap-day[data-level="4"] {
            background: #196127;
        }

        .legend-scale {
            display: flex;
            gap: 2px;
        }

        .legend-box {
            width: 12px;
            height: 12px;
            border-radius: 2px;
            background: #ebedf0;
        }

        .legend-box[data-level="1"] {
            background: #c6e48b;
        }

        .legend-box[data-level="2"] {
            background: #7bc96f;
        }

        .legend-box[data-level="3"] {
            background: #239a3b;
        }

        .legend-box[data-level="4"] {
            background: #196127;
        }

        .habit-item {
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .habit-item:last-child {
            border-bottom: none;
        }

        .topic-cell {
            max-width: 300px;
        }

        .table-success {
            background-color: rgba(25, 135, 84, 0.1) !important;
        }

        @media (max-width: 991.98px) {
            .metric-card {
                padding: 1.25rem;
            }

            .metric-icon {
                width: 50px;
                height: 50px;
                font-size: 1.25rem;
            }

            .metric-value {
                font-size: 1.75rem;
            }

            .chart-container {
                height: 250px;
            }

            .progress-controls {
                width: 100%;
                justify-content: center;
                margin-top: 1rem;
            }
        }

        @media (max-width: 767.98px) {
            .metric-card {
                padding: 1rem;
                flex-direction: column;
                text-align: center;
            }

            .metric-icon {
                width: 45px;
                height: 45px;
                font-size: 1.125rem;
            }

            .metric-value {
                font-size: 1.5rem;
            }

            .chart-controls {
                width: 100%;
                margin-top: 0.5rem;
            }

            .heatmap-day {
                width: 10px;
                height: 10px;
            }

            .legend-box {
                width: 10px;
                height: 10px;
            }

            .table-responsive {
                font-size: 0.875rem;
            }
        }
    </style>
</body>

</html>