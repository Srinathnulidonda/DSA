<!-- pages/progress.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progress - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <div id="topbar-container"></div>

            <!-- Progress Content -->
            <div class="container-fluid mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">Progress Tracking</h1>
                    <button class="btn btn-primary" onclick="generateReport()">
                        <i class="fas fa-download me-2"></i>Download Report
                    </button>
                </div>

                <!-- Overall Progress -->
                <div class="row g-4 mb-4">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <h5 class="card-title">Overall Progress</h5>
                                <div class="position-relative d-inline-flex">
                                    <svg class="progress-ring" width="200" height="200">
                                        <circle class="progress-ring-circle" stroke="#e9ecef" stroke-width="10"
                                            fill="transparent" r="90" cx="100" cy="100" />
                                        <circle class="progress-ring-circle" id="progressRing" stroke="#0d6efd"
                                            stroke-width="10" fill="transparent" r="90" cx="100" cy="100"
                                            style="stroke-dasharray: 565.48; stroke-dashoffset: 565.48;" />
                                    </svg>
                                    <div class="position-absolute top-50 start-50 translate-middle">
                                        <h2 class="mb-0" id="overallPercentage">0%</h2>
                                        <small class="text-muted">Complete</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title">Key Metrics</h5>
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                                                <i class="fas fa-calendar-check"></i>
                                            </div>
                                            <div>
                                                <h4 class="mb-0" id="totalDaysCompleted">0</h4>
                                                <small class="text-muted">Days Completed</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <div class="stat-icon bg-success bg-opacity-10 text-success me-3">
                                                <i class="fas fa-fire"></i>
                                            </div>
                                            <div>
                                                <h4 class="mb-0" id="currentStreakStat">0</h4>
                                                <small class="text-muted">Day Streak</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <div class="stat-icon bg-warning bg-opacity-10 text-warning me-3">
                                                <i class="fas fa-clock"></i>
                                            </div>
                                            <div>
                                                <h4 class="mb-0" id="totalHours">0</h4>
                                                <small class="text-muted">Hours Studied</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <div class="stat-icon bg-info bg-opacity-10 text-info me-3">
                                                <i class="fas fa-trophy"></i>
                                            </div>
                                            <div>
                                                <h4 class="mb-0" id="longestStreakStat">0</h4>
                                                <small class="text-muted">Longest Streak</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weekly Breakdown -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Weekly Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div id="weeklyBreakdown">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Topic Progress -->
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Topic Progress</h5>
                    </div>
                    <div class="card-body">
                        <div id="topicProgress">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/animation.js"></script>

    <script>
        // Load components
        fetch('/components/sidebar.html').then(r => r.text()).then(html => {
            document.getElementById('sidebar-container').innerHTML = html;
            initSidebar();
        });

        fetch('/components/topbar.html').then(r => r.text()).then(html => {
            document.getElementById('topbar-container').innerHTML = html;
        });

        fetch('/components/mobile-nav.html').then(r => r.text()).then(html => {
            document.getElementById('mobile-nav-container').innerHTML = html;
            initMobileNav();
        });

        // Progress functionality
        async function loadProgress() {
            try {
                const [progressResponse, roadmapResponse, dashboardResponse] = await Promise.all([
                    api.get('/progress'),
                    api.get('/roadmap'),
                    api.get('/dashboard')
                ]);

                const progressData = progressResponse.progress;
                const roadmapData = roadmapResponse.roadmap;
                const stats = dashboardResponse.stats;

                // Update overall stats
                updateOverallStats(stats);

                // Update progress ring
                updateProgressRing(document.getElementById('progressRing').parentElement, stats.completion_percentage);
                document.getElementById('overallPercentage').textContent = Math.round(stats.completion_percentage) + '%';

                // Render weekly breakdown
                renderWeeklyBreakdown(roadmapData, progressData);

                // Render topic progress
                renderTopicProgress(roadmapData, progressData);

            } catch (error) {
                console.error('Failed to load progress:', error);
                showToast('Failed to load progress data', 'danger');
            }
        }

        function updateOverallStats(stats) {
            animateNumber(document.getElementById('totalDaysCompleted'), 0, stats.completed_days, 1000);
            animateNumber(document.getElementById('currentStreakStat'), 0, stats.current_streak, 1000);
            animateNumber(document.getElementById('totalHours'), 0, Math.round(stats.total_study_time / 60), 1000);
            animateNumber(document.getElementById('longestStreakStat'), 0, stats.longest_streak, 1000);
        }

        function renderWeeklyBreakdown(roadmapData, progressData) {
            const container = document.getElementById('weeklyBreakdown');

            container.innerHTML = roadmapData.map(week => {
                const weekProgress = progressData[week.week] || {};
                const completedDays = Object.values(weekProgress).filter(d => d.completed).length;
                const totalDays = week.days.length;
                const percentage = totalDays > 0 ? (completedDays / totalDays) * 100 : 0;

                return `
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h6 class="mb-0">Week ${week.week}: ${week.title}</h6>
                                <small class="text-muted">${week.goal}</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-${percentage === 100 ? 'success' : 'primary'}">
                                    ${completedDays}/${totalDays} days
                                </span>
                            </div>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-${percentage === 100 ? 'success' : 'primary'}" 
                                 role="progressbar" 
                                 style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderTopicProgress(roadmapData, progressData) {
            const container = document.getElementById('topicProgress');
            const topics = {};

            // Group by topics
            roadmapData.forEach(week => {
                week.days.forEach(day => {
                    const topic = extractMainTopic(day.topic);
                    if (!topics[topic]) {
                        topics[topic] = { total: 0, completed: 0 };
                    }
                    topics[topic].total++;

                    const weekProgress = progressData[week.week] || {};
                    const dayProgress = weekProgress[day.day] || {};
                    if (dayProgress.completed) {
                        topics[topic].completed++;
                    }
                });
            });

            // Render topic cards
            container.innerHTML = Object.entries(topics).map(([topic, data]) => {
                const percentage = data.total > 0 ? (data.completed / data.total) * 100 : 0;
                const icon = getTopicIcon(topic);

                return `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="stat-icon bg-primary bg-opacity-10 text-primary me-3">
                                        <i class="fas fa-${icon}"></i>
                                    </div>
                                    <h6 class="mb-0">${topic}</h6>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: ${percentage}%"></div>
                                </div>
                                <small class="text-muted">${data.completed}/${data.total} lessons</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `<div class="row">${container.innerHTML}</div>`;
        }

        function extractMainTopic(topicString) {
            // Extract main topic category from lesson topic
            if (topicString.includes('Array')) return 'Arrays';
            if (topicString.includes('String')) return 'Strings';
            if (topicString.includes('Linked List')) return 'Linked Lists';
            if (topicString.includes('Stack')) return 'Stacks';
            if (topicString.includes('Queue')) return 'Queues';
            if (topicString.includes('Tree')) return 'Trees';
            if (topicString.includes('Graph')) return 'Graphs';
            if (topicString.includes('Hash')) return 'Hashing';
            if (topicString.includes('Sort')) return 'Sorting';
            if (topicString.includes('Search')) return 'Searching';
            if (topicString.includes('Dynamic')) return 'Dynamic Programming';
            if (topicString.includes('Recursion')) return 'Recursion';
            return 'Other';
        }

        function getTopicIcon(topic) {
            const icons = {
                'Arrays': 'list',
                'Strings': 'font',
                'Linked Lists': 'link',
                'Stacks': 'layer-group',
                'Queues': 'bars',
                'Trees': 'tree',
                'Graphs': 'project-diagram',
                'Hashing': 'hashtag',
                'Sorting': 'sort',
                'Searching': 'search',
                'Dynamic Programming': 'brain',
                'Recursion': 'redo',
                'Other': 'code'
            };
            return icons[topic] || 'code';
        }

        async function generateReport() {
            showToast('Generating progress report...', 'info');

            try {
                // In a real app, this would generate a PDF or export data
                const data = await api.get('/progress');

                // Create a simple text report
                let report = '=== DSA Learning Progress Report ===\n\n';
                report += `Generated on: ${new Date().toLocaleString()}\n\n`;
                report += `Overall Progress: ${Math.round(data.stats.completion_percentage)}%\n`;
                report += `Days Completed: ${data.stats.completed_days}\n`;
                report += `Current Streak: ${data.stats.current_streak} days\n`;
                report += `Total Study Time: ${Math.round(data.stats.total_study_time / 60)} hours\n\n`;

                // Download as text file
                const blob = new Blob([report], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `dsa-progress-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);

                showToast('Report downloaded successfully!', 'success');
            } catch (error) {
                showToast('Failed to generate report', 'danger');
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function () {
            loadProgress();
        });
    </script>
</body>

</html>