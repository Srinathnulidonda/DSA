<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>AI Assistant - DSAPath</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Marked.js for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body class="bg-light">
    <div class="app-wrapper">
        <!-- Topbar -->
        <nav class="topbar">
            <div class="container-fluid d-flex align-items-center">
                <button class="btn btn-link text-dark d-lg-none p-0 me-3" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars fa-lg"></i>
                </button>

                <a href="/pages/dashboard.html" class="topbar-brand">
                    <i class="fas fa-code-branch"></i>
                    DSAPath
                </a>

                <div class="topbar-nav">
                    <button class="btn btn-link text-dark position-relative" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                    </button>

                    <div class="dropdown">
                        <button class="btn btn-link text-dark dropdown-toggle d-flex align-items-center"
                            data-bs-toggle="dropdown">
                            <img src="/assets/images/default-avatar.png" alt="Avatar" class="rounded-circle me-2"
                                width="32" height="32" id="userAvatar">
                            <span class="d-none d-md-inline" id="userName">Loading...</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/pages/profile.html">
                                    <i class="fas fa-user me-2"></i>Profile
                                </a></li>
                            <li><a class="dropdown-item" href="/pages/settings.html">
                                    <i class="fas fa-cog me-2"></i>Settings
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <a href="/pages/dashboard.html" class="sidebar-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/pages/roadmap.html" class="sidebar-link">
                    <i class="fas fa-route"></i>
                    <span>Roadmap</span>
                </a>
                <a href="/pages/calendar.html" class="sidebar-link">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
                <a href="/pages/progress.html" class="sidebar-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Progress</span>
                </a>
                <a href="/pages/notes.html" class="sidebar-link">
                    <i class="fas fa-sticky-note"></i>
                    <span>Notes</span>
                </a>
                <a href="/pages/pomodoro.html" class="sidebar-link">
                    <i class="fas fa-clock"></i>
                    <span>Pomodoro</span>
                </a>
                <a href="/pages/resources.html" class="sidebar-link">
                    <i class="fas fa-book"></i>
                    <span>Resources</span>
                </a>
                <a href="/pages/ai-assistant.html" class="sidebar-link active">
                    <i class="fas fa-robot"></i>
                    <span>AI Assistant</span>
                </a>
                <a href="/pages/analytics.html" class="sidebar-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="page-header mb-4">
                    <h1 class="page-title">AI Study Assistant</h1>
                    <p class="page-subtitle">Get instant help with DSA concepts and problem-solving</p>
                </div>

                <div class="row">
                    <!-- Chat Interface -->
                    <div class="col-lg-8">
                        <div class="card border-0 shadow-sm chat-container">
                            <div class="card-body p-0 d-flex flex-column">
                                <!-- Chat Messages -->
                                <div id="chatMessages" class="chat-messages p-4">
                                    <!-- Welcome message -->
                                    <div class="message assistant-message">
                                        <div class="message-avatar">
                                            <i class="fas fa-robot"></i>
                                        </div>
                                        <div class="message-content">
                                            <div class="message-bubble">
                                                <p>ðŸ‘‹ Hello! I'm your AI study assistant. I can help you with:</p>
                                                <ul>
                                                    <li>Explaining DSA concepts</li>
                                                    <li>Solving coding problems</li>
                                                    <li>Debugging your code</li>
                                                    <li>Suggesting learning resources</li>
                                                    <li>Creating study plans</li>
                                                </ul>
                                                <p>How can I assist you today?</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Chat Input -->
                                <div class="chat-input-container p-3 border-top">
                                    <form id="chatForm" class="d-flex gap-2">
                                        <textarea class="form-control" id="messageInput" rows="1"
                                            placeholder="Ask me anything about DSA..."
                                            onkeydown="handleKeyPress(event)"></textarea>
                                        <button type="submit" class="btn btn-primary" id="sendBtn">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </form>
                                    <div class="text-muted small mt-2">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Press Shift+Enter for new line
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions & Suggestions -->
                    <div class="col-lg-4">
                        <!-- Quick Actions -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Quick Actions</h5>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary text-start"
                                        onclick="askQuestion('Explain time complexity with examples')">
                                        <i class="fas fa-clock me-2"></i>Explain Time Complexity
                                    </button>
                                    <button class="btn btn-outline-primary text-start" onclick="generateStudyPlan()">
                                        <i class="fas fa-calendar-check me-2"></i>Generate Study Plan
                                    </button>
                                    <button class="btn btn-outline-primary text-start" onclick="generateQuiz()">
                                        <i class="fas fa-question-circle me-2"></i>Create Practice Quiz
                                    </button>
                                    <button class="btn btn-outline-primary text-start"
                                        onclick="askQuestion('What should I study next based on my progress?')">
                                        <i class="fas fa-compass me-2"></i>What to Study Next
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Suggested Topics -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-body">
                                <h5 class="card-title">Suggested Topics</h5>
                                <div class="suggested-topics">
                                    <button class="badge bg-secondary me-2 mb-2 border-0"
                                        onclick="askQuestion('How do I implement a binary search tree?')">
                                        Binary Search Trees
                                    </button>
                                    <button class="badge bg-secondary me-2 mb-2 border-0"
                                        onclick="askQuestion('Explain dynamic programming approach')">
                                        Dynamic Programming
                                    </button>
                                    <button class="badge bg-secondary me-2 mb-2 border-0"
                                        onclick="askQuestion('Graph traversal algorithms comparison')">
                                        Graph Algorithms
                                    </button>
                                    <button class="badge bg-secondary me-2 mb-2 border-0"
                                        onclick="askQuestion('Common sorting algorithms and their complexities')">
                                        Sorting Algorithms
                                    </button>
                                    <button class="badge bg-secondary me-2 mb-2 border-0"
                                        onclick="askQuestion('When to use different data structures?')">
                                        Data Structure Selection
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- AI Capabilities -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">AI Capabilities</h5>
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Code explanation & debugging
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Complexity analysis
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Algorithm optimization
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Practice problem hints
                                    </li>
                                    <li class="mb-0">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Personalized recommendations
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav-list">
                <li class="mobile-nav-item">
                    <a href="/pages/dashboard.html" class="mobile-nav-link">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/roadmap.html" class="mobile-nav-link">
                        <i class="fas fa-route"></i>
                        <span>Roadmap</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/progress.html" class="mobile-nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>Progress</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/pomodoro.html" class="mobile-nav-link">
                        <i class="fas fa-clock"></i>
                        <span>Timer</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <button class="mobile-nav-link" onclick="toggleMobileDrawer()">
                        <i class="fas fa-ellipsis-h"></i>
                        <span>More</span>
                    </button>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Study Plan Modal -->
    <div class="modal fade" id="studyPlanModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generate Personalized Study Plan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="studyPlanForm">
                        <div class="mb-3">
                            <label class="form-label">Available Study Time (minutes/day)</label>
                            <input type="number" class="form-control" id="availableTime" value="60" min="15" max="480">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Focus Areas</label>
                            <select class="form-select" id="focusAreas" multiple size="5">
                                <option value="arrays">Arrays & Strings</option>
                                <option value="linkedlists">Linked Lists</option>
                                <option value="stacks">Stacks & Queues</option>
                                <option value="trees">Trees & Graphs</option>
                                <option value="sorting">Sorting & Searching</option>
                                <option value="dp">Dynamic Programming</option>
                                <option value="algorithms">Advanced Algorithms</option>
                            </select>
                            <small class="text-muted">Hold Ctrl/Cmd to select multiple</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Difficulty Level</label>
                            <select class="form-select" id="difficulty">
                                <option value="beginner">Beginner</option>
                                <option value="intermediate" selected>Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitStudyPlan()">
                        Generate Plan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal fade" id="quizModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Generate Practice Quiz</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="quizForm">
                        <div class="mb-3">
                            <label class="form-label">Topic</label>
                            <select class="form-select" id="quizTopic">
                                <option value="arrays">Arrays</option>
                                <option value="strings">Strings</option>
                                <option value="linkedlists">Linked Lists</option>
                                <option value="stacks">Stacks</option>
                                <option value="queues">Queues</option>
                                <option value="trees">Trees</option>
                                <option value="graphs">Graphs</option>
                                <option value="sorting">Sorting</option>
                                <option value="searching">Searching</option>
                                <option value="dp">Dynamic Programming</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Difficulty</label>
                            <select class="form-select" id="quizDifficulty">
                                <option value="easy">Easy</option>
                                <option value="medium" selected>Medium</option>
                                <option value="hard">Hard</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Number of Questions</label>
                            <input type="number" class="form-control" id="questionCount" value="5" min="1" max="10">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitQuiz()">
                        Generate Quiz
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Drawer -->
    <div class="mobile-drawer" id="mobileDrawer">
        <div class="drawer-header p-3 border-bottom">
            <h5 class="mb-0">Menu</h5>
            <button class="btn-close" onclick="toggleMobileDrawer()"></button>
        </div>
        <div class="drawer-body">
            <nav class="nav flex-column p-3">
                <a href="/pages/calendar.html" class="nav-link">
                    <i class="fas fa-calendar-alt me-2"></i>Calendar
                </a>
                <a href="/pages/notes.html" class="nav-link">
                    <i class="fas fa-sticky-note me-2"></i>Notes
                </a>
                <a href="/pages/resources.html" class="nav-link">
                    <i class="fas fa-book me-2"></i>Resources
                </a>
                <a href="/pages/ai-assistant.html" class="nav-link active">
                    <i class="fas fa-robot me-2"></i>AI Assistant
                </a>
                <a href="/pages/analytics.html" class="nav-link">
                    <i class="fas fa-chart-bar me-2"></i>Analytics
                </a>
                <hr>
                <a href="/pages/profile.html" class="nav-link">
                    <i class="fas fa-user me-2"></i>Profile
                </a>
                <a href="/pages/settings.html" class="nav-link">
                    <i class="fas fa-cog me-2"></i>Settings
                </a>
                <a href="#" class="nav-link text-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </a>
            </nav>
        </div>
    </div>
    <div class="drawer-backdrop" id="drawerBackdrop" onclick="toggleMobileDrawer()"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/constants.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/theme.js"></script>
    <script src="/js/notifications.js"></script>

    <script>
        // Initialize marked options
        marked.setOptions({
            highlight: function (code, lang) {
                if (Prism.languages[lang]) {
                    return Prism.highlight(code, Prism.languages[lang], lang);
                }
                return code;
            },
            breaks: true,
            gfm: true
        });

        // Chat state
        let isTyping = false;

        // Initialize AI Assistant
        async function initAIAssistant() {
            try {
                // Load user data
                const user = auth.getUser();
                if (user) {
                    document.getElementById('userName').textContent = user.name;
                    if (user.avatar_url) {
                        document.getElementById('userAvatar').src = user.avatar_url;
                    }
                }

                // Setup form handler
                document.getElementById('chatForm').addEventListener('submit', handleSubmit);

                // Auto-resize textarea
                const messageInput = document.getElementById('messageInput');
                messageInput.addEventListener('input', function () {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });

            } catch (error) {
                console.error('AI Assistant initialization error:', error);
                notifications.error('Failed to initialize AI Assistant');
            }
        }

        // Handle form submission
        async function handleSubmit(e) {
            e.preventDefault();

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();

            if (!message || isTyping) return;

            // Add user message
            addMessage(message, 'user');

            // Clear input
            messageInput.value = '';
            messageInput.style.height = 'auto';

            // Send to AI
            await sendToAI(message);
        }

        // Handle key press
        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                document.getElementById('chatForm').dispatchEvent(new Event('submit'));
            }
        }

        // Add message to chat
        function addMessage(content, type, citations = null) {
            const chatMessages = document.getElementById('chatMessages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message animate-slideInUp`;

            const avatar = type === 'user' ?
                `<img src="${document.getElementById('userAvatar').src}" alt="You" class="rounded-circle" width="32" height="32">` :
                '<i class="fas fa-robot"></i>';

            let messageContent = `
                <div class="message-avatar">
                    ${avatar}
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        ${type === 'assistant' ? marked.parse(content) : utils.escapeHtml(content)}
                    </div>
            `;

            // Add citations if available
            if (citations && citations.length > 0) {
                messageContent += `
                    <div class="message-citations mt-2">
                        <small class="text-muted">References:</small>
                        <div class="d-flex flex-wrap gap-2 mt-1">
                            ${citations.map(cite => `
                                <a href="${cite.url}" target="_blank" 
                                   class="badge bg-secondary text-decoration-none">
                                    <i class="fas fa-external-link-alt me-1"></i>${cite.title}
                                </a>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            messageContent += '</div>';
            messageDiv.innerHTML = messageContent;

            chatMessages.appendChild(messageDiv);

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Highlight code blocks
            if (type === 'assistant') {
                Prism.highlightAllUnder(messageDiv);
            }
        }

        // Add typing indicator
        function addTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');

            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant-message typing-indicator';
            typingDiv.innerHTML = `
                <div class="message-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="message-content">
                    <div class="message-bubble">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
            `;

            chatMessages.appendChild(typingDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            return typingDiv;
        }

        // Send message to AI
        async function sendToAI(question) {
            isTyping = true;
            document.getElementById('sendBtn').disabled = true;

            const typingIndicator = addTypingIndicator();

            try {
                const response = await api.askAI(question);

                // Remove typing indicator
                typingIndicator.remove();

                // Add AI response
                addMessage(response.answer, 'assistant', response.citations);

                // Check for service status
                if (response.service_status === 'quota_exceeded') {
                    notifications.warning('AI service is experiencing high demand. Some features may be limited.');
                }

            } catch (error) {
                console.error('AI request failed:', error);

                // Remove typing indicator
                typingIndicator.remove();

                // Show error message
                addMessage(
                    "I'm sorry, I'm having trouble processing your request right now. Please try again later or check the Resources section for study materials.",
                    'assistant'
                );

                notifications.error('Failed to get AI response');
            } finally {
                isTyping = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        // Ask predefined question
        function askQuestion(question) {
            document.getElementById('messageInput').value = question;
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }

        // Generate study plan
        function generateStudyPlan() {
            const modal = new bootstrap.Modal(document.getElementById('studyPlanModal'));
            modal.show();
        }

        // Submit study plan
        async function submitStudyPlan() {
            const availableTime = document.getElementById('availableTime').value;
            const focusAreas = Array.from(document.getElementById('focusAreas').selectedOptions)
                .map(opt => opt.value);
            const difficulty = document.getElementById('difficulty').value;

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('studyPlanModal')).hide();

            // Add user message
            const message = `Generate a personalized study plan with ${availableTime} minutes per day, ` +
                `focusing on ${focusAreas.join(', ') || 'general topics'}, ` +
                `at ${difficulty} difficulty level.`;
            addMessage(message, 'user');

            // Show typing
            isTyping = true;
            const typingIndicator = addTypingIndicator();

            try {
                const response = await api.generateStudyPlan({
                    available_time: parseInt(availableTime),
                    focus_areas: focusAreas,
                    difficulty: difficulty
                });

                // Remove typing indicator
                typingIndicator.remove();

                // Format and display study plan
                let formattedPlan = response.study_plan;
                if (response.progress_summary) {
                    formattedPlan += `\n\n**Progress Summary:** ${response.progress_summary}`;
                }

                addMessage(formattedPlan, 'assistant');

            } catch (error) {
                console.error('Study plan generation failed:', error);
                typingIndicator.remove();
                addMessage(
                    "I couldn't generate a study plan right now. Please try again later.",
                    'assistant'
                );
            } finally {
                isTyping = false;
            }
        }

        // Generate quiz
        function generateQuiz() {
            const modal = new bootstrap.Modal(document.getElementById('quizModal'));
            modal.show();
        }

        // Submit quiz
        async function submitQuiz() {
            const topic = document.getElementById('quizTopic').value;
            const difficulty = document.getElementById('quizDifficulty').value;
            const questionCount = document.getElementById('questionCount').value;

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('quizModal')).hide();

            // Add user message
            const message = `Create a ${difficulty} level quiz on ${topic} with ${questionCount} questions.`;
            addMessage(message, 'user');

            // Show typing
            isTyping = true;
            const typingIndicator = addTypingIndicator();

            try {
                const response = await api.generateQuiz({
                    topic: topic,
                    difficulty: difficulty,
                    question_count: parseInt(questionCount)
                });

                // Remove typing indicator
                typingIndicator.remove();

                // Display quiz
                addMessage(response.quiz, 'assistant');

            } catch (error) {
                console.error('Quiz generation failed:', error);
                typingIndicator.remove();
                addMessage(
                    "I couldn't generate a quiz right now. Please try again later.",
                    'assistant'
                );
            } finally {
                isTyping = false;
            }
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Toggle mobile drawer
        function toggleMobileDrawer() {
            const drawer = document.getElementById('mobileDrawer');
            const backdrop = document.getElementById('drawerBackdrop');

            drawer.classList.toggle('open');
            backdrop.classList.toggle('show');
        }

        // Show notifications
        function showNotifications() {
            notifications.info('Notifications panel coming soon!');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.logout();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initAIAssistant();
        });

        // Add custom styles
        const style = document.createElement('style');
        style.textContent = `
            .chat-container {
                height: calc(100vh - 200px);
                min-height: 500px;
            }
            
            .chat-messages {
                flex: 1;
                overflow-y: auto;
                background: #f8f9fa;
            }
            
            .message {
                display: flex;
                gap: 1rem;
                margin-bottom: 1.5rem;
            }
            
            .user-message {
                flex-direction: row-reverse;
            }
            
            .message-avatar {
                width: 40px;
                height: 40px;
                background: white;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }
            
            .message-avatar i {
                font-size: 1.25rem;
                color: var(--primary);
            }
            
            .message-content {
                max-width: 70%;
            }
            
            .message-bubble {
                background: white;
                padding: 1rem;
                border-radius: 1rem;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            }
            
            .user-message .message-bubble {
                background: var(--primary);
                color: white;
            }
            
            .message-bubble pre {
                background: #f6f8fa;
                border: 1px solid #e1e4e8;
                border-radius: 6px;
                padding: 16px;
                overflow-x: auto;
                margin: 1rem 0;
            }
            
            .user-message .message-bubble pre {
                background: rgba(255, 255, 255, 0.1);
                border-color: rgba(255, 255, 255, 0.2);
            }
            
            .message-bubble code {
                background: rgba(27, 31, 35, 0.05);
                padding: 0.2em 0.4em;
                border-radius: 3px;
                font-size: 85%;
            }
            
            .user-message .message-bubble code {
                background: rgba(255, 255, 255, 0.2);
            }
            
            .typing-dots {
                display: flex;
                gap: 0.3rem;
            }
            
            .typing-dots span {
                width: 8px;
                height: 8px;
                background: #6b7280;
                border-radius: 50%;
                animation: typing 1.4s infinite ease-in-out;
            }
            
            .typing-dots span:nth-child(2) {
                animation-delay: 0.2s;
            }
            
            .typing-dots span:nth-child(3) {
                animation-delay: 0.4s;
            }
            
            @keyframes typing {
                0%, 60%, 100% {
                    transform: translateY(0);
                }
                30% {
                    transform: translateY(-10px);
                }
            }
            
            .suggested-topics button {
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .suggested-topics button:hover {
                transform: scale(1.05);
            }
            
            @media (max-width: 767px) {
                .chat-container {
                    height: calc(100vh - 180px);
                }
                
                .message-content {
                    max-width: 85%;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>