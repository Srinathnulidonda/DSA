<!-- pages/calendar.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - DSA Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/animation.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
</head>

<body class="bg-gray-50">
    <!-- Sidebar -->
    <div id="sidebarContainer"></div>

    <!-- Topbar -->
    <div id="topbarContainer"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="h3 mb-3">Study Calendar</h1>
                    <p class="text-muted">Track your daily progress and plan your study schedule</p>
                </div>
            </div>

            <!-- Calendar Controls -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                <div class="d-flex align-items-center gap-2">
                                    <button class="btn btn-outline-primary" onclick="previousMonth()">
                                        <i class="fas fa-chevron-left"></i>
                                    </button>
                                    <h4 class="mb-0" id="currentMonth">January 2024</h4>
                                    <button class="btn btn-outline-primary" onclick="nextMonth()">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" onclick="goToToday()">Today</button>
                                    <button class="btn btn-outline-secondary"
                                        onclick="changeView('month')">Month</button>
                                    <button class="btn btn-outline-secondary" onclick="changeView('week')">Week</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Legend -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex flex-wrap gap-3 justify-content-center">
                        <div class="d-flex align-items-center gap-2">
                            <div class="calendar-day completed" style="width: 30px; height: 30px;"></div>
                            <span>Completed</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="calendar-day current" style="width: 30px; height: 30px;"></div>
                            <span>Today</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <div class="calendar-day" style="width: 30px; height: 30px; background: #ffeaa7;"></div>
                            <span>Scheduled</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body">
                            <div id="calendarView">
                                <!-- Calendar will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Day Details -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card" id="dayDetails" style="display: none;">
                        <div class="card-header bg-white">
                            <h5 class="mb-0" id="selectedDateTitle">Day Details</h5>
                        </div>
                        <div class="card-body" id="dayDetailsContent">
                            <!-- Day details will be shown here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let currentDate = new Date();
        let currentView = 'month';
        let roadmapData = null;
        let progressData = {};
        let calendarData = {};

        // Initialize calendar
        async function initCalendar() {
            await loadComponents();
            await loadRoadmap();
            await loadCalendarData();
            renderCalendar();
        }

        // Load roadmap data
        async function loadRoadmap() {
            try {
                const response = await fetch(`${API_BASE}/roadmap`);
                const data = await response.json();
                roadmapData = data.roadmap;
            } catch (error) {
                console.error('Failed to load roadmap:', error);
            }
        }

        // Load calendar data
        async function loadCalendarData() {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE}/calendar`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    calendarData = data.calendar;

                    // Also load detailed progress
                    const progressResponse = await fetch(`${API_BASE}/progress`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (progressResponse.ok) {
                        const progressInfo = await progressResponse.json();
                        progressData = progressInfo.progress;
                    }
                }
            } catch (error) {
                console.error('Failed to load calendar data:', error);
            }
        }

        // Render calendar
        function renderCalendar() {
            updateMonthDisplay();

            if (currentView === 'month') {
                renderMonthView();
            } else {
                renderWeekView();
            }
        }

        // Update month display
        function updateMonthDisplay() {
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonth').textContent =
                `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
        }

        // Render month view
        function renderMonthView() {
            const calendarView = document.getElementById('calendarView');
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);

            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            const daysInPrevMonth = prevLastDay.getDate();

            let html = '<div class="calendar-grid">';

            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="text-center fw-bold p-2">${day}</div>`;
            });

            // Previous month days
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                html += `<div class="calendar-day text-muted opacity-50">${daysInPrevMonth - i}</div>`;
            }

            // Current month days
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDate(date);
                const isToday = date.toDateString() === today.toDateString();
                const dayData = getDayData(date);

                let classes = 'calendar-day';
                if (isToday) classes += ' current';
                if (dayData.completed) classes += ' completed';
                else if (dayData.scheduled) classes += ' bg-warning-subtle';

                html += `
                    <div class="${classes}" onclick="selectDate('${dateStr}')" data-date="${dateStr}">
                        <div>${day}</div>
                        ${dayData.topic ? `<small class="d-none d-md-block text-truncate">${dayData.topic}</small>` : ''}
                    </div>
                `;
            }

            // Next month days
            const remainingDays = 42 - (firstDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingDays; day++) {
                html += `<div class="calendar-day text-muted opacity-50">${day}</div>`;
            }

            html += '</div>';
            calendarView.innerHTML = html;
        }

        // Render week view
        function renderWeekView() {
            const calendarView = document.getElementById('calendarView');
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

            let html = '<div class="week-view">';

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = formatDate(date);
                const dayData = getDayData(date);
                const isToday = date.toDateString() === new Date().toDateString();

                html += `
                    <div class="week-day ${isToday ? 'current' : ''} ${dayData.completed ? 'completed' : ''}" 
                         onclick="selectDate('${dateStr}')">
                        <h6>${date.toLocaleDateString('en-US', { weekday: 'short' })} ${date.getDate()}</h6>
                        ${dayData.topic ? `
                            <div class="p-2">
                                <strong>${dayData.topic}</strong>
                                <p class="mb-0 small text-muted">${dayData.activities || ''}</p>
                            </div>
                        ` : '<p class="text-muted">No tasks scheduled</p>'}
                    </div>
                `;
            }

            html += '</div>';
            calendarView.innerHTML = html;
        }

        // Get day data
        function getDayData(date) {
            // Calculate which week and day this date corresponds to in the roadmap
            const startDate = new Date('2024-01-01'); // Adjust based on your roadmap start
            const daysDiff = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));
            const weekNum = Math.floor(daysDiff / 7) + 1;
            const dayOfWeek = daysDiff % 7;

            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayName = dayNames[dayOfWeek];

            if (roadmapData && weekNum > 0 && weekNum <= 14) {
                const week = roadmapData.find(w => w.week === weekNum);
                if (week) {
                    const day = week.days.find(d => d.day === dayName);
                    if (day) {
                        const progress = progressData[weekNum]?.[dayName];
                        return {
                            scheduled: true,
                            completed: progress?.completed || false,
                            topic: day.topic,
                            activities: day.activities,
                            week: weekNum,
                            day: dayName
                        };
                    }
                }
            }

            return {
                scheduled: false,
                completed: false
            };
        }

        // Format date
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        // Select date
        function selectDate(dateStr) {
            const date = new Date(dateStr);
            const dayData = getDayData(date);

            // Highlight selected date
            document.querySelectorAll('.calendar-day').forEach(el => {
                el.classList.remove('selected');
            });
            document.querySelector(`[data-date="${dateStr}"]`)?.classList.add('selected');

            // Show day details
            const detailsCard = document.getElementById('dayDetails');
            const detailsTitle = document.getElementById('selectedDateTitle');
            const detailsContent = document.getElementById('dayDetailsContent');

            detailsCard.style.display = 'block';
            detailsTitle.textContent = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            if (dayData.scheduled) {
                detailsContent.innerHTML = `
                    <div class="mb-3">
                        <h5>${dayData.topic}</h5>
                        <p class="text-muted">${dayData.activities}</p>
                        <div class="mt-3">
                            <span class="badge ${dayData.completed ? 'bg-success' : 'bg-secondary'}">
                                ${dayData.completed ? 'Completed' : 'Not Completed'}
                            </span>
                        </div>
                    </div>
                    <div class="mt-3">
                        <a href="/roadmap?week=${dayData.week}" class="btn btn-primary">
                            <i class="fas fa-road me-2"></i> Go to Week ${dayData.week}
                        </a>
                    </div>
                `;
            } else {
                detailsContent.innerHTML = `
                    <p class="text-muted">No study tasks scheduled for this day.</p>
                    <a href="/roadmap" class="btn btn-outline-primary">
                        <i class="fas fa-road me-2"></i> View Roadmap
                    </a>
                `;
            }

            // Scroll to details on mobile
            if (window.innerWidth < 768) {
                detailsCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        // Navigation functions
        function previousMonth() {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() - 1);
            } else {
                currentDate.setDate(currentDate.getDate() - 7);
            }
            renderCalendar();
        }

        function nextMonth() {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + 1);
            } else {
                currentDate.setDate(currentDate.getDate() + 7);
            }
            renderCalendar();
        }

        function goToToday() {
            currentDate = new Date();
            renderCalendar();
        }

        function changeView(view) {
            currentView = view;

            // Update button states
            document.querySelectorAll('.btn-outline-secondary').forEach(btn => {
                if (btn.textContent.toLowerCase().includes(view)) {
                    btn.classList.remove('btn-outline-secondary');
                    btn.classList.add('btn-secondary');
                } else {
                    btn.classList.remove('btn-secondary');
                    btn.classList.add('btn-outline-secondary');
                }
            });

            renderCalendar();
        }

        // Add styles for week view
        const style = document.createElement('style');
        style.textContent = `
            .week-view {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1rem;
            }
            
            .week-day {
                padding: 1rem;
                background: #f8f9fa;
                border-radius: 0.5rem;
                cursor: pointer;
                transition: all 0.2s ease;
                min-height: 150px;
            }
            
            .week-day:hover {
                background: #e9ecef;
                transform: translateY(-2px);
            }
            
            .week-day.current {
                border: 2px solid var(--primary-color);
            }
            
            .week-day.completed {
                background: #d4edda;
            }
            
            .calendar-day.selected {
                background: var(--primary-color) !important;
                color: white !important;
            }
            
            @media (max-width: 768px) {
                .week-view {
                    grid-template-columns: 1fr;
                }
                
                .calendar-grid {
                    font-size: 0.875rem;
                }
                
                .calendar-day small {
                    display: none !important;
                }
            }
        `;
        document.head.appendChild(style);

        // Initialize on load
        initCalendar();
    </script>
</body>

</html>