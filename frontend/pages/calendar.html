<div class="container-fluid p-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="h3 fw-bold mb-1">
                        <i class="fas fa-calendar text-info me-2"></i>
                        Study Calendar
                    </h1>
                    <p class="text-muted mb-0">Track your daily progress and plan your study sessions</p>
                </div>
                <div class="d-flex gap-2 mt-3 mt-lg-0">
                    <button class="btn btn-outline-primary" id="today-btn">
                        <i class="fas fa-calendar-day me-2"></i>Today
                    </button>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="prev-month-btn">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <button class="btn btn-primary" id="next-month-btn">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Stats -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 border-0">
                <div class="card-body">
                    <div class="row g-4 text-center">
                        <div class="col-md-3 col-6">
                            <div class="stat-item">
                                <h4 class="h5 fw-bold text-primary mb-1" id="month-completed">0</h4>
                                <small class="text-muted">Days Completed</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-item">
                                <h4 class="h5 fw-bold text-success mb-1" id="month-study-time">0h</h4>
                                <small class="text-muted">Study Time</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-item">
                                <h4 class="h5 fw-bold text-warning mb-1" id="month-streak">0</h4>
                                <small class="text-muted">Current Streak</small>
                            </div>
                        </div>
                        <div class="col-md-3 col-6">
                            <div class="stat-item">
                                <h4 class="h5 fw-bold text-info mb-1" id="month-completion">0%</h4>
                                <small class="text-muted">Month Progress</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Calendar -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0 text-center" id="calendar-month-year">
                        <!-- Month Year will be displayed here -->
                    </h5>
                </div>
                <div class="card-body p-3">
                    <div class="calendar-grid">
                        <!-- Calendar header (weekdays) -->
                        <div class="calendar-header">
                            <div class="calendar-weekday">Sun</div>
                            <div class="calendar-weekday">Mon</div>
                            <div class="calendar-weekday">Tue</div>
                            <div class="calendar-weekday">Wed</div>
                            <div class="calendar-weekday">Thu</div>
                            <div class="calendar-weekday">Fri</div>
                            <div class="calendar-weekday">Sat</div>
                        </div>
                        <!-- Calendar days -->
                        <div class="calendar-days" id="calendar-days">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Selected Day Details -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-calendar-check me-2"></i>
                        <span id="selected-date">Select a date</span>
                    </h5>
                </div>
                <div class="card-body" id="day-details">
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-calendar fa-3x mb-3"></i>
                        <p>Click on a date to view details</p>
                    </div>
                </div>
            </div>

            <!-- Upcoming Tasks -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-tasks me-2"></i>Upcoming Tasks
                    </h5>
                </div>
                <div class="card-body">
                    <div id="upcoming-tasks">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Day Details Modal -->
<div class="modal fade" id="dayModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="dayModalTitle">Day Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="dayModalBody">
                <!-- Populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="mark-complete-btn">Mark as Complete</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        let currentDate = new Date();
        let selectedDate = null;
        let calendarData = {};
        let progressData = {};
        let roadmapData = [];

        // Initialize
        await loadCalendarData();
        await loadRoadmapData();
        renderCalendar();
        setupEventListeners();
        updateMonthStats();
        loadUpcomingTasks();

        async function loadCalendarData() {
            try {
                // Load progress data
                const progressResponse = await ApiMethods.progress.get();
                progressData = progressResponse.progress || {};

                // Convert progress data to calendar format
                Object.entries(progressData).forEach(([week, weekData]) => {
                    Object.entries(weekData).forEach(([day, dayData]) => {
                        if (dayData.completed && dayData.completion_date) {
                            const date = new Date(dayData.completion_date).toDateString();
                            calendarData[date] = {
                                completed: true,
                                week: parseInt(week),
                                day: day,
                                time_spent: dayData.time_spent || 0
                            };
                        }
                    });
                });

                console.log('Calendar data loaded:', calendarData);

            } catch (error) {
                console.error('Failed to load calendar data:', error);
            }
        }

        async function loadRoadmapData() {
            try {
                const response = await ApiMethods.roadmap.get();
                roadmapData = response.roadmap || [];
            } catch (error) {
                console.error('Failed to load roadmap:', error);
            }
        }

        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update month/year display
            document.getElementById('calendar-month-year').textContent =
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const prevMonthDays = new Date(year, month, 0).getDate();

            const calendarDays = document.getElementById('calendar-days');
            calendarDays.innerHTML = '';

            // Previous month days
            for (let i = firstDay - 1; i >= 0; i--) {
                const day = prevMonthDays - i;
                const dayElement = createDayElement(day, 'other-month');
                calendarDays.appendChild(dayElement);
            }

            // Current month days
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toDateString();
                const isToday = dateString === new Date().toDateString();
                const dayData = calendarData[dateString];

                const dayElement = createDayElement(day, 'current-month', date, isToday, dayData);
                calendarDays.appendChild(dayElement);
            }

            // Next month days
            const remainingDays = 42 - (firstDay + daysInMonth); // 6 weeks * 7 days
            for (let day = 1; day <= remainingDays; day++) {
                const dayElement = createDayElement(day, 'other-month');
                calendarDays.appendChild(dayElement);
            }
        }

        function createDayElement(day, monthClass, date = null, isToday = false, dayData = null) {
            const dayElement = document.createElement('div');
            dayElement.className = `calendar-day ${monthClass}`;

            if (isToday) {
                dayElement.classList.add('today');
            }

            if (dayData?.completed) {
                dayElement.classList.add('completed');
            }

            if (date) {
                dayElement.dataset.date = date.toISOString();
                dayElement.addEventListener('click', () => selectDate(date));
            }

            dayElement.innerHTML = `
            <div class="day-number">${day}</div>
            ${dayData ? `
                <div class="day-indicators">
                    ${dayData.completed ? '<i class="fas fa-check-circle text-success"></i>' : ''}
                    ${dayData.time_spent > 0 ? `<small class="text-muted">${dayData.time_spent}m</small>` : ''}
                </div>
            ` : ''}
        `;

            return dayElement;
        }

        function selectDate(date) {
            selectedDate = date;
            const dateString = date.toDateString();

            // Update selected date display
            document.getElementById('selected-date').textContent =
                date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

            // Highlight selected date
            document.querySelectorAll('.calendar-day').forEach(day => {
                day.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');

            // Load day details
            loadDayDetails(date);
        }

        function loadDayDetails(date) {
            const dateString = date.toDateString();
            const dayData = calendarData[dateString];
            const detailsContainer = document.getElementById('day-details');

            if (dayData) {
                // Find corresponding roadmap data
                const week = roadmapData.find(w => w.week === dayData.week);
                const dayInfo = week?.days.find(d => d.day === dayData.day);

                detailsContainer.innerHTML = `
                <div class="mb-3">
                    <span class="badge bg-success mb-2">
                        <i class="fas fa-check me-1"></i>Completed
                    </span>
                    <h6 class="fw-bold">Week ${dayData.week}, ${dayData.day}</h6>
                    ${dayInfo ? `
                        <p class="text-primary mb-2">${dayInfo.topic}</p>
                        <p class="text-muted small">${dayInfo.activities}</p>
                    ` : ''}
                </div>
                
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <i class="fas fa-clock text-primary"></i>
                            <div class="small text-muted">Study Time</div>
                            <div class="fw-bold">${dayData.time_spent || 0} min</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="border rounded p-2">
                            <i class="fas fa-check-circle text-success"></i>
                            <div class="small text-muted">Status</div>
                            <div class="fw-bold">Complete</div>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-outline-primary btn-sm w-100 mt-3" onclick="viewWeekProgress(${dayData.week})">
                    <i class="fas fa-calendar-week me-2"></i>View Week Progress
                </button>
            `;
            } else {
                // Check if this date corresponds to any roadmap day
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const weeksSinceStart = Math.floor((date - getStartDate()) / (7 * 24 * 60 * 60 * 1000)) + 1;

                if (weeksSinceStart > 0 && weeksSinceStart <= 14) {
                    const week = roadmapData.find(w => w.week === weeksSinceStart);
                    const dayInfo = week?.days.find(d => d.day === dayName);

                    if (dayInfo) {
                        detailsContainer.innerHTML = `
                        <div class="mb-3">
                            <span class="badge bg-warning mb-2">
                                <i class="fas fa-clock me-1"></i>Upcoming
                            </span>
                            <h6 class="fw-bold">Week ${weeksSinceStart}, ${dayName}</h6>
                            <p class="text-primary mb-2">${dayInfo.topic}</p>
                            <p class="text-muted small">${dayInfo.activities}</p>
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex align-items-center text-muted">
                                <i class="fas fa-clock me-2"></i>
                                <span>Estimated: ${dayInfo.time_estimate} minutes</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-primary w-100" onclick="startStudySession(${weeksSinceStart}, '${dayName}')">
                            <i class="fas fa-play me-2"></i>Start Study Session
                        </button>
                    `;
                    } else {
                        detailsContainer.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-calendar-times fa-3x mb-3"></i>
                            <p>No study plan for this day</p>
                        </div>
                    `;
                    }
                } else {
                    detailsContainer.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-calendar fa-3x mb-3"></i>
                        <p>No activities scheduled</p>
                    </div>
                `;
                }
            }
        }

        function getStartDate() {
            // Calculate program start date based on completed days
            // For demo, using a fixed date
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 30); // Started 30 days ago
            return startDate;
        }

        function updateMonthStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let completedDays = 0;
            let totalStudyTime = 0;

            // Count completed days and study time for current month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateString = date.toDateString();
                const dayData = calendarData[dateString];

                if (dayData?.completed) {
                    completedDays++;
                    totalStudyTime += dayData.time_spent || 0;
                }
            }

            // Update stats
            document.getElementById('month-completed').textContent = completedDays;
            document.getElementById('month-study-time').textContent = Utils.time.formatDuration(totalStudyTime * 60);
            document.getElementById('month-streak').textContent = calculateCurrentStreak();
            document.getElementById('month-completion').textContent =
                Math.round((completedDays / daysInMonth) * 100) + '%';
        }

        function calculateCurrentStreak() {
            let streak = 0;
            const today = new Date();
            let checkDate = new Date(today);

            while (true) {
                const dateString = checkDate.toDateString();
                if (calendarData[dateString]?.completed) {
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                } else {
                    break;
                }
            }

            return streak;
        }

        function loadUpcomingTasks() {
            const container = document.getElementById('upcoming-tasks');
            const today = new Date();
            const upcomingDays = [];

            // Get next 7 days of tasks
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() + i);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'long' });
                const weeksSinceStart = Math.floor((date - getStartDate()) / (7 * 24 * 60 * 60 * 1000)) + 1;

                if (weeksSinceStart > 0 && weeksSinceStart <= 14) {
                    const week = roadmapData.find(w => w.week === weeksSinceStart);
                    const dayInfo = week?.days.find(d => d.day === dayName);

                    if (dayInfo && !calendarData[date.toDateString()]?.completed) {
                        upcomingDays.push({
                            date: date,
                            week: weeksSinceStart,
                            dayName: dayName,
                            topic: dayInfo.topic,
                            timeEstimate: dayInfo.time_estimate
                        });
                    }
                }
            }

            if (upcomingDays.length === 0) {
                container.innerHTML = `
                <div class="text-center py-3 text-muted">
                    <i class="fas fa-check-circle fa-2x mb-2"></i>
                    <p class="mb-0">All caught up!</p>
                </div>
            `;
            } else {
                container.innerHTML = upcomingDays.slice(0, 5).map(task => `
                <div class="task-item mb-3 pb-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">${task.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</h6>
                            <p class="mb-1 text-primary">${task.topic}</p>
                            <small class="text-muted">Week ${task.week}, ${task.dayName}</small>
                        </div>
                        <span class="badge bg-light text-dark">${task.timeEstimate}min</span>
                    </div>
                </div>
            `).join('');
            }
        }

        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
                updateMonthStats();
            });

            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
                updateMonthStats();
            });

            document.getElementById('today-btn').addEventListener('click', () => {
                currentDate = new Date();
                renderCalendar();
                updateMonthStats();

                // Select today
                const today = new Date();
                selectDate(today);
            });
        }

        // Global functions for onclick handlers
        window.viewWeekProgress = function (week) {
            window.location.href = `/pages/roadmap?week=${week}`;
        };

        window.startStudySession = function (week, day) {
            // Store session info and redirect to pomodoro
            Storage.session.setItem('study_session', { week, day });
            window.location.href = '/pages/pomodoro';
        };

        // Add custom styles
        const style = document.createElement('style');
        style.textContent = `
        .calendar-grid {
            display: flex;
            flex-direction: column;
        }
        
        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            margin-bottom: 1px;
        }
        
        .calendar-weekday {
            padding: 10px;
            text-align: center;
            font-weight: bold;
            background-color: var(--bs-gray-100);
            font-size: 0.875rem;
        }
        
        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background-color: var(--bs-gray-200);
        }
        
        .calendar-day {
            background-color: white;
            min-height: 80px;
            padding: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }
        
        .calendar-day:hover {
            background-color: var(--bs-light);
        }
        
        .calendar-day.other-month {
            color: var(--bs-gray-400);
            background-color: var(--bs-gray-50);
        }
        
        .calendar-day.today {
            background-color: var(--bs-primary-bg-subtle);
        }
        
        .calendar-day.selected {
            background-color: var(--bs-primary);
            color: white;
        }
        
        .calendar-day.completed {
            background-color: var(--bs-success-bg-subtle);
        }
        
        .day-number {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .day-indicators {
            position: absolute;
            bottom: 4px;
            right: 4px;
            font-size: 0.75rem;
        }
        
        @media (max-width: 768px) {
            .calendar-day {
                min-height: 60px;
                padding: 4px;
                font-size: 0.875rem;
            }
        }
    `;
        document.head.appendChild(style);
    });
</script>