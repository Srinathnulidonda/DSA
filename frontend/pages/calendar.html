<!-- pages/calendar.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - DSA Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>

<body>
    <!-- Mobile Header -->
    <div class="mobile-header d-lg-none">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0 fw-bold">Calendar</h4>
                <small class="text-muted" id="currentMonth">Loading...</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="goToToday()">
                    <i class="fas fa-calendar-day"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="/roadmap">Roadmap View</a></li>
                        <li><a class="dropdown-item" href="#" onclick="exportCalendar()">Export Calendar</a></li>
                        <li><a class="dropdown-item" href="#" onclick="syncCalendar()">Sync with Google</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <!-- Topbar -->
        <div id="topbarContainer"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Calendar Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card animate-fade-in">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-lg-6">
                                    <div class="d-flex align-items-center">
                                        <button class="btn btn-outline-primary me-2" onclick="previousMonth()">
                                            <i class="fas fa-chevron-left"></i>
                                        </button>
                                        <h3 class="mb-0 me-2" id="calendarTitle">Loading...</h3>
                                        <button class="btn btn-outline-primary me-3" onclick="nextMonth()">
                                            <i class="fas fa-chevron-right"></i>
                                        </button>
                                        <button class="btn btn-outline-secondary" onclick="goToToday()">Today</button>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="d-flex justify-content-lg-end justify-content-start mt-3 mt-lg-0 gap-2">
                                        <div class="btn-group" role="group">
                                            <button type="button" class="btn btn-outline-primary active"
                                                onclick="setView('month')">Month</button>
                                            <button type="button" class="btn btn-outline-primary"
                                                onclick="setView('week')">Week</button>
                                            <button type="button" class="btn btn-outline-primary"
                                                onclick="setView('agenda')">Agenda</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Legend -->
            <div class="row mb-3">
                <div class="col-12">
                    <div class="card">
                        <div class="card-body py-2">
                            <div class="d-flex flex-wrap align-items-center gap-3">
                                <span class="d-flex align-items-center">
                                    <div class="bg-success rounded me-1" style="width: 12px; height: 12px;"></div>
                                    <small>Completed</small>
                                </span>
                                <span class="d-flex align-items-center">
                                    <div class="bg-warning rounded me-1" style="width: 12px; height: 12px;"></div>
                                    <small>In Progress</small>
                                </span>
                                <span class="d-flex align-items-center">
                                    <div class="bg-primary rounded me-1" style="width: 12px; height: 12px;"></div>
                                    <small>Scheduled</small>
                                </span>
                                <span class="d-flex align-items-center">
                                    <div class="bg-danger rounded me-1" style="width: 12px; height: 12px;"></div>
                                    <small>Overdue</small>
                                </span>
                                <span class="d-flex align-items-center">
                                    <div class="bg-info rounded me-1" style="width: 12px; height: 12px;"></div>
                                    <small>Today</small>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Grid -->
            <div class="row">
                <div class="col-12">
                    <div class="card animate-slide-up">
                        <div class="card-body p-0" id="calendarContainer">
                            <!-- Calendar will be loaded here -->
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Loading calendar...</span>
                                </div>
                                <p class="text-muted">Loading your study calendar...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Schedule -->
            <div class="row mt-4">
                <div class="col-lg-8">
                    <div class="card animate-slide-up animation-delay-100">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Today's Schedule</h5>
                        </div>
                        <div class="card-body" id="todaySchedule">
                            <!-- Today's tasks will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card animate-slide-up animation-delay-200">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Week Overview</h5>
                        </div>
                        <div class="card-body" id="weekOverview">
                            <!-- Week stats will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Deadlines -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card animate-slide-up animation-delay-300">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Upcoming Deadlines</h5>
                        </div>
                        <div class="card-body" id="upcomingDeadlines">
                            <!-- Upcoming deadlines will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <!-- Day Details Modal -->
    <div class="modal fade" id="dayDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayDetailsTitle">Day Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="dayDetailsBody">
                    <!-- Day details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="goToRoadmap()">View in Roadmap</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Task Modal -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Custom Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addTaskForm">
                        <div class="mb-3">
                            <label for="taskTitle" class="form-label">Task Title</label>
                            <input type="text" class="form-control" id="taskTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="taskDate" required>
                        </div>
                        <div class="mb-3">
                            <label for="taskDescription" class="form-label">Description</label>
                            <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="taskPriority" class="form-label">Priority</label>
                            <select class="form-control" id="taskPriority">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="addCustomTask()">Add Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';

        // Global variables
        let currentUser = null;
        let currentDate = new Date();
        let currentView = 'month';
        let calendarData = {};
        let roadmapData = [];
        let userProgress = {};

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadComponents();
            await loadCalendarData();
            setActivePage('calendar');
            updateCalendarDisplay();
        });

        // Authentication check
        async function checkAuth() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Authentication failed');
                }

                const data = await response.json();
                currentUser = data.user;
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = '/login';
            }
        }

        // Load reusable components
        async function loadComponents() {
            try {
                const sidebarResponse = await fetch('../components/sidebar.html');
                const sidebarHtml = await sidebarResponse.text();
                document.getElementById('sidebarContainer').innerHTML = sidebarHtml;

                if (window.innerWidth >= 992) {
                    const topbarResponse = await fetch('../components/topbar.html');
                    const topbarHtml = await topbarResponse.text();
                    document.getElementById('topbarContainer').innerHTML = topbarHtml;

                    setTimeout(() => {
                        const pageTitle = document.getElementById('pageTitle');
                        if (pageTitle) pageTitle.textContent = 'Calendar';
                    }, 100);
                }

                const mobileNavResponse = await fetch('../components/mobile-nav.html');
                const mobileNavHtml = await mobileNavResponse.text();
                document.getElementById('mobileNavContainer').innerHTML = mobileNavHtml;

            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Load calendar data
        async function loadCalendarData() {
            const token = localStorage.getItem('accessToken');

            try {
                // Load roadmap for calendar events
                const roadmapResponse = await fetch(`${API_BASE}/roadmap`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (roadmapResponse.ok) {
                    const data = await roadmapResponse.json();
                    roadmapData = data.roadmap;
                }

                // Load user progress
                const progressResponse = await fetch(`${API_BASE}/progress`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (progressResponse.ok) {
                    const progressData = await progressResponse.json();
                    userProgress = progressData.progress;
                }

                generateCalendarEvents();

            } catch (error) {
                console.error('Calendar error:', error);
                showToast('Error loading calendar data', 'error');
            }
        }

        // Generate calendar events from roadmap
        function generateCalendarEvents() {
            calendarData = {};
            const startDate = new Date('2024-01-01'); // Start date for the program

            roadmapData.forEach(week => {
                week.days.forEach((day, dayIndex) => {
                    const eventDate = new Date(startDate);
                    eventDate.setDate(startDate.getDate() + (week.week - 1) * 7 + dayIndex);

                    const dateKey = eventDate.toISOString().split('T')[0];
                    const progress = userProgress[week.week]?.[day.day];

                    if (!calendarData[dateKey]) {
                        calendarData[dateKey] = [];
                    }

                    calendarData[dateKey].push({
                        id: `week-${week.week}-${day.day}`,
                        title: day.topic,
                        description: day.activities,
                        week: week.week,
                        day: day.day,
                        timeEstimate: day.time_estimate,
                        resources: day.resources,
                        completed: progress?.completed || false,
                        timeSpent: progress?.time_spent || 0,
                        completionDate: progress?.completion_date,
                        type: 'study'
                    });
                });
            });
        }

        // Update calendar display
        function updateCalendarDisplay() {
            updateCalendarTitle();
            renderCalendar();
            renderTodaySchedule();
            renderWeekOverview();
            renderUpcomingDeadlines();
        }

        // Update calendar title
        function updateCalendarTitle() {
            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];

            const title = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear()}`;
            document.getElementById('calendarTitle').textContent = title;
            document.getElementById('currentMonth').textContent = title;
        }

        // Render calendar
        function renderCalendar() {
            const container = document.getElementById('calendarContainer');

            if (currentView === 'month') {
                container.innerHTML = renderMonthView();
            } else if (currentView === 'week') {
                container.innerHTML = renderWeekView();
            } else if (currentView === 'agenda') {
                container.innerHTML = renderAgendaView();
            }
        }

        // Render month view
        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const today = new Date();
            const todayString = today.toISOString().split('T')[0];

            let html = `
                <div class="calendar-grid">
                    <div class="calendar-header">
                        <div class="calendar-day-header">Sun</div>
                        <div class="calendar-day-header">Mon</div>
                        <div class="calendar-day-header">Tue</div>
                        <div class="calendar-day-header">Wed</div>
                        <div class="calendar-day-header">Thu</div>
                        <div class="calendar-day-header">Fri</div>
                        <div class="calendar-day-header">Sat</div>
                    </div>
                    <div class="calendar-body">
            `;

            for (let week = 0; week < 6; week++) {
                for (let day = 0; day < 7; day++) {
                    const currentDay = new Date(startDate);
                    currentDay.setDate(startDate.getDate() + week * 7 + day);

                    const dateString = currentDay.toISOString().split('T')[0];
                    const dayEvents = calendarData[dateString] || [];
                    const isToday = dateString === todayString;
                    const isCurrentMonth = currentDay.getMonth() === month;

                    let dayClasses = 'calendar-day';
                    if (isToday) dayClasses += ' today';
                    if (!isCurrentMonth) dayClasses += ' other-month';
                    if (dayEvents.some(e => e.completed)) dayClasses += ' has-completed';
                    if (dayEvents.some(e => !e.completed && new Date(dateString) < today)) dayClasses += ' has-overdue';

                    html += `
                        <div class="${dayClasses}" onclick="showDayDetails('${dateString}')" data-date="${dateString}">
                            <div class="day-number">${currentDay.getDate()}</div>
                            <div class="day-events">
                                ${dayEvents.slice(0, 3).map(event => `
                                    <div class="event-item ${event.completed ? 'completed' : 'pending'}" title="${event.title}">
                                        <i class="fas fa-circle text-xs me-1"></i>
                                        <span class="event-title">${event.title.substring(0, 15)}${event.title.length > 15 ? '...' : ''}</span>
                                    </div>
                                `).join('')}
                                ${dayEvents.length > 3 ? `<div class="more-events">+${dayEvents.length - 3} more</div>` : ''}
                            </div>
                        </div>
                    `;
                }
            }

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // Render week view
        function renderWeekView() {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

            let html = `
                <div class="week-view p-3">
                    <div class="row">
            `;

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateString = day.toISOString().split('T')[0];
                const dayEvents = calendarData[dateString] || [];
                const isToday = dateString === new Date().toISOString().split('T')[0];

                html += `
                    <div class="col">
                        <div class="week-day ${isToday ? 'today' : ''}">
                            <div class="week-day-header">
                                <div class="day-name">${day.toLocaleDateString('en', { weekday: 'short' })}</div>
                                <div class="day-number">${day.getDate()}</div>
                            </div>
                            <div class="week-day-events">
                                ${dayEvents.map(event => `
                                    <div class="week-event ${event.completed ? 'completed' : 'pending'}" onclick="showEventDetails('${event.id}')">
                                        <div class="event-time">${event.timeEstimate}min</div>
                                        <div class="event-title">${event.title}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            html += `
                    </div>
                </div>
            `;

            return html;
        }

        // Render agenda view
        function renderAgendaView() {
            const today = new Date();
            const events = [];

            // Collect all events for the next 30 days
            for (let i = 0; i < 30; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                const dayEvents = calendarData[dateString] || [];

                dayEvents.forEach(event => {
                    events.push({
                        ...event,
                        date: dateString,
                        dateObj: date
                    });
                });
            }

            // Group events by status
            const pendingEvents = events.filter(e => !e.completed);
            const completedEvents = events.filter(e => e.completed);

            let html = `
                <div class="agenda-view p-3">
                    <div class="row">
                        <div class="col-lg-6">
                            <h6 class="mb-3">Upcoming Tasks (${pendingEvents.length})</h6>
                            ${pendingEvents.slice(0, 20).map(event => `
                                <div class="agenda-item pending mb-2" onclick="showEventDetails('${event.id}')">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">${event.title}</h6>
                                            <p class="mb-1 text-muted small">${event.description}</p>
                                            <small class="text-muted">
                                                <i class="fas fa-calendar me-1"></i>${event.dateObj.toLocaleDateString()}
                                                <i class="fas fa-clock ms-2 me-1"></i>${event.timeEstimate} min
                                            </small>
                                        </div>
                                        <span class="badge bg-primary">Week ${event.week}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="col-lg-6">
                            <h6 class="mb-3">Completed Tasks (${completedEvents.length})</h6>
                            ${completedEvents.slice(0, 20).map(event => `
                                <div class="agenda-item completed mb-2">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">${event.title}</h6>
                                            <small class="text-muted">
                                                <i class="fas fa-check-circle text-success me-1"></i>Completed
                                                ${event.timeSpent ? `• ${event.timeSpent} min spent` : ''}
                                            </small>
                                        </div>
                                        <span class="badge bg-success">Week ${event.week}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;

            return html;
        }

        // Render today's schedule
        function renderTodaySchedule() {
            const today = new Date().toISOString().split('T')[0];
            const todayEvents = calendarData[today] || [];
            const container = document.getElementById('todaySchedule');

            if (todayEvents.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-calendar-day text-3xl mb-2"></i>
                        <p>No scheduled tasks for today</p>
                        <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                            <i class="fas fa-plus me-1"></i>Add Task
                        </button>
                    </div>
                `;
                return;
            }

            let html = '';
            todayEvents.forEach(event => {
                const statusClass = event.completed ? 'success' : 'primary';
                const statusIcon = event.completed ? 'fa-check-circle' : 'fa-clock';

                html += `
                    <div class="d-flex align-items-center mb-3 p-3 border rounded hover-lift" onclick="showEventDetails('${event.id}')">
                        <div class="flex-shrink-0 me-3">
                            <i class="fas ${statusIcon} text-${statusClass} text-2xl"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${event.title}</h6>
                            <p class="mb-1 text-muted">${event.description}</p>
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>${event.timeEstimate} min
                                ${event.timeSpent ? `• ${event.timeSpent} min spent` : ''}
                            </small>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="badge bg-${statusClass}">Week ${event.week}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Render week overview
        function renderWeekOverview() {
            const startOfWeek = new Date();
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());

            let totalTasks = 0;
            let completedTasks = 0;
            let totalTime = 0;
            let spentTime = 0;

            for (let i = 0; i < 7; i++) {
                const day = new Date(startOfWeek);
                day.setDate(startOfWeek.getDate() + i);
                const dateString = day.toISOString().split('T')[0];
                const dayEvents = calendarData[dateString] || [];

                totalTasks += dayEvents.length;
                completedTasks += dayEvents.filter(e => e.completed).length;
                totalTime += dayEvents.reduce((sum, e) => sum + e.timeEstimate, 0);
                spentTime += dayEvents.reduce((sum, e) => sum + (e.timeSpent || 0), 0);
            }

            const completion = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;

            document.getElementById('weekOverview').innerHTML = `
                <div class="text-center mb-3">
                    <div class="progress-ring mx-auto mb-2" style="width: 80px; height: 80px;">
                        <svg width="80" height="80">
                            <circle cx="40" cy="40" r="30" class="progress-ring-circle"></circle>
                            <circle cx="40" cy="40" r="30" class="progress-ring-progress" 
                                    style="stroke-dasharray: ${completion * 1.88} 188;"></circle>
                        </svg>
                        <div class="position-absolute top-50 start-50 translate-middle">
                            <strong>${completion}%</strong>
                        </div>
                    </div>
                    <h6>Week Completion</h6>
                </div>
                
                <div class="row text-center">
                    <div class="col-6">
                        <h5 class="text-primary mb-0">${completedTasks}</h5>
                        <small class="text-muted">Completed</small>
                    </div>
                    <div class="col-6">
                        <h5 class="text-warning mb-0">${totalTasks - completedTasks}</h5>
                        <small class="text-muted">Remaining</small>
                    </div>
                </div>
                
                <hr>
                
                <div class="row text-center">
                    <div class="col-6">
                        <h6 class="text-success mb-0">${Math.round(spentTime / 60)}h</h6>
                        <small class="text-muted">Time Spent</small>
                    </div>
                    <div class="col-6">
                        <h6 class="text-info mb-0">${Math.round(totalTime / 60)}h</h6>
                        <small class="text-muted">Total Planned</small>
                    </div>
                </div>
            `;
        }

        // Render upcoming deadlines
        function renderUpcomingDeadlines() {
            const today = new Date();
            const deadlines = [];

            // Find overdue and upcoming tasks
            for (let i = -7; i < 14; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dateString = date.toISOString().split('T')[0];
                const dayEvents = calendarData[dateString] || [];

                dayEvents.forEach(event => {
                    if (!event.completed) {
                        deadlines.push({
                            ...event,
                            date: dateString,
                            dateObj: date,
                            isOverdue: i < 0,
                            daysFromNow: i
                        });
                    }
                });
            }

            // Sort by date
            deadlines.sort((a, b) => a.dateObj - b.dateObj);

            const container = document.getElementById('upcomingDeadlines');

            if (deadlines.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-calendar-check text-3xl mb-2 text-success"></i>
                        <p>All caught up! No upcoming deadlines.</p>
                    </div>
                `;
                return;
            }

            let html = '';
            deadlines.slice(0, 10).forEach(deadline => {
                const urgencyClass = deadline.isOverdue ? 'danger' :
                    deadline.daysFromNow <= 1 ? 'warning' : 'primary';
                const urgencyText = deadline.isOverdue ? 'Overdue' :
                    deadline.daysFromNow === 0 ? 'Today' :
                        deadline.daysFromNow === 1 ? 'Tomorrow' :
                            `${deadline.daysFromNow} days`;

                html += `
                    <div class="d-flex align-items-center mb-3 p-3 border-start border-4 border-${urgencyClass} bg-light">
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${deadline.title}</h6>
                            <p class="mb-1 text-muted small">${deadline.description}</p>
                            <small class="text-muted">
                                <i class="fas fa-calendar me-1"></i>${deadline.dateObj.toLocaleDateString()}
                                <i class="fas fa-clock ms-2 me-1"></i>${deadline.timeEstimate} min
                            </small>
                        </div>
                        <div class="flex-shrink-0">
                            <span class="badge bg-${urgencyClass}">${urgencyText}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Navigation functions
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            updateCalendarDisplay();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            updateCalendarDisplay();
        }

        function goToToday() {
            currentDate = new Date();
            updateCalendarDisplay();
        }

        function setView(view) {
            currentView = view;

            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            renderCalendar();
        }

        // Show day details
        function showDayDetails(dateString) {
            const date = new Date(dateString);
            const events = calendarData[dateString] || [];

            document.getElementById('dayDetailsTitle').textContent =
                `${date.toLocaleDateString('en', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}`;

            let html = '';
            if (events.length === 0) {
                html = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-calendar-day text-4xl mb-3"></i>
                        <p>No scheduled tasks for this day</p>
                        <button class="btn btn-primary" onclick="addTaskForDate('${dateString}')">
                            <i class="fas fa-plus me-1"></i>Add Task
                        </button>
                    </div>
                `;
            } else {
                events.forEach(event => {
                    const statusClass = event.completed ? 'success' : 'primary';
                    const statusIcon = event.completed ? 'fa-check-circle' : 'fa-clock';

                    html += `
                        <div class="card mb-3">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0">${event.title}</h6>
                                    <span class="badge bg-${statusClass}">
                                        <i class="fas ${statusIcon} me-1"></i>
                                        ${event.completed ? 'Completed' : 'Pending'}
                                    </span>
                                </div>
                                <p class="text-muted mb-2">${event.description}</p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>${event.timeEstimate} min
                                        ${event.timeSpent ? `• ${event.timeSpent} min spent` : ''}
                                    </small>
                                    <button class="btn btn-outline-primary btn-sm" onclick="goToRoadmapDay(${event.week}, '${event.day}')">
                                        View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('dayDetailsBody').innerHTML = html;
            new bootstrap.Modal(document.getElementById('dayDetailsModal')).show();
        }

        // Add custom task
        function addCustomTask() {
            const title = document.getElementById('taskTitle').value;
            const date = document.getElementById('taskDate').value;
            const description = document.getElementById('taskDescription').value;
            const priority = document.getElementById('taskPriority').value;

            if (!title || !date) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }

            // In real implementation, would save to backend
            if (!calendarData[date]) {
                calendarData[date] = [];
            }

            calendarData[date].push({
                id: `custom-${Date.now()}`,
                title: title,
                description: description,
                week: 'Custom',
                day: 'Custom',
                timeEstimate: 60,
                resources: [],
                completed: false,
                timeSpent: 0,
                type: 'custom',
                priority: priority
            });

            updateCalendarDisplay();
            bootstrap.Modal.getInstance(document.getElementById('addTaskModal')).hide();
            document.getElementById('addTaskForm').reset();
            showToast('Custom task added successfully!', 'success');
        }

        function addTaskForDate(dateString) {
            document.getElementById('taskDate').value = dateString;
            bootstrap.Modal.getInstance(document.getElementById('dayDetailsModal')).hide();
            new bootstrap.Modal(document.getElementById('addTaskModal')).show();
        }

        function goToRoadmapDay(week, day) {
            window.location.href = `/roadmap?week=${week}`;
        }

        function goToRoadmap() {
            window.location.href = '/roadmap';
        }

        // Export calendar
        function exportCalendar() {
            const events = [];
            Object.keys(calendarData).forEach(date => {
                calendarData[date].forEach(event => {
                    events.push({
                        date: date,
                        title: event.title,
                        description: event.description,
                        completed: event.completed,
                        timeEstimate: event.timeEstimate,
                        timeSpent: event.timeSpent
                    });
                });
            });

            const blob = new Blob([JSON.stringify(events, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsa-calendar-${currentUser.name}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Calendar exported successfully!', 'success');
        }

        // Sync with Google Calendar (placeholder)
        function syncCalendar() {
            showToast('Google Calendar integration would be implemented here', 'info');
        }

        // Set active page in navigation
        function setActivePage(page) {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });

            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();

            const toast = `
                <div class="toast ${type}" role="alert" id="${toastId}">
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            toastContainer.innerHTML += toast;

            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement);
            bsToast.show();

            setTimeout(() => {
                toastElement.remove();
            }, 5000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
    </script>

    <style>
        .calendar-grid {
            display: grid;
            grid-template-rows: auto 1fr;
            min-height: 500px;
        }

        .calendar-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            background-color: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .calendar-day-header {
            padding: 1rem;
            text-align: center;
            font-weight: 600;
            color: #374151;
            border-right: 1px solid #e5e7eb;
        }

        .calendar-body {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: repeat(6, 1fr);
        }

        .calendar-day {
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
            min-height: 100px;
        }

        .calendar-day:hover {
            background-color: #f8fafc;
        }

        .calendar-day.today {
            background-color: #dbeafe;
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.has-completed {
            border-left: 4px solid #22c55e;
        }

        .calendar-day.has-overdue {
            border-left: 4px solid #ef4444;
        }

        .day-number {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .day-events {
            font-size: 0.75rem;
        }

        .event-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.25rem;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            background-color: rgba(59, 130, 246, 0.1);
        }

        .event-item.completed {
            background-color: rgba(34, 197, 94, 0.1);
            text-decoration: line-through;
        }

        .event-title {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .more-events {
            color: #6b7280;
            font-style: italic;
            text-align: center;
            margin-top: 0.25rem;
        }

        .week-view .week-day {
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 200px;
        }

        .week-view .week-day.today {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .week-day-header {
            text-align: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .day-name {
            font-weight: 600;
            color: #374151;
        }

        .day-number {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
        }

        .week-event {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .week-event:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .week-event.completed {
            background-color: #f0fdf4;
            border-color: #22c55e;
        }

        .event-time {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 0.25rem;
        }

        .agenda-item {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .agenda-item:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .agenda-item.completed {
            opacity: 0.7;
        }

        .progress-ring {
            position: relative;
        }

        .progress-ring-circle {
            stroke: #e5e7eb;
            stroke-width: 4;
            fill: none;
        }

        .progress-ring-progress {
            stroke: #3b82f6;
            stroke-width: 4;
            fill: none;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dasharray 0.5s ease;
        }
    </style>
</body>

</html>