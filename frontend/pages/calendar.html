<!-- pages/calendar.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendar - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <div id="topbar-container"></div>

            <!-- Calendar Content -->
            <div class="container-fluid mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">Study Calendar</h1>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeView('month')">
                            <i class="fas fa-calendar-alt"></i> Month
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeView('week')">
                            <i class="fas fa-calendar-week"></i> Week
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="changeView('list')">
                            <i class="fas fa-list"></i> List
                        </button>
                    </div>
                </div>

                <!-- Calendar Navigation -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="calendar-header">
                            <button class="btn btn-sm btn-outline-secondary" onclick="navigateCalendar(-1)">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h4 class="mb-0" id="currentMonthYear">Loading...</h4>
                            <button class="btn btn-sm btn-outline-secondary" onclick="navigateCalendar(1)">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendar View -->
                <div id="calendarView" class="card">
                    <div class="card-body">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading calendar...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Stats -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Study Streak</h5>
                                <div class="display-4 text-primary" id="currentStreakDisplay">0</div>
                                <p class="text-muted">consecutive days</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">This Month</h5>
                                <div class="display-4 text-success" id="monthlyDaysDisplay">0</div>
                                <p class="text-muted">days studied</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total Progress</h5>
                                <div class="display-4 text-info" id="totalProgressDisplay">0%</div>
                                <p class="text-muted">course completion</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/animation.js"></script>

    <script>
        // Load components
        fetch('/components/sidebar.html').then(r => r.text()).then(html => {
            document.getElementById('sidebar-container').innerHTML = html;
            initSidebar();
        });

        fetch('/components/topbar.html').then(r => r.text()).then(html => {
            document.getElementById('topbar-container').innerHTML = html;
        });

        fetch('/components/mobile-nav.html').then(r => r.text()).then(html => {
            document.getElementById('mobile-nav-container').innerHTML = html;
            initMobileNav();
        });

        // Calendar functionality
        let currentDate = new Date();
        let currentView = 'month';
        let progressData = {};
        let roadmapData = [];

        async function loadCalendarData() {
            try {
                const [progressResponse, roadmapResponse, dashboardResponse] = await Promise.all([
                    api.get('/progress'),
                    api.get('/roadmap'),
                    api.get('/dashboard')
                ]);

                progressData = progressResponse.progress;
                roadmapData = roadmapResponse.roadmap;

                // Update stats
                document.getElementById('currentStreakDisplay').textContent = dashboardResponse.stats.current_streak;
                document.getElementById('totalProgressDisplay').textContent =
                    Math.round(dashboardResponse.stats.completion_percentage) + '%';

                renderCalendar();

            } catch (error) {
                console.error('Failed to load calendar data:', error);
                showToast('Failed to load calendar data', 'danger');
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarView');

            switch (currentView) {
                case 'month':
                    renderMonthView(container);
                    break;
                case 'week':
                    renderWeekView(container);
                    break;
                case 'list':
                    renderListView(container);
                    break;
            }

            updateMonthlyStats();
        }

        function renderMonthView(container) {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            document.getElementById('currentMonthYear').textContent =
                currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDayOfWeek = firstDay.getDay();

            let html = '<div class="calendar-grid">';

            // Day headers
            const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayHeaders.forEach(day => {
                html += `<div class="text-center fw-bold p-2">${day}</div>`;
            });

            // Empty cells for days before month starts
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += '<div class="calendar-day opacity-25"></div>';
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                const isToday = isDateToday(date);
                const studyData = getStudyDataForDate(date);

                html += `
                    <div class="calendar-day ${isToday ? 'today' : ''} ${studyData.completed ? 'completed' : ''}" 
                         onclick="showDayDetails('${dateStr}')">
                        <div class="fw-bold">${day}</div>
                        ${studyData.completed ? '<i class="fas fa-check-circle text-success small"></i>' : ''}
                        ${studyData.scheduled ? '<i class="fas fa-dot-circle text-primary small"></i>' : ''}
                    </div>
                `;
            }

            html += '</div>';

            container.innerHTML = `
                <div class="card-body">
                    ${html}
                    <div class="mt-3 d-flex gap-3 justify-content-center">
                        <small><i class="fas fa-check-circle text-success"></i> Completed</small>
                        <small><i class="fas fa-dot-circle text-primary"></i> Scheduled</small>
                        <small><span class="badge bg-primary">Today</span></small>
                    </div>
                </div>
            `;
        }

        function renderWeekView(container) {
            const startOfWeek = new Date(currentDate);
            startOfWeek.setDate(currentDate.getDate() - currentDate.getDay());

            let html = '<div class="list-group">';

            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + i);
                const dateStr = date.toISOString().split('T')[0];
                const studyData = getStudyDataForDate(date);
                const isToday = isDateToday(date);

                html += `
                    <div class="list-group-item ${isToday ? 'active' : ''}" 
                         onclick="showDayDetails('${dateStr}')">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${date.toLocaleDateString('en-US', { weekday: 'long' })}</h6>
                                <p class="mb-0">${date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</p>
                            </div>
                            <div class="text-end">
                                ${studyData.topic ? `<small class="d-block">${studyData.topic}</small>` : ''}
                                ${studyData.completed ?
                        '<span class="badge bg-success">Completed</span>' :
                        studyData.scheduled ?
                            '<span class="badge bg-primary">Scheduled</span>' :
                            '<span class="badge bg-secondary">No Activity</span>'
                    }
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';

            container.innerHTML = `<div class="card-body">${html}</div>`;
        }

        function renderListView(container) {
            let html = '<div class="accordion" id="calendarAccordion">';

            roadmapData.forEach(week => {
                const weekProgress = progressData[week.week] || {};
                const completedDays = Object.values(weekProgress).filter(d => d.completed).length;

                html += `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#week${week.week}">
                                <div class="d-flex justify-content-between w-100 me-3">
                                    <span>Week ${week.week}: ${week.title}</span>
                                    <span class="badge bg-${completedDays === week.days.length ? 'success' : 'primary'}">
                                        ${completedDays}/${week.days.length} days
                                    </span>
                                </div>
                            </button>
                        </h2>
                        <div id="week${week.week}" class="accordion-collapse collapse" 
                             data-bs-parent="#calendarAccordion">
                            <div class="accordion-body">
                                <div class="list-group">
                                    ${week.days.map(day => {
                    const dayProgress = weekProgress[day.day] || {};
                    return `
                                            <div class="list-group-item">
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div>
                                                        <h6 class="mb-1">${day.day}: ${day.topic}</h6>
                                                        <p class="mb-1 text-muted small">${day.activities}</p>
                                                        <small class="text-muted">
                                                            <i class="fas fa-clock"></i> ${day.time_estimate} mins
                                                        </small>
                                                    </div>
                                                    <div>
                                                        ${dayProgress.completed ?
                            '<span class="badge bg-success">Completed</span>' :
                            '<span class="badge bg-secondary">Pending</span>'
                        }
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                }).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';

            container.innerHTML = `<div class="card-body">${html}</div>`;
        }

        function getStudyDataForDate(date) {
            // Find if this date corresponds to any day in the roadmap
            let dayOfCourse = 0;
            const courseStartDate = new Date(); // This should be the actual course start date
            courseStartDate.setDate(courseStartDate.getDate() - 30); // Example: course started 30 days ago

            const daysSinceStart = Math.floor((date - courseStartDate) / (1000 * 60 * 60 * 24));

            let result = {
                completed: false,
                scheduled: false,
                topic: null,
                week: null,
                day: null
            };

            // Map date to roadmap week/day
            let accumulatedDays = 0;
            for (const week of roadmapData) {
                for (const day of week.days) {
                    if (accumulatedDays === daysSinceStart) {
                        result.scheduled = true;
                        result.topic = day.topic;
                        result.week = week.week;
                        result.day = day.day;

                        // Check if completed
                        const weekProgress = progressData[week.week] || {};
                        const dayProgress = weekProgress[day.day] || {};
                        result.completed = dayProgress.completed || false;

                        return result;
                    }
                    accumulatedDays++;
                }
            }

            return result;
        }

        function isDateToday(date) {
            const today = new Date();
            return date.getDate() === today.getDate() &&
                date.getMonth() === today.getMonth() &&
                date.getFullYear() === today.getFullYear();
        }

        function updateMonthlyStats() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            let monthlyDays = 0;

            // Count completed days in current month
            Object.values(progressData).forEach(weekData => {
                Object.values(weekData).forEach(dayData => {
                    if (dayData.completed && dayData.completion_date) {
                        const completionDate = new Date(dayData.completion_date);
                        if (completionDate.getFullYear() === year && completionDate.getMonth() === month) {
                            monthlyDays++;
                        }
                    }
                });
            });

            document.getElementById('monthlyDaysDisplay').textContent = monthlyDays;
        }

        function navigateCalendar(direction) {
            if (currentView === 'month') {
                currentDate.setMonth(currentDate.getMonth() + direction);
            } else if (currentView === 'week') {
                currentDate.setDate(currentDate.getDate() + (direction * 7));
            }
            renderCalendar();
        }

        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.btn-group .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.btn').classList.add('active');
            renderCalendar();
        }

        function showDayDetails(dateStr) {
            // Navigate to roadmap with specific day highlighted
            // For now, just show a toast
            showToast(`Details for ${dateStr}`, 'info');
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function () {
            loadCalendarData();
        });
    </script>
</body>

</html>