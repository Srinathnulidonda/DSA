<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Calendar - DSAPath</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body class="bg-light">
    <div class="app-wrapper">
        <!-- Topbar -->
        <nav class="topbar">
            <div class="container-fluid d-flex align-items-center">
                <button class="btn btn-link text-dark d-lg-none p-0 me-3" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars fa-lg"></i>
                </button>

                <a href="/pages/dashboard.html" class="topbar-brand">
                    <i class="fas fa-code-branch"></i>
                    DSAPath
                </a>

                <div class="topbar-nav">
                    <button class="btn btn-link text-dark position-relative" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                    </button>

                    <div class="dropdown">
                        <button class="btn btn-link text-dark dropdown-toggle d-flex align-items-center"
                            data-bs-toggle="dropdown">
                            <img src="/assets/images/default-avatar.png" alt="Avatar" class="rounded-circle me-2"
                                width="32" height="32" id="userAvatar">
                            <span class="d-none d-md-inline" id="userName">Loading...</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/pages/profile.html">
                                    <i class="fas fa-user me-2"></i>Profile
                                </a></li>
                            <li><a class="dropdown-item" href="/pages/settings.html">
                                    <i class="fas fa-cog me-2"></i>Settings
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <a href="/pages/dashboard.html" class="sidebar-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/pages/roadmap.html" class="sidebar-link">
                    <i class="fas fa-route"></i>
                    <span>Roadmap</span>
                </a>
                <a href="/pages/calendar.html" class="sidebar-link active">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
                <a href="/pages/progress.html" class="sidebar-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Progress</span>
                </a>
                <a href="/pages/notes.html" class="sidebar-link">
                    <i class="fas fa-sticky-note"></i>
                    <span>Notes</span>
                </a>
                <a href="/pages/pomodoro.html" class="sidebar-link">
                    <i class="fas fa-clock"></i>
                    <span>Pomodoro</span>
                </a>
                <a href="/pages/resources.html" class="sidebar-link">
                    <i class="fas fa-book"></i>
                    <span>Resources</span>
                </a>
                <a href="/pages/ai-assistant.html" class="sidebar-link">
                    <i class="fas fa-robot"></i>
                    <span>AI Assistant</span>
                </a>
                <a href="/pages/analytics.html" class="sidebar-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="page-header mb-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h1 class="page-title">Study Calendar</h1>
                            <p class="page-subtitle">Track your daily learning progress</p>
                        </div>
                        <div class="d-flex gap-2 mt-3 mt-md-0">
                            <button class="btn btn-outline-primary" onclick="previousMonth()">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="btn btn-outline-primary" onclick="currentMonth()">
                                Today
                            </button>
                            <button class="btn btn-outline-primary" onclick="nextMonth()">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendar Header -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <h3 class="mb-0" id="currentMonthYear">Loading...</h3>
                            <div class="d-flex gap-3">
                                <div class="d-flex align-items-center">
                                    <div class="legend-dot bg-success"></div>
                                    <span class="small text-muted">Completed</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="legend-dot bg-warning"></div>
                                    <span class="small text-muted">In Progress</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <div class="legend-dot bg-primary"></div>
                                    <span class="small text-muted">Today</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Grid -->
                <div class="card border-0 shadow-sm">
                    <div class="card-body p-0">
                        <div class="calendar-container">
                            <div class="calendar-header">
                                <div class="calendar-day-name">Sun</div>
                                <div class="calendar-day-name">Mon</div>
                                <div class="calendar-day-name">Tue</div>
                                <div class="calendar-day-name">Wed</div>
                                <div class="calendar-day-name">Thu</div>
                                <div class="calendar-day-name">Fri</div>
                                <div class="calendar-day-name">Sat</div>
                            </div>
                            <div id="calendarGrid" class="calendar-grid">
                                <!-- Calendar days will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Study Stats -->
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">This Month</h5>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-muted">Study Days</span>
                                    <span class="fw-bold" id="monthStudyDays">0</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span class="text-muted">Total Hours</span>
                                    <span class="fw-bold" id="monthTotalHours">0h</span>
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">Completion Rate</span>
                                    <span class="fw-bold text-success" id="monthCompletionRate">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="card-title">Upcoming Topics</h5>
                                <div id="upcomingTopics">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav-list">
                <li class="mobile-nav-item">
                    <a href="/pages/dashboard.html" class="mobile-nav-link">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/roadmap.html" class="mobile-nav-link">
                        <i class="fas fa-route"></i>
                        <span>Roadmap</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/progress.html" class="mobile-nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>Progress</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/pomodoro.html" class="mobile-nav-link">
                        <i class="fas fa-clock"></i>
                        <span>Timer</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <button class="mobile-nav-link" onclick="toggleMobileDrawer()">
                        <i class="fas fa-ellipsis-h"></i>
                        <span>More</span>
                    </button>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Day Details Modal -->
    <div class="modal fade" id="dayDetailsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="dayDetailsTitle">Day Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="dayDetailsContent">
                    <!-- Content will be loaded dynamically -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="goToRoadmap()">
                        View in Roadmap
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Drawer -->
    <div class="mobile-drawer" id="mobileDrawer">
        <div class="drawer-header p-3 border-bottom">
            <h5 class="mb-0">Menu</h5>
            <button class="btn-close" onclick="toggleMobileDrawer()"></button>
        </div>
        <div class="drawer-body">
            <nav class="nav flex-column p-3">
                <a href="/pages/calendar.html" class="nav-link active">
                    <i class="fas fa-calendar-alt me-2"></i>Calendar
                </a>
                <a href="/pages/notes.html" class="nav-link">
                    <i class="fas fa-sticky-note me-2"></i>Notes
                </a>
                <a href="/pages/resources.html" class="nav-link">
                    <i class="fas fa-book me-2"></i>Resources
                </a>
                <a href="/pages/ai-assistant.html" class="nav-link">
                    <i class="fas fa-robot me-2"></i>AI Assistant
                </a>
                <a href="/pages/analytics.html" class="nav-link">
                    <i class="fas fa-chart-bar me-2"></i>Analytics
                </a>
                <hr>
                <a href="/pages/profile.html" class="nav-link">
                    <i class="fas fa-user me-2"></i>Profile
                </a>
                <a href="/pages/settings.html" class="nav-link">
                    <i class="fas fa-cog me-2"></i>Settings
                </a>
                <a href="#" class="nav-link text-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </a>
            </nav>
        </div>
    </div>
    <div class="drawer-backdrop" id="drawerBackdrop" onclick="toggleMobileDrawer()"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/constants.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/theme.js"></script>
    <script src="/js/notifications.js"></script>

    <script>
        // Global variables
        let currentDate = new Date();
        let calendarData = null;
        let roadmapData = null;
        let selectedDayInfo = null;

        // Initialize calendar
        async function initCalendar() {
            try {
                // Load user data
                const user = auth.getUser();
                if (user) {
                    document.getElementById('userName').textContent = user.name;
                    if (user.avatar_url) {
                        document.getElementById('userAvatar').src = user.avatar_url;
                    }
                }

                // Load calendar and roadmap data
                const [calendarResponse, roadmapResponse] = await Promise.all([
                    api.getCalendar(),
                    api.getRoadmap()
                ]);

                calendarData = calendarResponse;
                roadmapData = roadmapResponse.roadmap;

                // Render calendar
                renderCalendar();

                // Load upcoming topics
                loadUpcomingTopics();

            } catch (error) {
                console.error('Calendar initialization error:', error);
                notifications.error('Failed to load calendar data');
            }
        }

        // Render calendar
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();

            // Update header
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();

            // Build calendar grid
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';

            // Add empty cells for days before month starts
            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day empty';
                grid.appendChild(emptyCell);
            }

            // Calculate month stats
            let monthStudyDays = 0;
            let monthTotalMinutes = 0;
            let monthCompletedDays = 0;
            let monthTotalDays = 0;

            // Add days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                const dayDate = new Date(year, month, day);
                const isToday = dayDate.toDateString() === today.toDateString();

                if (isToday) {
                    dayElement.classList.add('today');
                }

                // Check progress for this day
                const dayProgress = getDayProgressByDate(dayDate);

                if (dayProgress) {
                    monthTotalDays++;

                    if (dayProgress.completed) {
                        dayElement.classList.add('completed');
                        monthStudyDays++;
                        monthCompletedDays++;
                        monthTotalMinutes += dayProgress.time_spent || 0;
                    } else if (dayProgress.inProgress) {
                        dayElement.classList.add('in-progress');
                        monthTotalMinutes += dayProgress.time_spent || 0;
                    }

                    dayElement.style.cursor = 'pointer';
                    dayElement.onclick = () => showDayDetails(dayDate, dayProgress);
                }

                // Add day content
                dayElement.innerHTML = `
                    <div class="day-number">${day}</div>
                    ${dayProgress && dayProgress.topic ? `
                        <div class="day-topic">${dayProgress.topic}</div>
                    ` : ''}
                    ${dayProgress && dayProgress.completed ? `
                        <i class="fas fa-check-circle text-success"></i>
                    ` : ''}
                `;

                grid.appendChild(dayElement);
            }

            // Update stats
            document.getElementById('monthStudyDays').textContent = monthStudyDays;
            document.getElementById('monthTotalHours').textContent = `${Math.round(monthTotalMinutes / 60)}h`;
            document.getElementById('monthCompletionRate').textContent =
                monthTotalDays > 0 ? `${Math.round((monthCompletedDays / monthTotalDays) * 100)}%` : '0%';
        }

        // Get day progress by date
        function getDayProgressByDate(date) {
            if (!calendarData || !calendarData.calendar) return null;

            // Calculate which week and day this date corresponds to
            const startDate = new Date('2024-01-01'); // Assuming course starts on Jan 1, 2024
            const daysSinceStart = Math.floor((date - startDate) / (1000 * 60 * 60 * 24));

            if (daysSinceStart < 0) return null;

            const weekNum = Math.floor(daysSinceStart / 7) + 1;
            const dayInWeek = daysSinceStart % 7;

            if (weekNum < 1 || weekNum > 14) return null;

            const weekData = calendarData.calendar[weekNum];
            if (!weekData) return null;

            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const dayName = dayNames[date.getDay()];

            // Get roadmap data for this week/day
            const roadmapWeek = roadmapData.find(w => w.week === weekNum);
            if (!roadmapWeek) return null;

            const roadmapDay = roadmapWeek.days.find(d => d.day === dayName);
            if (!roadmapDay) return null;

            // Get progress data
            const progressData = weekData.progress[dayName];

            return {
                week: weekNum,
                day: dayName,
                topic: roadmapDay.topic,
                activities: roadmapDay.activities,
                time_estimate: roadmapDay.time_estimate,
                completed: progressData?.completed || false,
                time_spent: progressData?.time_spent || 0,
                completion_date: progressData?.completion_date,
                inProgress: progressData?.time_spent > 0 && !progressData?.completed
            };
        }

        // Show day details
        function showDayDetails(date, dayProgress) {
            selectedDayInfo = { date, dayProgress };

            const dateStr = date.toLocaleDateString('en-US', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            document.getElementById('dayDetailsTitle').textContent = dateStr;

            let content = `
                <div class="mb-3">
                    <h6 class="text-muted">Week ${dayProgress.week}, ${dayProgress.day}</h6>
                    <h5>${dayProgress.topic}</h5>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-muted mb-2">Activities</h6>
                    <p>${dayProgress.activities}</p>
                </div>
                
                <div class="row mb-3">
                    <div class="col-6">
                        <h6 class="text-muted mb-1">Estimated Time</h6>
                        <p class="mb-0">${dayProgress.time_estimate} minutes</p>
                    </div>
                    <div class="col-6">
                        <h6 class="text-muted mb-1">Time Spent</h6>
                        <p class="mb-0">${dayProgress.time_spent || 0} minutes</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 class="text-muted mb-2">Status</h6>
                    ${dayProgress.completed ? `
                        <span class="badge bg-success">
                            <i class="fas fa-check-circle me-1"></i>Completed
                        </span>
                        <p class="text-muted small mt-2 mb-0">
                            Completed on ${utils.formatDate(dayProgress.completion_date, 'long')}
                        </p>
                    ` : dayProgress.inProgress ? `
                        <span class="badge bg-warning">
                            <i class="fas fa-clock me-1"></i>In Progress
                        </span>
                    ` : `
                        <span class="badge bg-secondary">
                            <i class="fas fa-circle me-1"></i>Not Started
                        </span>
                    `}
                </div>
            `;

            document.getElementById('dayDetailsContent').innerHTML = content;

            const modal = new bootstrap.Modal(document.getElementById('dayDetailsModal'));
            modal.show();
        }

        // Go to roadmap
        function goToRoadmap() {
            if (selectedDayInfo) {
                window.location.href = `/pages/roadmap.html?week=${selectedDayInfo.dayProgress.week}&day=${selectedDayInfo.dayProgress.day}`;
            }
        }

        // Load upcoming topics
        async function loadUpcomingTopics() {
            const upcomingContainer = document.getElementById('upcomingTopics');

            try {
                // Find next 5 incomplete days
                const upcoming = [];
                const today = new Date();

                for (const week of roadmapData) {
                    for (const day of week.days) {
                        const weekProgress = calendarData.calendar[week.week];
                        const dayProgress = weekProgress?.progress[day.day];

                        if (!dayProgress?.completed) {
                            upcoming.push({
                                week: week.week,
                                day: day.day,
                                topic: day.topic,
                                time_estimate: day.time_estimate
                            });
                        }

                        if (upcoming.length >= 5) break;
                    }
                    if (upcoming.length >= 5) break;
                }

                if (upcoming.length === 0) {
                    upcomingContainer.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="fas fa-check-circle fa-3x mb-3"></i>
                            <p>All topics completed! ðŸŽ‰</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div class="list-group list-group-flush">';

                upcoming.forEach(item => {
                    html += `
                        <div class="list-group-item px-0 py-3 border-0 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="mb-1">${item.topic}</h6>
                                    <p class="text-muted small mb-0">
                                        Week ${item.week}, ${item.day} â€¢ ${item.time_estimate} min
                                    </p>
                                </div>
                                <button class="btn btn-sm btn-outline-primary" 
                                        onclick="window.location.href='/pages/roadmap.html?week=${item.week}'">
                                    View
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                upcomingContainer.innerHTML = html;

            } catch (error) {
                console.error('Error loading upcoming topics:', error);
                upcomingContainer.innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Failed to load upcoming topics</p>
                    </div>
                `;
            }
        }

        // Navigation functions
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function currentMonth() {
            currentDate = new Date();
            renderCalendar();
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Toggle mobile drawer
        function toggleMobileDrawer() {
            const drawer = document.getElementById('mobileDrawer');
            const backdrop = document.getElementById('drawerBackdrop');

            drawer.classList.toggle('open');
            backdrop.classList.toggle('show');
        }

        // Show notifications
        function showNotifications() {
            notifications.info('Notifications panel coming soon!');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.logout();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initCalendar();
        });

        // Add custom styles
        const style = document.createElement('style');
        style.textContent = `
            .calendar-container {
                overflow-x: auto;
            }
            
            .calendar-header {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                background: #f8f9fa;
                padding: 1rem 0;
                text-align: center;
                font-weight: 600;
                color: #6b7280;
                border-bottom: 1px solid #e5e7eb;
            }
            
            .calendar-grid {
                display: grid;
                grid-template-columns: repeat(7, 1fr);
                gap: 1px;
                background: #e5e7eb;
                padding: 1px;
            }
            
            .calendar-day {
                background: white;
                min-height: 100px;
                padding: 0.5rem;
                position: relative;
                transition: all 0.2s ease;
            }
            
            .calendar-day:hover:not(.empty) {
                background: #f8f9fa;
            }
            
            .calendar-day.empty {
                background: #fafafa;
            }
            
            .calendar-day.today {
                background: #e0e7ff;
                border: 2px solid var(--primary);
            }
            
            .calendar-day.completed {
                background: #d1fae5;
            }
            
            .calendar-day.in-progress {
                background: #fef3c7;
            }
            
            .day-number {
                font-weight: 600;
                margin-bottom: 0.25rem;
            }
            
            .day-topic {
                font-size: 0.75rem;
                color: #6b7280;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .calendar-day i {
                position: absolute;
                bottom: 0.5rem;
                right: 0.5rem;
                font-size: 0.875rem;
            }
            
            .legend-dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                margin-right: 0.5rem;
            }
            
            @media (max-width: 767px) {
                .calendar-day {
                    min-height: 80px;
                    padding: 0.25rem;
                }
                
                .day-topic {
                    display: none;
                }
                
                .calendar-day-name {
                    font-size: 0.875rem;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>