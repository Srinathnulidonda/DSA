<div class="page-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-graph-up text-primary me-2"></i>
                        Progress Analytics
                    </h1>
                    <p class="text-muted mb-0">Track your learning journey with detailed insights</p>
                </div>
                <div class="mt-3 mt-lg-0 d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-calendar-range me-2"></i>Last 30 Days
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="setTimeRange('7')">Last 7 Days</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setTimeRange('30')">Last 30 Days</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setTimeRange('90')">Last 3 Months</a></li>
                            <li><a class="dropdown-item" href="#" onclick="setTimeRange('all')">All Time</a></li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="exportProgressReport()">
                        <i class="bi bi-download me-2"></i>Export Report
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="row g-4 mb-4">
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-primary bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-trophy text-primary fs-4"></i>
                        </div>
                    </div>
                    <h3 class="h3 mb-1 text-primary fw-bold" id="overall-completion">0%</h3>
                    <p class="text-muted mb-1 small">Overall Completion</p>
                    <small class="text-success" id="completion-change">+0% this week</small>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-warning bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-fire text-warning fs-4"></i>
                        </div>
                    </div>
                    <h3 class="h3 mb-1 text-warning fw-bold" id="current-streak">0</h3>
                    <p class="text-muted mb-1 small">Day Streak</p>
                    <small class="text-muted" id="streak-status">Keep it up!</small>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-success bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-clock text-success fs-4"></i>
                        </div>
                    </div>
                    <h3 class="h3 mb-1 text-success fw-bold" id="total-study-time">0h</h3>
                    <p class="text-muted mb-1 small">Total Study Time</p>
                    <small class="text-info" id="weekly-avg-time">0h/week avg</small>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body text-center">
                    <div class="d-flex align-items-center justify-content-center mb-3">
                        <div class="bg-info bg-opacity-10 p-3 rounded-circle">
                            <i class="bi bi-speedometer2 text-info fs-4"></i>
                        </div>
                    </div>
                    <h3 class="h3 mb-1 text-info fw-bold" id="avg-daily-time">0m</h3>
                    <p class="text-muted mb-1 small">Daily Average</p>
                    <small class="text-primary" id="consistency-score">85% consistent</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row g-4 mb-4">
        <!-- Study Time Trend -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-graph-up text-primary me-2"></i>
                        Study Time Trend
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="chart-period" id="daily" checked>
                        <label class="btn btn-outline-primary" for="daily">Daily</label>

                        <input type="radio" class="btn-check" name="chart-period" id="weekly">
                        <label class="btn btn-outline-primary" for="weekly">Weekly</label>

                        <input type="radio" class="btn-check" name="chart-period" id="monthly">
                        <label class="btn btn-outline-primary" for="monthly">Monthly</label>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="study-time-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Distribution -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">
                        <i class="bi bi-pie-chart text-success me-2"></i>
                        Weekly Progress
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="progress-distribution-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Weekly Breakdown -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-calendar-check text-info me-2"></i>
                        Weekly Breakdown
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="expandAllWeeks()">
                        <i class="bi bi-arrows-expand me-1"></i>
                        Expand All
                    </button>
                </div>
                <div class="card-body">
                    <div id="weekly-breakdown">
                        <!-- Loading state -->
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2 mb-0">Loading weekly breakdown...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Study Habits -->
    <div class="row g-4">
        <!-- Consistency Heatmap -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">
                        <i class="bi bi-grid text-warning me-2"></i>
                        Study Consistency
                    </h5>
                    <small class="text-muted">Last 90 days activity</small>
                </div>
                <div class="card-body">
                    <div id="consistency-heatmap">
                        <!-- Heatmap will be generated here -->
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <small class="text-muted">Less</small>
                        <div class="d-flex gap-1">
                            <div class="heatmap-legend bg-light" style="width: 12px; height: 12px;"></div>
                            <div class="heatmap-legend bg-success bg-opacity-25" style="width: 12px; height: 12px;">
                            </div>
                            <div class="heatmap-legend bg-success bg-opacity-50" style="width: 12px; height: 12px;">
                            </div>
                            <div class="heatmap-legend bg-success bg-opacity-75" style="width: 12px; height: 12px;">
                            </div>
                            <div class="heatmap-legend bg-success" style="width: 12px; height: 12px;"></div>
                        </div>
                        <small class="text-muted">More</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Achievements -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-bottom-0">
                    <h5 class="mb-0">
                        <i class="bi bi-award text-warning me-2"></i>
                        Recent Achievements
                    </h5>
                </div>
                <div class="card-body">
                    <div id="achievements-list">
                        <!-- Achievements will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let progressData = null;
    let dashboardData = null;
    let currentTimeRange = '30';
    let studyTimeChart = null;
    let progressChart = null;

    document.addEventListener('DOMContentLoaded', async function () {
        await loadProgressData();
        setupProgressTracking();
        renderCharts();
        renderWeeklyBreakdown();
        renderConsistencyHeatmap();
        loadAchievements();

        // Setup chart period change listeners
        document.querySelectorAll('input[name="chart-period"]').forEach(radio => {
            radio.addEventListener('change', function () {
                updateStudyTimeChart(this.id);
            });
        });
    });

    async function loadProgressData() {
        try {
            const [progress, dashboard] = await Promise.all([
                API.progress.get(),
                API.dashboard.get()
            ]);

            progressData = progress.progress;
            dashboardData = dashboard;

            updateKeyMetrics();

        } catch (error) {
            console.error('Error loading progress data:', error);
            Notifications.handleApiError(error, 'Loading progress data');
            showErrorState();
        }
    }

    function showErrorState() {
        document.querySelector('.page-container').innerHTML = `
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="text-center py-5">
                    <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                    <h3>Unable to Load Progress</h3>
                    <p class="text-muted mb-4">There was an error loading your progress data.</p>
                    <button class="btn btn-primary" onclick="location.reload()">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    `;
    }

    function updateKeyMetrics() {
        if (!dashboardData || !dashboardData.stats) return;

        const stats = dashboardData.stats;

        // Overall completion
        document.getElementById('overall-completion').textContent = `${Math.round(stats.completion_percentage || 0)}%`;
        document.getElementById('completion-change').textContent = '+5% this week'; // Would be calculated from historical data

        // Current streak
        document.getElementById('current-streak').textContent = stats.current_streak || 0;
        document.getElementById('streak-status').textContent = stats.current_streak > 0 ? 'Keep it up!' : 'Start your streak!';

        // Study time
        const totalHours = Math.round((stats.total_study_time || 0) / 60);
        document.getElementById('total-study-time').textContent = `${totalHours}h`;

        const weeklyAvg = Math.round((stats.study_time_last_7_days || 0) / 7 / 60 * 10) / 10;
        document.getElementById('weekly-avg-time').textContent = `${weeklyAvg}h/week avg`;

        // Daily average
        const completedDays = stats.completed_days || 0;
        const avgDaily = completedDays > 0 ? Math.round((stats.total_study_time || 0) / completedDays) : 0;
        document.getElementById('avg-daily-time').textContent = `${avgDaily}m`;

        // Consistency score (simplified calculation)
        const consistencyScore = Math.min(100, Math.round((stats.current_streak || 0) * 10));
        document.getElementById('consistency-score').textContent = `${consistencyScore}% consistent`;
    }

    function setupProgressTracking() {
        // Setup auto-refresh every 2 minutes
        setInterval(async () => {
            try {
                const freshData = await API.dashboard.get();
                dashboardData = freshData;
                updateKeyMetrics();
            } catch (error) {
                console.warn('Progress refresh failed:', error);
            }
        }, 2 * 60 * 1000);
    }

    function renderCharts() {
        renderStudyTimeChart();
        renderProgressDistributionChart();
    }

    function renderStudyTimeChart() {
        const canvas = document.getElementById('study-time-chart');
        if (!canvas || !dashboardData) return;

        const ctx = canvas.getContext('2d');

        // Generate sample data for last 30 days
        const last30Days = Array.from({ length: 30 }, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - (29 - i));
            return {
                date: date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
                minutes: Math.floor(Math.random() * 120) + 30 // Random study time between 30-150 mins
            };
        });

        if (studyTimeChart) {
            studyTimeChart.destroy();
        }

        studyTimeChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last30Days.map(d => d.date),
                datasets: [{
                    label: 'Study Time (minutes)',
                    data: last30Days.map(d => d.minutes),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--bs-primary'),
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return `${context.parsed.y} minutes`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) {
                                return `${value}m`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderProgressDistributionChart() {
        const canvas = document.getElementById('progress-distribution-chart');
        if (!canvas || !dashboardData || !dashboardData.weekly_progress) return;

        const ctx = canvas.getContext('2d');

        // Calculate completed vs pending weeks
        const weeklyProgress = dashboardData.weekly_progress;
        let completedWeeks = 0;
        let inProgressWeeks = 0;
        let notStartedWeeks = 0;

        Object.values(weeklyProgress).forEach(week => {
            if (week.completed === week.total) {
                completedWeeks++;
            } else if (week.completed > 0) {
                inProgressWeeks++;
            } else {
                notStartedWeeks++;
            }
        });

        if (progressChart) {
            progressChart.destroy();
        }

        progressChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Completed', 'In Progress', 'Not Started'],
                datasets: [{
                    data: [completedWeeks, inProgressWeeks, notStartedWeeks],
                    backgroundColor: [
                        getComputedStyle(document.documentElement).getPropertyValue('--bs-success'),
                        getComputedStyle(document.documentElement).getPropertyValue('--bs-warning'),
                        getComputedStyle(document.documentElement).getPropertyValue('--bs-light')
                    ],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true
                        }
                    }
                }
            }
        });
    }

    function updateStudyTimeChart(period) {
        // Update chart based on selected period
        // This would fetch different data based on period
        console.log('Updating chart for period:', period);

        // For now, just re-render with different labels
        let labels, data;

        switch (period) {
            case 'daily':
                labels = Array.from({ length: 7 }, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (6 - i));
                    return date.toLocaleDateString('en-US', { weekday: 'short' });
                });
                data = Array.from({ length: 7 }, () => Math.floor(Math.random() * 120) + 30);
                break;
            case 'weekly':
                labels = Array.from({ length: 4 }, (_, i) => `Week ${i + 1}`);
                data = Array.from({ length: 4 }, () => Math.floor(Math.random() * 500) + 200);
                break;
            case 'monthly':
                labels = Array.from({ length: 6 }, (_, i) => {
                    const date = new Date();
                    date.setMonth(date.getMonth() - (5 - i));
                    return date.toLocaleDateString('en-US', { month: 'short' });
                });
                data = Array.from({ length: 6 }, () => Math.floor(Math.random() * 2000) + 500);
                break;
        }

        studyTimeChart.data.labels = labels;
        studyTimeChart.data.datasets[0].data = data;
        studyTimeChart.update();
    }

    function renderWeeklyBreakdown() {
        const container = document.getElementById('weekly-breakdown');

        if (!dashboardData || !dashboardData.weekly_progress) {
            container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <p class="mb-0">No progress data available</p>
            </div>
        `;
            return;
        }

        const weeklyProgress = dashboardData.weekly_progress;

        container.innerHTML = Object.entries(weeklyProgress).map(([weekNum, weekData]) => {
            const completionPercentage = weekData.total > 0 ? (weekData.completed / weekData.total) * 100 : 0;
            const isCompleted = weekData.completed === weekData.total;

            return `
            <div class="week-breakdown-item mb-3" data-week="${weekNum}">
                <div class="card border-0 bg-light">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="me-3">
                                    ${isCompleted ?
                    '<i class="bi bi-check-circle-fill text-success fs-5"></i>' :
                    '<i class="bi bi-clock-fill text-warning fs-5"></i>'
                }
                                </div>
                                <div>
                                    <h6 class="mb-1">Week ${weekNum}</h6>
                                    <p class="text-muted small mb-0">${weekData.title || `Week ${weekNum} Content`}</p>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fs-6 fw-bold ${isCompleted ? 'text-success' : 'text-primary'}">
                                    ${Math.round(completionPercentage)}%
                                </div>
                                <small class="text-muted">${weekData.completed}/${weekData.total} days</small>
                            </div>
                        </div>
                        <div class="progress mt-2" style="height: 6px;">
                            <div class="progress-bar ${isCompleted ? 'bg-success' : 'bg-primary'}" 
                                 style="width: ${completionPercentage}%"></div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        }).join('');
    }

    function renderConsistencyHeatmap() {
        const container = document.getElementById('consistency-heatmap');

        // Generate 90 days of data
        const heatmapData = Array.from({ length: 90 }, (_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - (89 - i));

            // Simulate study activity (0-4 intensity)
            const intensity = Math.random() > 0.3 ? Math.floor(Math.random() * 4) + 1 : 0;

            return {
                date: date,
                intensity: intensity,
                studied: intensity > 0
            };
        });

        // Group by weeks
        const weeks = [];
        for (let i = 0; i < heatmapData.length; i += 7) {
            weeks.push(heatmapData.slice(i, i + 7));
        }

        container.innerHTML = `
        <div class="heatmap-container">
            ${weeks.map(week => `
                <div class="heatmap-week d-flex gap-1 mb-1">
                    ${week.map(day => {
            const opacity = day.intensity * 0.25;
            const bgClass = day.intensity === 0 ? 'bg-light' : 'bg-success';

            return `
                            <div class="heatmap-day ${bgClass}" 
                                 style="width: 12px; height: 12px; opacity: ${day.intensity === 0 ? 1 : opacity + 0.25};"
                                 title="${day.date.toLocaleDateString()} - ${day.studied ? 'Studied' : 'No activity'}"
                                 data-bs-toggle="tooltip">
                            </div>
                        `;
        }).join('')}
                </div>
            `).join('')}
        </div>
    `;

        // Initialize tooltips
        const tooltipTriggerList = container.querySelectorAll('[data-bs-toggle="tooltip"]');
        tooltipTriggerList.forEach(tooltipTriggerEl => {
            new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    function loadAchievements() {
        const container = document.getElementById('achievements-list');

        // Generate sample achievements based on progress
        const achievements = [];

        if (dashboardData && dashboardData.stats) {
            const stats = dashboardData.stats;

            if (stats.current_streak >= 7) {
                achievements.push({
                    title: 'Week Warrior',
                    description: '7 day study streak!',
                    icon: 'bi-fire',
                    color: 'text-warning',
                    earned: true,
                    date: new Date(Date.now() - 86400000) // Yesterday
                });
            }

            if (stats.completion_percentage >= 25) {
                achievements.push({
                    title: 'Quarter Champion',
                    description: '25% roadmap complete',
                    icon: 'bi-trophy',
                    color: 'text-success',
                    earned: true,
                    date: new Date(Date.now() - 172800000) // 2 days ago
                });
            }

            if (stats.total_study_time >= 1200) { // 20 hours
                achievements.push({
                    title: 'Time Master',
                    description: '20+ hours of study time',
                    icon: 'bi-clock',
                    color: 'text-primary',
                    earned: true,
                    date: new Date(Date.now() - 259200000) // 3 days ago
                });
            }
        }

        // Add some upcoming achievements
        achievements.push({
            title: 'Consistency King',
            description: 'Study for 30 days straight',
            icon: 'bi-calendar-check',
            color: 'text-muted',
            earned: false,
            progress: Math.min(100, (dashboardData?.stats?.current_streak || 0) / 30 * 100)
        });

        if (achievements.length === 0) {
            container.innerHTML = `
            <div class="text-center py-4 text-muted">
                <i class="bi bi-award fs-2 mb-2"></i>
                <p class="mb-0">Start studying to earn achievements!</p>
            </div>
        `;
            return;
        }

        container.innerHTML = achievements.map(achievement => `
        <div class="achievement-item d-flex align-items-start mb-3 ${achievement.earned ? '' : 'opacity-50'}">
            <div class="flex-shrink-0 me-3">
                <div class="achievement-icon bg-light rounded-circle p-2" 
                     style="width: 40px; height: 40px;">
                    <i class="${achievement.icon} ${achievement.earned ? achievement.color : 'text-muted'} d-flex align-items-center justify-content-center h-100"></i>
                </div>
            </div>
            <div class="flex-grow-1">
                <h6 class="mb-1 ${achievement.earned ? '' : 'text-muted'}">${achievement.title}</h6>
                <p class="text-muted small mb-1">${achievement.description}</p>
                ${achievement.earned ?
                `<small class="text-success">Earned ${Utils.getRelativeTime(achievement.date)}</small>` :
                achievement.progress !== undefined ?
                    `<div class="progress mt-1" style="height: 3px;">
                            <div class="progress-bar bg-primary" style="width: ${achievement.progress}%"></div>
                         </div>
                         <small class="text-muted">${Math.round(achievement.progress)}% complete</small>` :
                    '<small class="text-muted">Not earned yet</small>'
            }
            </div>
        </div>
    `).join('');
    }

    function setTimeRange(range) {
        currentTimeRange = range;

        // Update dropdown text
        const timeRangeTexts = {
            '7': 'Last 7 Days',
            '30': 'Last 30 Days',
            '90': 'Last 3 Months',
            'all': 'All Time'
        };

        const button = document.querySelector('.dropdown-toggle');
        button.innerHTML = `<i class="bi bi-calendar-range me-2"></i>${timeRangeTexts[range]}`;

        // Reload data for new time range
        // In a real app, this would fetch different data
        console.log('Loading data for time range:', range);
    }

    function expandAllWeeks() {
        // Toggle expansion of all week breakdown items
        const items = document.querySelectorAll('.week-breakdown-item');
        const button = document.querySelector('[onclick="expandAllWeeks()"]');

        const isExpanded = button.textContent.includes('Collapse');

        if (isExpanded) {
            button.innerHTML = '<i class="bi bi-arrows-expand me-1"></i>Expand All';
            // Collapse logic would go here
        } else {
            button.innerHTML = '<i class="bi bi-arrows-collapse me-1"></i>Collapse All';
            // Expand logic would go here
        }
    }

    async function exportProgressReport() {
        try {
            // Generate comprehensive progress report
            const report = generateDetailedReport();

            // Create and download file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsa-progress-detailed-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Notifications.success('Progress report exported successfully!');

        } catch (error) {
            console.error('Export error:', error);
            Notifications.error('Failed to export progress report');
        }
    }

    function generateDetailedReport() {
        const stats = dashboardData?.stats || {};
        const weeklyProgress = dashboardData?.weekly_progress || {};

        let report = `DSA Learning Progress - Detailed Report\n`;
        report += `Generated on: ${new Date().toLocaleString()}\n`;
        report += `User: ${Auth.getUserName()}\n`;
        report += `===============================================\n\n`;

        // Key Metrics
        report += `KEY METRICS:\n`;
        report += `- Overall Completion: ${Math.round(stats.completion_percentage || 0)}%\n`;
        report += `- Current Streak: ${stats.current_streak || 0} days\n`;
        report += `- Longest Streak: ${stats.longest_streak || 0} days\n`;
        report += `- Total Study Time: ${Math.round((stats.total_study_time || 0) / 60)} hours\n`;
        report += `- Days Completed: ${stats.completed_days || 0}/${stats.total_days || 98}\n\n`;

        // Weekly Progress
        report += `WEEKLY PROGRESS:\n`;
        Object.entries(weeklyProgress).forEach(([week, data]) => {
            const percentage = data.total > 0 ? Math.round((data.completed / data.total) * 100) : 0;
            report += `- Week ${week}: ${data.completed}/${data.total} days (${percentage}%)\n`;
        });
        report += `\n`;

        // Study Patterns
        report += `STUDY PATTERNS:\n`;
        report += `- Average Daily Time: ${Math.round((stats.total_study_time || 0) / (stats.completed_days || 1))} minutes\n`;
        report += `- Weekly Average: ${Math.round((stats.study_time_last_7_days || 0) / 60)} hours\n`;
        report += `- Consistency Score: ${Math.min(100, Math.round((stats.current_streak || 0) * 10))}%\n\n`;

        report += `Report generated by DSA Path - ${new Date().toISOString()}\n`;

        return report;
    }

    // Add CSS for heatmap
    const heatmapStyle = document.createElement('style');
    heatmapStyle.textContent = `
    .heatmap-day {
        border-radius: 2px;
        cursor: pointer;
        transition: transform 0.1s ease;
    }
    
    .heatmap-day:hover {
        transform: scale(1.1);
    }
    
    .heatmap-legend {
        border-radius: 2px;
    }
    
    .achievement-icon {
        display: flex;
        align-items: center;
        justify-content: center;
    }
`;
    document.head.appendChild(heatmapStyle);
</script>