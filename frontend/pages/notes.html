<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes - DSA Path</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Quill Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <style>
        .notes-sidebar {
            background: var(--gray-50);
            border-right: 1px solid var(--gray-200);
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        .note-item {
            padding: 1rem;
            border-bottom: 1px solid var(--gray-200);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .note-item:hover {
            background: var(--gray-100);
        }

        .note-item.active {
            background: var(--primary);
            color: white;
        }

        .note-item.active .note-meta {
            color: rgba(255, 255, 255, 0.8);
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .note-meta {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .editor-container {
            height: calc(100vh - 200px);
            background: white;
            border-radius: var(--radius-lg);
        }

        .ql-container {
            font-size: 1rem;
            height: calc(100% - 42px);
        }

        .tag-input {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius-md);
            min-height: 40px;
            align-items: center;
        }

        .tag-item {
            background: var(--primary);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag-remove {
            cursor: pointer;
            opacity: 0.8;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--gray-500);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            color: var(--gray-300);
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            padding-left: 2.5rem;
        }

        .search-box .search-icon {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray-400);
        }
    </style>
</head>

<body>
    <div class="app-layout">
        <!-- Sidebar (same as previous pages) -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-code-branch"></i>
                    <span>DSA Path</span>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="/dashboard" class="nav-link">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/roadmap" class="nav-link">
                        <i class="fas fa-route"></i>
                        <span>Roadmap</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/calendar" class="nav-link">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Calendar</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/progress" class="nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>Progress</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/resources" class="nav-link">
                        <i class="fas fa-book"></i>
                        <span>Resources</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/notes" class="nav-link active">
                        <i class="fas fa-sticky-note"></i>
                        <span>Notes</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/pomodoro" class="nav-link">
                        <i class="fas fa-clock"></i>
                        <span>Pomodoro</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/ai-assistant" class="nav-link">
                        <i class="fas fa-robot"></i>
                        <span>AI Assistant</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="/analytics" class="nav-link">
                        <i class="fas fa-chart-bar"></i>
                        <span>Analytics</span>
                    </a>
                </div>

                <div class="mt-auto pt-4 border-top">
                    <div class="nav-item">
                        <a href="/profile" class="nav-link">
                            <i class="fas fa-user"></i>
                            <span>Profile</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="/settings" class="nav-link">
                            <i class="fas fa-cog"></i>
                            <span>Settings</span>
                        </a>
                    </div>
                    <div class="nav-item">
                        <a href="#" class="nav-link" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Top Bar -->
            <header class="topbar">
                <div class="topbar-left">
                    <button class="btn btn-link d-lg-none" onclick="toggleSidebar()">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h4 class="mb-0 fw-bold">Notes</h4>
                </div>

                <div class="topbar-right">
                    <button class="btn btn-primary me-3" onclick="createNewNote()">
                        <i class="fas fa-plus me-2"></i>New Note
                    </button>

                    <button class="btn btn-link position-relative me-2">
                        <i class="fas fa-bell fa-lg"></i>
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                            3
                        </span>
                    </button>

                    <div class="dropdown">
                        <button class="btn btn-link dropdown-toggle d-flex align-items-center"
                            data-bs-toggle="dropdown">
                            <img src="https://ui-avatars.com/api/?name=User&background=6366f1&color=fff" alt="Avatar"
                                class="rounded-circle me-2" width="32" height="32" id="userAvatar">
                            <span id="userName">Loading...</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/profile"><i class="fas fa-user me-2"></i>Profile</a>
                            </li>
                            <li><a class="dropdown-item" href="/settings"><i class="fas fa-cog me-2"></i>Settings</a>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i
                                        class="fas fa-sign-out-alt me-2"></i>Logout</a></li>
                        </ul>
                    </div>
                </div>
            </header>

            <!-- Page Content -->
            <div class="page-content p-0">
                <div class="row g-0 h-100">
                    <!-- Notes List Sidebar -->
                    <div class="col-md-4 col-lg-3">
                        <div class="notes-sidebar">
                            <!-- Search -->
                            <div class="p-3 border-bottom">
                                <div class="search-box">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="form-control" placeholder="Search notes..."
                                        id="searchNotes" onkeyup="searchNotes()">
                                </div>
                            </div>

                            <!-- Notes List -->
                            <div id="notesList">
                                <div class="text-center py-4">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Note Editor -->
                    <div class="col-md-8 col-lg-9">
                        <div class="h-100 p-4" id="editorSection">
                            <!-- Empty State -->
                            <div class="empty-state" id="emptyState">
                                <i class="fas fa-sticky-note empty-state-icon"></i>
                                <h4>No note selected</h4>
                                <p>Select a note from the sidebar or create a new one to get started</p>
                                <button class="btn btn-primary" onclick="createNewNote()">
                                    <i class="fas fa-plus me-2"></i>Create New Note
                                </button>
                            </div>

                            <!-- Editor (hidden by default) -->
                            <div class="h-100 d-none" id="noteEditor">
                                <!-- Note Header -->
                                <div class="mb-3">
                                    <input type="text" class="form-control form-control-lg border-0 px-0"
                                        placeholder="Note Title" id="noteTitle" style="font-weight: 600;">
                                </div>

                                <!-- Tags -->
                                <div class="mb-3">
                                    <label class="form-label text-muted small">Tags</label>
                                    <div class="tag-input" id="tagInput">
                                        <input type="text" class="border-0 flex-grow-1" placeholder="Add tags..."
                                            id="tagInputField" onkeypress="handleTagInput(event)"
                                            style="outline: none; min-width: 100px;">
                                    </div>
                                </div>

                                <!-- Editor -->
                                <div class="editor-container">
                                    <div id="editor"></div>
                                </div>

                                <!-- Save Button -->
                                <div class="mt-3 d-flex justify-content-between">
                                    <button class="btn btn-outline-danger" onclick="deleteCurrentNote()">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </button>
                                    <div>
                                        <span class="text-muted me-3" id="lastSaved"></span>
                                        <button class="btn btn-primary" onclick="saveNote()">
                                            <i class="fas fa-save me-2"></i>Save Note
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-items">
            <a href="/dashboard" class="mobile-nav-item">
                <i class="fas fa-home mobile-nav-icon"></i>
                <span>Home</span>
            </a>
            <a href="/roadmap" class="mobile-nav-item">
                <i class="fas fa-route mobile-nav-icon"></i>
                <span>Roadmap</span>
            </a>
            <a href="/resources" class="mobile-nav-item">
                <i class="fas fa-book mobile-nav-icon"></i>
                <span>Resources</span>
            </a>
            <a href="/notes" class="mobile-nav-item active">
                <i class="fas fa-sticky-note mobile-nav-icon"></i>
                <span>Notes</span>
            </a>
            <a href="/profile" class="mobile-nav-item">
                <i class="fas fa-user mobile-nav-icon"></i>
                <span>Profile</span>
            </a>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // API Configuration
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';
        let accessToken = localStorage.getItem('access_token');
        let notes = [];
        let currentNote = null;
        let quill = null;

        // Authentication check
        if (!accessToken) {
            window.location.href = '/login';
        }

        // Initialize Quill editor
        function initializeEditor() {
            quill = new Quill('#editor', {
                theme: 'snow',
                placeholder: 'Start writing your note...',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'indent': '-1' }, { 'indent': '+1' }],
                        ['link', 'image'],
                        ['clean']
                    ]
                }
            });

            // Auto-save on content change
            quill.on('text-change', debounce(() => {
                if (currentNote) {
                    autoSave();
                }
            }, 2000));
        }

        // Utility Functions
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();

            const toastHTML = `
                <div id="${toastId}" class="custom-toast ${type}" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', toastHTML);

            setTimeout(() => {
                const toast = document.getElementById(toastId);
                if (toast) {
                    toast.style.animation = 'fadeOut 0.3s ease-out forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        async function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }

        // API Functions
        async function fetchWithAuth(url, options = {}) {
            const response = await fetch(url, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                }
            });

            if (response.status === 401) {
                logout();
            }

            return response;
        }

        // Load User Profile
        async function loadUserProfile() {
            try {
                const response = await fetchWithAuth(`${API_BASE}/profile`);
                if (response.ok) {
                    const data = await response.json();
                    const user = data.user;

                    document.getElementById('userName').textContent = user.name;

                    if (user.avatar_url) {
                        document.getElementById('userAvatar').src = user.avatar_url;
                    } else {
                        document.getElementById('userAvatar').src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name)}&background=6366f1&color=fff`;
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Load Notes
        async function loadNotes() {
            try {
                const response = await fetchWithAuth(`${API_BASE}/notes`);
                if (response.ok) {
                    const data = await response.json();
                    notes = data.notes;
                    renderNotesList();

                    // Check if there's a note ID in the URL hash
                    const noteId = window.location.hash.substring(1);
                    if (noteId) {
                        const note = notes.find(n => n.id === noteId);
                        if (note) {
                            selectNote(note);
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading notes:', error);
                showToast('Failed to load notes', 'error');
            }
        }

        // Render Notes List
        function renderNotesList(searchTerm = '') {
            const container = document.getElementById('notesList');

            let filteredNotes = notes;
            if (searchTerm) {
                filteredNotes = notes.filter(note =>
                    note.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    note.content.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    note.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
                );
            }

            if (filteredNotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state p-4">
                        <i class="fas fa-sticky-note empty-state-icon"></i>
                        <p>No notes found</p>
                    </div>
                `;
                return;
            }

            let html = '';
            filteredNotes.forEach(note => {
                const date = new Date(note.updated_at);
                const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

                html += `
                    <div class="note-item ${currentNote && currentNote.id === note.id ? 'active' : ''}" 
                         onclick="selectNote('${note.id}')"
                         data-note-id="${note.id}">
                        <div class="note-title">${note.title || 'Untitled Note'}</div>
                        <div class="note-meta">
                            ${dateStr} • ${note.tags.length > 0 ? note.tags.slice(0, 2).join(', ') : 'No tags'}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Select Note
        function selectNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;

            currentNote = note;

            // Update active state
            document.querySelectorAll('.note-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.noteId === noteId) {
                    item.classList.add('active');
                }
            });

            // Show editor
            document.getElementById('emptyState').classList.add('d-none');
            document.getElementById('noteEditor').classList.remove('d-none');

            // Load note content
            document.getElementById('noteTitle').value = note.title;
            quill.root.innerHTML = note.content;

            // Load tags
            renderTags(note.tags);

            // Update last saved
            updateLastSaved(note.updated_at);

            // Update URL
            window.location.hash = noteId;
        }

        // Create New Note
        async function createNewNote() {
            try {
                const response = await fetchWithAuth(`${API_BASE}/notes`, {
                    method: 'POST',
                    body: JSON.stringify({
                        title: 'New Note',
                        content: '',
                        tags: []
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showToast('Note created successfully', 'success');

                    // Reload notes and select the new one
                    await loadNotes();
                    selectNote(data.id);
                }
            } catch (error) {
                console.error('Error creating note:', error);
                showToast('Failed to create note', 'error');
            }
        }

        // Save Note
        async function saveNote() {
            if (!currentNote) return;

            const title = document.getElementById('noteTitle').value || 'Untitled Note';
            const content = quill.root.innerHTML;
            const tags = Array.from(document.querySelectorAll('.tag-item')).map(tag =>
                tag.textContent.replace('×', '').trim()
            );

            try {
                const response = await fetchWithAuth(`${API_BASE}/notes/${currentNote.id}`, {
                    method: 'PUT',
                    body: JSON.stringify({ title, content, tags })
                });

                if (response.ok) {
                    showToast('Note saved successfully', 'success');

                    // Update local data
                    currentNote.title = title;
                    currentNote.content = content;
                    currentNote.tags = tags;
                    currentNote.updated_at = new Date().toISOString();

                    // Update notes list
                    renderNotesList();
                    updateLastSaved(currentNote.updated_at);
                }
            } catch (error) {
                console.error('Error saving note:', error);
                showToast('Failed to save note', 'error');
            }
        }

        // Auto-save
        const autoSave = debounce(async () => {
            await saveNote();
        }, 2000);

        // Delete Note
        async function deleteCurrentNote() {
            if (!currentNote) return;

            if (!confirm('Are you sure you want to delete this note?')) return;

            try {
                const response = await fetchWithAuth(`${API_BASE}/notes/${currentNote.id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showToast('Note deleted successfully', 'success');

                    // Remove from local array
                    notes = notes.filter(n => n.id !== currentNote.id);
                    currentNote = null;

                    // Update UI
                    renderNotesList();
                    document.getElementById('emptyState').classList.remove('d-none');
                    document.getElementById('noteEditor').classList.add('d-none');

                    // Clear URL hash
                    window.location.hash = '';
                }
            } catch (error) {
                console.error('Error deleting note:', error);
                showToast('Failed to delete note', 'error');
            }
        }

        // Search Notes
        function searchNotes() {
            const searchTerm = document.getElementById('searchNotes').value;
            renderNotesList(searchTerm);
        }

        // Tag Management
        function renderTags(tags) {
            const container = document.getElementById('tagInput');
            const input = document.getElementById('tagInputField');

            // Clear existing tags
            container.querySelectorAll('.tag-item').forEach(tag => tag.remove());

            // Add tags
            tags.forEach(tag => {
                const tagElement = document.createElement('div');
                tagElement.className = 'tag-item';
                tagElement.innerHTML = `
                    ${tag}
                    <span class="tag-remove" onclick="removeTag('${tag}')">×</span>
                `;
                container.insertBefore(tagElement, input);
            });
        }

        function handleTagInput(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                const input = event.target;
                const tag = input.value.trim();

                if (tag && currentNote) {
                    // Add tag if not already exists
                    if (!currentNote.tags.includes(tag)) {
                        currentNote.tags.push(tag);
                        renderTags(currentNote.tags);
                        autoSave();
                    }

                    input.value = '';
                }
            }
        }

        function removeTag(tag) {
            if (!currentNote) return;

            currentNote.tags = currentNote.tags.filter(t => t !== tag);
            renderTags(currentNote.tags);
            autoSave();
        }

        // Update last saved time
        function updateLastSaved(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            let text = '';
            if (diff < 60000) {
                text = 'Just now';
            } else if (diff < 3600000) {
                text = `${Math.floor(diff / 60000)} minutes ago`;
            } else if (diff < 86400000) {
                text = `${Math.floor(diff / 3600000)} hours ago`;
            } else {
                text = date.toLocaleDateString();
            }

            document.getElementById('lastSaved').textContent = `Last saved: ${text}`;
        }

        // Initialize
        async function init() {
            initializeEditor();
            await loadUserProfile();
            await loadNotes();
        }

        init();

        // Handle title input
        document.getElementById('noteTitle').addEventListener('input', debounce(() => {
            if (currentNote) {
                autoSave();
            }
        }, 1000));
    </script>
</body>

</html>