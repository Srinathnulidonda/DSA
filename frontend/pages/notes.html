<div class="container-fluid p-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="h3 fw-bold mb-1">
                        <i class="fas fa-sticky-note text-warning me-2"></i>
                        My Notes
                    </h1>
                    <p class="text-muted mb-0">Capture your learning journey and insights</p>
                </div>
                <div class="d-flex gap-2 mt-3 mt-lg-0">
                    <button class="btn btn-outline-primary" id="search-notes-btn">
                        <i class="fas fa-search me-2"></i>Search Notes
                    </button>
                    <button class="btn btn-primary" id="new-note-btn">
                        <i class="fas fa-plus me-2"></i>New Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Search -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-3">
                    <div class="row g-3 align-items-center">
                        <div class="col-lg-4">
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="note-search" placeholder="Search notes..."
                                    autocomplete="off">
                            </div>
                        </div>
                        <div class="col-lg-2">
                            <select class="form-select" id="week-filter">
                                <option value="">All Weeks</option>
                                <!-- Populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-lg-2">
                            <select class="form-select" id="sort-filter">
                                <option value="updated_at">Recently Updated</option>
                                <option value="created_at">Recently Created</option>
                                <option value="title">Title A-Z</option>
                            </select>
                        </div>
                        <div class="col-lg-4">
                            <div id="selected-tags" class="d-flex flex-wrap gap-1">
                                <!-- Selected tags will appear here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Grid -->
    <div class="row" id="notes-container">
        <!-- Populated by JavaScript -->
    </div>

    <!-- Pagination -->
    <div class="row mt-4">
        <div class="col-12">
            <nav aria-label="Notes pagination" id="notes-pagination">
                <!-- Populated by JavaScript -->
            </nav>
        </div>
    </div>
</div>

<!-- Note Editor Modal -->
<div class="modal fade" id="noteModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="noteModalTitle">New Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="note-form">
                    <div class="mb-3">
                        <label for="note-title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="note-title" placeholder="Enter note title" required>
                        <div class="invalid-feedback">Please provide a note title.</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="note-week" class="form-label">Week (Optional)</label>
                            <select class="form-select" id="note-week">
                                <option value="">Select week...</option>
                                <!-- Populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="note-day" class="form-label">Day (Optional)</label>
                            <select class="form-select" id="note-day" disabled>
                                <option value="">Select day...</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="note-tags" class="form-label">Tags</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="note-tags-input"
                                placeholder="Type and press Enter to add tags">
                            <button class="btn btn-outline-secondary" type="button" id="add-tag-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div id="note-tags-display" class="mt-2 d-flex flex-wrap gap-1">
                            <!-- Tags will appear here -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label for="note-content" class="form-label">Content</label>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="editor-mode" id="markdown-mode" checked>
                                <label class="btn btn-outline-primary" for="markdown-mode">
                                    <i class="fab fa-markdown me-1"></i>Markdown
                                </label>
                                <input type="radio" class="btn-check" name="editor-mode" id="preview-mode">
                                <label class="btn btn-outline-primary" for="preview-mode">
                                    <i class="fas fa-eye me-1"></i>Preview
                                </label>
                            </div>
                        </div>

                        <div id="editor-container">
                            <textarea class="form-control" id="note-content" rows="15"
                                placeholder="Write your note here... (Markdown supported)" data-auto-resize></textarea>
                            <div id="note-preview" class="border rounded p-3 d-none"
                                style="min-height: 400px; max-height: 500px; overflow-y: auto;">
                                <!-- Preview content -->
                            </div>
                        </div>

                        <div class="form-text">
                            Supports Markdown formatting. Use **bold**, *italic*, `code`, and more.
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between w-100">
                    <div>
                        <button type="button" class="btn btn-outline-danger" id="delete-note-btn"
                            style="display: none;">
                            <i class="fas fa-trash me-2"></i>Delete
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="save-note-btn">
                            <i class="fas fa-save me-2"></i>Save Note
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this note? This action cannot be undone.</p>
                <div class="alert alert-warning">
                    <strong>Note:</strong> <span id="delete-note-title"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirm-delete-btn">Delete Note</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        let notes = [];
        let allTags = new Set();
        let selectedTags = new Set();
        let currentFilters = {
            search: '',
            week: '',
            sort: 'updated_at'
        };
        let currentPage = 1;
        let totalPages = 1;
        let currentEditingNote = null;
        let currentNoteTags = new Set();

        // Initialize the page
        await loadNotes();
        setupEventListeners();
        populateWeekSelectors();

        async function loadNotes() {
            try {
                // Show loading
                document.getElementById('notes-container').innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading notes...</span>
                    </div>
                    <p class="mt-2 text-muted">Loading your notes...</p>
                </div>
            `;

                const filters = {
                    search: currentFilters.search,
                    week: currentFilters.week,
                    page: currentPage,
                    per_page: 12
                };

                const response = await ApiMethods.notes.getAll(currentPage, 12, filters);
                notes = response.notes || [];
                totalPages = response.pagination?.pages || 1;

                // Extract all tags
                allTags.clear();
                notes.forEach(note => {
                    if (note.tags) {
                        note.tags.forEach(tag => allTags.add(tag));
                    }
                });

                renderNotes();
                renderPagination();

                console.log('Notes loaded:', notes.length);

            } catch (error) {
                console.error('Failed to load notes:', error);
                document.getElementById('notes-container').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Failed to load notes. Please try again.
                    </div>
                </div>
            `;
            }
        }

        function renderNotes() {
            const container = document.getElementById('notes-container');

            if (notes.length === 0) {
                container.innerHTML = `
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-sticky-note text-muted fa-4x mb-3"></i>
                        <h4 class="text-muted">No notes found</h4>
                        <p class="text-muted mb-4">
                            ${currentFilters.search || selectedTags.size > 0 ?
                        'No notes match your search criteria.' :
                        'Start capturing your learning journey by creating your first note.'}
                        </p>
                        <button class="btn btn-primary" onclick="openNoteEditor()">
                            <i class="fas fa-plus me-2"></i>Create First Note
                        </button>
                    </div>
                </div>
            `;
                return;
            }

            container.innerHTML = notes.map(note => `
            <div class="col-lg-4 col-md-6 mb-4">
                <div class="card h-100 note-card" onclick="openNoteEditor('${note.id}')">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="card-title fw-bold mb-0 flex-grow-1">${Utils.string.truncate(note.title, 50)}</h6>
                            <div class="dropdown" onclick="event.stopPropagation()">
                                <button class="btn btn-sm btn-ghost" data-bs-toggle="dropdown">
                                    <i class="fas fa-ellipsis-v"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="openNoteEditor('${note.id}')">
                                        <i class="fas fa-edit me-2"></i>Edit
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="duplicateNote('${note.id}')">
                                        <i class="fas fa-copy me-2"></i>Duplicate
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="confirmDeleteNote('${note.id}', '${note.title.replace(/'/g, "\\'")}')">
                                        <i class="fas fa-trash me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                        
                        ${note.content ? `
                            <p class="card-text text-muted small flex-grow-1">${Utils.string.truncate(stripMarkdown(note.content), 120)}</p>
                        ` : `
                            <p class="card-text text-muted small flex-grow-1 font-italic">No content</p>
                        `}
                        
                        <div class="mt-auto">
                            ${note.tags && note.tags.length > 0 ? `
                                <div class="mb-2">
                                    ${note.tags.slice(0, 3).map(tag => `
                                        <span class="badge bg-light text-dark me-1">${tag}</span>
                                    `).join('')}
                                    ${note.tags.length > 3 ? `<span class="badge bg-secondary">+${note.tags.length - 3}</span>` : ''}
                                </div>
                            ` : ''}
                            
                            <div class="d-flex justify-content-between align-items-center text-muted small">
                                <div>
                                    ${note.week ? `<span class="badge bg-primary">Week ${note.week}</span>` : ''}
                                    ${note.day ? `<span class="badge bg-info ms-1">${note.day}</span>` : ''}
                                </div>
                                <span>${Utils.date.relative(note.updated_at)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        }

        function renderPagination() {
            const container = document.getElementById('notes-pagination');
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            const pagination = Components.pagination.create({
                currentPage,
                totalPages,
                maxVisible: 5,
                onPageChange: (page) => {
                    currentPage = page;
                    loadNotes();
                }
            });

            container.innerHTML = '';
            container.appendChild(pagination);
        }

        function setupEventListeners() {
            // Search functionality
            const searchInput = document.getElementById('note-search');
            const debouncedSearch = Utils.time.debounce((value) => {
                currentFilters.search = value;
                currentPage = 1;
                loadNotes();
            }, 300);

            searchInput.addEventListener('input', (e) => {
                debouncedSearch(e.target.value);
            });

            // Filter changes
            document.getElementById('week-filter').addEventListener('change', (e) => {
                currentFilters.week = e.target.value;
                currentPage = 1;
                loadNotes();
            });

            document.getElementById('sort-filter').addEventListener('change', (e) => {
                currentFilters.sort = e.target.value;
                currentPage = 1;
                loadNotes();
            });

            // New note button
            document.getElementById('new-note-btn').addEventListener('click', () => {
                openNoteEditor();
            });

            // Note editor modal events
            setupNoteEditorEvents();

            // Auto-save draft
            setupAutoSave();
        }

        function setupNoteEditorEvents() {
            const modal = document.getElementById('noteModal');
            const form = document.getElementById('note-form');
            const titleInput = document.getElementById('note-title');
            const contentTextarea = document.getElementById('note-content');
            const weekSelect = document.getElementById('note-week');
            const daySelect = document.getElementById('note-day');
            const tagsInput = document.getElementById('note-tags-input');
            const saveBtn = document.getElementById('save-note-btn');
            const deleteBtn = document.getElementById('delete-note-btn');

            // Week selection changes day options
            weekSelect.addEventListener('change', function () {
                const selectedWeek = this.value;
                daySelect.disabled = !selectedWeek;

                if (selectedWeek) {
                    // Populate days for the week
                    daySelect.innerHTML = `
                    <option value="">Select day...</option>
                    <option value="Monday">Monday</option>
                    <option value="Tuesday">Tuesday</option>
                    <option value="Wednesday">Wednesday</option>
                    <option value="Thursday">Thursday</option>
                    <option value="Friday">Friday</option>
                    <option value="Saturday">Saturday</option>
                    <option value="Sunday">Sunday</option>
                `;
                } else {
                    daySelect.innerHTML = '<option value="">Select day...</option>';
                }
            });

            // Tag input handling
            tagsInput.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addTag();
                }
            });

            document.getElementById('add-tag-btn').addEventListener('click', addTag);

            // Editor mode switching
            document.getElementById('markdown-mode').addEventListener('change', function () {
                if (this.checked) {
                    document.getElementById('note-content').classList.remove('d-none');
                    document.getElementById('note-preview').classList.add('d-none');
                }
            });

            document.getElementById('preview-mode').addEventListener('change', function () {
                if (this.checked) {
                    updatePreview();
                    document.getElementById('note-content').classList.add('d-none');
                    document.getElementById('note-preview').classList.remove('d-none');
                }
            });

            // Save note
            saveBtn.addEventListener('click', saveNote);

            // Delete note
            deleteBtn.addEventListener('click', () => {
                if (currentEditingNote) {
                    confirmDeleteNote(currentEditingNote.id, currentEditingNote.title);
                }
            });

            // Form validation
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                saveNote();
            });
        }

        function addTag() {
            const input = document.getElementById('note-tags-input');
            const tag = input.value.trim();

            if (tag && !currentNoteTags.has(tag)) {
                currentNoteTags.add(tag);
                renderNoteTags();
                input.value = '';
            }
        }

        function removeTag(tag) {
            currentNoteTags.delete(tag);
            renderNoteTags();
        }

        function renderNoteTags() {
            const container = document.getElementById('note-tags-display');
            container.innerHTML = Array.from(currentNoteTags).map(tag => `
            <span class="badge bg-primary">
                ${tag}
                <button type="button" class="btn-close btn-close-white ms-1" 
                        onclick="removeTag('${tag}')" aria-label="Remove tag"></button>
            </span>
        `).join('');
        }

        function updatePreview() {
            const content = document.getElementById('note-content').value;
            const preview = document.getElementById('note-preview');

            if (typeof marked !== 'undefined') {
                preview.innerHTML = marked.parse(content);
            } else {
                preview.innerHTML = content.replace(/\n/g, '<br>');
            }
        }

        async function saveNote() {
            const title = document.getElementById('note-title').value.trim();
            const content = document.getElementById('note-content').value.trim();
            const week = document.getElementById('note-week').value || null;
            const day = document.getElementById('note-day').value || null;

            if (!title) {
                Notifications.error('Please provide a note title');
                document.getElementById('note-title').focus();
                return;
            }

            const noteData = {
                title,
                content,
                week: week ? parseInt(week) : null,
                day,
                tags: Array.from(currentNoteTags)
            };

            const saveBtn = document.getElementById('save-note-btn');
            const originalText = saveBtn.innerHTML;

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';

                if (currentEditingNote) {
                    // Update existing note
                    await ApiMethods.notes.update(currentEditingNote.id, noteData);
                    Notifications.success('Note updated successfully');
                } else {
                    // Create new note
                    await ApiMethods.notes.create(noteData);
                    Notifications.success('Note created successfully');
                }

                // Close modal and refresh notes
                bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                await loadNotes();

                // Clear draft
                Storage.notes.removeDraftNote(currentEditingNote?.id || 'new');

            } catch (error) {
                console.error('Failed to save note:', error);
                Notifications.error('Failed to save note');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        }

        function openNoteEditor(noteId = null) {
            currentEditingNote = noteId ? notes.find(n => n.id === noteId) : null;
            currentNoteTags.clear();

            const modal = new bootstrap.Modal(document.getElementById('noteModal'));
            const titleInput = document.getElementById('note-title');
            const contentTextarea = document.getElementById('note-content');
            const weekSelect = document.getElementById('note-week');
            const daySelect = document.getElementById('note-day');
            const deleteBtn = document.getElementById('delete-note-btn');

            if (currentEditingNote) {
                // Edit existing note
                document.getElementById('noteModalTitle').textContent = 'Edit Note';
                titleInput.value = currentEditingNote.title;
                contentTextarea.value = currentEditingNote.content || '';
                weekSelect.value = currentEditingNote.week || '';
                daySelect.value = currentEditingNote.day || '';

                if (currentEditingNote.tags) {
                    currentEditingNote.tags.forEach(tag => currentNoteTags.add(tag));
                }

                deleteBtn.style.display = 'block';
            } else {
                // New note
                document.getElementById('noteModalTitle').textContent = 'New Note';
                titleInput.value = '';
                contentTextarea.value = '';
                weekSelect.value = '';
                daySelect.value = '';
                deleteBtn.style.display = 'none';

                // Load draft if exists
                const draft = Storage.notes.getDraftNote('new');
                if (draft) {
                    contentTextarea.value = draft.content;
                }
            }

            renderNoteTags();

            // Trigger week change to update day options
            weekSelect.dispatchEvent(new Event('change'));

            modal.show();

            // Focus title input
            setTimeout(() => titleInput.focus(), 300);
        }

        function setupAutoSave() {
            const titleInput = document.getElementById('note-title');
            const contentTextarea = document.getElementById('note-content');

            const autoSave = Utils.time.debounce(() => {
                const noteId = currentEditingNote?.id || 'new';
                const content = contentTextarea.value;

                if (content.trim()) {
                    Storage.notes.setDraftNote(noteId, content);
                }
            }, 2000);

            contentTextarea.addEventListener('input', autoSave);
        }

        function populateWeekSelectors() {
            const selectors = ['#week-filter', '#note-week'];

            selectors.forEach(selector => {
                const element = document.querySelector(selector);
                if (!element) return;

                const isNoteWeek = selector === '#note-week';
                const baseOptions = isNoteWeek ? ['<option value="">Select week...</option>'] : [];

                for (let i = 1; i <= 14; i++) {
                    baseOptions.push(`<option value="${i}">Week ${i}</option>`);
                }

                element.innerHTML = baseOptions.join('');
            });
        }

        function stripMarkdown(text) {
            return text
                .replace(/[#*`_~]/g, '')
                .replace(/```math([\s\S]*?)```\s*(?:KATEX_INLINE_OPEN[\s\S]*?KATEX_INLINE_CLOSE\s*)?/g, '$1')
                .replace(/\n/g, ' ')
                .trim();
        }

        function confirmDeleteNote(noteId, noteTitle) {
            document.getElementById('delete-note-title').textContent = noteTitle;

            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            document.getElementById('confirm-delete-btn').onclick = () => {
                deleteNote(noteId);
                modal.hide();
            };

            modal.show();
        }

        async function deleteNote(noteId) {
            try {
                await ApiMethods.notes.delete(noteId);
                Notifications.success('Note deleted successfully');

                // Close note editor if it was open
                const noteModal = bootstrap.Modal.getInstance(document.getElementById('noteModal'));
                if (noteModal) {
                    noteModal.hide();
                }

                await loadNotes();
            } catch (error) {
                console.error('Failed to delete note:', error);
                Notifications.error('Failed to delete note');
            }
        }

        async function duplicateNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;

            const duplicatedNote = {
                title: `${note.title} (Copy)`,
                content: note.content,
                week: note.week,
                day: note.day,
                tags: note.tags || []
            };

            try {
                await ApiMethods.notes.create(duplicatedNote);
                Notifications.success('Note duplicated successfully');
                await loadNotes();
            } catch (error) {
                console.error('Failed to duplicate note:', error);
                Notifications.error('Failed to duplicate note');
            }
        }

        // Global functions for onclick handlers
        window.openNoteEditor = openNoteEditor;
        window.confirmDeleteNote = confirmDeleteNote;
        window.duplicateNote = duplicateNote;
        window.removeTag = removeTag;
    });
</script>