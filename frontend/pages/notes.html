<!-- pages/notes.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <div id="topbar-container"></div>

            <!-- Notes Content -->
            <div class="container-fluid mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">My Notes</h1>
                    <button class="btn btn-primary" onclick="createNewNote()">
                        <i class="fas fa-plus me-2"></i>New Note
                    </button>
                </div>

                <!-- Search and Filters -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-search"></i>
                                    </span>
                                    <input type="text" class="form-control" id="searchNotes"
                                        placeholder="Search notes...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="weekFilter">
                                    <option value="">All Weeks</option>
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                    <option value="7">Week 7</option>
                                    <option value="8">Week 8</option>
                                    <option value="9">Week 9</option>
                                    <option value="10">Week 10</option>
                                    <option value="11">Week 11</option>
                                    <option value="12">Week 12</option>
                                    <option value="13">Week 13</option>
                                    <option value="14">Week 14</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="sortNotes">
                                    <option value="updated">Last Updated</option>
                                    <option value="created">Date Created</option>
                                    <option value="title">Title</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Notes List -->
                <div id="notesList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading notes...</span>
                        </div>
                    </div>
                </div>

                <!-- Pagination -->
                <nav id="notesPagination" class="mt-4"></nav>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <!-- Note Editor Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="noteModalTitle">New Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="noteForm">
                        <input type="hidden" id="noteId">
                        <div class="mb-3">
                            <label for="noteTitle" class="form-label">Title</label>
                            <input type="text" class="form-control" id="noteTitle" required>
                        </div>
                        <div class="mb-3">
                            <label for="noteContent" class="form-label">Content</label>
                            <textarea class="form-control" id="noteContent" rows="10" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="noteWeek" class="form-label">Week (Optional)</label>
                                <select class="form-select" id="noteWeek">
                                    <option value="">Select Week</option>
                                    <option value="1">Week 1</option>
                                    <option value="2">Week 2</option>
                                    <option value="3">Week 3</option>
                                    <option value="4">Week 4</option>
                                    <option value="5">Week 5</option>
                                    <option value="6">Week 6</option>
                                    <option value="7">Week 7</option>
                                    <option value="8">Week 8</option>
                                    <option value="9">Week 9</option>
                                    <option value="10">Week 10</option>
                                    <option value="11">Week 11</option>
                                    <option value="12">Week 12</option>
                                    <option value="13">Week 13</option>
                                    <option value="14">Week 14</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="noteTags" class="form-label">Tags (comma-separated)</label>
                                <input type="text" class="form-control" id="noteTags"
                                    placeholder="e.g., arrays, sorting, algorithms">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNote()">Save Note</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/animation.js"></script>

    <script>
        // Load components
        fetch('/components/sidebar.html').then(r => r.text()).then(html => {
            document.getElementById('sidebar-container').innerHTML = html;
            initSidebar();
        });

        fetch('/components/topbar.html').then(r => r.text()).then(html => {
            document.getElementById('topbar-container').innerHTML = html;
        });

        fetch('/components/mobile-nav.html').then(r => r.text()).then(html => {
            document.getElementById('mobile-nav-container').innerHTML = html;
            initMobileNav();
        });

        // Notes functionality
        let currentPage = 1;
        let totalPages = 1;
        let noteModal;

        document.addEventListener('DOMContentLoaded', function () {
            noteModal = new bootstrap.Modal(document.getElementById('noteModal'));

            // Set up search debounce
            document.getElementById('searchNotes').addEventListener('input', debounce(() => {
                currentPage = 1;
                loadNotes();
            }, 300));

            // Set up filters
            document.getElementById('weekFilter').addEventListener('change', () => {
                currentPage = 1;
                loadNotes();
            });

            document.getElementById('sortNotes').addEventListener('change', () => {
                currentPage = 1;
                loadNotes();
            });

            loadNotes();
        });

        async function loadNotes() {
            try {
                const search = document.getElementById('searchNotes').value;
                const week = document.getElementById('weekFilter').value;

                const params = new URLSearchParams({
                    page: currentPage,
                    per_page: 10
                });

                if (search) params.append('search', search);
                if (week) params.append('week', week);

                const data = await api.get(`/notes?${params}`);

                renderNotes(data.notes);
                renderPagination(data.pagination);

            } catch (error) {
                console.error('Failed to load notes:', error);
                showToast('Failed to load notes', 'danger');
            }
        }

        function renderNotes(notes) {
            const container = document.getElementById('notesList');

            if (notes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-sticky-note empty-state-icon"></i>
                        <h3 class="empty-state-title">No notes yet</h3>
                        <p class="empty-state-text">Create your first note to start organizing your learning!</p>
                        <button class="btn btn-primary" onclick="createNewNote()">
                            <i class="fas fa-plus me-2"></i>Create Note
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = notes.map(note => `
                <div class="note-card animate-fade-in">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h5 class="mb-2">${escapeHtml(note.title)}</h5>
                            <p class="text-muted mb-2">${escapeHtml(note.content).substring(0, 200)}${note.content.length > 200 ? '...' : ''}</p>
                            <div class="d-flex flex-wrap gap-2 mb-2">
                                ${note.week ? `<span class="badge bg-primary">Week ${note.week}</span>` : ''}
                                ${note.tags.map(tag => `<span class="note-tag">${escapeHtml(tag)}</span>`).join('')}
                            </div>
                            <small class="text-muted">Updated ${formatDate(note.updated_at)}</small>
                        </div>
                        <div class="dropdown">
                            <button class="btn btn-link text-muted" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" onclick="editNote('${note.id}')">
                                    <i class="fas fa-edit me-2"></i>Edit
                                </a></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="deleteNote('${note.id}')">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPagination(pagination) {
            const container = document.getElementById('notesPagination');

            if (pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '<ul class="pagination justify-content-center">';

            // Previous button
            html += `
                <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${pagination.page - 1})">Previous</a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
                    html += `
                        <li class="page-item ${i === pagination.page ? 'active' : ''}">
                            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                        </li>
                    `;
                } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                    html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Next button
            html += `
                <li class="page-item ${pagination.page === pagination.pages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${pagination.page + 1})">Next</a>
                </li>
            `;

            html += '</ul>';
            container.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            loadNotes();
            window.scrollTo(0, 0);
        }

        function createNewNote() {
            document.getElementById('noteModalTitle').textContent = 'New Note';
            document.getElementById('noteForm').reset();
            document.getElementById('noteId').value = '';
            noteModal.show();
        }

        async function editNote(noteId) {
            try {
                const response = await fetch(`${API_BASE}/notes?search=id:${noteId}`, {
                    headers: api.headers()
                });
                const data = await response.json();

                if (data.notes && data.notes.length > 0) {
                    const note = data.notes[0];
                    document.getElementById('noteModalTitle').textContent = 'Edit Note';
                    document.getElementById('noteId').value = note.id;
                    document.getElementById('noteTitle').value = note.title;
                    document.getElementById('noteContent').value = note.content;
                    document.getElementById('noteWeek').value = note.week || '';
                    document.getElementById('noteTags').value = note.tags.join(', ');
                    noteModal.show();
                }
            } catch (error) {
                showToast('Failed to load note', 'danger');
            }
        }

        async function saveNote() {
            const noteId = document.getElementById('noteId').value;
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const week = document.getElementById('noteWeek').value;
            const tags = document.getElementById('noteTags').value.split(',').map(t => t.trim()).filter(t => t);

            if (!title || !content) {
                showToast('Please fill in all required fields', 'warning');
                return;
            }

            try {
                const noteData = { title, content, tags };
                if (week) noteData.week = parseInt(week);

                if (noteId) {
                    await api.put(`/notes/${noteId}`, noteData);
                    showToast('Note updated successfully', 'success');
                } else {
                    await api.post('/notes', noteData);
                    showToast('Note created successfully', 'success');
                }

                noteModal.hide();
                loadNotes();

            } catch (error) {
                showToast('Failed to save note', 'danger');
            }
        }

        async function deleteNote(noteId) {
            if (!confirm('Are you sure you want to delete this note?')) {
                return;
            }

            try {
                await api.delete(`/notes/${noteId}`);
                showToast('Note deleted successfully', 'success');
                loadNotes();
            } catch (error) {
                showToast('Failed to delete note', 'danger');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>