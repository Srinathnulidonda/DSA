<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes - DSA Learning Platform</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Quill Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/animation.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <style>
        .note-card {
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .note-card.pinned {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-color: #667eea;
        }

        .tag-pill {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            background: #e0e7ff;
            color: #4338ca;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .search-highlight {
            background: #fef08a;
            font-weight: 500;
        }

        #noteEditor {
            min-height: 400px;
        }

        .note-preview {
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }

        .note-preview::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to bottom, transparent, white);
        }

        .sidebar-filter {
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .sidebar-filter:hover {
            background: #f3f4f6;
        }

        .sidebar-filter.active {
            background: #e0e7ff;
            color: #4338ca;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .notes-sidebar {
                position: fixed;
                top: 0;
                left: -100%;
                width: 80%;
                max-width: 300px;
                height: 100vh;
                background: white;
                z-index: 1050;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            }

            .notes-sidebar.show {
                left: 0;
            }

            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1040;
                display: none;
            }

            .sidebar-overlay.show {
                display: block;
            }
        }
    </style>
</head>

<body class="bg-gray-50">
    <!-- Desktop Sidebar -->
    <div id="sidebar" class="desktop-only"></div>

    <!-- Mobile Top Bar -->
    <div id="topbar" class="mobile-only"></div>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container-fluid p-4">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h1 class="h3 fw-bold mb-2">Study Notes</h1>
                            <p class="text-muted mb-0">Organize your learning with personal notes</p>
                        </div>
                        <div class="d-flex gap-2 mt-3 mt-md-0">
                            <button class="btn btn-outline-secondary d-md-none" onclick="toggleNotesSidebar()">
                                <i class="bi bi-funnel"></i>
                            </button>
                            <button class="btn btn-primary" onclick="showNewNoteModal()">
                                <i class="bi bi-plus-circle me-2"></i>New Note
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0 ps-0" id="searchNotes"
                            placeholder="Search notes by title, content, or tags...">
                    </div>
                </div>
            </div>

            <div class="row">
                <!-- Notes Sidebar (Filters) -->
                <div class="col-md-3 mb-4">
                    <div class="notes-sidebar">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="fw-semibold mb-3">Filters</h6>

                                <div class="mb-4">
                                    <div class="sidebar-filter active" data-filter="all">
                                        <i class="bi bi-journal-text me-2"></i>All Notes
                                        <span class="float-end badge bg-secondary" id="allNotesCount">0</span>
                                    </div>
                                    <div class="sidebar-filter" data-filter="pinned">
                                        <i class="bi bi-pin-angle me-2"></i>Pinned
                                        <span class="float-end badge bg-secondary" id="pinnedCount">0</span>
                                    </div>
                                    <div class="sidebar-filter" data-filter="recent">
                                        <i class="bi bi-clock me-2"></i>Recent
                                    </div>
                                </div>

                                <h6 class="fw-semibold mb-3">Topics</h6>
                                <div id="topicFilters" class="mb-4">
                                    <!-- Topic filters will be loaded here -->
                                </div>

                                <h6 class="fw-semibold mb-3">Tags</h6>
                                <div id="tagCloud">
                                    <!-- Tags will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="sidebar-overlay" onclick="toggleNotesSidebar()"></div>
                </div>

                <!-- Notes Grid -->
                <div class="col-md-9">
                    <div class="row" id="notesGrid">
                        <!-- Notes will be loaded here -->
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <i class="bi bi-journal-text fs-1 text-muted mb-3 d-block"></i>
                        <h5 class="text-muted">No notes found</h5>
                        <p class="text-muted">Create your first note to start organizing your learning</p>
                        <button class="btn btn-primary" onclick="showNewNoteModal()">
                            <i class="bi bi-plus-circle me-2"></i>Create Note
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Bottom Navigation -->
    <div id="mobileNav" class="mobile-only"></div>

    <!-- Note Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg modal-fullscreen-md-down">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="noteModalTitle">New Note</h5>
                    <div class="ms-auto d-flex gap-2">
                        <button type="button" class="btn btn-sm btn-outline-secondary" id="pinNoteBtn"
                            onclick="togglePinNote()" title="Pin note">
                            <i class="bi bi-pin-angle"></i>
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <form id="noteForm">
                        <div class="mb-3">
                            <input type="text" class="form-control form-control-lg border-0 px-0" id="noteTitle"
                                placeholder="Note Title" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted small">Topic</label>
                            <select class="form-select" id="noteTopic">
                                <option value="">Select a topic (optional)</option>
                                <!-- Topics will be loaded here -->
                            </select>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted small">Content</label>
                            <div id="noteEditor"></div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-muted small">Tags</label>
                            <input type="text" class="form-control" id="noteTags"
                                placeholder="Enter tags separated by commas">
                            <small class="text-muted">e.g., arrays, sorting, interview</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-danger me-auto" id="deleteNoteBtn" onclick="deleteNote()"
                        style="display: none;">
                        <i class="bi bi-trash me-1"></i>Delete
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNote()">
                        <i class="bi bi-check-circle me-1"></i>Save Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Quill JS -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <script>
        // API Configuration
        const API_BASE = 'https://dsa-8ko1.onrender.com/api';
        let authToken = null;
        let notes = [];
        let currentNote = null;
        let quill = null;
        let currentFilter = 'all';
        let searchQuery = '';

        // Initialize notes page
        async function initNotes() {
            authToken = localStorage.getItem('access_token');

            if (!authToken) {
                window.location.href = '../auth/login.html';
                return;
            }

            // Load components
            await loadComponents();

            // Initialize Quill editor
            initializeQuillEditor();

            // Load notes
            await loadNotes();

            // Load topics for filter and dropdown
            await loadTopics();

            // Setup event listeners
            setupEventListeners();
        }

        // Load reusable components
        async function loadComponents() {
            // Load sidebar
            const sidebarResponse = await fetch('../components/sidebar.html');
            const sidebarHtml = await sidebarResponse.text();
            document.getElementById('sidebar').innerHTML = sidebarHtml;

            // Load topbar
            const topbarResponse = await fetch('../components/topbar.html');
            const topbarHtml = await topbarResponse.text();
            document.getElementById('topbar').innerHTML = topbarHtml;

            // Load mobile nav
            const mobileNavResponse = await fetch('../components/mobile-nav.html');
            const mobileNavHtml = await mobileNavResponse.text();
            document.getElementById('mobileNav').innerHTML = mobileNavHtml;

            // Set active states
            setActiveNavItem('notes');
        }

        // Set active navigation item
        function setActiveNavItem(page) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });

            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.page === page) {
                    item.classList.add('active');
                }
            });
        }

        // Initialize Quill editor
        function initializeQuillEditor() {
            quill = new Quill('#noteEditor', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['blockquote', 'code-block'],
                        [{ 'header': 1 }, { 'header': 2 }],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                        [{ 'script': 'sub' }, { 'script': 'super' }],
                        [{ 'indent': '-1' }, { 'indent': '+1' }],
                        ['link', 'image'],
                        ['clean']
                    ]
                },
                placeholder: 'Write your notes here...'
            });
        }

        // Load notes
        async function loadNotes() {
            try {
                let url = `${API_BASE}/notes`;
                const params = new URLSearchParams();

                if (searchQuery) {
                    params.append('search', searchQuery);
                }

                if (params.toString()) {
                    url += `?${params.toString()}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    notes = data.notes;

                    // Apply client-side filters
                    filterAndDisplayNotes();
                    updateCounts();
                    updateTagCloud();
                }

            } catch (error) {
                console.error('Error loading notes:', error);
                showToast('Failed to load notes', 'error');
            }
        }

        // Filter and display notes
        function filterAndDisplayNotes() {
            let filteredNotes = [...notes];

            // Apply filter
            if (currentFilter === 'pinned') {
                filteredNotes = filteredNotes.filter(note => note.is_pinned);
            } else if (currentFilter === 'recent') {
                // Sort by updated_at and take recent 10
                filteredNotes = filteredNotes
                    .sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at))
                    .slice(0, 10);
            } else if (currentFilter.startsWith('topic:')) {
                const topic = currentFilter.replace('topic:', '');
                filteredNotes = filteredNotes.filter(note => note.topic === topic);
            } else if (currentFilter.startsWith('tag:')) {
                const tag = currentFilter.replace('tag:', '');
                filteredNotes = filteredNotes.filter(note => note.tags.includes(tag));
            }

            displayNotes(filteredNotes);
        }

        // Display notes
        function displayNotes(notesToDisplay) {
            const container = document.getElementById('notesGrid');
            const emptyState = document.getElementById('emptyState');

            if (notesToDisplay.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            // Sort pinned notes first
            notesToDisplay.sort((a, b) => {
                if (a.is_pinned && !b.is_pinned) return -1;
                if (!a.is_pinned && b.is_pinned) return 1;
                return new Date(b.updated_at) - new Date(a.updated_at);
            });

            container.innerHTML = notesToDisplay.map(note => {
                const preview = stripHtml(note.content).substring(0, 150) + '...';
                const updated = new Date(note.updated_at);
                const updatedStr = formatDate(updated);

                return `
                    <div class="col-12 col-md-6 col-lg-4 mb-4">
                        <div class="card note-card h-100 ${note.is_pinned ? 'pinned' : ''}" 
                             onclick="editNote('${note.id}')">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="card-title mb-0">${highlightSearch(note.title)}</h5>
                                    ${note.is_pinned ? '<i class="bi bi-pin-angle-fill text-primary"></i>' : ''}
                                </div>
                                
                                ${note.topic ? `
                                    <p class="text-muted small mb-2">
                                        <i class="bi bi-folder me-1"></i>${note.topic}
                                    </p>
                                ` : ''}
                                
                                <div class="note-preview text-muted mb-3">
                                    ${highlightSearch(preview)}
                                </div>
                                
                                <div class="d-flex flex-wrap gap-1 mb-3">
                                    ${note.tags.map(tag => `
                                        <span class="tag-pill">${tag}</span>
                                    `).join('')}
                                </div>
                                
                                <small class="text-muted">
                                    <i class="bi bi-clock me-1"></i>${updatedStr}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Strip HTML from content
        function stripHtml(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        // Highlight search terms
        function highlightSearch(text) {
            if (!searchQuery) return text;

            const regex = new RegExp(`(${searchQuery})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // Format date
        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) {
                const hours = Math.floor(diff / (1000 * 60 * 60));
                if (hours === 0) {
                    const minutes = Math.floor(diff / (1000 * 60));
                    return minutes === 0 ? 'Just now' : `${minutes}m ago`;
                }
                return `${hours}h ago`;
            } else if (days === 1) {
                return 'Yesterday';
            } else if (days < 7) {
                return `${days} days ago`;
            } else {
                return date.toLocaleDateString();
            }
        }

        // Update counts
        function updateCounts() {
            document.getElementById('allNotesCount').textContent = notes.length;
            document.getElementById('pinnedCount').textContent = notes.filter(n => n.is_pinned).length;
        }

        // Update tag cloud
        function updateTagCloud() {
            const tagCounts = {};
            notes.forEach(note => {
                note.tags.forEach(tag => {
                    tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                });
            });

            const container = document.getElementById('tagCloud');
            const tags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            container.innerHTML = tags.map(([tag, count]) => `
                <span class="tag-pill cursor-pointer" onclick="filterByTag('${tag}')">
                    ${tag} (${count})
                </span>
            `).join('');
        }

        // Load topics
        async function loadTopics() {
            try {
                const response = await fetch(`${API_BASE}/roadmap`);
                const data = await response.json();

                const topics = new Set();
                data.roadmap.forEach(week => {
                    week.days.forEach(day => {
                        topics.add(day.topic);
                    });
                });

                // Update topic filters
                const topicFilters = document.getElementById('topicFilters');
                const topicCounts = {};

                notes.forEach(note => {
                    if (note.topic) {
                        topicCounts[note.topic] = (topicCounts[note.topic] || 0) + 1;
                    }
                });

                const topTopics = Object.entries(topicCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5);

                topicFilters.innerHTML = topTopics.map(([topic, count]) => `
                    <div class="sidebar-filter" data-filter="topic:${topic}" onclick="filterByTopic('${topic}')">
                        <span class="text-truncate">${topic}</span>
                        <span class="float-end badge bg-secondary">${count}</span>
                    </div>
                `).join('');

                // Update topic dropdown
                const topicSelect = document.getElementById('noteTopic');
                topicSelect.innerHTML = '<option value="">Select a topic (optional)</option>' +
                    Array.from(topics).map(topic => `
                        <option value="${topic}">${topic}</option>
                    `).join('');

            } catch (error) {
                console.error('Error loading topics:', error);
            }
        }

        // Show new note modal
        function showNewNoteModal() {
            currentNote = null;
            document.getElementById('noteForm').reset();
            document.getElementById('noteModalTitle').textContent = 'New Note';
            document.getElementById('deleteNoteBtn').style.display = 'none';
            document.getElementById('pinNoteBtn').classList.remove('active');
            quill.setText('');

            const modal = new bootstrap.Modal(document.getElementById('noteModal'));
            modal.show();
        }

        // Edit note
        async function editNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;

            currentNote = note;
            document.getElementById('noteModalTitle').textContent = 'Edit Note';
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteTopic').value = note.topic || '';
            document.getElementById('noteTags').value = note.tags.join(', ');
            document.getElementById('deleteNoteBtn').style.display = 'block';

            if (note.is_pinned) {
                document.getElementById('pinNoteBtn').classList.add('active');
            } else {
                document.getElementById('pinNoteBtn').classList.remove('active');
            }

            quill.root.innerHTML = note.content;

            const modal = new bootstrap.Modal(document.getElementById('noteModal'));
            modal.show();
        }

        // Toggle pin note
        function togglePinNote() {
            const btn = document.getElementById('pinNoteBtn');
            btn.classList.toggle('active');
        }

        // Save note
        async function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = quill.root.innerHTML;
            const topic = document.getElementById('noteTopic').value;
            const tagsInput = document.getElementById('noteTags').value;
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];
            const isPinned = document.getElementById('pinNoteBtn').classList.contains('active');

            if (!title) {
                showToast('Please enter a note title', 'warning');
                return;
            }

            const noteData = {
                title,
                content,
                topic: topic || null,
                tags,
                is_pinned: isPinned
            };

            try {
                let response;

                if (currentNote) {
                    // Update existing note
                    response = await fetch(`${API_BASE}/notes/${currentNote.id}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(noteData)
                    });
                } else {
                    // Create new note
                    response = await fetch(`${API_BASE}/notes`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${authToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(noteData)
                    });
                }

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                    showToast(currentNote ? 'Note updated successfully' : 'Note created successfully', 'success');
                    await loadNotes();
                } else {
                    showToast('Failed to save note', 'error');
                }

            } catch (error) {
                console.error('Error saving note:', error);
                showToast('Failed to save note', 'error');
            }
        }

        // Delete note
        async function deleteNote() {
            if (!currentNote || !confirm('Are you sure you want to delete this note?')) return;

            try {
                const response = await fetch(`${API_BASE}/notes/${currentNote.id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                    showToast('Note deleted successfully', 'success');
                    await loadNotes();
                } else {
                    showToast('Failed to delete note', 'error');
                }

            } catch (error) {
                console.error('Error deleting note:', error);
                showToast('Failed to delete note', 'error');
            }
        }

        // Filter by topic
        function filterByTopic(topic) {
            currentFilter = `topic:${topic}`;
            updateActiveFilter();
            filterAndDisplayNotes();
        }

        // Filter by tag
        function filterByTag(tag) {
            currentFilter = `tag:${tag}`;
            filterAndDisplayNotes();
        }

        // Update active filter
        function updateActiveFilter() {
            document.querySelectorAll('.sidebar-filter').forEach(filter => {
                if (filter.dataset.filter === currentFilter) {
                    filter.classList.add('active');
                } else {
                    filter.classList.remove('active');
                }
            });
        }

        // Toggle notes sidebar (mobile)
        function toggleNotesSidebar() {
            document.querySelector('.notes-sidebar').classList.toggle('show');
            document.querySelector('.sidebar-overlay').classList.toggle('show');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search
            let searchTimeout;
            document.getElementById('searchNotes').addEventListener('input', function (e) {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchQuery = e.target.value.trim();
                    loadNotes();
                }, 300);
            });

            // Sidebar filters
            document.querySelectorAll('.sidebar-filter').forEach(filter => {
                filter.addEventListener('click', function () {
                    currentFilter = this.dataset.filter;
                    updateActiveFilter();
                    filterAndDisplayNotes();
                });
            });
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const toastHtml = `
                <div class="toast align-items-center text-bg-${type} border-0" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;

            const toastContainer = document.querySelector('.toast-container') || createToastContainer();
            const toastElement = document.createElement('div');
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement.firstElementChild);

            const toast = new bootstrap.Toast(toastElement.firstElementChild);
            toast.show();
        }

        // Create toast container
        function createToastContainer() {
            const container = document.createElement('div');
            container.className = 'toast-container position-fixed bottom-0 end-0 p-3';
            document.body.appendChild(container);
            return container;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initNotes);
    </script>
</body>

</html>