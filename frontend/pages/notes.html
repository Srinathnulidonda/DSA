<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Notes - DSAPath</title>

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- SimpleMDE Markdown Editor -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/simplemde/dist/simplemde.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/layouts.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animations.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body class="bg-light">
    <div class="app-wrapper">
        <!-- Topbar -->
        <nav class="topbar">
            <div class="container-fluid d-flex align-items-center">
                <button class="btn btn-link text-dark d-lg-none p-0 me-3" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars fa-lg"></i>
                </button>

                <a href="/pages/dashboard.html" class="topbar-brand">
                    <i class="fas fa-code-branch"></i>
                    DSAPath
                </a>

                <div class="topbar-nav">
                    <button class="btn btn-link text-dark position-relative" onclick="showNotifications()">
                        <i class="fas fa-bell"></i>
                    </button>

                    <div class="dropdown">
                        <button class="btn btn-link text-dark dropdown-toggle d-flex align-items-center"
                            data-bs-toggle="dropdown">
                            <img src="/assets/images/default-avatar.png" alt="Avatar" class="rounded-circle me-2"
                                width="32" height="32" id="userAvatar">
                            <span class="d-none d-md-inline" id="userName">Loading...</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/pages/profile.html">
                                    <i class="fas fa-user me-2"></i>Profile
                                </a></li>
                            <li><a class="dropdown-item" href="/pages/settings.html">
                                    <i class="fas fa-cog me-2"></i>Settings
                                </a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                                </a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <a href="/pages/dashboard.html" class="sidebar-link">
                    <i class="fas fa-home"></i>
                    <span>Dashboard</span>
                </a>
                <a href="/pages/roadmap.html" class="sidebar-link">
                    <i class="fas fa-route"></i>
                    <span>Roadmap</span>
                </a>
                <a href="/pages/calendar.html" class="sidebar-link">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Calendar</span>
                </a>
                <a href="/pages/progress.html" class="sidebar-link">
                    <i class="fas fa-chart-line"></i>
                    <span>Progress</span>
                </a>
                <a href="/pages/notes.html" class="sidebar-link active">
                    <i class="fas fa-sticky-note"></i>
                    <span>Notes</span>
                </a>
                <a href="/pages/pomodoro.html" class="sidebar-link">
                    <i class="fas fa-clock"></i>
                    <span>Pomodoro</span>
                </a>
                <a href="/pages/resources.html" class="sidebar-link">
                    <i class="fas fa-book"></i>
                    <span>Resources</span>
                </a>
                <a href="/pages/ai-assistant.html" class="sidebar-link">
                    <i class="fas fa-robot"></i>
                    <span>AI Assistant</span>
                </a>
                <a href="/pages/analytics.html" class="sidebar-link">
                    <i class="fas fa-chart-bar"></i>
                    <span>Analytics</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid">
                <!-- Page Header -->
                <div class="page-header mb-4">
                    <div class="d-flex justify-content-between align-items-center flex-wrap">
                        <div>
                            <h1 class="page-title">Study Notes</h1>
                            <p class="page-subtitle">Organize your learning with markdown-powered notes</p>
                        </div>
                        <div class="d-flex gap-2 mt-3 mt-md-0">
                            <div class="input-group" style="width: 250px;">
                                <input type="text" class="form-control" placeholder="Search notes..." id="searchInput"
                                    onkeyup="searchNotes()">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <button class="btn btn-primary" onclick="createNewNote()">
                                <i class="fas fa-plus me-2"></i>New Note
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Notes Layout -->
                <div class="row">
                    <!-- Notes List -->
                    <div class="col-lg-4 mb-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white border-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">My Notes</h5>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-link text-muted" data-bs-toggle="dropdown">
                                            <i class="fas fa-filter"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li><a class="dropdown-item active" href="#" onclick="filterNotes('all')">
                                                    All Notes
                                                </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="filterNotes('recent')">
                                                    Recent
                                                </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="filterNotes('week')">
                                                    By Week
                                                </a></li>
                                            <li>
                                                <hr class="dropdown-divider">
                                            </li>
                                            <li><a class="dropdown-item" href="#" onclick="filterNotes('tagged')">
                                                    Tagged
                                                </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-0">
                                <div id="notesList" class="notes-list">
                                    <div class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading notes...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Note Editor -->
                    <div class="col-lg-8 mb-4">
                        <div class="card border-0 shadow-sm h-100">
                            <div id="noteEditor" style="display: none;">
                                <div class="card-header bg-white border-0">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <input type="text" class="form-control form-control-lg border-0 px-0"
                                            id="noteTitle" placeholder="Note Title..." style="font-weight: 600;">
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-sm btn-outline-secondary" onclick="togglePreview()">
                                                <i class="fas fa-eye me-1"></i>Preview
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteCurrentNote()">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            <button class="btn btn-sm btn-primary" onclick="saveNote()">
                                                <i class="fas fa-save me-1"></i>Save
                                            </button>
                                        </div>
                                    </div>
                                    <div class="mt-2">
                                        <input type="text" class="form-control form-control-sm" id="noteTags"
                                            placeholder="Tags (comma separated)">
                                    </div>
                                </div>
                                <div class="card-body p-0">
                                    <textarea id="noteContent"></textarea>
                                </div>
                            </div>

                            <!-- Empty State -->
                            <div id="emptyState"
                                class="card-body d-flex flex-column align-items-center justify-content-center h-100">
                                <i class="fas fa-sticky-note fa-4x text-muted mb-3"></i>
                                <h5 class="text-muted">Select a note to view</h5>
                                <p class="text-muted">Or create a new one to get started</p>
                                <button class="btn btn-primary mt-2" onclick="createNewNote()">
                                    <i class="fas fa-plus me-2"></i>Create New Note
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Note Templates -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0">Quick Templates</h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="template-card" onclick="useTemplate('algorithm')">
                                    <i class="fas fa-code mb-2"></i>
                                    <h6>Algorithm Template</h6>
                                    <p class="text-muted small mb-0">Problem, approach, complexity</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="template-card" onclick="useTemplate('concept')">
                                    <i class="fas fa-lightbulb mb-2"></i>
                                    <h6>Concept Notes</h6>
                                    <p class="text-muted small mb-0">Definition, examples, use cases</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="template-card" onclick="useTemplate('review')">
                                    <i class="fas fa-redo mb-2"></i>
                                    <h6>Review Template</h6>
                                    <p class="text-muted small mb-0">Key points, questions, summary</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="template-card" onclick="useTemplate('project')">
                                    <i class="fas fa-project-diagram mb-2"></i>
                                    <h6>Project Notes</h6>
                                    <p class="text-muted small mb-0">Requirements, progress, TODOs</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav">
            <ul class="mobile-nav-list">
                <li class="mobile-nav-item">
                    <a href="/pages/dashboard.html" class="mobile-nav-link">
                        <i class="fas fa-home"></i>
                        <span>Home</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/roadmap.html" class="mobile-nav-link">
                        <i class="fas fa-route"></i>
                        <span>Roadmap</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/progress.html" class="mobile-nav-link">
                        <i class="fas fa-chart-line"></i>
                        <span>Progress</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <a href="/pages/pomodoro.html" class="mobile-nav-link">
                        <i class="fas fa-clock"></i>
                        <span>Timer</span>
                    </a>
                </li>
                <li class="mobile-nav-item">
                    <button class="mobile-nav-link" onclick="toggleMobileDrawer()">
                        <i class="fas fa-ellipsis-h"></i>
                        <span>More</span>
                    </button>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Note</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this note? This action cannot be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Drawer -->
    <div class="mobile-drawer" id="mobileDrawer">
        <div class="drawer-header p-3 border-bottom">
            <h5 class="mb-0">Menu</h5>
            <button class="btn-close" onclick="toggleMobileDrawer()"></button>
        </div>
        <div class="drawer-body">
            <nav class="nav flex-column p-3">
                <a href="/pages/calendar.html" class="nav-link">
                    <i class="fas fa-calendar-alt me-2"></i>Calendar
                </a>
                <a href="/pages/notes.html" class="nav-link active">
                    <i class="fas fa-sticky-note me-2"></i>Notes
                </a>
                <a href="/pages/resources.html" class="nav-link">
                    <i class="fas fa-book me-2"></i>Resources
                </a>
                <a href="/pages/ai-assistant.html" class="nav-link">
                    <i class="fas fa-robot me-2"></i>AI Assistant
                </a>
                <a href="/pages/analytics.html" class="nav-link">
                    <i class="fas fa-chart-bar me-2"></i>Analytics
                </a>
                <hr>
                <a href="/pages/profile.html" class="nav-link">
                    <i class="fas fa-user me-2"></i>Profile
                </a>
                <a href="/pages/settings.html" class="nav-link">
                    <i class="fas fa-cog me-2"></i>Settings
                </a>
                <a href="#" class="nav-link text-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-2"></i>Logout
                </a>
            </nav>
        </div>
    </div>
    <div class="drawer-backdrop" id="drawerBackdrop" onclick="toggleMobileDrawer()"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/constants.js"></script>
    <script src="/js/utils.js"></script>
    <script src="/js/storage.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/theme.js"></script>
    <script src="/js/notifications.js"></script>

    <script>
        // Global variables
        let notesData = [];
        let currentNote = null;
        let simplemde = null;
        let isUnsaved = false;

        // Note templates
        const templates = {
            algorithm: `# Algorithm: [Problem Name]

## Problem Statement
[Describe the problem here]

## Approach
1. [Step 1]
2. [Step 2]
3. [Step 3]

## Code Implementation
\`\`\`python
def solution():
    # Your code here
    pass
\`\`\`

## Time Complexity
- **Time:** O(?)
- **Space:** O(?)

## Key Insights
- [Insight 1]
- [Insight 2]

## Similar Problems
- [Problem 1]
- [Problem 2]`,

            concept: `# Concept: [Topic Name]

## Definition
[Define the concept clearly]

## Key Properties
- Property 1
- Property 2
- Property 3

## Examples
### Example 1
[Description]

### Example 2
[Description]

## Common Use Cases
1. [Use case 1]
2. [Use case 2]

## Important Notes
- [Note 1]
- [Note 2]

## References
- [Reference 1]
- [Reference 2]`,

            review: `# Review: [Week/Topic]

## Key Concepts Learned
- [ ] Concept 1
- [ ] Concept 2
- [ ] Concept 3

## Important Algorithms
1. **Algorithm 1**: [Brief description]
2. **Algorithm 2**: [Brief description]

## Practice Problems Solved
- [ ] Problem 1 - [Difficulty]
- [ ] Problem 2 - [Difficulty]
- [ ] Problem 3 - [Difficulty]

## Areas for Improvement
- [Area 1]
- [Area 2]

## Questions/Doubts
- Q: [Question 1]
- Q: [Question 2]

## Next Steps
- [ ] [Action item 1]
- [ ] [Action item 2]`,

            project: `# Project: [Project Name]

## Overview
[Brief description of the project]

## Requirements
- [ ] Requirement 1
- [ ] Requirement 2
- [ ] Requirement 3

## Technical Stack
- Language: [Language]
- Data Structures: [List DS used]
- Algorithms: [List algorithms used]

## Implementation Progress
- [x] Setup project structure
- [ ] Implement feature 1
- [ ] Implement feature 2
- [ ] Testing
- [ ] Documentation

## Code Structure
\`\`\`
project/
├── main.py
├── data_structures/
│   ├── linked_list.py
│   └── tree.py
└── algorithms/
    ├── sorting.py
    └── searching.py
\`\`\`

## Challenges & Solutions
### Challenge 1
- **Problem**: [Description]
- **Solution**: [How you solved it]

## TODOs
- [ ] [Task 1]
- [ ] [Task 2]

## Learning Outcomes
- [What you learned]
- [Skills developed]`
        };

        // Initialize notes
        async function initNotes() {
            try {
                // Load user data
                const user = auth.getUser();
                if (user) {
                    document.getElementById('userName').textContent = user.name;
                    if (user.avatar_url) {
                        document.getElementById('userAvatar').src = user.avatar_url;
                    }
                }

                // Initialize markdown editor
                simplemde = new SimpleMDE({
                    element: document.getElementById("noteContent"),
                    spellChecker: false,
                    autosave: {
                        enabled: true,
                        uniqueId: "dsapath-note",
                        delay: 1000,
                    },
                    toolbar: [
                        "bold", "italic", "heading", "|",
                        "quote", "unordered-list", "ordered-list", "|",
                        "link", "image", "table", "|",
                        "preview", "side-by-side", "fullscreen", "|",
                        "guide"
                    ],
                    status: ["autosave", "lines", "words", "cursor"],
                    placeholder: "Start writing your note in Markdown..."
                });

                // Track changes
                simplemde.codemirror.on("change", () => {
                    isUnsaved = true;
                });

                // Load notes
                await loadNotes();

            } catch (error) {
                console.error('Notes initialization error:', error);
                notifications.error('Failed to load notes');
            }
        }

        // Load notes
        async function loadNotes(filter = 'all', searchQuery = '') {
            try {
                const params = {};
                if (searchQuery) {
                    params.search = searchQuery;
                }

                const response = await api.getNotes(params);
                notesData = response.notes;

                renderNotesList(notesData);

            } catch (error) {
                console.error('Error loading notes:', error);
                document.getElementById('notesList').innerHTML = `
                    <div class="text-center text-danger py-4">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Failed to load notes</p>
                    </div>
                `;
            }
        }

        // Render notes list
        function renderNotesList(notes) {
            const container = document.getElementById('notesList');

            if (notes.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-sticky-note fa-3x mb-3"></i>
                        <p>No notes found</p>
                        <button class="btn btn-sm btn-primary" onclick="createNewNote()">
                            Create your first note
                        </button>
                    </div>
                `;
                return;
            }

            let html = '<div class="list-group list-group-flush">';

            notes.forEach(note => {
                const isActive = currentNote && currentNote.id === note.id;
                const preview = note.content ? note.content.substring(0, 100) + '...' : 'No content';
                const tags = note.tags.length > 0 ? note.tags.map(tag =>
                    `<span class="badge bg-secondary me-1">${tag}</span>`
                ).join('') : '';

                html += `
                    <div class="list-group-item list-group-item-action ${isActive ? 'active' : ''}" 
                         onclick="selectNote('${note.id}')" style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 me-2">
                                <h6 class="mb-1 ${isActive ? 'text-white' : ''}">${utils.escapeHtml(note.title)}</h6>
                                <p class="mb-2 small ${isActive ? 'text-white-50' : 'text-muted'}">
                                    ${utils.escapeHtml(preview)}
                                </p>
                                <div class="d-flex align-items-center gap-2">
                                    ${tags}
                                    <small class="${isActive ? 'text-white-50' : 'text-muted'}">
                                        ${utils.getRelativeTime(note.updated_at)}
                                    </small>
                                </div>
                            </div>
                            ${note.week ? `
                                <span class="badge ${isActive ? 'bg-white text-primary' : 'bg-primary'} flex-shrink-0">
                                    Week ${note.week}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Select note
        async function selectNote(noteId) {
            if (isUnsaved && currentNote) {
                if (confirm('You have unsaved changes. Do you want to save them?')) {
                    await saveNote();
                }
            }

            const note = notesData.find(n => n.id === noteId);
            if (!note) return;

            currentNote = note;
            isUnsaved = false;

            // Show editor
            document.getElementById('noteEditor').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            // Populate editor
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteTags').value = note.tags.join(', ');
            simplemde.value(note.content || '');

            // Update list UI
            renderNotesList(notesData);
        }

        // Create new note
        function createNewNote() {
            if (isUnsaved && currentNote) {
                if (confirm('You have unsaved changes. Do you want to save them?')) {
                    saveNote();
                }
            }

            currentNote = {
                id: null,
                title: 'Untitled Note',
                content: '',
                tags: []
            };

            isUnsaved = false;

            // Show editor
            document.getElementById('noteEditor').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';

            // Clear editor
            document.getElementById('noteTitle').value = currentNote.title;
            document.getElementById('noteTags').value = '';
            simplemde.value('');

            // Focus on title
            document.getElementById('noteTitle').focus();
            document.getElementById('noteTitle').select();
        }

        // Save note
        async function saveNote() {
            if (!currentNote) return;

            const title = document.getElementById('noteTitle').value.trim();
            const content = simplemde.value();
            const tagsInput = document.getElementById('noteTags').value;
            const tags = tagsInput ? tagsInput.split(',').map(t => t.trim()).filter(t => t) : [];

            if (!title) {
                notifications.error('Please enter a note title');
                return;
            }

            try {
                const noteData = {
                    title,
                    content,
                    tags
                };

                let savedNote;
                if (currentNote.id) {
                    // Update existing note
                    await api.updateNote(currentNote.id, noteData);
                    savedNote = { ...currentNote, ...noteData, updated_at: new Date().toISOString() };

                    // Update in local array
                    const index = notesData.findIndex(n => n.id === currentNote.id);
                    if (index !== -1) {
                        notesData[index] = savedNote;
                    }
                } else {
                    // Create new note
                    const response = await api.createNote(noteData);
                    savedNote = {
                        id: response.id,
                        ...noteData,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };

                    // Add to local array
                    notesData.unshift(savedNote);
                }

                currentNote = savedNote;
                isUnsaved = false;

                // Update UI
                renderNotesList(notesData);
                notifications.success('Note saved successfully');

            } catch (error) {
                console.error('Error saving note:', error);
                notifications.error('Failed to save note');
            }
        }

        // Delete current note
        function deleteCurrentNote() {
            if (!currentNote || !currentNote.id) return;

            const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
            modal.show();
        }

        // Confirm delete
        async function confirmDelete() {
            if (!currentNote || !currentNote.id) return;

            try {
                await api.deleteNote(currentNote.id);

                // Remove from local array
                notesData = notesData.filter(n => n.id !== currentNote.id);

                // Clear editor
                currentNote = null;
                document.getElementById('noteEditor').style.display = 'none';
                document.getElementById('emptyState').style.display = 'flex';

                // Update list
                renderNotesList(notesData);

                // Close modal
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();

                notifications.success('Note deleted successfully');

            } catch (error) {
                console.error('Error deleting note:', error);
                notifications.error('Failed to delete note');
            }
        }

        // Search notes
        const searchNotes = utils.debounce(async () => {
            const query = document.getElementById('searchInput').value.trim();
            await loadNotes('all', query);
        }, 300);

        // Filter notes
        async function filterNotes(filter) {
            // Update dropdown UI
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');

            // Apply filter
            let filtered = notesData;

            switch (filter) {
                case 'recent':
                    // Sort by updated date
                    filtered = [...notesData].sort((a, b) =>
                        new Date(b.updated_at) - new Date(a.updated_at)
                    ).slice(0, 10);
                    break;

                case 'week':
                    // Group by week
                    filtered = notesData.filter(n => n.week);
                    filtered.sort((a, b) => a.week - b.week);
                    break;

                case 'tagged':
                    // Only notes with tags
                    filtered = notesData.filter(n => n.tags.length > 0);
                    break;
            }

            renderNotesList(filtered);
        }

        // Use template
        function useTemplate(templateType) {
            const template = templates[templateType];
            if (!template) return;

            createNewNote();

            // Set template content
            simplemde.value(template);

            // Update title based on template
            const titles = {
                algorithm: 'Algorithm: New Problem',
                concept: 'Concept: New Topic',
                review: 'Review: Week X',
                project: 'Project: New Project'
            };

            document.getElementById('noteTitle').value = titles[templateType] || 'New Note';
            document.getElementById('noteTitle').focus();
            document.getElementById('noteTitle').select();
        }

        // Toggle preview
        function togglePreview() {
            simplemde.togglePreview();
        }

        // Handle page unload
        window.addEventListener('beforeunload', (e) => {
            if (isUnsaved && currentNote) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Toggle mobile drawer
        function toggleMobileDrawer() {
            const drawer = document.getElementById('mobileDrawer');
            const backdrop = document.getElementById('drawerBackdrop');

            drawer.classList.toggle('open');
            backdrop.classList.toggle('show');
        }

        // Show notifications
        function showNotifications() {
            notifications.info('Notifications panel coming soon!');
        }

        // Logout
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                auth.logout();
            }
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initNotes();
        });

        // Add custom styles
        const style = document.createElement('style');
        style.textContent = `
            .notes-list {
                height: calc(100vh - 300px);
                overflow-y: auto;
            }
            
            .list-group-item.active {
                background-color: var(--primary);
                border-color: var(--primary);
            }
            
            .template-card {
                background: #f8f9fa;
                border: 1px solid #e5e7eb;
                border-radius: 0.5rem;
                padding: 1.5rem;
                text-align: center;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .template-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                border-color: var(--primary);
            }
            
            .template-card i {
                font-size: 2rem;
                color: var(--primary);
            }
            
            .template-card h6 {
                margin-bottom: 0.5rem;
            }
            
            /* SimpleMDE customization */
            .CodeMirror {
                height: calc(100vh - 400px);
                font-family: var(--font-mono);
            }
            
            .editor-toolbar {
                border-color: #e5e7eb;
            }
            
            .CodeMirror-wrap pre {
                word-break: break-word;
            }
            
            @media (max-width: 991px) {
                .notes-list {
                    height: 300px;
                }
                
                .CodeMirror {
                    height: 400px;
                }
            }
            
            @media (max-width: 767px) {
                .template-card {
                    padding: 1rem;
                }
                
                .template-card i {
                    font-size: 1.5rem;
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>