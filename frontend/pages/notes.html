<!-- pages/notes.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes - DSA Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@1.3.6/dist/quill.snow.css" rel="stylesheet">
    <link href="../css/main.css" rel="stylesheet">
    <link href="../css/components.css" rel="stylesheet">
    <link href="../css/animation.css" rel="stylesheet">
    <link href="../css/responsive.css" rel="stylesheet">
</head>

<body>
    <!-- Mobile Header -->
    <div class="mobile-header d-lg-none">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-0 fw-bold">Notes</h4>
                <small class="text-muted" id="notesCount">0 notes</small>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-primary btn-sm" onclick="createNewNote()">
                    <i class="fas fa-plus"></i>
                </button>
                <div class="dropdown">
                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="#" onclick="exportNotes()">Export All Notes</a></li>
                        <li><a class="dropdown-item" href="#" onclick="importNotes()">Import Notes</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item" href="#" onclick="showTrash()">Trash</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Desktop Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <div id="sidebarContainer"></div>

        <!-- Topbar -->
        <div id="topbarContainer"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card bg-gradient-to-r from-green-500 to-teal-500 text-white animate-fade-in">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-lg-8">
                                    <h2 class="mb-2"><i class="fas fa-sticky-note me-2"></i>Study Notes</h2>
                                    <p class="mb-0 opacity-75">Organize your learning with rich-text notes and tags</p>
                                </div>
                                <div class="col-lg-4 text-lg-end">
                                    <div
                                        class="d-flex justify-content-lg-end justify-content-center mt-3 mt-lg-0 gap-2">
                                        <button class="btn btn-light btn-sm" onclick="createNewNote()">
                                            <i class="fas fa-plus me-1"></i>
                                            New Note
                                        </button>
                                        <div class="dropdown">
                                            <button class="btn btn-outline-light btn-sm" data-bs-toggle="dropdown">
                                                <i class="fas fa-sort me-1"></i>
                                                Sort
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="sortNotes('recent')">Recently Modified</a></li>
                                                <li><a class="dropdown-item" href="#"
                                                        onclick="sortNotes('created')">Date Created</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="sortNotes('title')">Title
                                                        A-Z</a></li>
                                                <li><a class="dropdown-item" href="#" onclick="sortNotes('week')">By
                                                        Week</a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="row mb-4">
                <div class="col-lg-8 mb-3">
                    <div class="card">
                        <div class="card-body py-3">
                            <div class="row align-items-center">
                                <div class="col-lg-6">
                                    <div class="position-relative">
                                        <input type="text" class="form-control" placeholder="Search notes..."
                                            id="searchInput">
                                        <i
                                            class="fas fa-search position-absolute top-50 end-0 translate-middle-y me-3 text-muted"></i>
                                    </div>
                                </div>
                                <div class="col-lg-6 mt-2 mt-lg-0">
                                    <div class="d-flex gap-2">
                                        <select class="form-select form-select-sm" id="weekFilter">
                                            <option value="">All Weeks</option>
                                            <option value="1">Week 1</option>
                                            <option value="2">Week 2</option>
                                            <option value="3">Week 3</option>
                                            <option value="4">Week 4</option>
                                            <option value="5">Week 5</option>
                                            <option value="6">Week 6</option>
                                            <option value="7">Week 7</option>
                                            <option value="8">Week 8</option>
                                            <option value="9">Week 9</option>
                                            <option value="10">Week 10</option>
                                            <option value="11">Week 11</option>
                                            <option value="12">Week 12</option>
                                            <option value="13">Week 13</option>
                                            <option value="14">Week 14</option>
                                        </select>
                                        <button class="btn btn-outline-primary btn-sm" onclick="clearFilters()">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">View:</span>
                                <div class="btn-group btn-group-sm" role="group">
                                    <button type="button" class="btn btn-outline-primary active"
                                        onclick="setView('grid')" id="gridViewBtn">
                                        <i class="fas fa-th-large"></i>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="setView('list')"
                                        id="listViewBtn">
                                        <i class="fas fa-list"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notes Container -->
            <div class="row">
                <div class="col-12">
                    <div id="notesContainer">
                        <!-- Loading state -->
                        <div class="text-center py-5" id="loadingState">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Loading notes...</span>
                            </div>
                            <p class="text-muted">Loading your notes...</p>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div id="paginationContainer" class="mt-4"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <!-- Note Editor Modal -->
    <div class="modal fade" id="noteModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="flex-grow-1">
                        <input type="text" class="form-control form-control-lg border-0" placeholder="Note title..."
                            id="noteTitle">
                    </div>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-lg-9">
                            <!-- Rich Text Editor -->
                            <div id="noteEditor" style="min-height: 400px;"></div>
                        </div>
                        <div class="col-lg-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Note Details</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Week</label>
                                        <select class="form-select" id="noteWeek">
                                            <option value="">Select Week</option>
                                            <option value="1">Week 1</option>
                                            <option value="2">Week 2</option>
                                            <option value="3">Week 3</option>
                                            <option value="4">Week 4</option>
                                            <option value="5">Week 5</option>
                                            <option value="6">Week 6</option>
                                            <option value="7">Week 7</option>
                                            <option value="8">Week 8</option>
                                            <option value="9">Week 9</option>
                                            <option value="10">Week 10</option>
                                            <option value="11">Week 11</option>
                                            <option value="12">Week 12</option>
                                            <option value="13">Week 13</option>
                                            <option value="14">Week 14</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Day</label>
                                        <select class="form-select" id="noteDay">
                                            <option value="">Select Day</option>
                                            <option value="Monday">Monday</option>
                                            <option value="Tuesday">Tuesday</option>
                                            <option value="Wednesday">Wednesday</option>
                                            <option value="Thursday">Thursday</option>
                                            <option value="Friday">Friday</option>
                                            <option value="Saturday">Saturday</option>
                                            <option value="Sunday">Sunday</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Tags</label>
                                        <div class="tag-input-container" id="tagContainer">
                                            <input type="text" class="tag-input" placeholder="Add tags..."
                                                id="tagInput">
                                        </div>
                                        <small class="text-muted">Press Enter to add tags</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Created</label>
                                        <p class="text-muted small mb-0" id="noteCreated">-</p>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Last Modified</label>
                                        <p class="text-muted small mb-0" id="noteModified">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="deleteNote()" id="deleteNoteBtn"
                        style="display: none;">
                        <i class="fas fa-trash me-1"></i>Delete
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveNote()">
                        <i class="fas fa-save me-1"></i>Save Note
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quill@1.3.6/dist/quill.min.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';

        // Global variables
        let currentUser = null;
        let notes = [];
        let filteredNotes = [];
        let currentView = 'grid';
        let currentSort = 'recent';
        let currentPage = 1;
        let notesPerPage = 12;
        let noteEditor = null;
        let currentNoteId = null;
        let tags = [];

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadComponents();
            await loadNotes();
            setActivePage('notes');
            initializeEditor();
            setupEventListeners();
        });

        // Authentication check
        async function checkAuth() {
            const token = localStorage.getItem('accessToken');
            if (!token) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/profile`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Authentication failed');
                }

                const data = await response.json();
                currentUser = data.user;
            } catch (error) {
                console.error('Auth error:', error);
                localStorage.removeItem('accessToken');
                localStorage.removeItem('refreshToken');
                window.location.href = '/login';
            }
        }

        // Load reusable components
        async function loadComponents() {
            try {
                const sidebarResponse = await fetch('../components/sidebar.html');
                const sidebarHtml = await sidebarResponse.text();
                document.getElementById('sidebarContainer').innerHTML = sidebarHtml;

                if (window.innerWidth >= 992) {
                    const topbarResponse = await fetch('../components/topbar.html');
                    const topbarHtml = await topbarResponse.text();
                    document.getElementById('topbarContainer').innerHTML = topbarHtml;

                    setTimeout(() => {
                        const pageTitle = document.getElementById('pageTitle');
                        if (pageTitle) pageTitle.textContent = 'Notes';
                    }, 100);
                }

                const mobileNavResponse = await fetch('../components/mobile-nav.html');
                const mobileNavHtml = await mobileNavResponse.text();
                document.getElementById('mobileNavContainer').innerHTML = mobileNavHtml;

            } catch (error) {
                console.error('Error loading components:', error);
            }
        }

        // Load notes
        async function loadNotes() {
            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch(`${API_BASE}/notes?page=${currentPage}&per_page=${notesPerPage}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    notes = data.notes;
                    filteredNotes = [...notes];
                    updateNotesDisplay();
                    updatePagination(data.pagination);
                    updateNotesCount();
                } else {
                    throw new Error('Failed to load notes');
                }

            } catch (error) {
                console.error('Notes error:', error);
                showToast('Error loading notes', 'error');
                // Show empty state with sample data
                notes = generateSampleNotes();
                filteredNotes = [...notes];
                updateNotesDisplay();
                updateNotesCount();
            }
        }

        // Generate sample notes for demo
        function generateSampleNotes() {
            return [
                {
                    id: '1',
                    title: 'Array Operations Cheat Sheet',
                    content: '<h3>Array Operations</h3><p>Key operations: insertion, deletion, searching, sorting</p><ul><li>Time complexity for access: O(1)</li><li>Time complexity for search: O(n)</li><li>Space complexity: O(n)</li></ul>',
                    tags: ['arrays', 'cheatsheet', 'big-o'],
                    week: 2,
                    day: 'Monday',
                    created_at: '2024-01-15T10:30:00Z',
                    updated_at: '2024-01-15T14:22:00Z'
                },
                {
                    id: '2',
                    title: 'Linked List Implementation Notes',
                    content: '<h3>Singly Linked List</h3><p>Basic structure and operations</p><pre><code>class ListNode:\n    def __init__(self, val=0, next=None):\n        self.val = val\n        self.next = next</code></pre>',
                    tags: ['linked-list', 'implementation', 'python'],
                    week: 3,
                    day: 'Tuesday',
                    created_at: '2024-01-22T09:15:00Z',
                    updated_at: '2024-01-22T16:45:00Z'
                },
                {
                    id: '3',
                    title: 'Binary Search Algorithm',
                    content: '<h3>Binary Search</h3><p>Efficient searching in sorted arrays</p><p><strong>Time Complexity:</strong> O(log n)</p><p><strong>Space Complexity:</strong> O(1) iterative, O(log n) recursive</p>',
                    tags: ['binary-search', 'algorithms', 'searching'],
                    week: 11,
                    day: 'Thursday',
                    created_at: '2024-03-14T11:20:00Z',
                    updated_at: '2024-03-14T11:20:00Z'
                },
                {
                    id: '4',
                    title: 'Stack vs Queue Comparison',
                    content: '<h3>Stack vs Queue</h3><table><tr><th>Feature</th><th>Stack</th><th>Queue</th></tr><tr><td>Principle</td><td>LIFO</td><td>FIFO</td></tr><tr><td>Insert</td><td>push()</td><td>enqueue()</td></tr><tr><td>Remove</td><td>pop()</td><td>dequeue()</td></tr></table>',
                    tags: ['stack', 'queue', 'comparison', 'data-structures'],
                    week: 4,
                    day: 'Friday',
                    created_at: '2024-01-29T15:45:00Z',
                    updated_at: '2024-01-30T09:12:00Z'
                },
                {
                    id: '5',
                    title: 'Tree Traversal Methods',
                    content: '<h3>Tree Traversals</h3><ul><li><strong>Inorder:</strong> Left → Root → Right</li><li><strong>Preorder:</strong> Root → Left → Right</li><li><strong>Postorder:</strong> Left → Right → Root</li><li><strong>Level Order:</strong> BFS approach</li></ul>',
                    tags: ['trees', 'traversal', 'dfs', 'bfs'],
                    week: 5,
                    day: 'Wednesday',
                    created_at: '2024-02-05T13:30:00Z',
                    updated_at: '2024-02-05T18:15:00Z'
                },
                {
                    id: '6',
                    title: 'Dynamic Programming Patterns',
                    content: '<h3>DP Patterns</h3><p>Common patterns to recognize:</p><ol><li>Fibonacci sequence</li><li>Coin change</li><li>Longest increasing subsequence</li><li>Knapsack problem</li><li>Edit distance</li></ol>',
                    tags: ['dynamic-programming', 'patterns', 'optimization'],
                    week: 13,
                    day: 'Monday',
                    created_at: '2024-03-25T10:00:00Z',
                    updated_at: '2024-03-25T14:30:00Z'
                }
            ];
        }

        // Initialize rich text editor
        function initializeEditor() {
            const toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'header': 1 }, { 'header': 2 }],
                [{ 'list': 'ordered' }, { 'list': 'bullet' }],
                [{ 'script': 'sub' }, { 'script': 'super' }],
                [{ 'indent': '-1' }, { 'indent': '+1' }],
                [{ 'direction': 'rtl' }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'font': [] }],
                [{ 'align': [] }],
                ['clean'],
                ['link', 'image']
            ];

            noteEditor = new Quill('#noteEditor', {
                theme: 'snow',
                modules: {
                    toolbar: toolbarOptions
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Search input
            document.getElementById('searchInput').addEventListener('input', debounce(handleSearch, 300));

            // Week filter
            document.getElementById('weekFilter').addEventListener('change', handleFilter);

            // Tag input
            document.getElementById('tagInput').addEventListener('keypress', handleTagInput);
        }

        // Update notes display
        function updateNotesDisplay() {
            const container = document.getElementById('notesContainer');
            document.getElementById('loadingState').style.display = 'none';

            if (filteredNotes.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-sticky-note text-muted text-6xl mb-3"></i>
                        <h5 class="text-muted mb-3">No notes found</h5>
                        <p class="text-muted mb-4">Start taking notes to track your learning progress</p>
                        <button class="btn btn-primary" onclick="createNewNote()">
                            <i class="fas fa-plus me-2"></i>Create Your First Note
                        </button>
                    </div>
                `;
                return;
            }

            if (currentView === 'grid') {
                renderGridView(container);
            } else {
                renderListView(container);
            }
        }

        // Render grid view
        function renderGridView(container) {
            let html = '<div class="row">';

            filteredNotes.forEach((note, index) => {
                const createdDate = new Date(note.created_at).toLocaleDateString();
                const updatedDate = new Date(note.updated_at).toLocaleDateString();
                const excerpt = stripHtml(note.content).substring(0, 150) + '...';

                html += `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card note-card h-100 animate-slide-up" style="animation-delay: ${index * 0.1}s" onclick="editNote('${note.id}')">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${note.title}</h6>
                                    ${note.week ? `<span class="badge bg-primary">Week ${note.week}</span>` : ''}
                                </div>
                                <p class="card-text text-muted small mb-3">${excerpt}</p>
                                <div class="mb-3">
                                    ${note.tags.map(tag => `<span class="badge bg-light text-dark me-1">${tag}</span>`).join('')}
                                </div>
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        ${updatedDate}
                                    </small>
                                    <div class="note-actions">
                                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editNote('${note.id}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Render list view
        function renderListView(container) {
            let html = '<div class="list-group">';

            filteredNotes.forEach((note, index) => {
                const createdDate = new Date(note.created_at).toLocaleDateString();
                const updatedDate = new Date(note.updated_at).toLocaleDateString();
                const excerpt = stripHtml(note.content).substring(0, 200) + '...';

                html += `
                    <div class="list-group-item list-group-item-action note-list-item animate-slide-up" 
                         style="animation-delay: ${index * 0.05}s" onclick="editNote('${note.id}')">
                        <div class="d-flex w-100 justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0">${note.title}</h6>
                                    <div class="d-flex align-items-center gap-2">
                                        ${note.week ? `<span class="badge bg-primary">Week ${note.week}</span>` : ''}
                                        ${note.day ? `<span class="badge bg-secondary">${note.day}</span>` : ''}
                                    </div>
                                </div>
                                <p class="mb-2 text-muted">${excerpt}</p>
                                <div class="mb-2">
                                    ${note.tags.map(tag => `<span class="badge bg-light text-dark me-1">${tag}</span>`).join('')}
                                </div>
                                <small class="text-muted">
                                    Created: ${createdDate} • Modified: ${updatedDate}
                                </small>
                            </div>
                            <div class="flex-shrink-0 ms-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); editNote('${note.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Create new note
        function createNewNote() {
            currentNoteId = null;
            tags = [];

            // Reset form
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteWeek').value = '';
            document.getElementById('noteDay').value = '';
            document.getElementById('tagContainer').innerHTML = '<input type="text" class="tag-input" placeholder="Add tags..." id="tagInput">';

            // Reset editor
            noteEditor.setContents([]);

            // Reset dates
            document.getElementById('noteCreated').textContent = '-';
            document.getElementById('noteModified').textContent = '-';

            // Hide delete button
            document.getElementById('deleteNoteBtn').style.display = 'none';

            // Show modal
            new bootstrap.Modal(document.getElementById('noteModal')).show();

            // Setup tag input
            document.getElementById('tagInput').addEventListener('keypress', handleTagInput);
        }

        // Edit existing note
        function editNote(noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;

            currentNoteId = noteId;
            tags = [...note.tags];

            // Populate form
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteWeek').value = note.week || '';
            document.getElementById('noteDay').value = note.day || '';

            // Set content
            noteEditor.root.innerHTML = note.content;

            // Set dates
            document.getElementById('noteCreated').textContent = new Date(note.created_at).toLocaleString();
            document.getElementById('noteModified').textContent = new Date(note.updated_at).toLocaleString();

            // Show delete button
            document.getElementById('deleteNoteBtn').style.display = 'inline-block';

            // Render tags
            renderTags();

            // Show modal
            new bootstrap.Modal(document.getElementById('noteModal')).show();

            // Setup tag input
            setTimeout(() => {
                const tagInput = document.getElementById('tagInput');
                if (tagInput) {
                    tagInput.addEventListener('keypress', handleTagInput);
                }
            }, 100);
        }

        // Save note
        async function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = noteEditor.root.innerHTML;
            const week = document.getElementById('noteWeek').value;
            const day = document.getElementById('noteDay').value;

            if (!title) {
                showToast('Please enter a note title', 'warning');
                return;
            }

            const noteData = {
                title: title,
                content: content,
                tags: tags,
                week: week ? parseInt(week) : null,
                day: day || null
            };

            const token = localStorage.getItem('accessToken');

            try {
                let response;
                if (currentNoteId) {
                    // Update existing note
                    response = await fetch(`${API_BASE}/notes/${currentNoteId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(noteData)
                    });
                } else {
                    // Create new note
                    response = await fetch(`${API_BASE}/notes`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(noteData)
                    });
                }

                if (response.ok) {
                    showToast('Note saved successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                    await loadNotes(); // Refresh notes
                } else {
                    throw new Error('Failed to save note');
                }

            } catch (error) {
                console.error('Save note error:', error);

                // Simulate successful save for demo
                if (currentNoteId) {
                    const noteIndex = notes.findIndex(n => n.id === currentNoteId);
                    if (noteIndex !== -1) {
                        notes[noteIndex] = {
                            ...notes[noteIndex],
                            ...noteData,
                            updated_at: new Date().toISOString()
                        };
                    }
                } else {
                    const newNote = {
                        id: Date.now().toString(),
                        ...noteData,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    };
                    notes.unshift(newNote);
                }

                filteredNotes = [...notes];
                updateNotesDisplay();
                updateNotesCount();
                showToast('Note saved successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
            }
        }

        // Delete note
        async function deleteNote() {
            if (!currentNoteId) return;

            if (!confirm('Are you sure you want to delete this note?')) return;

            const token = localStorage.getItem('accessToken');

            try {
                const response = await fetch(`${API_BASE}/notes/${currentNoteId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showToast('Note deleted successfully!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
                    await loadNotes(); // Refresh notes
                } else {
                    throw new Error('Failed to delete note');
                }

            } catch (error) {
                console.error('Delete note error:', error);

                // Simulate successful delete for demo
                notes = notes.filter(n => n.id !== currentNoteId);
                filteredNotes = [...notes];
                updateNotesDisplay();
                updateNotesCount();
                showToast('Note deleted successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('noteModal')).hide();
            }
        }

        // Handle tag input
        function handleTagInput(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const tag = e.target.value.trim().toLowerCase();

                if (tag && !tags.includes(tag)) {
                    tags.push(tag);
                    renderTags();
                    e.target.value = '';
                }
            }
        }

        // Render tags
        function renderTags() {
            const container = document.getElementById('tagContainer');

            let html = '';
            tags.forEach(tag => {
                html += `
                    <span class="tag">
                        ${tag}
                        <button type="button" class="tag-remove" onclick="removeTag('${tag}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </span>
                `;
            });

            html += '<input type="text" class="tag-input" placeholder="Add tags..." id="tagInput">';
            container.innerHTML = html;

            // Re-attach event listener
            document.getElementById('tagInput').addEventListener('keypress', handleTagInput);
        }

        // Remove tag
        function removeTag(tag) {
            tags = tags.filter(t => t !== tag);
            renderTags();
        }

        // Handle search
        function handleSearch(e) {
            const query = e.target.value.toLowerCase().trim();

            if (!query) {
                filteredNotes = [...notes];
            } else {
                filteredNotes = notes.filter(note =>
                    note.title.toLowerCase().includes(query) ||
                    stripHtml(note.content).toLowerCase().includes(query) ||
                    note.tags.some(tag => tag.toLowerCase().includes(query))
                );
            }

            updateNotesDisplay();
        }

        // Handle filter
        function handleFilter() {
            const week = document.getElementById('weekFilter').value;

            if (!week) {
                filteredNotes = [...notes];
            } else {
                filteredNotes = notes.filter(note => note.week == week);
            }

            updateNotesDisplay();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('weekFilter').value = '';
            filteredNotes = [...notes];
            updateNotesDisplay();
        }

        // Set view
        function setView(view) {
            currentView = view;

            // Update button states
            document.getElementById('gridViewBtn').classList.toggle('active', view === 'grid');
            document.getElementById('listViewBtn').classList.toggle('active', view === 'list');

            updateNotesDisplay();
        }

        // Sort notes
        function sortNotes(sortBy) {
            currentSort = sortBy;

            switch (sortBy) {
                case 'recent':
                    notes.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                    break;
                case 'created':
                    notes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
                case 'title':
                    notes.sort((a, b) => a.title.localeCompare(b.title));
                    break;
                case 'week':
                    notes.sort((a, b) => (a.week || 0) - (b.week || 0));
                    break;
            }

            filteredNotes = [...notes];
            updateNotesDisplay();
        }

        // Update notes count
        function updateNotesCount() {
            const count = filteredNotes.length;
            document.getElementById('notesCount').textContent = `${count} note${count !== 1 ? 's' : ''}`;
        }

        // Update pagination
        function updatePagination(pagination) {
            if (!pagination || pagination.pages <= 1) {
                document.getElementById('paginationContainer').innerHTML = '';
                return;
            }

            let html = '<nav><ul class="pagination justify-content-center">';

            // Previous button
            html += `
                <li class="page-item ${pagination.page <= 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${pagination.page - 1})">Previous</a>
                </li>
            `;

            // Page numbers
            for (let i = 1; i <= pagination.pages; i++) {
                html += `
                    <li class="page-item ${i === pagination.page ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                    </li>
                `;
            }

            // Next button
            html += `
                <li class="page-item ${pagination.page >= pagination.pages ? 'disabled' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${pagination.page + 1})">Next</a>
                </li>
            `;

            html += '</ul></nav>';
            document.getElementById('paginationContainer').innerHTML = html;
        }

        // Change page
        function changePage(page) {
            currentPage = page;
            loadNotes();
        }

        // Export notes
        function exportNotes() {
            const exportData = {
                user: currentUser.name,
                exportDate: new Date().toISOString(),
                notes: notes
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsa-notes-${currentUser.name}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Notes exported successfully!', 'success');
        }

        // Import notes (placeholder)
        function importNotes() {
            showToast('Import feature coming soon!', 'info');
        }

        // Show trash (placeholder)
        function showTrash() {
            showToast('Trash feature coming soon!', 'info');
        }

        // Utility functions
        function stripHtml(html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;
            return temp.textContent || temp.innerText || '';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Set active page in navigation
        function setActivePage(page) {
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });

            document.querySelectorAll('.mobile-nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === page) {
                    link.classList.add('active');
                }
            });
        }

        // Toast notification system
        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');
            const toastId = 'toast-' + Date.now();

            const toast = `
                <div class="toast ${type}" role="alert" id="${toastId}">
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            toastContainer.innerHTML += toast;

            const toastElement = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastElement);
            bsToast.show();

            setTimeout(() => {
                toastElement.remove();
            }, 5000);
        }

        // Logout function
        function logout() {
            localStorage.removeItem('accessToken');
            localStorage.removeItem('refreshToken');
            localStorage.removeItem('user');
            window.location.href = '/login';
        }
    </script>

    <style>
        .note-card {
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .note-list-item {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .note-list-item:hover {
            background-color: #f8fafc;
        }

        .note-actions {
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .note-card:hover .note-actions {
            opacity: 1;
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            min-height: 42px;
            cursor: text;
        }

        .tag {
            background-color: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .tag-remove {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            display: flex;
            align-items: center;
            font-size: 0.75rem;
        }

        .tag-input {
            border: none;
            outline: none;
            flex: 1;
            min-width: 100px;
            font-size: 0.875rem;
            background: transparent;
        }

        .ql-editor {
            min-height: 300px;
        }

        .ql-toolbar {
            border-top: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            border-radius: 0.375rem 0.375rem 0 0;
        }

        .ql-container {
            border-bottom: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            border-radius: 0 0 0.375rem 0.375rem;
        }
    </style>
</body>

</html>