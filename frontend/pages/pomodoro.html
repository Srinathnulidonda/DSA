<!-- pages/pomodoro.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <div id="topbar-container"></div>

            <!-- Pomodoro Content -->
            <div class="container-fluid mt-4">
                <div class="text-center mb-4">
                    <h1 class="h3 mb-0">Pomodoro Timer</h1>
                    <p class="text-muted">Stay focused and productive with timed study sessions</p>
                </div>

                <div class="row justify-content-center">
                    <div class="col-lg-6">
                        <!-- Timer Card -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="pomodoro-container">
                                    <!-- Timer Display -->
                                    <div class="pomodoro-timer mx-auto">
                                        <svg class="pomodoro-ring" viewBox="0 0 260 260">
                                            <circle class="pomodoro-ring-bg" cx="130" cy="130" r="120" />
                                            <circle class="pomodoro-ring-progress" id="timerProgress" cx="130" cy="130"
                                                r="120" style="stroke-dasharray: 754; stroke-dashoffset: 0;" />
                                        </svg>
                                        <div class="pomodoro-time" id="timerDisplay">25:00</div>
                                    </div>

                                    <!-- Session Type Selector -->
                                    <div class="btn-group mb-4" role="group">
                                        <input type="radio" class="btn-check" name="sessionType" id="pomodoroSession"
                                            value="25" checked>
                                        <label class="btn btn-outline-primary" for="pomodoroSession">
                                            Pomodoro
                                        </label>

                                        <input type="radio" class="btn-check" name="sessionType" id="shortBreak"
                                            value="5">
                                        <label class="btn btn-outline-primary" for="shortBreak">
                                            Short Break
                                        </label>

                                        <input type="radio" class="btn-check" name="sessionType" id="longBreak"
                                            value="15">
                                        <label class="btn btn-outline-primary" for="longBreak">
                                            Long Break
                                        </label>
                                    </div>

                                    <!-- Topic Input -->
                                    <div class="mb-4">
                                        <input type="text" class="form-control" id="sessionTopic"
                                            placeholder="What are you working on?">
                                    </div>

                                    <!-- Control Buttons -->
                                    <div class="d-flex justify-content-center gap-3">
                                        <button class="btn btn-primary btn-lg" id="startBtn" onclick="startTimer()">
                                            <i class="fas fa-play me-2"></i>Start
                                        </button>
                                        <button class="btn btn-warning btn-lg d-none" id="pauseBtn"
                                            onclick="pauseTimer()">
                                            <i class="fas fa-pause me-2"></i>Pause
                                        </button>
                                        <button class="btn btn-success btn-lg d-none" id="resumeBtn"
                                            onclick="resumeTimer()">
                                            <i class="fas fa-play me-2"></i>Resume
                                        </button>
                                        <button class="btn btn-danger btn-lg d-none" id="stopBtn" onclick="stopTimer()">
                                            <i class="fas fa-stop me-2"></i>Stop
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Session Stats -->
                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">Today's Sessions</h5>
                                        <h2 class="text-primary mb-0" id="todaySessions">0</h2>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title">Focus Time</h5>
                                        <h2 class="text-success mb-0" id="todayFocusTime">0h 0m</h2>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Sessions -->
                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Recent Sessions</h5>
                            </div>
                            <div class="card-body">
                                <div id="recentSessions">
                                    <p class="text-muted text-center">No sessions yet today</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Settings & Tips -->
                    <div class="col-lg-4">
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Settings</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Pomodoro Duration</label>
                                    <input type="number" class="form-control" id="pomodoroDuration" value="25" min="1"
                                        max="60">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Short Break Duration</label>
                                    <input type="number" class="form-control" id="shortBreakDuration" value="5" min="1"
                                        max="30">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Long Break Duration</label>
                                    <input type="number" class="form-control" id="longBreakDuration" value="15" min="1"
                                        max="60">
                                </div>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="soundEnabled" checked>
                                    <label class="form-check-label" for="soundEnabled">
                                        Sound Notifications
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h5 class="card-title mb-0">Pomodoro Tips</h5>
                            </div>
                            <div class="card-body">
                                <ul class="list-unstyled mb-0">
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Focus on one task at a time
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Take breaks away from screen
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Stay hydrated during breaks
                                    </li>
                                    <li class="mb-2">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Long break after 4 pomodoros
                                    </li>
                                    <li>
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        Review progress at day end
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/animation.js"></script>

    <script>
        // Load components
        fetch('/components/sidebar.html').then(r => r.text()).then(html => {
            document.getElementById('sidebar-container').innerHTML = html;
            initSidebar();
        });

        fetch('/components/topbar.html').then(r => r.text()).then(html => {
            document.getElementById('topbar-container').innerHTML = html;
        });

        fetch('/components/mobile-nav.html').then(r => r.text()).then(html => {
            document.getElementById('mobile-nav-container').innerHTML = html;
            initMobileNav();
        });

        // Pomodoro functionality
        let timer = null;
        let timeLeft = 25 * 60; // 25 minutes in seconds
        let totalTime = 25 * 60;
        let isRunning = false;
        let isPaused = false;
        let currentSessionId = null;
        let sessionType = 'study';

        // Audio for notifications
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2')
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playNotificationSound() {
            if (!document.getElementById('soundEnabled').checked) return;

            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            oscillator.frequency.value = 800;
            oscillator.type = 'sine';

            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.5);
        }

        // Load settings
        document.addEventListener('DOMContentLoaded', function () {
            loadTodayStats();
            loadRecentSessions();

            // Session type change handlers
            document.querySelectorAll('input[name="sessionType"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    const duration = parseInt(this.value);
                    timeLeft = duration * 60;
                    totalTime = duration * 60;
                    updateTimerDisplay();
                    updateProgress();

                    if (this.id === 'pomodoroSession') {
                        sessionType = 'study';
                    } else {
                        sessionType = 'break';
                    }
                });
            });

            // Settings change handlers
            document.getElementById('pomodoroDuration').addEventListener('change', function () {
                document.getElementById('pomodoroSession').value = this.value;
                if (document.getElementById('pomodoroSession').checked && !isRunning) {
                    timeLeft = this.value * 60;
                    totalTime = this.value * 60;
                    updateTimerDisplay();
                    updateProgress();
                }
            });

            document.getElementById('shortBreakDuration').addEventListener('change', function () {
                document.getElementById('shortBreak').value = this.value;
            });

            document.getElementById('longBreakDuration').addEventListener('change', function () {
                document.getElementById('longBreak').value = this.value;
            });
        });

        async function startTimer() {
            if (isRunning) return;

            const topic = document.getElementById('sessionTopic').value.trim();

            try {
                const response = await api.post('/pomodoro', {
                    duration: Math.ceil(totalTime / 60),
                    topic: topic,
                    session_type: sessionType
                });

                currentSessionId = response.session_id;
                isRunning = true;
                isPaused = false;

                updateButtons();
                runTimer();

            } catch (error) {
                showToast('Failed to start session', 'danger');
            }
        }

        function pauseTimer() {
            if (!isRunning || isPaused) return;

            isPaused = true;
            updateButtons();
        }

        function resumeTimer() {
            if (!isRunning || !isPaused) return;

            isPaused = false;
            updateButtons();
            runTimer();
        }

        async function stopTimer() {
            if (!isRunning) return;

            isRunning = false;
            isPaused = false;

            if (currentSessionId) {
                try {
                    await api.post(`/pomodoro/${currentSessionId}/complete`);
                    showToast('Session saved!', 'success');
                } catch (error) {
                    console.error('Failed to save session:', error);
                }
            }

            // Reset timer
            const checkedRadio = document.querySelector('input[name="sessionType"]:checked');
            timeLeft = parseInt(checkedRadio.value) * 60;
            totalTime = timeLeft;

            updateTimerDisplay();
            updateProgress();
            updateButtons();

            loadTodayStats();
            loadRecentSessions();
        }

        function runTimer() {
            if (!isRunning || isPaused) return;

            timer = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    completeSession();
                    return;
                }

                if (!isPaused) {
                    timeLeft--;
                    updateTimerDisplay();
                    updateProgress();
                }
            }, 1000);
        }

        async function completeSession() {
            playNotificationSound();

            if (currentSessionId) {
                try {
                    await api.post(`/pomodoro/${currentSessionId}/complete`);

                    if (sessionType === 'study') {
                        showAchievement('Pomodoro Complete!', 'Great job staying focused!');
                    } else {
                        showToast('Break time is over!', 'info');
                    }
                } catch (error) {
                    console.error('Failed to complete session:', error);
                }
            }

            isRunning = false;
            isPaused = false;

            // Auto-switch to next session type
            if (sessionType === 'study') {
                document.getElementById('shortBreak').checked = true;
                document.getElementById('shortBreak').dispatchEvent(new Event('change'));
            } else {
                document.getElementById('pomodoroSession').checked = true;
                document.getElementById('pomodoroSession').dispatchEvent(new Event('change'));
            }

            updateButtons();
            loadTodayStats();
            loadRecentSessions();

            // Show notification
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('Pomodoro Timer', {
                    body: sessionType === 'study' ? 'Time for a break!' : 'Break is over, time to focus!',
                    icon: '/favicon.ico'
                });
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateProgress() {
            const progress = ((totalTime - timeLeft) / totalTime) * 754;
            document.getElementById('timerProgress').style.strokeDashoffset = progress;
        }

        function updateButtons() {
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const resumeBtn = document.getElementById('resumeBtn');
            const stopBtn = document.getElementById('stopBtn');

            if (isRunning) {
                startBtn.classList.add('d-none');
                stopBtn.classList.remove('d-none');

                if (isPaused) {
                    pauseBtn.classList.add('d-none');
                    resumeBtn.classList.remove('d-none');
                } else {
                    pauseBtn.classList.remove('d-none');
                    resumeBtn.classList.add('d-none');
                }
            } else {
                startBtn.classList.remove('d-none');
                pauseBtn.classList.add('d-none');
                resumeBtn.classList.add('d-none');
                stopBtn.classList.add('d-none');
            }
        }

        async function loadTodayStats() {
            try {
                const data = await api.get('/pomodoro/history?per_page=100');

                const today = new Date().toDateString();
                const todaySessions = data.sessions.filter(s => {
                    return new Date(s.start_time).toDateString() === today && s.completed;
                });

                const studySessions = todaySessions.filter(s => s.session_type === 'study');
                const totalMinutes = studySessions.reduce((sum, s) => sum + s.duration, 0);

                document.getElementById('todaySessions').textContent = studySessions.length;
                document.getElementById('todayFocusTime').textContent = formatTime(totalMinutes);

            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadRecentSessions() {
            try {
                const data = await api.get('/pomodoro/history?per_page=5');
                const container = document.getElementById('recentSessions');

                if (data.sessions.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center">No sessions yet today</p>';
                    return;
                }

                container.innerHTML = data.sessions.map(session => `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <h6 class="mb-0 small">${session.topic || 'Untitled Session'}</h6>
                            <small class="text-muted">
                                ${new Date(session.start_time).toLocaleTimeString()} - 
                                ${session.duration} minutes
                            </small>
                        </div>
                        <span class="badge bg-${session.session_type === 'study' ? 'primary' : 'success'}">
                            ${session.session_type}
                        </span>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Failed to load recent sessions:', error);
            }
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Prevent accidental page close during active session
        window.addEventListener('beforeunload', function (e) {
            if (isRunning) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
</body>

</html>