<div class="container-fluid p-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="h3 fw-bold mb-1">
                        <i class="fas fa-clock text-danger me-2"></i>
                        Pomodoro Timer
                    </h1>
                    <p class="text-muted mb-0">Focus on your studies with structured time blocks</p>
                </div>
                <div class="d-flex gap-2 mt-3 mt-lg-0">
                    <button class="btn btn-outline-primary" id="stats-btn">
                        <i class="fas fa-chart-bar me-2"></i>View Stats
                    </button>
                    <button class="btn btn-outline-secondary" id="settings-btn">
                        <i class="fas fa-cog me-2"></i>Settings
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Timer Section -->
    <div class="row justify-content-center mb-5">
        <div class="col-lg-8">
            <div class="card shadow-lg border-0 timer-card">
                <div class="card-body p-5 text-center">
                    <!-- Session Type -->
                    <div class="mb-4">
                        <h4 class="fw-bold mb-3" id="session-type">Study Session</h4>
                        <div class="btn-group" role="group" id="session-selector">
                            <input type="radio" class="btn-check" name="session-type" id="study-session" value="study"
                                checked>
                            <label class="btn btn-outline-primary" for="study-session">
                                <i class="fas fa-book me-2"></i>Study (25min)
                            </label>

                            <input type="radio" class="btn-check" name="session-type" id="short-break"
                                value="short_break">
                            <label class="btn btn-outline-success" for="short-break">
                                <i class="fas fa-coffee me-2"></i>Short Break (5min)
                            </label>

                            <input type="radio" class="btn-check" name="session-type" id="long-break"
                                value="long_break">
                            <label class="btn btn-outline-info" for="long-break">
                                <i class="fas fa-couch me-2"></i>Long Break (15min)
                            </label>
                        </div>
                    </div>

                    <!-- Timer Display -->
                    <div class="timer-display mb-4">
                        <div class="position-relative d-inline-block">
                            <svg class="timer-circle" width="300" height="300">
                                <circle cx="150" cy="150" r="140" fill="none" stroke="#e5e7eb" stroke-width="8" />
                                <circle id="timer-progress" cx="150" cy="150" r="140" fill="none" stroke="#3b82f6"
                                    stroke-width="8" stroke-linecap="round" stroke-dasharray="879.64"
                                    stroke-dashoffset="879.64" transform="rotate(-90 150 150)"
                                    class="transition-all duration-1000" />
                            </svg>
                            <div class="position-absolute top-50 start-50 translate-middle text-center">
                                <div class="timer-time display-1 fw-bold" id="timer-display">25:00</div>
                                <div class="timer-label text-muted mt-2" id="timer-status">Ready to start</div>
                            </div>
                        </div>
                    </div>

                    <!-- Topic Input -->
                    <div class="mb-4">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text">
                                <i class="fas fa-tag"></i>
                            </span>
                            <input type="text" class="form-control" id="session-topic"
                                placeholder="What are you studying? (Optional)" maxlength="100">
                        </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="d-flex justify-content-center gap-3 mb-4">
                        <button class="btn btn-primary btn-lg px-4" id="start-pause-btn">
                            <i class="fas fa-play me-2"></i>Start
                        </button>
                        <button class="btn btn-outline-secondary btn-lg px-4" id="reset-btn" disabled>
                            <i class="fas fa-redo me-2"></i>Reset
                        </button>
                        <button class="btn btn-outline-danger btn-lg px-4" id="stop-btn" disabled>
                            <i class="fas fa-stop me-2"></i>Stop
                        </button>
                    </div>

                    <!-- Session Progress -->
                    <div class="session-progress" id="session-progress" style="display: none;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small text-muted">Session Progress</span>
                            <span class="small text-muted" id="session-count">Session 1 of 4</span>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-success" id="session-progress-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Sessions -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-history me-2"></i>Recent Sessions
                    </h5>
                    <button class="btn btn-sm btn-outline-primary" id="view-all-sessions">
                        View All
                    </button>
                </div>
                <div class="card-body">
                    <div id="recent-sessions">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Today's Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div id="daily-stats">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Timer Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Timer Settings</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="settings-form">
                    <div class="mb-3">
                        <label for="study-duration" class="form-label">Study Duration (minutes)</label>
                        <input type="number" class="form-control" id="study-duration" min="1" max="60" value="25">
                    </div>
                    <div class="mb-3">
                        <label for="short-break-duration" class="form-label">Short Break (minutes)</label>
                        <input type="number" class="form-control" id="short-break-duration" min="1" max="30" value="5">
                    </div>
                    <div class="mb-3">
                        <label for="long-break-duration" class="form-label">Long Break (minutes)</label>
                        <input type="number" class="form-control" id="long-break-duration" min="1" max="60" value="15">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="auto-start-breaks" checked>
                            <label class="form-check-label" for="auto-start-breaks">
                                Auto-start breaks
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="play-sounds" checked>
                            <label class="form-check-label" for="play-sounds">
                                Play notification sounds
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-settings-btn">Save Settings</button>
            </div>
        </div>
    </div>
</div>

<!-- Session Complete Modal -->
<div class="modal fade" id="sessionCompleteModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ðŸŽ‰ Session Complete!</h5>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-check-circle text-success fa-4x mb-3"></i>
                    <h4 id="completion-message">Great work!</h4>
                    <p class="text-muted" id="completion-details">You completed a 25-minute study session.</p>
                </div>

                <div class="mb-4">
                    <h6>Session Summary</h6>
                    <div class="row g-3 text-center">
                        <div class="col-4">
                            <div class="small text-muted">Duration</div>
                            <div class="fw-bold" id="summary-duration">25:00</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">Topic</div>
                            <div class="fw-bold" id="summary-topic">Study Session</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">Sessions Today</div>
                            <div class="fw-bold" id="summary-sessions">1</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="start-next-session">Start Next Session</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        let currentTimer = null;
        let isRunning = false;
        let timeRemaining = 25 * 60; // 25 minutes in seconds
        let currentSessionType = 'study';
        let sessionSettings = {
            study: 25,
            short_break: 5,
            long_break: 15,
            autoStartBreaks: true,
            playSounds: true
        };
        let currentSessionId = null;
        let completedSessions = 0;
        let timerWorker = null;

        // Initialize
        await loadSettings();
        await loadRecentSessions();
        await loadDailyStats();
        setupEventListeners();
        checkForRestoredSession();

        function setupEventListeners() {
            // Session type selector
            document.querySelectorAll('input[name="session-type"]').forEach(radio => {
                radio.addEventListener('change', function () {
                    if (!isRunning) {
                        currentSessionType = this.value;
                        updateTimerForSessionType();
                    }
                });
            });

            // Control buttons
            document.getElementById('start-pause-btn').addEventListener('click', toggleTimer);
            document.getElementById('reset-btn').addEventListener('click', resetTimer);
            document.getElementById('stop-btn').addEventListener('click', stopTimer);

            // Modal buttons
            document.getElementById('settings-btn').addEventListener('click', openSettings);
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
            document.getElementById('start-next-session').addEventListener('click', startNextSession);

            // Close session complete modal
            document.getElementById('sessionCompleteModal').addEventListener('hidden.bs.modal', function () {
                suggestNextSession();
            });
        }

        function updateTimerForSessionType() {
            const durations = {
                study: sessionSettings.study,
                short_break: sessionSettings.short_break,
                long_break: sessionSettings.long_break
            };

            timeRemaining = durations[currentSessionType] * 60;
            updateTimerDisplay();
            updateSessionTypeDisplay();
        }

        function updateSessionTypeDisplay() {
            const typeLabels = {
                study: 'Study Session',
                short_break: 'Short Break',
                long_break: 'Long Break'
            };

            document.getElementById('session-type').textContent = typeLabels[currentSessionType];

            // Update timer circle color
            const colors = {
                study: '#3b82f6',
                short_break: '#10b981',
                long_break: '#06b6d4'
            };

            document.getElementById('timer-progress').style.stroke = colors[currentSessionType];
        }

        async function toggleTimer() {
            if (isRunning) {
                pauseTimer();
            } else {
                await startTimer();
            }
        }

        async function startTimer() {
            try {
                const topic = document.getElementById('session-topic').value.trim();

                if (!currentSessionId) {
                    // Start new session
                    const response = await ApiMethods.pomodoro.start({
                        duration: Math.ceil(timeRemaining / 60),
                        topic: topic || null,
                        session_type: currentSessionType
                    });

                    currentSessionId = response.session_id;
                }

                isRunning = true;
                updateControlButtons();

                // Start timer worker
                if (!timerWorker) {
                    timerWorker = new Worker('/js/timer-worker.js');
                    timerWorker.onmessage = handleTimerMessage;
                }

                timerWorker.postMessage({
                    action: 'start',
                    duration: Math.ceil(timeRemaining / 60)
                });

                // Save timer state
                Storage.timer.setTimerState({
                    sessionId: currentSessionId,
                    startTime: Date.now(),
                    duration: timeRemaining,
                    sessionType: currentSessionType,
                    topic: topic,
                    isRunning: true
                });

                document.getElementById('timer-status').textContent = 'Focus time!';

            } catch (error) {
                console.error('Failed to start timer:', error);
                Notifications.error('Failed to start timer session');
            }
        }

        function pauseTimer() {
            isRunning = false;

            if (timerWorker) {
                timerWorker.postMessage({ action: 'pause' });
            }

            updateControlButtons();
            document.getElementById('timer-status').textContent = 'Paused';

            // Update stored state
            const state = Storage.timer.getTimerState();
            if (state) {
                state.isRunning = false;
                Storage.timer.setTimerState(state);
            }
        }

        async function resetTimer() {
            if (timerWorker) {
                timerWorker.postMessage({ action: 'stop' });
            }

            isRunning = false;
            currentSessionId = null;
            updateTimerForSessionType();
            updateControlButtons();
            document.getElementById('timer-status').textContent = 'Ready to start';
            document.getElementById('session-progress').style.display = 'none';

            // Clear stored state
            Storage.timer.clearTimerState();
        }

        async function stopTimer() {
            try {
                if (currentSessionId) {
                    await ApiMethods.pomodoro.complete(currentSessionId);
                }

                await resetTimer();
                await loadRecentSessions();
                await loadDailyStats();

            } catch (error) {
                console.error('Failed to stop timer:', error);
                Notifications.error('Failed to stop timer session');
            }
        }

        function handleTimerMessage(event) {
            const { type, remaining, elapsed } = event.data;

            switch (type) {
                case 'tick':
                    timeRemaining = remaining;
                    updateTimerDisplay();
                    updateProgress();
                    break;

                case 'complete':
                    completeSession();
                    break;
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            const display = `${minutes}:${seconds.toString().padStart(2, '0')}`;

            document.getElementById('timer-display').textContent = display;

            // Update page title
            if (isRunning) {
                document.title = `${display} - ${currentSessionType} - DSA Path`;
            } else {
                document.title = 'Pomodoro Timer - DSA Path';
            }
        }

        function updateProgress() {
            const totalDuration = sessionSettings[currentSessionType] * 60;
            const progress = ((totalDuration - timeRemaining) / totalDuration) * 100;
            const circumference = 879.64; // 2 * Ï€ * r (140)
            const offset = circumference - (progress / 100) * circumference;

            document.getElementById('timer-progress').style.strokeDashoffset = offset;
        }

        function updateControlButtons() {
            const startPauseBtn = document.getElementById('start-pause-btn');
            const resetBtn = document.getElementById('reset-btn');
            const stopBtn = document.getElementById('stop-btn');

            if (isRunning) {
                startPauseBtn.innerHTML = '<i class="fas fa-pause me-2"></i>Pause';
                startPauseBtn.className = 'btn btn-warning btn-lg px-4';
            } else {
                startPauseBtn.innerHTML = '<i class="fas fa-play me-2"></i>Start';
                startPauseBtn.className = 'btn btn-primary btn-lg px-4';
            }

            resetBtn.disabled = !currentSessionId && timeRemaining === sessionSettings[currentSessionType] * 60;
            stopBtn.disabled = !currentSessionId;
        }

        async function completeSession() {
            try {
                isRunning = false;

                if (currentSessionId) {
                    await ApiMethods.pomodoro.complete(currentSessionId);
                }

                completedSessions++;

                // Play completion sound
                if (sessionSettings.playSounds && typeof Lib !== 'undefined' && Lib.audio) {
                    Lib.audio.play('timerComplete');
                }

                // Show completion modal
                showSessionCompleteModal();

                // Update UI
                await loadRecentSessions();
                await loadDailyStats();

                // Clear timer state
                Storage.timer.clearTimerState();
                currentSessionId = null;

            } catch (error) {
                console.error('Failed to complete session:', error);
                Notifications.error('Failed to complete session');
            }
        }

        function showSessionCompleteModal() {
            const modal = new bootstrap.Modal(document.getElementById('sessionCompleteModal'));

            const messages = {
                study: 'Excellent focus! Time for a well-deserved break.',
                short_break: 'Break time over! Ready to get back to work?',
                long_break: 'Long break complete! You\'re refreshed and ready to continue.'
            };

            const topic = document.getElementById('session-topic').value.trim();
            const duration = sessionSettings[currentSessionType];

            document.getElementById('completion-message').textContent = messages[currentSessionType];
            document.getElementById('completion-details').textContent =
                `You completed a ${duration}-minute ${currentSessionType.replace('_', ' ')} session.`;
            document.getElementById('summary-duration').textContent = `${duration}:00`;
            document.getElementById('summary-topic').textContent = topic || 'General Study';
            document.getElementById('summary-sessions').textContent = completedSessions;

            modal.show();
        }

        function startNextSession() {
            const modal = bootstrap.Modal.getInstance(document.getElementById('sessionCompleteModal'));
            modal.hide();

            // Auto-suggest next session type
            suggestNextSession();
        }

        function suggestNextSession() {
            if (currentSessionType === 'study') {
                // After study, suggest break
                const breakType = completedSessions % 4 === 0 ? 'long_break' : 'short_break';
                document.getElementById(breakType).checked = true;
                currentSessionType = breakType;
            } else {
                // After break, suggest study
                document.getElementById('study-session').checked = true;
                currentSessionType = 'study';
            }

            updateTimerForSessionType();

            if (sessionSettings.autoStartBreaks && currentSessionType !== 'study') {
                setTimeout(() => {
                    startTimer();
                }, 2000);
            }
        }

        function checkForRestoredSession() {
            const savedState = Storage.timer.getTimerState();
            if (!savedState) return;

            const { sessionId, startTime, duration, sessionType, topic, isRunning } = savedState;
            const elapsed = Math.floor((Date.now() - startTime) / 1000);

            if (elapsed < duration) {
                // Restore session
                currentSessionId = sessionId;
                currentSessionType = sessionType;
                timeRemaining = duration - elapsed;

                document.getElementById('session-topic').value = topic || '';
                document.querySelector(`input[value="${sessionType}"]`).checked = true;

                updateTimerForSessionType();
                updateTimerDisplay();

                if (isRunning) {
                    Notifications.info('Restored your previous timer session');
                    // Auto-resume if it was running
                    setTimeout(() => {
                        startTimer();
                    }, 1000);
                }
            } else {
                // Session would have completed
                Storage.timer.clearTimerState();
            }
        }

        async function loadRecentSessions() {
            try {
                const response = await ApiMethods.pomodoro.getHistory(1, 10);
                const sessions = response.sessions || [];

                const container = document.getElementById('recent-sessions');

                if (sessions.length === 0) {
                    container.innerHTML = `
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-clock fa-2x mb-2"></i>
                        <p class="mb-0">No sessions yet. Start your first pomodoro!</p>
                    </div>
                `;
                    return;
                }

                container.innerHTML = sessions.map(session => `
                <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-${session.completed ? 'check-circle text-success' : 'clock text-warning'} me-2"></i>
                            <div>
                                <div class="fw-medium">${session.topic || 'Study Session'}</div>
                                <small class="text-muted">${Utils.date.relative(session.start_time)}</small>
                            </div>
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-${session.completed ? 'success' : 'warning'}">
                            ${session.duration}min
                        </span>
                    </div>
                </div>
            `).join('');

            } catch (error) {
                console.error('Failed to load recent sessions:', error);
            }
        }

        async function loadDailyStats() {
            try {
                // Calculate today's stats from recent sessions
                const today = new Date().toDateString();
                const response = await ApiMethods.pomodoro.getHistory(1, 50);
                const allSessions = response.sessions || [];

                const todaySessions = allSessions.filter(session =>
                    new Date(session.start_time).toDateString() === today && session.completed
                );

                const totalTime = todaySessions.reduce((sum, session) => sum + session.duration, 0);
                const studySessions = todaySessions.filter(s => s.session_type === 'study').length;
                const avgSession = todaySessions.length > 0 ? Math.round(totalTime / todaySessions.length) : 0;

                document.getElementById('daily-stats').innerHTML = `
                <div class="row g-3 text-center">
                    <div class="col-12">
                        <div class="border-bottom pb-2 mb-3">
                            <div class="h4 fw-bold text-primary">${Utils.time.formatDuration(totalTime * 60)}</div>
                            <small class="text-muted">Total Focus Time</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="h5 fw-bold">${studySessions}</div>
                        <small class="text-muted">Study Sessions</small>
                    </div>
                    <div class="col-6">
                        <div class="h5 fw-bold">${avgSession}min</div>
                        <small class="text-muted">Avg Session</small>
                    </div>
                </div>
                
                <div class="mt-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="text-muted">Daily Goal</small>
                        <small class="text-muted">${Math.min(Math.round((totalTime / 120) * 100), 100)}%</small>
                    </div>
                    <div class="progress" style="height: 6px;">
                        <div class="progress-bar" style="width: ${Math.min((totalTime / 120) * 100, 100)}%"></div>
                    </div>
                    <small class="text-muted">Target: 2 hours daily</small>
                </div>
            `;

            } catch (error) {
                console.error('Failed to load daily stats:', error);
            }
        }

        function openSettings() {
            // Populate current settings
            document.getElementById('study-duration').value = sessionSettings.study;
            document.getElementById('short-break-duration').value = sessionSettings.short_break;
            document.getElementById('long-break-duration').value = sessionSettings.long_break;
            document.getElementById('auto-start-breaks').checked = sessionSettings.autoStartBreaks;
            document.getElementById('play-sounds').checked = sessionSettings.playSounds;

            const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
            modal.show();
        }

        function saveSettings() {
            sessionSettings = {
                study: parseInt(document.getElementById('study-duration').value),
                short_break: parseInt(document.getElementById('short-break-duration').value),
                long_break: parseInt(document.getElementById('long-break-duration').value),
                autoStartBreaks: document.getElementById('auto-start-breaks').checked,
                playSounds: document.getElementById('play-sounds').checked
            };

            // Save to storage
            Storage.setItem('pomodoro_settings', sessionSettings);

            // Update current timer if not running
            if (!isRunning) {
                updateTimerForSessionType();
            }

            // Update session selector labels
            document.querySelector('label[for="study-session"]').innerHTML =
                `<i class="fas fa-book me-2"></i>Study (${sessionSettings.study}min)`;
            document.querySelector('label[for="short-break"]').innerHTML =
                `<i class="fas fa-coffee me-2"></i>Short Break (${sessionSettings.short_break}min)`;
            document.querySelector('label[for="long-break"]').innerHTML =
                `<i class="fas fa-couch me-2"></i>Long Break (${sessionSettings.long_break}min)`;

            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            Notifications.success('Settings saved successfully');
        }

        function loadSettings() {
            const saved = Storage.getItem('pomodoro_settings');
            if (saved) {
                sessionSettings = { ...sessionSettings, ...saved };
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function () {
            if (timerWorker) {
                timerWorker.terminate();
            }
        });
    });
</script>