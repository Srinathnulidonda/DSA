<!-- pages/pomodoro.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro Timer - DSA Learning Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">
    <link href="/css/components.css" rel="stylesheet">
    <link href="/css/animation.css" rel="stylesheet">
    <link href="/css/responsive.css" rel="stylesheet">
</head>

<body class="bg-gray-50">
    <!-- Sidebar -->
    <div id="sidebarContainer"></div>

    <!-- Topbar -->
    <div id="topbarContainer"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container-fluid">
            <!-- Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <h1 class="h3 mb-3">Pomodoro Timer</h1>
                    <p class="text-muted">Stay focused and productive with the Pomodoro Technique</p>
                </div>
            </div>

            <!-- Timer Section -->
            <div class="row justify-content-center mb-4">
                <div class="col-12 col-lg-8">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <!-- Timer Display -->
                            <div class="study-timer">
                                <div class="timer-ring mx-auto">
                                    <svg width="200" height="200">
                                        <circle cx="100" cy="100" r="90" class="timer-ring-circle"></circle>
                                        <circle cx="100" cy="100" r="90" class="timer-ring-progress"
                                            stroke-dasharray="565.48" stroke-dashoffset="0"></circle>
                                    </svg>
                                    <div class="position-absolute top-50 start-50 translate-middle">
                                        <div class="timer-display" id="timerDisplay">25:00</div>
                                    </div>
                                </div>

                                <!-- Session Info -->
                                <div class="mt-4 mb-4">
                                    <h4 id="sessionType" class="mb-2">Study Session</h4>
                                    <div class="d-flex justify-content-center gap-3 text-muted">
                                        <span>Session <span id="sessionCount">1</span></span>
                                        <span>â€¢</span>
                                        <span>Today: <span id="todayMinutes">0</span> min</span>
                                    </div>
                                </div>

                                <!-- Timer Controls -->
                                <div class="timer-controls">
                                    <button class="btn btn-primary btn-lg" id="startBtn" onclick="startTimer()">
                                        <i class="fas fa-play me-2"></i> Start
                                    </button>
                                    <button class="btn btn-warning btn-lg d-none" id="pauseBtn" onclick="pauseTimer()">
                                        <i class="fas fa-pause me-2"></i> Pause
                                    </button>
                                    <button class="btn btn-success btn-lg d-none" id="resumeBtn"
                                        onclick="resumeTimer()">
                                        <i class="fas fa-play me-2"></i> Resume
                                    </button>
                                    <button class="btn btn-danger btn-lg" onclick="resetTimer()">
                                        <i class="fas fa-redo me-2"></i> Reset
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings -->
            <div class="row justify-content-center mb-4">
                <div class="col-12 col-lg-8">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Timer Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Study Duration (minutes)</label>
                                    <input type="number" class="form-control" id="studyDuration" value="25" min="1"
                                        max="60" onchange="updateSettings()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Short Break (minutes)</label>
                                    <input type="number" class="form-control" id="shortBreak" value="5" min="1" max="30"
                                        onchange="updateSettings()">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Long Break (minutes)</label>
                                    <input type="number" class="form-control" id="longBreak" value="15" min="5" max="60"
                                        onchange="updateSettings()">
                                </div>
                                <div class="col-12">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="autoStart" checked>
                                        <label class="form-check-label" for="autoStart">
                                            Auto-start next session
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="notifications" checked>
                                        <label class="form-check-label" for="notifications">
                                            Enable notifications
                                        </label>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="soundEnabled" checked>
                                        <label class="form-check-label" for="soundEnabled">
                                            Play sound when timer ends
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Today's Sessions -->
            <div class="row justify-content-center">
                <div class="col-12 col-lg-8">
                    <div class="card">
                        <div class="card-header bg-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Today's Sessions</h5>
                            <button class="btn btn-sm btn-outline-primary" onclick="loadSessionHistory()">
                                View All History
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="todaySessions">
                                <div class="text-center py-4 text-muted">
                                    <i class="fas fa-clock fa-3x mb-3 opacity-25"></i>
                                    <p>No sessions yet today. Start your first session!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Mobile Navigation -->
    <div id="mobileNavContainer"></div>

    <!-- Session Complete Modal -->
    <div class="modal fade" id="sessionCompleteModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                    <h4 id="sessionCompleteTitle">Session Complete!</h4>
                    <p id="sessionCompleteMessage">Great job! Take a break.</p>
                    <button class="btn btn-primary" onclick="startNextSession()">
                        Start Next Session
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Audio for notifications -->
    <audio id="notificationSound" preload="auto">
        <source
            src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhCBSBzvLZiTYIF2m98OScTgwOUarm7blmFgU7k9n1yXkn"
            type="audio/wav">
    </audio>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/components.js"></script>
    <script>
        const API_BASE = 'https://dsa-backend-gj8n.onrender.com';

        // Timer state
        let timerInterval = null;
        let currentTime = 25 * 60; // 25 minutes in seconds
        let isRunning = false;
        let isPaused = false;
        let sessionType = 'study'; // study, shortBreak, longBreak
        let sessionCount = 1;
        let currentSessionId = null;
        let todayMinutes = 0;
        let todaySessions = [];

        // Timer settings
        let settings = {
            studyDuration: 25,
            shortBreak: 5,
            longBreak: 15,
            autoStart: true,
            notifications: true,
            soundEnabled: true
        };

        // Initialize
        async function initPomodoro() {
            await loadComponents();
            loadSettings();
            loadTodaySessions();
            requestNotificationPermission();
            updateDisplay();
        }

        // Load settings from localStorage
        function loadSettings() {
            const saved = localStorage.getItem('pomodoroSettings');
            if (saved) {
                settings = JSON.parse(saved);
                document.getElementById('studyDuration').value = settings.studyDuration;
                document.getElementById('shortBreak').value = settings.shortBreak;
                document.getElementById('longBreak').value = settings.longBreak;
                document.getElementById('autoStart').checked = settings.autoStart;
                document.getElementById('notifications').checked = settings.notifications;
                document.getElementById('soundEnabled').checked = settings.soundEnabled;
            }
        }

        // Update settings
        function updateSettings() {
            settings = {
                studyDuration: parseInt(document.getElementById('studyDuration').value),
                shortBreak: parseInt(document.getElementById('shortBreak').value),
                longBreak: parseInt(document.getElementById('longBreak').value),
                autoStart: document.getElementById('autoStart').checked,
                notifications: document.getElementById('notifications').checked,
                soundEnabled: document.getElementById('soundEnabled').checked
            };
            localStorage.setItem('pomodoroSettings', JSON.stringify(settings));

            // Update current time if timer is not running
            if (!isRunning && !isPaused) {
                if (sessionType === 'study') {
                    currentTime = settings.studyDuration * 60;
                } else if (sessionType === 'shortBreak') {
                    currentTime = settings.shortBreak * 60;
                } else {
                    currentTime = settings.longBreak * 60;
                }
                updateDisplay();
            }
        }

        // Start timer
        async function startTimer() {
            if (isRunning) return;

            isRunning = true;
            isPaused = false;

            // Start session in backend
            const token = localStorage.getItem('access_token');
            if (token) {
                try {
                    const response = await fetch(`${API_BASE}/pomodoro`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            duration: Math.ceil(currentTime / 60),
                            session_type: sessionType,
                            topic: document.getElementById('sessionType').textContent
                        })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        currentSessionId = data.session_id;
                    }
                } catch (error) {
                    console.error('Failed to start session:', error);
                }
            }

            // Update UI
            document.getElementById('startBtn').classList.add('d-none');
            document.getElementById('pauseBtn').classList.remove('d-none');

            // Start countdown
            timerInterval = setInterval(() => {
                currentTime--;
                updateDisplay();

                if (currentTime <= 0) {
                    completeSession();
                }
            }, 1000);
        }

        // Pause timer
        function pauseTimer() {
            if (!isRunning) return;

            isPaused = true;
            clearInterval(timerInterval);

            document.getElementById('pauseBtn').classList.add('d-none');
            document.getElementById('resumeBtn').classList.remove('d-none');
        }

        // Resume timer
        function resumeTimer() {
            if (!isPaused) return;

            isPaused = false;

            document.getElementById('resumeBtn').classList.add('d-none');
            document.getElementById('pauseBtn').classList.remove('d-none');

            timerInterval = setInterval(() => {
                currentTime--;
                updateDisplay();

                if (currentTime <= 0) {
                    completeSession();
                }
            }, 1000);
        }

        // Reset timer
        function resetTimer() {
            clearInterval(timerInterval);
            isRunning = false;
            isPaused = false;

            // Reset to current session type duration
            if (sessionType === 'study') {
                currentTime = settings.studyDuration * 60;
            } else if (sessionType === 'shortBreak') {
                currentTime = settings.shortBreak * 60;
            } else {
                currentTime = settings.longBreak * 60;
            }

            // Update UI
            document.getElementById('startBtn').classList.remove('d-none');
            document.getElementById('pauseBtn').classList.add('d-none');
            document.getElementById('resumeBtn').classList.add('d-none');

            updateDisplay();
        }

        // Complete session
        async function completeSession() {
            clearInterval(timerInterval);
            isRunning = false;

            // Complete session in backend
            if (currentSessionId) {
                const token = localStorage.getItem('access_token');
                if (token) {
                    try {
                        await fetch(`${API_BASE}/pomodoro/${currentSessionId}/complete`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                    } catch (error) {
                        console.error('Failed to complete session:', error);
                    }
                }
            }

            // Update stats
            if (sessionType === 'study') {
                todayMinutes += settings.studyDuration;
                document.getElementById('todayMinutes').textContent = todayMinutes;
            }

            // Play sound
            if (settings.soundEnabled) {
                document.getElementById('notificationSound').play();
            }

            // Show notification
            if (settings.notifications) {
                showNotification();
            }

            // Show completion modal
            showCompletionModal();

            // Update sessions list
            loadTodaySessions();
        }

        // Update display
        function updateDisplay() {
            const minutes = Math.floor(currentTime / 60);
            const seconds = currentTime % 60;
            document.getElementById('timerDisplay').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            // Update progress ring
            const totalTime = sessionType === 'study' ? settings.studyDuration * 60 :
                sessionType === 'shortBreak' ? settings.shortBreak * 60 :
                    settings.longBreak * 60;
            const progress = (totalTime - currentTime) / totalTime;
            const circumference = 2 * Math.PI * 90;
            const offset = circumference - (progress * circumference);

            document.querySelector('.timer-ring-progress').style.strokeDashoffset = offset;
        }

        // Show completion modal
        function showCompletionModal() {
            let title, message;

            if (sessionType === 'study') {
                title = 'Study Session Complete!';
                message = sessionCount % 4 === 0 ?
                    'Great work! Time for a long break.' :
                    'Well done! Take a short break.';
            } else {
                title = 'Break Complete!';
                message = 'Ready to get back to studying?';
            }

            document.getElementById('sessionCompleteTitle').textContent = title;
            document.getElementById('sessionCompleteMessage').textContent = message;

            const modal = new bootstrap.Modal(document.getElementById('sessionCompleteModal'));
            modal.show();

            // Auto-start next session if enabled
            if (settings.autoStart) {
                setTimeout(() => {
                    modal.hide();
                    startNextSession();
                }, 5000);
            }
        }

        // Start next session
        function startNextSession() {
            // Determine next session type
            if (sessionType === 'study') {
                if (sessionCount % 4 === 0) {
                    sessionType = 'longBreak';
                    document.getElementById('sessionType').textContent = 'Long Break';
                } else {
                    sessionType = 'shortBreak';
                    document.getElementById('sessionType').textContent = 'Short Break';
                }
            } else {
                sessionType = 'study';
                document.getElementById('sessionType').textContent = 'Study Session';
                if (sessionType === 'longBreak') {
                    sessionCount = 1;
                } else {
                    sessionCount++;
                }
                document.getElementById('sessionCount').textContent = sessionCount;
            }

            // Reset timer
            resetTimer();

            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('sessionCompleteModal'));
            if (modal) modal.hide();

            // Auto-start if enabled
            if (settings.autoStart) {
                startTimer();
            }
        }

        // Load today's sessions
        async function loadTodaySessions() {
            const token = localStorage.getItem('access_token');
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE}/pomodoro/history?per_page=20`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const today = new Date().toDateString();

                    todaySessions = data.sessions.filter(session =>
                        new Date(session.start_time).toDateString() === today
                    );

                    // Calculate today's total minutes
                    todayMinutes = todaySessions
                        .filter(s => s.completed && s.session_type === 'study')
                        .reduce((total, s) => total + s.duration, 0);

                    document.getElementById('todayMinutes').textContent = todayMinutes;

                    renderTodaySessions();
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }

        // Render today's sessions
        function renderTodaySessions() {
            const container = document.getElementById('todaySessions');

            if (todaySessions.length === 0) {
                return;
            }

            container.innerHTML = `
                <div class="list-group">
                    ${todaySessions.map(session => {
                const startTime = new Date(session.start_time);
                const typeIcon = session.session_type === 'study' ? 'book' : 'coffee';
                const typeBadge = session.session_type === 'study' ? 'primary' : 'success';

                return `
                            <div class="list-group-item border-0 px-0">
                                <div class="d-flex align-items-center">
                                                                        <div class="stat-icon bg-${typeBadge} text-white me-3" style="width: 40px; height: 40px;">
                                        <i class="fas fa-${typeIcon}"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">${session.topic || (session.session_type === 'study' ? 'Study Session' : 'Break')}</h6>
                                        <small class="text-muted">
                                            ${startTime.toLocaleTimeString()} - ${session.duration} minutes
                                        </small>
                                    </div>
                                    ${session.completed ?
                        '<span class="badge bg-success">Completed</span>' :
                        '<span class="badge bg-warning">Incomplete</span>'}
                                </div>
                            </div>
                        `;
            }).join('')}
                </div>
            `;
        }

        // Load session history
        function loadSessionHistory() {
            // Navigate to analytics page with pomodoro filter
            window.location.href = '/analytics#pomodoro';
        }

        // Request notification permission
        function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        // Show notification
        function showNotification() {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }

            const title = sessionType === 'study' ? 'Study Session Complete!' : 'Break Complete!';
            const body = sessionType === 'study' ?
                'Great job! Time for a break.' :
                'Break is over. Ready to continue?';

            new Notification(title, {
                body: body,
                icon: '/assets/icons/timer-icon.png',
                badge: '/assets/icons/timer-badge.png'
            });
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Space bar to start/pause
            if (e.code === 'Space' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                if (!isRunning) {
                    startTimer();
                } else if (!isPaused) {
                    pauseTimer();
                } else {
                    resumeTimer();
                }
            }

            // R to reset
            if (e.code === 'KeyR' && e.target.tagName !== 'INPUT') {
                e.preventDefault();
                resetTimer();
            }
        });

        // Prevent accidental page leave during active session
        window.addEventListener('beforeunload', (e) => {
            if (isRunning && !isPaused) {
                e.preventDefault();
                e.returnValue = '';
            }
        });

        // Initialize on load
        initPomodoro();
    </script>
</body>

</html>