<!-- pages/roadmap.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roadmap - DSA Learning Path</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/animation.css">
    <link rel="stylesheet" href="/css/responsive.css">
</head>

<body>
    <div class="main-wrapper">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Topbar -->
            <div id="topbar-container"></div>

            <!-- Roadmap Content -->
            <div class="container-fluid mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="h3 mb-0">14-Week DSA Roadmap</h1>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="collapseAll()">
                            <i class="fas fa-compress"></i> Collapse All
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="expandAll()">
                            <i class="fas fa-expand"></i> Expand All
                        </button>
                    </div>
                </div>

                <!-- Progress Overview -->
                <div class="card mb-4">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="card-title">Your Progress</h5>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-success" role="progressbar" id="overallProgress"
                                        style="width: 0%">0%</div>
                                </div>
                                <p class="text-muted mb-0">
                                    <span id="completedWeeks">0</span> of 14 weeks completed
                                </p>
                            </div>
                            <div class="col-md-4 text-center">
                                <div class="d-flex justify-content-center gap-3 mt-3 mt-md-0">
                                    <div>
                                        <h3 class="mb-0" id="totalCompleted">0</h3>
                                        <small class="text-muted">Days Completed</small>
                                    </div>
                                    <div>
                                        <h3 class="mb-0" id="totalRemaining">98</h3>
                                        <small class="text-muted">Days Remaining</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Roadmap Weeks -->
                <div id="roadmapContainer" data-accordion-group="roadmap">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading roadmap...</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Mobile Navigation -->
    <div id="mobile-nav-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/components.js"></script>
    <script src="/js/animation.js"></script>

    <script>
        // Load components
        fetch('/components/sidebar.html').then(r => r.text()).then(html => {
            document.getElementById('sidebar-container').innerHTML = html;
            initSidebar();
        });

        fetch('/components/topbar.html').then(r => r.text()).then(html => {
            document.getElementById('topbar-container').innerHTML = html;
        });

        fetch('/components/mobile-nav.html').then(r => r.text()).then(html => {
            document.getElementById('mobile-nav-container').innerHTML = html;
            initMobileNav();
        });

        // Roadmap functionality
        let roadmapData = [];
        let progressData = {};

        async function loadRoadmap() {
            try {
                const [roadmapResponse, progressResponse] = await Promise.all([
                    api.get('/roadmap'),
                    api.get('/progress')
                ]);

                roadmapData = roadmapResponse.roadmap;
                progressData = progressResponse.progress;

                renderRoadmap();
                updateOverallProgress();

            } catch (error) {
                console.error('Failed to load roadmap:', error);
                showToast('Failed to load roadmap', 'danger');
            }
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmapContainer');

            container.innerHTML = roadmapData.map(week => {
                const weekProgress = progressData[week.week] || {};
                const completedDays = Object.values(weekProgress).filter(d => d.completed).length;
                const totalDays = week.days.length;
                const weekPercentage = totalDays > 0 ? (completedDays / totalDays) * 100 : 0;

                return `
                    <div class="roadmap-week animate-fade-in">
                        <div class="roadmap-week-header ${weekPercentage === 100 ? 'bg-success text-white' : ''}" 
                             data-accordion onclick="toggleWeek(${week.week})">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h5 class="mb-1">
                                        Week ${week.week}: ${week.title}
                                        ${weekPercentage === 100 ? '<i class="fas fa-check-circle ms-2"></i>' : ''}
                                    </h5>
                                    <p class="mb-0 ${weekPercentage === 100 ? '' : 'text-muted'}">
                                        ${week.goal}
                                    </p>
                                </div>
                                <div class="text-end">
                                    <div class="mb-1">${completedDays}/${totalDays} days</div>
                                    <div class="progress" style="width: 100px; height: 8px;">
                                        <div class="progress-bar bg-${weekPercentage === 100 ? 'white' : 'success'}" 
                                             style="width: ${weekPercentage}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="roadmap-week-content accordion-content" id="week-${week.week}">
                            ${week.days.map(day => {
                    const dayProgress = weekProgress[day.day] || {};
                    const isCompleted = dayProgress.completed;

                    return `
                                    <div class="roadmap-day ${isCompleted ? 'completed' : ''}">
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <h6 class="mb-2">
                                                    ${day.day}: ${day.topic}
                                                    ${isCompleted ? '<i class="fas fa-check text-success ms-2"></i>' : ''}
                                                </h6>
                                                <p class="text-muted mb-2">${day.activities}</p>
                                                <div class="d-flex flex-wrap gap-2 mb-2">
                                                    ${day.resources.map(resourceId => {
                        const resource = getResourceById(resourceId);
                        if (!resource) return '';

                        return `
                                                            <a href="${resource.url}" target="_blank" 
                                                               class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-${getResourceIcon(resource.type)} me-1"></i>
                                                                ${resource.title}
                                                            </a>
                                                        `;
                    }).join('')}
                                                </div>
                                                <div class="d-flex align-items-center gap-3">
                                                    <small class="text-muted">
                                                        <i class="fas fa-clock me-1"></i>
                                                        ${day.time_estimate} mins
                                                    </small>
                                                    ${dayProgress.time_spent ? `
                                                        <small class="text-success">
                                                            <i class="fas fa-check-circle me-1"></i>
                                                            ${dayProgress.time_spent} mins completed
                                                        </small>
                                                    ` : ''}
                                                </div>
                                            </div>
                                            <div class="form-check ms-3">
                                                <input class="form-check-input progress-checkbox" 
                                                       type="checkbox" 
                                                       id="check-${week.week}-${day.day}"
                                                       ${isCompleted ? 'checked' : ''}
                                                       onchange="toggleDayCompletion(${week.week}, '${day.day}', this.checked)">
                                                <label class="form-check-label" for="check-${week.week}-${day.day}">
                                                    Mark Complete
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                `;
                }).join('')}
                            
                            ${week.project ? `
                                <div class="mt-4 p-3 bg-light rounded">
                                    <h6 class="mb-2">
                                        <i class="fas fa-project-diagram me-2"></i>
                                        Weekly Project: ${week.project.title}
                                    </h6>
                                    <p class="mb-2">${week.project.description}</p>
                                    <div class="d-flex flex-wrap gap-2">
                                        ${week.project.skills.map(skill =>
                    `<span class="badge bg-secondary">${skill}</span>`
                ).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // Initialize accordions after rendering
            initAccordions();
        }

        function updateOverallProgress() {
            let totalCompleted = 0;
            let totalDays = 0;
            let completedWeeks = 0;

            roadmapData.forEach(week => {
                const weekProgress = progressData[week.week] || {};
                const weekDays = week.days.length;
                const weekCompleted = Object.values(weekProgress).filter(d => d.completed).length;

                totalDays += weekDays;
                totalCompleted += weekCompleted;

                if (weekCompleted === weekDays && weekDays > 0) {
                    completedWeeks++;
                }
            });

            const percentage = totalDays > 0 ? (totalCompleted / totalDays) * 100 : 0;

            document.getElementById('overallProgress').style.width = percentage + '%';
            document.getElementById('overallProgress').textContent = Math.round(percentage) + '%';
            document.getElementById('completedWeeks').textContent = completedWeeks;
            document.getElementById('totalCompleted').textContent = totalCompleted;
            document.getElementById('totalRemaining').textContent = totalDays - totalCompleted;
        }

        async function toggleDayCompletion(week, day, completed) {
            try {
                await api.post('/progress', {
                    week: week,
                    day: day,
                    completed: completed,
                    time_spent: 60 // Default time, could be made dynamic
                });

                // Update local progress data
                if (!progressData[week]) progressData[week] = {};
                progressData[week][day] = { completed: completed };

                // Re-render to update UI
                renderRoadmap();
                updateOverallProgress();

                if (completed) {
                    showAchievement('Day Completed!', `Great job completing ${day} of Week ${week}!`);
                }

            } catch (error) {
                console.error('Failed to update progress:', error);
                showToast('Failed to update progress', 'danger');

                // Revert checkbox state
                document.getElementById(`check-${week}-${day}`).checked = !completed;
            }
        }

        function toggleWeek(weekNum) {
            const content = document.getElementById(`week-${weekNum}`);
            content.classList.toggle('show');
        }

        function expandAll() {
            document.querySelectorAll('.accordion-content').forEach(content => {
                content.classList.add('show');
            });
        }

        function collapseAll() {
            document.querySelectorAll('.accordion-content').forEach(content => {
                content.classList.remove('show');
            });
        }

        // Resource helper functions
        const resourcesMap = {
            'w3_python_getstarted': { title: 'Python Setup - W3Schools', url: 'https://www.w3schools.com/python/python_getstarted.asp', type: 'text' },
            'jt_cpp_tutorial': { title: 'C++ Setup - JavaTpoint', url: 'https://www.javatpoint.com/cpp-tutorial', type: 'text' },
            'galles_array_vis': { title: 'Array Visualization', url: 'https://www.cs.usfca.edu/~galles/visualization/Array.html', type: 'interactive' },
            'yt_neetcode_two_pointers': { title: 'Two Pointers - NeetCode', url: 'https://www.youtube.com/watch?v=jzZsG8n2R9A', type: 'video' },
            'lc_1_two_sum': { title: 'Two Sum - LeetCode', url: 'https://leetcode.com/problems/two-sum/', type: 'practice' }
            // Add more resources as needed
        };

        function getResourceById(id) {
            return resourcesMap[id];
        }

        function getResourceIcon(type) {
            const icons = {
                'text': 'book',
                'video': 'video',
                'interactive': 'play-circle',
                'practice': 'code'
            };
            return icons[type] || 'link';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function () {
            loadRoadmap();
        });
    </script>
</body>

</html>