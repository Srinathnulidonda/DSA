<div class="page-container">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="h2 mb-1">
                        <i class="bi bi-map text-primary me-2"></i>
                        DSA Learning Roadmap
                    </h1>
                    <p class="text-muted mb-0">Your 14-week journey to master Data Structures & Algorithms</p>
                </div>
                <div class="mt-3 mt-lg-0 d-flex gap-2">
                    <div class="dropdown">
                        <button class="btn btn-outline-secondary dropdown-toggle" type="button"
                            data-bs-toggle="dropdown">
                            <i class="bi bi-funnel me-2"></i>Filter
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="filterWeeks('all')">All Weeks</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterWeeks('completed')">Completed</a></li>
                            <li><a class="dropdown-item" href="#" onclick="filterWeeks('in-progress')">In Progress</a>
                            </li>
                            <li><a class="dropdown-item" href="#" onclick="filterWeeks('not-started')">Not Started</a>
                            </li>
                        </ul>
                    </div>
                    <button class="btn btn-primary" onclick="exportProgress()">
                        <i class="bi bi-download me-2"></i>Export Progress
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-3">Overall Progress</h5>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Completion Rate</span>
                                <span class="fw-medium" id="roadmap-progress-text">0 of 98 days completed</span>
                            </div>
                            <div class="progress mb-3" style="height: 16px;">
                                <div class="progress-bar bg-gradient-primary" role="progressbar"
                                    id="roadmap-progress-bar" style="width: 0%">
                                </div>
                            </div>
                            <div class="row g-3">
                                <div class="col-6 col-sm-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-success" id="completed-weeks">0</div>
                                        <small class="text-muted">Weeks Done</small>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-warning" id="current-week-num">1</div>
                                        <small class="text-muted">Current Week</small>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-info" id="total-study-hours">0h</div>
                                        <small class="text-muted">Study Time</small>
                                    </div>
                                </div>
                                <div class="col-6 col-sm-3">
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-primary" id="avg-daily-time">0m</div>
                                        <small class="text-muted">Daily Avg</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="position-relative d-inline-block">
                                <canvas id="roadmap-progress-chart" width="150" height="150"></canvas>
                                <div class="position-absolute top-50 start-50 translate-middle text-center">
                                    <div class="fs-3 fw-bold text-primary" id="roadmap-percentage">0%</div>
                                    <small class="text-muted">Complete</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Week Cards -->
    <div class="row g-4" id="roadmap-weeks">
        <!-- Loading state -->
        <div class="col-12">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-muted mt-3 mb-0">Loading roadmap...</p>
            </div>
        </div>
    </div>
</div>

<!-- Week Detail Modal -->
<div class="modal fade" id="weekDetailModal" tabindex="-1" aria-labelledby="weekDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="weekDetailModalLabel">Week Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="weekDetailContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="startWeekBtn">Start This Week</button>
            </div>
        </div>
    </div>
</div>

<script>
    let roadmapData = null;
    let progressData = null;
    let currentFilter = 'all';

    document.addEventListener('DOMContentLoaded', async function () {
        await loadRoadmapData();
        setupRoadmap();

        // Check if specific week is requested in URL
        const urlParams = new URLSearchParams(window.location.search);
        const weekParam = urlParams.get('week');
        if (weekParam) {
            const weekElement = document.querySelector(`[data-week="${weekParam}"]`);
            if (weekElement) {
                weekElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                weekElement.classList.add('highlight');
                setTimeout(() => weekElement.classList.remove('highlight'), 2000);
            }
        }
    });

    async function loadRoadmapData() {
        try {
            const [roadmap, progress] = await Promise.all([
                API.resources.getRoadmap(),
                API.progress.get()
            ]);

            roadmapData = roadmap.roadmap;
            progressData = progress.progress;

            updateProgressOverview();
            renderWeekCards();

        } catch (error) {
            console.error('Error loading roadmap:', error);
            Notifications.handleApiError(error, 'Loading roadmap');
            showErrorState();
        }
    }

    function showErrorState() {
        document.getElementById('roadmap-weeks').innerHTML = `
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-exclamation-triangle text-warning fs-1 mb-3"></i>
                <h3>Unable to Load Roadmap</h3>
                <p class="text-muted mb-4">There was an error loading the roadmap data.</p>
                <button class="btn btn-primary" onclick="loadRoadmapData()">
                    <i class="bi bi-arrow-clockwise me-2"></i>
                    Try Again
                </button>
            </div>
        </div>
    `;
    }

    function updateProgressOverview() {
        if (!roadmapData || !progressData) return;

        // Calculate overall stats
        let totalDays = 0;
        let completedDays = 0;
        let completedWeeks = 0;
        let currentWeek = 1;
        let totalStudyTime = 0;

        roadmapData.forEach(week => {
            const weekProgress = progressData[week.week] || {};
            const weekDays = week.days.length;
            const weekCompletedDays = Object.values(weekProgress).filter(day => day.completed).length;

            totalDays += weekDays;
            completedDays += weekCompletedDays;

            if (weekCompletedDays === weekDays) {
                completedWeeks++;
            } else if (weekCompletedDays > 0 && currentWeek === week.week) {
                // Current week is the first week with some but not all days completed
            } else if (weekCompletedDays === 0 && currentWeek === 1) {
                currentWeek = week.week;
            }

            // Calculate total study time
            Object.values(weekProgress).forEach(day => {
                if (day.time_spent) {
                    totalStudyTime += day.time_spent;
                }
            });
        });

        const completionPercentage = totalDays > 0 ? (completedDays / totalDays) * 100 : 0;
        const avgDailyTime = completedDays > 0 ? totalStudyTime / completedDays : 0;

        // Update UI elements
        document.getElementById('roadmap-progress-text').textContent = `${completedDays} of ${totalDays} days completed`;
        document.getElementById('roadmap-progress-bar').style.width = `${completionPercentage}%`;
        document.getElementById('roadmap-percentage').textContent = `${Math.round(completionPercentage)}%`;
        document.getElementById('completed-weeks').textContent = completedWeeks;
        document.getElementById('current-week-num').textContent = currentWeek;
        document.getElementById('total-study-hours').textContent = Utils.formatDuration(totalStudyTime);
        document.getElementById('avg-daily-time').textContent = `${Math.round(avgDailyTime)}m`;

        // Update progress chart
        updateProgressChart(completionPercentage);
    }

    function updateProgressChart(percentage) {
        const canvas = document.getElementById('roadmap-progress-chart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');

        new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [percentage, 100 - percentage],
                    backgroundColor: [
                        getComputedStyle(document.documentElement).getPropertyValue('--bs-primary'),
                        '#f8f9fa'
                    ],
                    borderWidth: 0,
                    cutout: '75%'
                }]
            },
            options: {
                responsive: false,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                }
            }
        });
    }

    function renderWeekCards() {
        if (!roadmapData || !progressData) return;

        const container = document.getElementById('roadmap-weeks');

        container.innerHTML = roadmapData
            .filter(week => {
                if (currentFilter === 'all') return true;

                const weekProgress = progressData[week.week] || {};
                const completedDays = Object.values(weekProgress).filter(day => day.completed).length;
                const totalDays = week.days.length;

                switch (currentFilter) {
                    case 'completed':
                        return completedDays === totalDays;
                    case 'in-progress':
                        return completedDays > 0 && completedDays < totalDays;
                    case 'not-started':
                        return completedDays === 0;
                    default:
                        return true;
                }
            })
            .map(week => createWeekCard(week))
            .join('');
    }

    function createWeekCard(week) {
        const weekProgress = progressData[week.week] || {};
        const completedDays = Object.values(weekProgress).filter(day => day.completed).length;
        const totalDays = week.days.length;
        const completionPercentage = totalDays > 0 ? (completedDays / totalDays) * 100 : 0;

        const isCompleted = completedDays === totalDays;
        const isInProgress = completedDays > 0 && completedDays < totalDays;
        const isNotStarted = completedDays === 0;

        let statusClass = '';
        let statusIcon = '';
        let statusText = '';

        if (isCompleted) {
            statusClass = 'border-success';
            statusIcon = 'bi-check-circle-fill text-success';
            statusText = 'Completed';
        } else if (isInProgress) {
            statusClass = 'border-warning';
            statusIcon = 'bi-clock-fill text-warning';
            statusText = 'In Progress';
        } else {
            statusClass = 'border-light';
            statusIcon = 'bi-circle text-muted';
            statusText = 'Not Started';
        }

        return `
        <div class="col-md-6 col-lg-4" data-week="${week.week}">
            <div class="card h-100 shadow-sm border-2 ${statusClass} week-card" 
                 data-week-number="${week.week}">
                <div class="card-header bg-white border-bottom-0 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0 text-primary">Week ${week.week}</h6>
                        <small class="text-muted">${statusText}</small>
                    </div>
                    <i class="${statusIcon} fs-5"></i>
                </div>
                <div class="card-body">
                    <h5 class="card-title mb-2">${week.title}</h5>
                    <p class="text-muted small mb-3">${week.goal}</p>
                    
                    <!-- Progress Bar -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small class="text-muted">Progress</small>
                            <small class="fw-medium">${completedDays}/${totalDays} days</small>
                        </div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar ${isCompleted ? 'bg-success' : 'bg-primary'}" 
                                 style="width: ${completionPercentage}%"></div>
                        </div>
                    </div>
                    
                    <!-- Project Preview -->
                    <div class="bg-light rounded p-3 mb-3">
                        <h6 class="text-primary mb-1">
                            <i class="bi bi-code-slash me-1"></i>
                            Project
                        </h6>
                        <p class="mb-1 fw-medium">${week.project.title}</p>
                        <p class="text-muted small mb-0">${week.project.description}</p>
                    </div>
                    
                    <!-- Skills Tags -->
                    <div class="mb-3">
                        <div class="d-flex flex-wrap gap-1">
                            ${week.project.skills.slice(0, 3).map(skill =>
            `<span class="badge bg-primary bg-opacity-10 text-primary">${skill}</span>`
        ).join('')}
                            ${week.project.skills.length > 3 ?
                `<span class="badge bg-secondary bg-opacity-10 text-secondary">+${week.project.skills.length - 3}</span>` :
                ''
            }
                        </div>
                    </div>
                </div>
                <div class="card-footer bg-white border-top-0">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary btn-sm flex-grow-1" 
                                onclick="viewWeekDetails(${week.week})">
                            <i class="bi bi-eye me-1"></i>
                            View Details
                        </button>
                        ${!isCompleted ?
                `<button class="btn btn-primary btn-sm" 
                                     onclick="startWeek(${week.week})">
                                ${isInProgress ? 'Continue' : 'Start'}
                            </button>` :
                `<button class="btn btn-success btn-sm" disabled>
                                <i class="bi bi-check me-1"></i>
                                Done
                            </button>`
            }
                    </div>
                </div>
            </div>
        </div>
    `;
    }

    function viewWeekDetails(weekNumber) {
        const week = roadmapData.find(w => w.week === weekNumber);
        if (!week) return;

        const weekProgress = progressData[weekNumber] || {};

        const modalContent = document.getElementById('weekDetailContent');
        modalContent.innerHTML = `
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-start mb-4">
                    <div>
                        <h4 class="text-primary mb-1">Week ${week.week}: ${week.title}</h4>
                        <p class="text-muted mb-0">${week.goal}</p>
                    </div>
                    <span class="badge bg-primary fs-6">${week.days.length} days</span>
                </div>
                
                <!-- Project Section -->
                <div class="card bg-light border-0 mb-4">
                    <div class="card-body">
                        <h5 class="text-primary mb-3">
                            <i class="bi bi-code-slash me-2"></i>
                            Project: ${week.project.title}
                        </h5>
                        <p class="mb-3">${week.project.description}</p>
                        <div class="d-flex flex-wrap gap-2">
                            ${week.project.skills.map(skill =>
            `<span class="badge bg-primary">${skill}</span>`
        ).join('')}
                        </div>
                    </div>
                </div>
                
                <!-- Daily Schedule -->
                <h5 class="mb-3">Daily Schedule</h5>
                <div class="row g-3">
                    ${week.days.map(day => {
            const dayProgress = weekProgress[day.day] || {};
            const isCompleted = dayProgress.completed || false;

            return `
                            <div class="col-md-6">
                                <div class="card border ${isCompleted ? 'border-success bg-success bg-opacity-10' : ''}">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0">${day.day}</h6>
                                            ${isCompleted ?
                    '<i class="bi bi-check-circle-fill text-success"></i>' :
                    '<i class="bi bi-circle text-muted"></i>'
                }
                                        </div>
                                        <p class="fw-medium text-primary mb-2">${day.topic}</p>
                                        <p class="text-muted small mb-2">${day.activities}</p>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <small class="text-muted">
                                                <i class="bi bi-clock me-1"></i>
                                                ${day.time_estimate} min
                                            </small>
                                            ${day.resources && day.resources.length > 0 ?
                    `<small class="text-primary">${day.resources.length} resources</small>` :
                    ''
                }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
        }).join('')}
                </div>
            </div>
        </div>
    `;

        // Update start button
        const startBtn = document.getElementById('startWeekBtn');
        startBtn.onclick = () => startWeek(weekNumber);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('weekDetailModal'));
        modal.show();
    }

    function startWeek(weekNumber) {
        // Close modal if open
        const modal = bootstrap.Modal.getInstance(document.getElementById('weekDetailModal'));
        if (modal) {
            modal.hide();
        }

        // Navigate to calendar with week focus
        Router.navigate(`/calendar?week=${weekNumber}`);
    }

    function filterWeeks(filter) {
        currentFilter = filter;
        renderWeekCards();

        // Update dropdown text
        const filterButton = document.querySelector('.dropdown-toggle');
        const filterTexts = {
            'all': 'All Weeks',
            'completed': 'Completed',
            'in-progress': 'In Progress',
            'not-started': 'Not Started'
        };
        filterButton.innerHTML = `<i class="bi bi-funnel me-2"></i>${filterTexts[filter]}`;
    }

    async function exportProgress() {
        try {
            // Generate progress report
            const report = generateProgressReport();

            // Create and download file
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dsa-progress-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            Notifications.success('Progress report exported successfully!');

        } catch (error) {
            console.error('Export error:', error);
            Notifications.error('Failed to export progress report');
        }
    }

    function generateProgressReport() {
        if (!roadmapData || !progressData) return '';

        let report = `DSA Learning Progress Report\n`;
        report += `Generated on: ${new Date().toLocaleString()}\n`;
        report += `===============================================\n\n`;

        // Overall stats
        let totalDays = 0;
        let completedDays = 0;
        roadmapData.forEach(week => {
            const weekProgress = progressData[week.week] || {};
            totalDays += week.days.length;
            completedDays += Object.values(weekProgress).filter(day => day.completed).length;
        });

        report += `OVERALL PROGRESS:\n`;
        report += `- Completion Rate: ${Math.round((completedDays / totalDays) * 100)}%\n`;
        report += `- Days Completed: ${completedDays}/${totalDays}\n\n`;

        // Week by week breakdown
        report += `WEEK BY WEEK BREAKDOWN:\n\n`;
        roadmapData.forEach(week => {
            const weekProgress = progressData[week.week] || {};
            const weekCompletedDays = Object.values(weekProgress).filter(day => day.completed).length;
            const weekTotalDays = week.days.length;

            report += `Week ${week.week}: ${week.title}\n`;
            report += `- Progress: ${weekCompletedDays}/${weekTotalDays} days (${Math.round((weekCompletedDays / weekTotalDays) * 100)}%)\n`;
            report += `- Goal: ${week.goal}\n`;
            report += `- Project: ${week.project.title}\n\n`;
        });

        return report;
    }

    function setupRoadmap() {
        // Auto-refresh progress every 30 seconds
        setInterval(async () => {
            try {
                const progress = await API.progress.get();
                progressData = progress.progress;
                updateProgressOverview();
                renderWeekCards();
            } catch (error) {
                console.warn('Progress refresh failed:', error);
            }
        }, 30 * 1000);
    }

    // Add CSS for highlight animation
    const style = document.createElement('style');
    style.textContent = `
    .week-card.highlight {
        animation: highlight 2s ease-in-out;
    }
    
    @keyframes highlight {
        0%, 100% { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        50% { box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25); }
    }
`;
    document.head.appendChild(style);
</script>