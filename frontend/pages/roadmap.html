<div class="container-fluid p-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center">
                <div>
                    <h1 class="h3 fw-bold mb-1">
                        <i class="fas fa-map text-primary me-2"></i>
                        14-Week DSA Roadmap
                    </h1>
                    <p class="text-muted mb-0">Master Data Structures & Algorithms with our structured curriculum</p>
                </div>
                <div class="d-flex gap-2 mt-3 mt-lg-0">
                    <button class="btn btn-outline-primary" id="progress-overview-btn">
                        <i class="fas fa-chart-pie me-2"></i>Progress Overview
                    </button>
                    <button class="btn btn-primary" id="continue-learning-btn">
                        <i class="fas fa-play me-2"></i>Continue Learning
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Summary -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-gray-800 dark:to-gray-700 border-0">
                <div class="card-body p-4">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="fw-bold mb-2">Your Progress</h5>
                            <div class="progress mb-3" style="height: 12px;">
                                <div class="progress-bar bg-gradient progress-bar-animated" id="overall-progress-bar"
                                    role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0"
                                    aria-valuemax="100">
                                </div>
                            </div>
                            <div class="row g-3 text-sm">
                                <div class="col-auto">
                                    <span class="badge bg-success" id="completed-days">0</span>
                                    <span class="text-muted ms-1">Completed</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-warning" id="current-week">Week 1</span>
                                    <span class="text-muted ms-1">Current</span>
                                </div>
                                <div class="col-auto">
                                    <span class="badge bg-info" id="total-study-time">0h</span>
                                    <span class="text-muted ms-1">Study Time</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-md-end mt-3 mt-md-0">
                            <div class="d-inline-flex align-items-center justify-content-center bg-white dark:bg-gray-600 rounded-circle shadow-sm"
                                style="width: 80px; height: 80px;">
                                <div class="text-center">
                                    <div class="h4 fw-bold mb-0 text-primary" id="completion-percentage">0%</div>
                                    <small class="text-muted">Complete</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Week Filter -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-3">
                    <div class="d-flex flex-wrap gap-2" id="week-filter">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Roadmap Content -->
    <div class="row">
        <div class="col-12">
            <div id="roadmap-container">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Week Detail Modal -->
<div class="modal fade" id="weekModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="weekModalTitle">Week Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="weekModalBody">
                <!-- Populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="startWeekBtn">Start This Week</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async function () {
        let roadmapData = [];
        let progressData = {};
        let currentWeekFilter = null;

        // Load initial data
        await loadRoadmapData();
        await loadProgressData();

        // Render the roadmap
        renderRoadmap();
        updateProgressSummary();
        renderWeekFilter();

        async function loadRoadmapData() {
            try {
                const response = await ApiMethods.roadmap.get();
                roadmapData = response.roadmap || [];
                console.log('Roadmap data loaded:', roadmapData);
            } catch (error) {
                console.error('Failed to load roadmap:', error);
                Notifications.error('Failed to load roadmap data');
            }
        }

        async function loadProgressData() {
            try {
                const response = await ApiMethods.progress.get();
                progressData = response.progress || {};
                console.log('Progress data loaded:', progressData);
            } catch (error) {
                console.error('Failed to load progress:', error);
                // Continue without progress data
            }
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmap-container');
            if (!container || roadmapData.length === 0) return;

            const filteredWeeks = currentWeekFilter
                ? roadmapData.filter(week => week.week === currentWeekFilter)
                : roadmapData;

            container.innerHTML = filteredWeeks.map(week => {
                const weekProgress = progressData[week.week] || {};
                const completedDays = Object.values(weekProgress).filter(day => day.completed).length;
                const totalDays = week.days.length;
                const completionPercentage = totalDays > 0 ? (completedDays / totalDays) * 100 : 0;

                return `
                <div class="card mb-4 week-card" data-week="${week.week}">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="mb-1 fw-bold">
                                    Week ${week.week}: ${week.title}
                                    ${getWeekStatusBadge(completionPercentage)}
                                </h5>
                                <p class="text-muted mb-0">${week.goal}</p>
                            </div>
                            <div class="col-md-4 text-md-end mt-2 mt-md-0">
                                <div class="d-flex align-items-center justify-content-md-end gap-3">
                                    <div class="text-center">
                                        <div class="small text-muted">Progress</div>
                                        <div class="fw-bold text-primary">${Math.round(completionPercentage)}%</div>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="showWeekDetails(${week.week})">
                                        <i class="fas fa-eye me-1"></i>Details
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="progress mt-3" style="height: 6px;">
                            <div class="progress-bar bg-gradient" 
                                 style="width: ${completionPercentage}%" 
                                 role="progressbar"></div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            ${week.days.map(day => renderDayCard(week.week, day, weekProgress[day.day])).join('')}
                        </div>
                        
                        <!-- Project Section -->
                        ${week.project ? renderProjectSection(week.project, completionPercentage) : ''}
                    </div>
                </div>
            `;
            }).join('');
        }

        function renderDayCard(weekNum, day, dayProgress) {
            const isCompleted = dayProgress?.completed || false;
            const timeSpent = dayProgress?.time_spent || 0;

            return `
            <div class="col-lg-4 col-md-6">
                <div class="card h-100 day-card ${isCompleted ? 'border-success' : ''}" 
                     onclick="toggleDayProgress(${weekNum}, '${day.day}')">
                    <div class="card-body p-3">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold mb-0">${day.day}</h6>
                            <div class="form-check">
                                <input class="form-check-input" 
                                       type="checkbox" 
                                       ${isCompleted ? 'checked' : ''}
                                       onclick="event.stopPropagation()">
                            </div>
                        </div>
                        <p class="fw-medium text-primary mb-2">${day.topic}</p>
                        <p class="text-muted small mb-2">${day.activities}</p>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-light text-dark">
                                <i class="fas fa-clock me-1"></i>
                                ${day.time_estimate}min
                            </span>
                            ${timeSpent > 0 ? `<span class="badge bg-success">${timeSpent}min spent</span>` : ''}
                        </div>

                        ${day.resources && day.resources.length > 0 ? `
                            <div class="mt-2">
                                <small class="text-muted">Resources:</small>
                                <div class="d-flex flex-wrap gap-1 mt-1">
                                    ${day.resources.slice(0, 2).map(resource => `
                                        <span class="badge bg-info">${getResourceTypeIcon(resource)} ${getResourceTitle(resource)}</span>
                                    `).join('')}
                                    ${day.resources.length > 2 ? `<span class="badge bg-secondary">+${day.resources.length - 2}</span>` : ''}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
        }

        function renderProjectSection(project, weekCompletion) {
            return `
            <div class="mt-4 pt-4 border-top">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="fw-bold mb-1">
                            <i class="fas fa-project-diagram text-warning me-2"></i>
                            Week Project: ${project.title}
                        </h6>
                        <p class="text-muted mb-2">${project.description}</p>
                        <div class="d-flex flex-wrap gap-1">
                            ${project.skills.map(skill => `
                                <span class="badge bg-warning text-dark">${skill}</span>
                            `).join('')}
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end mt-3 mt-md-0">
                        <button class="btn btn-warning" ${weekCompletion < 80 ? 'disabled' : ''}>
                            <i class="fas fa-code me-2"></i>
                            ${weekCompletion >= 80 ? 'Start Project' : 'Complete 80% to unlock'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        }

        function getWeekStatusBadge(completionPercentage) {
            if (completionPercentage === 100) {
                return '<span class="badge bg-success ms-2"><i class="fas fa-check me-1"></i>Completed</span>';
            } else if (completionPercentage > 0) {
                return '<span class="badge bg-warning ms-2"><i class="fas fa-clock me-1"></i>In Progress</span>';
            } else {
                return '<span class="badge bg-secondary ms-2"><i class="fas fa-lock me-1"></i>Not Started</span>';
            }
        }

        function renderWeekFilter() {
            const container = document.getElementById('week-filter');
            if (!container) return;

            const buttons = [
                `<button class="btn btn-sm ${currentWeekFilter === null ? 'btn-primary' : 'btn-outline-primary'}" 
                     onclick="filterByWeek(null)">All Weeks</button>`
            ];

            for (let i = 1; i <= 14; i++) {
                const isActive = currentWeekFilter === i;
                const weekProgress = progressData[i] || {};
                const completedDays = Object.values(weekProgress).filter(day => day.completed).length;
                const totalDays = roadmapData.find(w => w.week === i)?.days.length || 7;

                buttons.push(`
                <button class="btn btn-sm ${isActive ? 'btn-primary' : 'btn-outline-primary'} position-relative" 
                        onclick="filterByWeek(${i})">
                    Week ${i}
                    ${completedDays === totalDays && totalDays > 0 ? '<i class="fas fa-check position-absolute top-0 start-100 translate-middle text-success"></i>' : ''}
                </button>
            `);
            }

            container.innerHTML = buttons.join('');
        }

        function updateProgressSummary() {
            const totalDays = roadmapData.reduce((sum, week) => sum + week.days.length, 0);
            let completedDays = 0;
            let totalStudyTime = 0;

            Object.values(progressData).forEach(weekProgress => {
                Object.values(weekProgress).forEach(dayProgress => {
                    if (dayProgress.completed) completedDays++;
                    totalStudyTime += dayProgress.time_spent || 0;
                });
            });

            const completionPercentage = totalDays > 0 ? (completedDays / totalDays) * 100 : 0;

            // Update UI elements
            document.getElementById('overall-progress-bar').style.width = `${completionPercentage}%`;
            document.getElementById('overall-progress-bar').setAttribute('aria-valuenow', completionPercentage);
            document.getElementById('completed-days').textContent = completedDays;
            document.getElementById('completion-percentage').textContent = `${Math.round(completionPercentage)}%`;
            document.getElementById('total-study-time').textContent = Utils.time.formatDuration(totalStudyTime * 60);

            // Find current week
            const currentWeek = findCurrentWeek();
            document.getElementById('current-week').textContent = `Week ${currentWeek}`;
        }

        function findCurrentWeek() {
            for (let i = 1; i <= 14; i++) {
                const weekProgress = progressData[i] || {};
                const completedDays = Object.values(weekProgress).filter(day => day.completed).length;
                const totalDays = roadmapData.find(w => w.week === i)?.days.length || 7;

                if (completedDays < totalDays) {
                    return i;
                }
            }
            return 14; // All weeks completed
        }

        async function toggleDayProgress(weekNum, dayName) {
            try {
                const currentProgress = progressData[weekNum]?.[dayName] || {};
                const newCompleted = !currentProgress.completed;

                // Optimistic update
                if (!progressData[weekNum]) progressData[weekNum] = {};
                progressData[weekNum][dayName] = {
                    ...currentProgress,
                    completed: newCompleted,
                    completion_date: newCompleted ? new Date().toISOString() : null
                };

                // Update UI immediately
                renderRoadmap();
                updateProgressSummary();

                // Send to backend
                await ApiMethods.progress.update(weekNum, dayName, {
                    completed: newCompleted,
                    time_spent: currentProgress.time_spent || 0
                });

                // Show success message
                if (newCompleted) {
                    Notifications.success(`Completed ${dayName} of Week ${weekNum}!`);

                    // Check if week is completed
                    const weekProgress = progressData[weekNum];
                    const week = roadmapData.find(w => w.week === weekNum);
                    if (week) {
                        const completedDays = Object.values(weekProgress).filter(day => day.completed).length;
                        if (completedDays === week.days.length) {
                            setTimeout(() => {
                                Notifications.success(`ðŸŽ‰ Week ${weekNum} completed! Great job!`);
                                // Show confetti effect
                                if (typeof Lib !== 'undefined' && Lib.animation) {
                                    Lib.animation.confetti();
                                }
                            }, 1000);
                        }
                    }
                }

            } catch (error) {
                console.error('Failed to update progress:', error);
                Notifications.error('Failed to update progress');

                // Revert optimistic update
                await loadProgressData();
                renderRoadmap();
                updateProgressSummary();
            }
        }

        function getResourceTypeIcon(resourceKey) {
            // This would map to your RESOURCES data
            const resourceTypes = {
                'text': '<i class="fas fa-file-text"></i>',
                'video': '<i class="fas fa-video"></i>',
                'interactive': '<i class="fas fa-play-circle"></i>',
                'practice': '<i class="fas fa-code"></i>'
            };
            return resourceTypes.text || '<i class="fas fa-link"></i>';
        }

        function getResourceTitle(resourceKey) {
            // Extract a short title from resource key
            return resourceKey.replace(/_/g, ' ').substring(0, 10) + '...';
        }

        // Global functions for event handlers
        window.filterByWeek = function (weekNum) {
            currentWeekFilter = weekNum;
            renderRoadmap();
            renderWeekFilter();
        };

        window.showWeekDetails = function (weekNum) {
            const week = roadmapData.find(w => w.week === weekNum);
            if (!week) return;

            const modal = new bootstrap.Modal(document.getElementById('weekModal'));
            document.getElementById('weekModalTitle').textContent = `Week ${week.week}: ${week.title}`;

            const weekProgress = progressData[weekNum] || {};
            const completedDays = Object.values(weekProgress).filter(day => day.completed).length;

            document.getElementById('weekModalBody').innerHTML = `
            <div class="mb-4">
                <h6 class="fw-bold">Goal</h6>
                <p class="text-muted">${week.goal}</p>
            </div>
            
            <div class="mb-4">
                <h6 class="fw-bold">Progress</h6>
                <div class="progress mb-2">
                    <div class="progress-bar" style="width: ${(completedDays / week.days.length) * 100}%"></div>
                </div>
                <small class="text-muted">${completedDays} of ${week.days.length} days completed</small>
            </div>

            <div class="mb-4">
                <h6 class="fw-bold">Daily Schedule</h6>
                <div class="list-group">
                    ${week.days.map(day => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${day.day}:</strong> ${day.topic}
                                <div class="small text-muted">${day.activities}</div>
                            </div>
                            <span class="badge ${weekProgress[day.day]?.completed ? 'bg-success' : 'bg-secondary'}">
                                ${weekProgress[day.day]?.completed ? 'Done' : 'Pending'}
                            </span>
                        </div>
                    `).join('')}
                </div>
            </div>

            ${week.project ? `
                <div class="mb-4">
                    <h6 class="fw-bold">Week Project</h6>
                    <div class="card">
                        <div class="card-body">
                            <h6 class="card-title">${week.project.title}</h6>
                            <p class="card-text">${week.project.description}</p>
                            <div class="d-flex flex-wrap gap-1">
                                ${week.project.skills.map(skill => `
                                    <span class="badge bg-primary">${skill}</span>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            ` : ''}
        `;

            document.getElementById('startWeekBtn').onclick = () => {
                modal.hide();
                // Scroll to the week
                const weekCard = document.querySelector(`[data-week="${weekNum}"]`);
                if (weekCard) {
                    weekCard.scrollIntoView({ behavior: 'smooth' });
                }
            };

            modal.show();
        };

        // Continue learning button
        document.getElementById('continue-learning-btn').addEventListener('click', function () {
            const currentWeek = findCurrentWeek();
            filterByWeek(currentWeek);

            // Scroll to current week
            setTimeout(() => {
                const weekCard = document.querySelector(`[data-week="${currentWeek}"]`);
                if (weekCard) {
                    weekCard.scrollIntoView({ behavior: 'smooth' });
                }
            }, 100);
        });

        // Progress overview button
        document.getElementById('progress-overview-btn').addEventListener('click', function () {
            window.location.href = '/pages/progress';
        });
    });
</script>