<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roadmap - DSA Learning Platform</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/components.css">
    <link rel="stylesheet" href="../css/animation.css">
    <link rel="stylesheet" href="../css/responsive.css">

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
</head>

<body class="bg-gray-50">
    <!-- Include Top Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top" id="topNav">
        <!-- Same as dashboard -->
    </nav>

    <div class="d-flex">
        <!-- Include Sidebar -->
        <nav class="sidebar bg-white shadow-sm" id="sidebar">
            <!-- Same as dashboard but with roadmap active -->
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="container-fluid p-4">
                <!-- Header -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h1 class="h3 mb-0">14-Week DSA Roadmap</h1>
                                <p class="text-muted mb-0">Your structured path to mastering Data Structures &
                                    Algorithms</p>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-primary" id="collapseAllBtn">
                                    <i class="fas fa-compress"></i> Collapse All
                                </button>
                                <button class="btn btn-primary" id="expandAllBtn">
                                    <i class="fas fa-expand"></i> Expand All
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress Overview -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h5 class="mb-3">Overall Progress</h5>
                                <div class="progress mb-2" style="height: 20px;">
                                    <div class="progress-bar bg-primary" id="overallProgress" style="width: 0%">
                                        <span class="progress-text">0%</span>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between text-muted">
                                    <small>Start</small>
                                    <small id="progressStats">0 of 98 days completed</small>
                                    <small>Finish</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Roadmap Weeks -->
                <div class="row" id="roadmapContainer">
                    <!-- Dynamically populated -->
                </div>
            </div>
        </main>
    </div>

    <!-- Include Mobile Navigation -->
    <nav class="mobile-nav d-lg-none">
        <!-- Same as dashboard -->
    </nav>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/components.js"></script>

    <script>
        let roadmapData = [];
        let userProgress = {};

        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();
            await loadRoadmap();
            await loadUserProgress();
            renderRoadmap();

            // Check for week parameter
            const urlParams = new URLSearchParams(window.location.search);
            const week = urlParams.get('week');
            if (week) {
                scrollToWeek(week);
            }
        });

        async function loadRoadmap() {
            try {
                const response = await fetchWithAuth(`${API_BASE}/roadmap`);
                if (!response.ok) throw new Error('Failed to load roadmap');

                const data = await response.json();
                roadmapData = data.roadmap;
            } catch (error) {
                console.error('Roadmap error:', error);
                showToast('Failed to load roadmap', 'error');
            }
        }

        async function loadUserProgress() {
            try {
                const response = await fetchWithAuth(`${API_BASE}/progress`);
                if (!response.ok) throw new Error('Failed to load progress');

                const data = await response.json();
                userProgress = data.progress;

                // Update overall progress
                updateOverallProgress();
            } catch (error) {
                console.error('Progress error:', error);
            }
        }

        function updateOverallProgress() {
            let completedDays = 0;
            let totalDays = 0;

            roadmapData.forEach(week => {
                week.days.forEach(day => {
                    totalDays++;
                    if (userProgress[week.week]?.[day.day]?.completed) {
                        completedDays++;
                    }
                });
            });

            const percentage = totalDays > 0 ? Math.round((completedDays / totalDays) * 100) : 0;

            document.getElementById('overallProgress').style.width = `${percentage}%`;
            document.querySelector('.progress-text').textContent = `${percentage}%`;
            document.getElementById('progressStats').textContent = `${completedDays} of ${totalDays} days completed`;
        }

        function renderRoadmap() {
            const container = document.getElementById('roadmapContainer');

            roadmapData.forEach((week, index) => {
                const weekProgress = calculateWeekProgress(week);
                const isCurrentWeek = isThisCurrentWeek(week.week);

                const weekCard = document.createElement('div');
                weekCard.className = 'col-12 mb-4';
                weekCard.innerHTML = `
                    <div class="card border-0 shadow-sm ${isCurrentWeek ? 'border-primary border-2' : ''}" id="week-${week.week}">
                        <div class="card-header bg-white py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <button class="btn btn-link text-dark p-0 me-3" data-bs-toggle="collapse" 
                                            data-bs-target="#weekContent${week.week}">
                                        <i class="fas fa-chevron-down week-toggle"></i>
                                    </button>
                                    <div>
                                        <h5 class="mb-0">
                                            Week ${week.week}: ${week.title}
                                            ${isCurrentWeek ? '<span class="badge bg-primary ms-2">Current</span>' : ''}
                                        </h5>
                                        <small class="text-muted">${week.goal}</small>
                                    </div>
                                </div>
                                <div class="text-end">
                                    <div class="mb-2">
                                        <span class="text-muted">${weekProgress.completed}/${weekProgress.total} days</span>
                                    </div>
                                    <div class="progress" style="width: 150px; height: 8px;">
                                        <div class="progress-bar bg-${weekProgress.percentage === 100 ? 'success' : 'primary'}" 
                                             style="width: ${weekProgress.percentage}%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="weekContent${week.week}" class="collapse ${isCurrentWeek ? 'show' : ''}">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <h6 class="mb-3">Daily Schedule</h6>
                                        ${renderDays(week)}
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="bg-light rounded p-3 mb-3">
                                            <h6 class="mb-3">Weekly Project</h6>
                                            <h5 class="text-primary">${week.project.title}</h5>
                                            <p class="text-muted mb-3">${week.project.description}</p>
                                            <div>
                                                <small class="text-muted">Skills practiced:</small>
                                                <div class="mt-2">
                                                    ${week.project.skills.map(skill =>
                    `<span class="badge bg-secondary me-1">${skill}</span>`
                ).join('')}
                                                </div>
                                            </div>
                                        </div>
                                        ${week.week > 1 ? `
                                            <button class="btn btn-outline-primary w-100" 
                                                    onclick="reviewWeek(${week.week - 1})">
                                                <i class="fas fa-history me-2"></i>Review Previous Week
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                container.appendChild(weekCard);
            });
        }

        function renderDays(week) {
            return week.days.map(day => {
                const isCompleted = userProgress[week.week]?.[day.day]?.completed || false;
                const timeSpent = userProgress[week.week]?.[day.day]?.time_spent || 0;

                return `
                    <div class="day-item mb-3 p-3 border rounded ${isCompleted ? 'bg-success bg-opacity-10 border-success' : ''}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <input type="checkbox" class="form-check-input me-2" 
                                           ${isCompleted ? 'checked' : ''} 
                                           onchange="toggleDayComplete(${week.week}, '${day.day}', this.checked)">
                                    <h6 class="mb-0">${day.day}: ${day.topic}</h6>
                                </div>
                                <p class="text-muted mb-2">${day.activities}</p>
                                <div class="d-flex flex-wrap gap-2">
                                    ${day.resources.map(resId => {
                    const resource = getResourceById(resId);
                    return resource ? `
                                            <a href="${resource.url}" target="_blank" 
                                               class="btn btn-sm btn-outline-secondary">
                                                <i class="fas fa-${getResourceIcon(resource.type)} me-1"></i>
                                                ${resource.title}
                                            </a>
                                        ` : '';
                }).join('')}
                                </div>
                            </div>
                            <div class="text-end ms-3">
                                <small class="text-muted d-block">
                                    <i class="fas fa-clock"></i> ${day.time_estimate} min
                                </small>
                                ${timeSpent > 0 ? `
                                    <small class="text-success d-block">
                                        <i class="fas fa-check"></i> ${timeSpent} min spent
                                    </small>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calculateWeekProgress(week) {
            let completed = 0;
            week.days.forEach(day => {
                if (userProgress[week.week]?.[day.day]?.completed) {
                    completed++;
                }
            });

            return {
                completed,
                total: week.days.length,
                percentage: Math.round((completed / week.days.length) * 100)
            };
        }

        function isThisCurrentWeek(weekNum) {
            // Find the first incomplete week
            for (let i = 0; i < roadmapData.length; i++) {
                const week = roadmapData[i];
                const progress = calculateWeekProgress(week);
                if (progress.percentage < 100) {
                    return week.week === weekNum;
                }
            }
            return false;
        }

        async function toggleDayComplete(week, day, completed) {
            try {
                const response = await fetchWithAuth(`${API_BASE}/progress`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        week,
                        day,
                        completed,
                        time_spent: completed ? 60 : 0 // Default 60 minutes
                    })
                });

                if (!response.ok) throw new Error('Failed to update progress');

                // Update local progress
                if (!userProgress[week]) userProgress[week] = {};
                userProgress[week][day] = { completed, time_spent: 60 };

                // Update UI
                updateOverallProgress();

                // Show achievement for completing a day
                if (completed) {
                    showToast('Day completed! Keep up the great work! 🎉', 'success');

                    // Check if week is complete
                    const weekData = roadmapData.find(w => w.week === week);
                    const weekProgress = calculateWeekProgress(weekData);
                    if (weekProgress.percentage === 100) {
                        showWeekCompleteAchievement(week, weekData.title);
                    }
                }
            } catch (error) {
                console.error('Progress update error:', error);
                showToast('Failed to update progress', 'error');

                // Revert checkbox
                event.target.checked = !completed;
            }
        }

        function showWeekCompleteAchievement(weekNum, weekTitle) {
            confetti({
                particleCount: 150,
                spread: 100,
                origin: { y: 0.6 }
            });

            Swal.fire({
                icon: 'success',
                title: 'Week Completed!',
                html: `
                    <p>Congratulations! You've completed <strong>Week ${weekNum}: ${weekTitle}</strong></p>
                    <p class="mt-3">Ready for the next challenge?</p>
                `,
                confirmButtonText: 'Continue to Next Week',
                showCancelButton: true,
                cancelButtonText: 'Stay Here'
            }).then((result) => {
                if (result.isConfirmed && weekNum < 14) {
                    scrollToWeek(weekNum + 1);
                }
            });
        }

        function scrollToWeek(weekNum) {
            const weekElement = document.getElementById(`week-${weekNum}`);
            if (weekElement) {
                weekElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // Expand the week if collapsed
                const collapseElement = document.getElementById(`weekContent${weekNum}`);
                if (collapseElement && !collapseElement.classList.contains('show')) {
                    new bootstrap.Collapse(collapseElement, { show: true });
                }

                // Highlight the week
                weekElement.classList.add('highlight-animation');
                setTimeout(() => {
                    weekElement.classList.remove('highlight-animation');
                }, 2000);
            }
        }

        function reviewWeek(weekNum) {
            scrollToWeek(weekNum);
        }

        // Collapse/Expand all functionality
        document.getElementById('collapseAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.collapse').forEach(collapse => {
                new bootstrap.Collapse(collapse, { hide: true });
            });
            document.querySelectorAll('.week-toggle').forEach(icon => {
                icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
            });
        });

        document.getElementById('expandAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.collapse').forEach(collapse => {
                new bootstrap.Collapse(collapse, { show: true });
            });
            document.querySelectorAll('.week-toggle').forEach(icon => {
                icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
            });
        });

        // Toggle chevron icon on collapse
        document.addEventListener('shown.bs.collapse', (e) => {
            const toggle = e.target.previousElementSibling.querySelector('.week-toggle');
            if (toggle) toggle.classList.replace('fa-chevron-down', 'fa-chevron-up');
        });

        document.addEventListener('hidden.bs.collapse', (e) => {
            const toggle = e.target.previousElementSibling.querySelector('.week-toggle');
            if (toggle) toggle.classList.replace('fa-chevron-up', 'fa-chevron-down');
        });

        // Resource helper functions
        function getResourceById(id) {
            // This would be populated from the resources API
            return window.resourcesMap?.[id] || null;
        }

        function getResourceIcon(type) {
            const icons = {
                'text': 'book',
                'video': 'play-circle',
                'interactive': 'laptop-code',
                'practice': 'code'
            };
            return icons[type] || 'link';
        }

        // Load resources map
        async function loadResourcesMap() {
            try {
                const response = await fetchWithAuth(`${API_BASE}/resources`);
                if (response.ok) {
                    const data = await response.json();
                    window.resourcesMap = {};
                    data.resources.forEach(res => {
                        window.resourcesMap[res.id] = res;
                    });
                }
            } catch (error) {
                console.error('Failed to load resources:', error);
            }
        }

        // Load resources on page load
        loadResourcesMap();
    </script>
</body>

</html>